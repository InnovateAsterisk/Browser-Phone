function uID(){return Date.now()+Math.floor(1e4*Math.random()).toString(16).toUpperCase()}function utcDateNow(){return moment().utc().format("YYYY-MM-DD HH:mm:ss UTC")}function getDbItem(e,t){var n=window.localStorage;return null!=n.getItem(e)?n.getItem(e):t}function getAudioSrcID(){var e=localDB.getItem("AudioSrcId");return null!=e?e:"default"}function getAudioOutputID(){var e=localDB.getItem("AudioOutputId");return null!=e?e:"default"}function getVideoSrcID(){var e=localDB.getItem("VideoSrcId");return null!=e?e:"default"}function getRingerOutputID(){var e=localDB.getItem("RingOutputId");return null!=e?e:"default"}function formatDuration(e){var t=Math.floor(parseFloat(e));if(t<0)return t;if(t>=0&&t<60)return t+" "+(t>1?lang.seconds_plural:lang.second_single);if(t>=60&&t<3600){var n=moment.duration(t,"seconds");return n.minutes()+" "+(n.minutes()>1?lang.minutes_plural:lang.minute_single)+" "+n.seconds()+" "+(n.seconds()>1?lang.seconds_plural:lang.second_single)}if(t>=3600&&t<86400){n=moment.duration(t,"seconds");return n.hours()+" "+(n.hours()>1?lang.hours_plural:lang.hour_single)+" "+n.minutes()+" "+(n.minutes()>1?lang.minutes_plural:lang.minute_single)+" "+n.seconds()+" "+(n.seconds()>1?lang.seconds_plural:lang.second_single)}}function formatShortDuration(e){var t=Math.floor(parseFloat(e));if(t<0)return t;if(t>=0&&t<60)return"00:"+(t>9?t:"0"+t);if(t>=60&&t<3600){var n=moment.duration(t,"seconds");return(n.minutes()>9?n.minutes():"0"+n.minutes())+":"+(n.seconds()>9?n.seconds():"0"+n.seconds())}if(t>=3600&&t<86400){n=moment.duration(t,"seconds");return(n.hours()>9?n.hours():"0"+n.hours())+":"+(n.minutes()>9?n.minutes():"0"+n.minutes())+":"+(n.seconds()>9?n.seconds():"0"+n.seconds())}}function formatBytes(e,t){if(0===e)return"0 "+lang.bytes;var n=1024,i=t&&t>=0?t:2,a=[lang.bytes,lang.kb,lang.mb,lang.gb,lang.tb,lang.pb,lang.eb,lang.zb,lang.yb],o=Math.floor(Math.log(e)/Math.log(n));return parseFloat((e/Math.pow(n,o)).toFixed(i))+" "+a[o]}function UserLocale(){var e=window.navigator.userLanguage||window.navigator.language;return langtag=e.split("-"),1==langtag.length?"":2==langtag.length?langtag[1].toLowerCase():langtag.length>=3?langtag[1].toLowerCase():void 0}function GetAlternateLanguage(){var e=window.navigator.userLanguage||window.navigator.language;if("auto"!=Language&&(e=Language),e=e.toLowerCase(),"en"==e||0==e.indexOf("en-"))return"";for(l=0;l<availableLang.length;l++)if(0==e.indexOf(availableLang[l].toLowerCase()))return console.log("Alternate Language detected: ",e),moment.locale(e),availableLang[l].toLowerCase();return""}function getFilter(e,t){return-1!=e.indexOf(",",e.indexOf(t+": ")+t.length+2)?e.substring(e.indexOf(t+": ")+t.length+2,e.indexOf(",",e.indexOf(t+": ")+t.length+2)):e.substring(e.indexOf(t+": ")+t.length+2)}function base64toBlob(e,t){e.indexOf(!0)&&(e=e.split(",")[1]);for(var n=atob(e),i=Math.ceil(n.length/1024),a=new Array(i),o=0;o<i;++o){for(var s=1024*o,l=Math.min(s+1024,n.length),r=new Array(l-s),d=s,c=0;d<l;++c,++d)r[c]=n[d].charCodeAt(0);a[o]=new Uint8Array(r)}return new Blob(a,{type:t})}function MakeDataArray(e,t){for(var n=new Array(t),i=0;i<n.length;i++)n[i]=e;return n}function onLocalStorageEvent(e){"InstanceId"==e.key&&Unregister()}function UpdateUI(){var e=$(window).outerWidth(),t=$(window).outerHeight();e>UiMaxWidth?($("#leftContentTable").css("border-left-width","1px"),null==selectedBuddy&&null==selectedLine?$("#leftContentTable").css("border-right-width","1px"):$("#rightContent").css("border-right-width","1px")):($("#leftContentTable").css("border-left-width","0px"),null==selectedBuddy&&null==selectedLine?$("#leftContentTable").css("border-right-width","0px"):$("#leftContentTable").css("border-right-width","1px"),$("#rightContent").css("border-right-width","0px")),e<920?null==selectedBuddy&null==selectedLine?($("#rightContent").hide(),$("#leftContent").css("width","100%"),$("#leftContent").show()):($("#rightContent").css("margin-left","0px"),$("#rightContent").show(),$("#leftContent").hide(),null!=selectedBuddy&&updateScroll(selectedBuddy.identity)):null==selectedBuddy&null==selectedLine?($("#leftContent").css("width","100%"),$("#rightContent").css("margin-left","0px"),$("#leftContent").show(),$("#rightContent").hide()):($("#leftContent").css("width","320px"),$("#rightContent").css("margin-left","320px"),$("#leftContent").show(),$("#rightContent").show(),null!=selectedBuddy&&updateScroll(selectedBuddy.identity));for(var n=0;n<Lines.length;n++)updateLineScroll(Lines[n].LineNumber),RedrawStage(Lines[n].LineNumber,!1);if(null!=windowObj){var i=windowObj.parent().outerHeight(),a=windowObj.width();e<=a||t<=i?(windowObj.dialog("option","height",t),windowObj.dialog("option","width",e-6),windowObj.parent().css("top","0px"),windowObj.parent().css("left","0px")):(windowObj.parent().css("left",e/2-a/2+"px"),windowObj.parent().css("top",t/2-i/2+"px"))}if(null!=alertObj){a=300,i=alertObj.parent().outerHeight();e<=a||t<=i?(e<=a&&(alertObj.dialog("option","width",e-6),alertObj.parent().css("left","0px"),alertObj.parent().css("top",t/2-i/2+"px")),t<=i&&(alertObj.dialog("option","height",t),alertObj.parent().css("left",e/2-a/2+"px"),alertObj.parent().css("top","0px"))):(alertObj.parent().css("left",e/2-a/2+"px"),alertObj.parent().css("top",t/2-i/2+"px"))}if(null!=confirmObj){a=300,i=confirmObj.parent().outerHeight();e<=a||t<=i?(e<=a&&(confirmObj.dialog("option","width",e-6),confirmObj.parent().css("left","0px"),confirmObj.parent().css("top",t/2-i/2+"px")),t<=i&&(confirmObj.dialog("option","height",t),confirmObj.parent().css("left",e/2-a/2+"px"),confirmObj.parent().css("top","0px"))):(confirmObj.parent().css("left",e/2-a/2+"px"),confirmObj.parent().css("top",t/2-i/2+"px"))}if(null!=promptObj){a=300,i=promptObj.parent().outerHeight();e<=a||t<=i?(e<=a&&(promptObj.dialog("option","width",e-6),promptObj.parent().css("left","0px"),promptObj.parent().css("top",t/2-i/2+"px")),t<=i&&(promptObj.dialog("option","height",t),promptObj.parent().css("left",e/2-a/2+"px"),promptObj.parent().css("top","0px"))):(promptObj.parent().css("left",e/2-a/2+"px"),promptObj.parent().css("top",t/2-i/2+"px"))}HidePopup()}function AddSomeoneWindow(e){ShowContacts(),$("#myContacts").hide(),$("#searchArea").hide(),$("#actionArea").empty();var t='<div style="text-align:right"><button class=roundButtons onclick="ShowContacts()"><i class="fa fa-close"></i></button></div>';t+="<div border=0 class=UiSideField>",t+="<div class=UiText>"+lang.full_name+":</div>",t+="<div><input id=AddSomeone_Name class=UiInputText type=text placeholder='"+lang.eg_full_name+"'></div>",t+="<div><input type=checkbox id=AddSomeone_Dnd><label for=AddSomeone_Dnd>"+lang.allow_calls_on_dnd+"</label></div>",t+='<ul style="list-style-type:none">',t+="<li><input type=radio name=buddyType id=type_exten checked><label for=type_exten>"+lang.basic_extension+"</label>","XMPP"==ChatEngine&&(t+="<li><input type=radio name=buddyType id=type_xmpp><label for=type_xmpp>"+lang.extension_including_xmpp+"</label>"),t+="<li><input type=radio name=buddyType id=type_contact><label for=type_contact>"+lang.addressbook_contact+"</label>",t+="</ul>",t+="<div id=RowDescription>",t+="<div class=UiText>"+lang.title_description+":</div>",t+="<div><input id=AddSomeone_Desc class=UiInputText type=text placeholder='"+lang.eg_general_manager+"'></div>",t+="</div>",t+="<div id=RowExtension>",t+="<div class=UiText>"+lang.extension_number+":</div>",t+="<div><input id=AddSomeone_Exten class=UiInputText type=text placeholder='"+lang.eg_internal_subscribe_extension+"'></div>",t+="<div><input type=checkbox id=AddSomeone_Subscribe><label for=AddSomeone_Subscribe>"+lang.subscribe_to_dev_state+"</label></div>",t+='<div id=RowSubscribe style="display:none; margin-left:30px;">',t+="<div class=UiText>"+lang.internal_subscribe_extension+":</div>",t+="<div><input id=AddSomeone_SubscribeUser class=UiInputText type=text placeholder='"+lang.eg_internal_subscribe_extension+"'></div>",t+="</div>",t+="</div>",t+="<div id=RowMobileNumber>",t+="<div class=UiText>"+lang.mobile_number+":</div>",t+="<div><input id=AddSomeone_Mobile class=UiInputText type=tel placeholder='"+lang.eg_mobile_number+"'></div>",t+="</div>",t+="<div id=RowEmail>",t+="<div class=UiText>"+lang.email+":</div>",t+="<div><input id=AddSomeone_Email class=UiInputText type=email placeholder='"+lang.eg_email+"'></div>",t+="</div>",t+="<div id=RowContact1>",t+="<div class=UiText>"+lang.contact_number_1+":</div>",t+="<div><input id=AddSomeone_Num1 class=UiInputText type=text placeholder='"+lang.eg_contact_number_1+"'></div>",t+="</div>",t+="<div id=RowContact2>",t+="<div class=UiText>"+lang.contact_number_2+":</div>",t+="<div><input id=AddSomeone_Num2 class=UiInputText type=text placeholder='"+lang.eg_contact_number_2+"'></div>",t+="</div>",t+="<div id=Persistance>",t+="<div class=UiText>Auto Delete:</div>",t+="<div><input type=checkbox id=AddSomeone_AutoDelete><label for=AddSomeone_AutoDelete>"+lang.yes+"</label></div>",t+="</div>",t+="</div>",t+="<div class=UiWindowButtonBar id=ButtonBar></div>",$("#actionArea").html(t);var n=[];n.push({text:lang.add,action:function(){if(""!=$("#AddSomeone_Name").val()&&("extension"!=e&&"xmpp"!=e||""!=$("#AddSomeone_Exten").val())){var e="extension";$("#type_exten").is(":checked")?(e="extension",$("#AddSomeone_Subscribe").is(":checked")&&""==$("#AddSomeone_SubscribeUser").val()&&$("#AddSomeone_SubscribeUser").val($("#AddSomeone_Exten").val())):$("#type_xmpp").is(":checked")?(e="xmpp",$("#AddSomeone_Subscribe").is(":checked")&&""==$("#AddSomeone_SubscribeUser").val()&&$("#AddSomeone_SubscribeUser").val($("#AddSomeone_Exten").val())):$("#type_contact").is(":checked")&&(e="contact");var t=JSON.parse(localDB.getItem(profileUserID+"-Buddies"));null==t&&(t=InitUserBuddies());var n=null;if("extension"==e){var i=uID(),a=utcDateNow();t.DataCollection.push({Type:"extension",LastActivity:a,ExtensionNumber:$("#AddSomeone_Exten").val(),MobileNumber:$("#AddSomeone_Mobile").val(),ContactNumber1:$("#AddSomeone_Num1").val(),ContactNumber2:$("#AddSomeone_Num2").val(),uID:i,cID:null,gID:null,jid:null,DisplayName:$("#AddSomeone_Name").val(),Description:$("#AddSomeone_Desc").val(),Email:$("#AddSomeone_Email").val(),MemberCount:0,EnableDuringDnd:$("#AddSomeone_Dnd").is(":checked"),Subscribe:$("#AddSomeone_Subscribe").is(":checked"),SubscribeUser:$("#AddSomeone_SubscribeUser").val(),AutoDelete:$("#AddSomeone_AutoDelete").is(":checked")}),n=new Buddy("extension",i,$("#AddSomeone_Name").val(),$("#AddSomeone_Exten").val(),$("#AddSomeone_Mobile").val(),$("#AddSomeone_Num1").val(),$("#AddSomeone_Num2").val(),a,$("#AddSomeone_Desc").val(),$("#AddSomeone_Email").val(),o,$("#AddSomeone_Dnd").is(":checked"),$("#AddSomeone_Subscribe").is(":checked"),$("#AddSomeone_SubscribeUser").val(),$("#AddSomeone_AutoDelete").is(":checked")),AddBuddy(n,!1,!1,$("#AddSomeone_Subscribe").is(":checked"),!0)}if("xmpp"==e){i=uID(),a=utcDateNow();var o=$("#AddSomeone_Exten").val()+"@"+SipDomain;""!=XmppRealm&&""!=XmppRealmSeparator&&(o=XmppRealm+""+XmppRealmSeparator+o),t.DataCollection.push({Type:"xmpp",LastActivity:a,ExtensionNumber:$("#AddSomeone_Exten").val(),MobileNumber:null,ContactNumber1:null,ContactNumber2:null,uID:i,cID:null,gID:null,jid:o,DisplayName:$("#AddSomeone_Name").val(),Description:null,Email:null,MemberCount:0,EnableDuringDnd:$("#AddSomeone_Dnd").is(":checked"),Subscribe:$("#AddSomeone_Subscribe").is(":checked"),SubscribeUser:$("#AddSomeone_SubscribeUser").val(),AutoDelete:$("#AddSomeone_AutoDelete").is(":checked")}),n=new Buddy("xmpp",i,$("#AddSomeone_Name").val(),$("#AddSomeone_Exten").val(),"","","",a,"","",o,$("#AddSomeone_Dnd").is(":checked"),$("#AddSomeone_Subscribe").is(":checked"),$("#AddSomeone_SubscribeUser").val(),$("#AddSomeone_AutoDelete").is(":checked")),XmppAddBuddyToRoster(n),AddBuddy(n,!1,!1,$("#AddSomeone_Subscribe").is(":checked"),!0)}if("contact"==e){i=uID(),a=utcDateNow();t.DataCollection.push({Type:"contact",LastActivity:a,ExtensionNumber:"",MobileNumber:$("#AddSomeone_Mobile").val(),ContactNumber1:$("#AddSomeone_Num1").val(),ContactNumber2:$("#AddSomeone_Num2").val(),uID:null,cID:i,gID:null,jid:null,DisplayName:$("#AddSomeone_Name").val(),Description:$("#AddSomeone_Desc").val(),Email:$("#AddSomeone_Email").val(),MemberCount:0,EnableDuringDnd:$("#AddSomeone_Dnd").is(":checked"),Subscribe:!1,SubscribeUser:null,AutoDelete:$("#AddSomeone_AutoDelete").is(":checked")}),n=new Buddy("contact",i,$("#AddSomeone_Name").val(),"",$("#AddSomeone_Mobile").val(),$("#AddSomeone_Num1").val(),$("#AddSomeone_Num2").val(),a,$("#AddSomeone_Desc").val(),$("#AddSomeone_Email").val(),o,$("#AddSomeone_Dnd").is(":checked"),!1,null,$("#AddSomeone_AutoDelete").is(":checked")),AddBuddy(n,!1,!1,!1,!0)}t.TotalRows=t.DataCollection.length,localDB.setItem(profileUserID+"-Buddies",JSON.stringify(t)),UpdateBuddyList(),ShowContacts()}}}),n.push({text:lang.cancel,action:function(){ShowContacts()}}),$.each(n,function(e,t){var n=$("<button>"+t.text+"</button>").click(t.action);$("#ButtonBar").append(n)}),$("#actionArea").show(),$("#AddSomeone_Name").focus(),window.setTimeout(function(){$("#type_exten").change(function(){$("#type_exten").is(":checked")&&($("#RowDescription").show(),$("#RowExtension").show(),$("#RowMobileNumber").show(),$("#RowEmail").show(),$("#RowContact1").show(),$("#RowContact2").show())}),$("#type_xmpp").change(function(){$("#type_xmpp").is(":checked")&&($("#RowDescription").hide(),$("#RowExtension").show(),$("#RowMobileNumber").hide(),$("#RowEmail").hide(),$("#RowContact1").hide(),$("#RowContact2").hide())}),$("#type_contact").change(function(){$("#type_contact").is(":checked")&&($("#RowDescription").show(),$("#RowExtension").hide(),$("#RowMobileNumber").show(),$("#RowEmail").show(),$("#RowContact1").show(),$("#RowContact2").show())}),$("#AddSomeone_Subscribe").change(function(){$("#AddSomeone_Subscribe").is(":checked")?(""!=$("#AddSomeone_Exten").val()&&""==$("#AddSomeone_SubscribeUser").val()&&$("#AddSomeone_SubscribeUser").val($("#AddSomeone_Exten").val()),$("#RowSubscribe").show()):$("#RowSubscribe").hide()})},0)}function CreateGroupWindow(){}function checkNotificationPromise(){try{Notification.requestPermission().then()}catch(e){return!1}return!0}function HandleNotifyPermission(e){"granted"==e||Alert(lang.alert_notification_permission,lang.permission,function(){console.log("Attempting to uncheck the checkbox..."),$("#Settings_Notifications").prop("checked",!1)})}function EditBuddyWindow(e){var t=FindBuddyByIdentity(e);if(null!=t){var n={},i=-1,a=JSON.parse(localDB.getItem(profileUserID+"-Buddies"));if($.each(a.DataCollection,function(t,a){if(a.uID==e||a.cID==e||a.gID==e)return n=a,i=t,!1}),n!={})if(1!=UiCustomEditBuddy){var o="<div border=0 class='UiWindowField'>";o+='<div id=ImageCanvas style="width:150px; height:150px"></div>',o+='<div style="float:left; margin-left:200px;"><input id=fileUploader type=file></div>',o+='<div style="margin-top: 50px"></div>',o+="<div class=UiText>"+lang.full_name+":</div>",o+="<div><input id=AddSomeone_Name class=UiInputText type=text placeholder='"+lang.eg_full_name+"' value='"+(n.DisplayName&&"null"!=n.DisplayName&&"undefined"!=n.DisplayName?n.DisplayName:"")+"'></div>",o+="<div><input type=checkbox id=AddSomeone_Dnd "+(1==n.EnableDuringDnd?"checked":"")+"><label for=AddSomeone_Dnd>Allow calls while on Do Not Disturb</label></div>",o+="<div class=UiText>"+lang.title_description+":</div>",o+="<div><input id=AddSomeone_Desc class=UiInputText type=text placeholder='"+lang.eg_general_manager+"' value='"+(n.Description&&"null"!=n.Description&&"undefined"!=n.Description?n.Description:"")+"'></div>","extension"==n.Type||"xmpp"==n.Type?(o+="<div class=UiText>"+lang.extension_number+": </div>",o+="<div><input id=AddSomeone_Exten class=UiInputText type=text value="+n.ExtensionNumber+"></div>",o+="<div><input type=checkbox id=AddSomeone_Subscribe "+(1==n.Subscribe?"checked":"")+"><label for=AddSomeone_Subscribe>Subscribe to Device State Notifications</label></div>",o+='<div id=RowSubscribe style="display:'+(1==n.Subscribe?"unset":"none")+';">',o+='<div class=UiText style="margin-left:30px">'+lang.internal_subscribe_extension+":</div>",o+='<div style="margin-left:30px"><input id=AddSomeone_SubscribeUser class=UiInputText type=text placeholder=\''+lang.eg_internal_subscribe_extension+"' value='"+(n.SubscribeUser&&"null"!=n.SubscribeUser&&"undefined"!=n.SubscribeUser?n.SubscribeUser:"")+"'></div>",o+="</div>"):o+='<input type=checkbox id=AddSomeone_Subscribe style="display:none">',o+="<div class=UiText>"+lang.mobile_number+":</div>",o+="<div><input id=AddSomeone_Mobile class=UiInputText type=text placeholder='"+lang.eg_mobile_number+"' value='"+(n.MobileNumber&&"null"!=n.MobileNumber&&"undefined"!=n.MobileNumber?n.MobileNumber:"")+"'></div>",o+="<div class=UiText>"+lang.email+":</div>",o+="<div><input id=AddSomeone_Email class=UiInputText type=text placeholder='"+lang.eg_email+"' value='"+(n.Email&&"null"!=n.Email&&"undefined"!=n.Email?n.Email:"")+"'></div>",o+="<div class=UiText>"+lang.contact_number_1+":</div>",o+="<div><input id=AddSomeone_Num1 class=UiInputText type=text placeholder='"+lang.eg_contact_number_1+"' value='"+(n.ContactNumber1&&"null"!=n.ContactNumber1&&"undefined"!=n.ContactNumber1?n.ContactNumber1:"")+"'></div>",o+="<div class=UiText>"+lang.contact_number_2+":</div>",o+="<div><input id=AddSomeone_Num2 class=UiInputText type=text placeholder='"+lang.eg_contact_number_2+"' value='"+(n.ContactNumber2&&"null"!=n.ContactNumber2&&"undefined"!=n.ContactNumber2?n.ContactNumber2:"")+"'></div>",o+="<div class=UiText>Auto Delete:</div>",o+="<div><input type=checkbox id=AddSomeone_AutoDelete "+(1==n.AutoDelete?"checked":"")+"><label for=AddSomeone_AutoDelete>"+lang.yes+"</label></div>",o+="<div class=UiText><button onclick=\"RemoveBuddy('"+t.identity+'\')" class="UiDeleteButton"><i class="fa fa-trash"></i> '+lang.delete_buddy+"</button></div>",o+="</div>",OpenWindow(o,lang.edit,480,640,!1,!0,lang.save,function(){if(""!=$("#AddSomeone_Name").val()){if($("#AddSomeone_Subscribe").is(":checked")&&""!=$("#AddSomeone_Exten").val()&&""==$("#AddSomeone_SubscribeUser").val()&&$("#AddSomeone_SubscribeUser").val($("#AddSomeone_Exten").val()),n.LastActivity=utcDateNow(),t.lastActivity=n.LastActivity,n.DisplayName=$("#AddSomeone_Name").val(),t.CallerIDName=n.DisplayName,n.Description=$("#AddSomeone_Desc").val(),t.Desc=n.Description,n.MobileNumber=$("#AddSomeone_Mobile").val(),t.MobileNumber=n.MobileNumber,n.Email=$("#AddSomeone_Email").val(),t.Email=n.Email,n.ContactNumber1=$("#AddSomeone_Num1").val(),t.ContactNumber1=n.ContactNumber1,n.ContactNumber2=$("#AddSomeone_Num2").val(),t.ContactNumber2=n.ContactNumber2,n.EnableDuringDnd=$("#AddSomeone_Dnd").is(":checked"),t.EnableDuringDnd=n.EnableDuringDnd,n.AutoDelete=$("#AddSomeone_AutoDelete").is(":checked"),t.AllowAutoDelete=n.AutoDelete,("extension"==n.Type||"xmpp"==n.Type)&&(UnsubscribeBuddy(t),n.ExtensionNumber=$("#AddSomeone_Exten").val(),t.ExtNo=n.ExtensionNumber,n.Subscribe=$("#AddSomeone_Subscribe").is(":checked"),t.EnableSubscribe=n.Subscribe,1==n.Subscribe)){var e=$("#AddSomeone_SubscribeUser").val();n.SubscribeUser=e,t.SubscribeUser=e,SubscribeBuddy(t)}UpdateBuddyList();var o={type:"base64",size:"viewport",format:"png",quality:1,circle:!1};$("#ImageCanvas").croppie("result",o).then(function(e){"extension"==n.Type?(console.log("Saving image for extension buddy:",n.uID),localDB.setItem("img-"+n.uID+"-extension",e),$("#contact-"+n.uID+"-picture").css("background-image","url("+getPicture(n.uID,"extension",!0)+")"),$("#contact-"+n.uID+"-picture-main").css("background-image","url("+getPicture(n.uID,"extension",!0)+")")):"contact"==n.Type?(console.log("Saving image for contact buddy:",n.cID),localDB.setItem("img-"+n.cID+"-contact",e),$("#contact-"+n.cID+"-picture").css("background-image","url("+getPicture(n.cID,"contact",!0)+")"),$("#contact-"+n.cID+"-picture-main").css("background-image","url("+getPicture(n.cID,"contact",!0)+")")):"group"==n.Type&&(console.log("Saving image for group buddy:",n.gID),localDB.setItem("img-"+n.gID+"-group",e),$("#contact-"+n.gID+"-picture").css("background-image","url("+getPicture(n.gID,"group",!0)+")"),$("#contact-"+n.gID+"-picture-main").css("background-image","url("+getPicture(n.gID,"group",!0)+")")),UpdateBuddyList()}),a.DataCollection[i]=n,localDB.setItem(profileUserID+"-Buddies",JSON.stringify(a)),CloseWindow()}},lang.cancel,function(){CloseWindow()},function(){$("#ImageCanvas").croppie({viewport:{width:150,height:150,type:"circle"}}),"extension"==n.Type&&$("#ImageCanvas").croppie("bind",{url:getPicture(n.uID,"extension")}).then(),"xmpp"==n.Type?($("#ImageCanvas").croppie("bind",{url:getPicture(n.uID,"xmpp")}).then(),$("#fileUploader").hide(),$("#AddSomeone_Name").attr("disabled",!0),$("#AddSomeone_Desc").attr("disabled",!0),$("#AddSomeone_Mobile").attr("disabled",!0),$("#AddSomeone_Email").attr("disabled",!0),$("#AddSomeone_Num1").attr("disabled",!0),$("#AddSomeone_Num2").attr("disabled",!0)):"contact"==n.Type?$("#ImageCanvas").croppie("bind",{url:getPicture(n.cID,"contact")}).then():"group"==n.Type&&$("#ImageCanvas").croppie("bind",{url:getPicture(n.gID,"group")}).then(),$("#AddSomeone_Subscribe").change(function(){$("#AddSomeone_Subscribe").is(":checked")?(""!=$("#AddSomeone_Exten").val()&&""==$("#AddSomeone_SubscribeUser").val()&&$("#AddSomeone_SubscribeUser").val($("#AddSomeone_Exten").val()),$("#RowSubscribe").show()):$("#RowSubscribe").hide()}),$("#fileUploader").change(function(){var e=$(this).prop("files");if(1==e.length){var t=Math.floor(1e9*Math.random()),n=e[0],i=n.name,a=n.size;if(a<=52428800){console.log("Adding ("+t+"): "+i+" of size: "+a+"bytes");var o=new FileReader;o.Name=i,o.UploadId=t,o.Size=a,o.onload=function(e){$("#ImageCanvas").croppie("bind",{url:e.target.result})},o.readAsDataURL(n)}else Alert(lang.alert_file_size,lang.error)}else Alert(lang.alert_single_file,lang.error)})})}else"undefined"!=typeof web_hook_on_edit_buddy&&web_hook_on_edit_buddy(n);else Alert(lang.alert_not_found,lang.error)}else Alert(lang.alert_not_found,lang.error)}function SetStatusWindow(){HidePopup();var e="<div class=UiWindowField>";e+="<div><input type=text id=presence_text class=UiInputText maxlength=128></div>",e+="</div>",OpenWindow(e,lang.set_status,180,350,!1,!1,"OK",function(){var e="chat",t=$("#presence_text").val();localDB.setItem("XmppLastPresence",e),localDB.setItem("XmppLastStatus",t),XmppSetMyPresence(e,t),CloseWindow()},"Cancel",function(){CloseWindow()},function(){$("#presence_text").val(getDbItem("XmppLastStatus",""))})}function InitUi(){"undefined"!=typeof web_hook_on_before_init&&web_hook_on_before_init(),ApplyThemeColor();var e=$("#Phone");e.empty(),e.attr("class","pageContainer"),e.css("max-width",UiMaxWidth+"px");var t=$("<div/>");t.attr("id","leftContent"),t.attr("style","float:left; height: 100%; width:320px");var n='<table id=leftContentTable class=leftContentTable style="height:100%; width:100%" cellspacing=0 cellpadding=0>';n+='<tr><td class=streamSection style="height: 50px; box-sizing: border-box;">',n+="<div class=profileContainer>",n+='<div class=contact id=UserProfile style="cursor: default; margin-bottom:5px;">',n+="<span id=TxtVoiceMessages class=voiceMessageNotifyer>0</span>",n+="<div id=UserProfilePic class=buddyIcon></div>",n+="<span class=settingsMenu>",n+='<button class=roundButtons id=BtnFreeDial><i class="fa fa-phone"></i></button>',n+='<button class=roundButtons id=BtnAddSomeone><i class="fa fa-user-plus"></i></button>',n+='<button class=roundButtons id=SettingsMenu><i class="fa fa-cogs"></i></button>',n+="</span>",n+='<div class=contactNameText style="margin-right: 0px;">',n+='<span id=dereglink class=dotOnline style="display:none"></span>',n+='<span id=WebRtcFailed class=dotFailed style="display:none"></span>',n+="<span id=reglink class=dotOffline></span>",n+=" <span id=UserCallID></span>",n+="</div>",n+="<div class=presenceText><span id=regStatus>&nbsp;</span> <span id=dndStatus></span></div>",n+="</div>",n+="</div>",n+="</td></tr>",n+='<tr id=searchArea><td class=streamSection style="height: 35px; box-sizing: border-box; padding-top: 3px; padding-bottom: 0px;">',n+='<span id=divFindBuddy class=searchClean><INPUT id=txtFindBuddy type=text autocomplete=none style="width: calc(100% - 78px);"></span>',n+='<button class=roundButtons id=BtnFilter style="margin-left:5px"><i class="fa fa-sliders"></i></button>',n+="</td></tr>",n+="<tr><td class=streamSection>",n+='<div id=myContacts class="contactArea cleanScroller"></div>',n+='<div id=actionArea style="display:none" class="contactArea cleanScroller"></div>',n+="</td></tr>",n+="</table>",t.html(n);var i=$("<div/>");i.attr("id","rightContent"),i.attr("class","rightContent"),i.attr("style","margin-left: 320px; height: 100%"),e.append(t),e.append(i),1==DisableFreeDial&&$("#BtnFreeDial").hide(),1==DisableBuddies&&($("#BtnAddSomeone").hide(),$("#BtnFreeDial").show()),$("#BtnCreateGroup").hide(),$("#UserCallID").html(profileName),$("#UserProfilePic").css("background-image","url('"+getPicture("profilePicture")+"')"),$("#BtnFilter").attr("title",lang.filter_and_sort),$("#BtnFilter").on("click",function(e){1==UiCustomSortAndFilterButton?"undefined"!=typeof web_hook_sort_and_filter&&web_hook_sort_and_filter(e):ShowSortAnfFilter()}),$("#txtFindBuddy").attr("placeholder",lang.find_someone),$("#txtFindBuddy").on("keyup",function(e){UpdateBuddyList(),$("#txtFindBuddy").focus()}),$("#BtnFreeDial").attr("title",lang.call),$("#BtnFreeDial").on("click",function(e){1==UiCustomDialButton?"undefined"!=typeof web_hook_dial_out&&web_hook_dial_out(e):ShowDial()}),$("#BtnAddSomeone").attr("title",lang.add_someone),$("#BtnAddSomeone").on("click",function(e){1==UiCustomAddBuddy?"undefined"!=typeof web_hook_on_add_buddy&&web_hook_on_add_buddy(e):AddSomeoneWindow()}),$("#TxtVoiceMessages").on("click",function(e){""!=VoicemailDid&&DialByLine("audio",null,VoicemailDid,"VoiceMail")}),$("#BtnCreateGroup").attr("title",lang.create_group),$("#BtnCreateGroup").on("click",function(e){CreateGroupWindow()}),$("#SettingsMenu").attr("title",lang.configure_extension),$("#SettingsMenu").on("click",function(e){1==UiCustomConfigMenu?"undefined"!=typeof web_hook_on_config_menu&&web_hook_on_config_menu(e):ShowMyProfileMenu(this)}),$("#reglink").on("click",Register),$("#dereglink").on("click",Unregister),$("#WebRtcFailed").on("click",function(){Confirm(lang.error_connecting_web_socket,lang.web_socket_error,function(){window.open("https://"+wssServer+":"+WebSocketPort+"/httpstatus")},null)}),$(".loading").remove(),UpdateUI(),welcomeScreen&&"yes"!=localDB.getItem("WelcomeScreenAccept")?OpenWindow(welcomeScreen,lang.welcome,480,600,!0,!1,lang.accept,function(){localDB.setItem("WelcomeScreenAccept","yes"),CloseWindow(),ShowMyProfile()},null,null,null,null):null!=profileUserID?(PopulateBuddyList(),null!=localDB.getItem("SelectedBuddy")&&(console.log("Selecting previously selected buddy...",localDB.getItem("SelectedBuddy")),SelectBuddy(localDB.getItem("SelectedBuddy")),UpdateUI()),PreloadAudioFiles(),"undefined"!=typeof web_hook_on_init&&web_hook_on_init(),CreateUserAgent()):ShowMyProfile()}function ShowMyProfileMenu(e){var t=' <i class="fa fa-check" style="float: right; line-height: 18px;"></i>',n=[];n.push({icon:"fa fa-refresh",text:lang.refresh_registration,value:1}),n.push({icon:"fa fa-wrench",text:lang.configure_extension,value:2}),n.push({icon:null,text:"-"}),n.push({icon:"fa fa-user-plus",text:lang.add_someone,value:3}),n.push({icon:null,text:"-"}),1==AutoAnswerEnabled?n.push({icon:"fa fa-phone",text:lang.auto_answer+t,value:5}):n.push({icon:"fa fa-phone",text:lang.auto_answer,value:5}),1==DoNotDisturbEnabled?n.push({icon:"fa fa-ban",text:lang.do_no_disturb+t,value:6}):n.push({icon:"fa fa-ban",text:lang.do_no_disturb,value:6}),1==CallWaitingEnabled?n.push({icon:"fa fa-volume-control-phone",text:lang.call_waiting+t,value:7}):n.push({icon:"fa fa-volume-control-phone",text:lang.call_waiting,value:7}),1==RecordAllCalls?n.push({icon:"fa fa-dot-circle-o",text:lang.record_all_calls+t,value:8}):n.push({icon:"fa fa-dot-circle-o",text:lang.record_all_calls,value:8}),"XMPP"==ChatEngine&&(n.push({icon:null,text:"-"}),n.push({icon:"fa fa-comments",text:lang.set_status,value:9}));var i={selectEvent:function(e,t){var n=t.item.attr("value");HidePopup(),"1"==n&&RefreshRegistration(),"2"==n&&ShowMyProfile(),"3"==n&&AddSomeoneWindow(),"4"==n&&CreateGroupWindow(),"5"==n&&ToggleAutoAnswer(),"6"==n&&ToggleDoNoDisturb(),"7"==n&&ToggleCallWaiting(),"8"==n&&ToggleRecordAllCalls(),"9"==n&&SetStatusWindow()},createEvent:null,autoFocus:!0,items:n};PopupMenu(e,i)}function ApplyThemeColor(){var e=hostingPrefix+"phone.light.css",t=hostingPrefix+""+wallpaperLight;"system"==UiThemeStyle?window.matchMedia?window.matchMedia("(prefers-color-scheme: dark)").matches?(e=hostingPrefix+"phone.dark.css",t=hostingPrefix+""+wallpaperDark):(e=hostingPrefix+"phone.light.css",t=hostingPrefix+""+wallpaperLight):e=hostingPrefix+"phone.dark.css":"light"==UiThemeStyle?(e=hostingPrefix+"phone.light.css",t=hostingPrefix+""+wallpaperLight):"dark"==UiThemeStyle?(e=hostingPrefix+"phone.dark.css",t=hostingPrefix+""+wallpaperDark):(e=hostingPrefix+"phone.light.css",t=hostingPrefix+""+wallpaperLight),$("#colorSchemeMode").length||$("head").append('<link rel="stylesheet" id="colorSchemeMode" />'),$("#colorSchemeMode").attr("href",e),$("#colorSchemeModeSheet").length?$("#colorSchemeModeSheet").empty():$("head").append("<style id='colorSchemeModeSheet'></style>");var n=".wallpaperBackground { background-image:url('"+t+"') }";$("#colorSchemeModeSheet").text(n)}function PreloadAudioFiles(){audioBlobs.Alert={file:"Alert.mp3",url:hostingPrefix+"media/Alert.mp3"},audioBlobs.Ringtone={file:"Ringtone_1.mp3",url:hostingPrefix+"media/Ringtone_1.mp3"},audioBlobs.speech_orig={file:"speech_orig.mp3",url:hostingPrefix+"media/speech_orig.mp3"},audioBlobs.Busy_UK={file:"Tone_Busy-UK.mp3",url:hostingPrefix+"media/Tone_Busy-UK.mp3"},audioBlobs.Busy_US={file:"Tone_Busy-US.mp3",url:hostingPrefix+"media/Tone_Busy-US.mp3"},audioBlobs.CallWaiting={file:"Tone_CallWaiting.mp3",url:hostingPrefix+"media/Tone_CallWaiting.mp3"},audioBlobs.Congestion_UK={file:"Tone_Congestion-UK.mp3",url:hostingPrefix+"media/Tone_Congestion-UK.mp3"},audioBlobs.Congestion_US={file:"Tone_Congestion-US.mp3",url:hostingPrefix+"media/Tone_Congestion-US.mp3"},audioBlobs.EarlyMedia_Australia={file:"Tone_EarlyMedia-Australia.mp3",url:hostingPrefix+"media/Tone_EarlyMedia-Australia.mp3"},audioBlobs.EarlyMedia_European={file:"Tone_EarlyMedia-European.mp3",url:hostingPrefix+"media/Tone_EarlyMedia-European.mp3"},audioBlobs.EarlyMedia_Japan={file:"Tone_EarlyMedia-Japan.mp3",url:hostingPrefix+"media/Tone_EarlyMedia-Japan.mp3"},audioBlobs.EarlyMedia_UK={file:"Tone_EarlyMedia-UK.mp3",url:hostingPrefix+"media/Tone_EarlyMedia-UK.mp3"},audioBlobs.EarlyMedia_US={file:"Tone_EarlyMedia-US.mp3",url:hostingPrefix+"media/Tone_EarlyMedia-US.mp3"},$.each(audioBlobs,function(e,t){var n=new XMLHttpRequest;n.open("GET",t.url,!0),n.responseType="blob",n.onload=function(e){var i=new FileReader;i.readAsDataURL(n.response),i.onload=function(){t.blob=i.result}},n.send()})}function CreateUserAgent(){console.log("Creating User Agent..."),null!=SipDomain&&""!=SipDomain&&"null"!=SipDomain&&"undefined"!=SipDomain||(SipDomain=wssServer);var e={uri:SIP.UserAgent.makeURI("sip:"+SipUsername+"@"+SipDomain),transportOptions:{server:"wss://"+wssServer+":"+WebSocketPort+ServerPath,traceSip:!1,connectionTimeout:TransportConnectionTimeout},sessionDescriptionHandlerFactoryOptions:{peerConnectionConfiguration:{bundlePolicy:BundlePolicy},iceGatheringTimeout:IceStunCheckTimeout},contactName:ContactUserName,displayName:profileName,authorizationUsername:SipUsername,authorizationPassword:SipPassword,hackIpInContact:IpInContact,userAgentString:userAgentStr,autoStart:!1,autoStop:!0,register:!1,noAnswerTimeout:NoAnswerTimeout,contactParams:{},delegate:{onInvite:function(e){ReceiveCall(e)},onMessage:function(e){
ReceiveOutOfDialogMessage(e)}}};if(""!=IceStunServerJson&&(e.sessionDescriptionHandlerFactoryOptions.peerConnectionConfiguration.iceServers=JSON.parse(IceStunServerJson)),RegisterContactParams&&""!=RegisterContactParams&&"{}"!=RegisterContactParams)try{e.contactParams=JSON.parse(RegisterContactParams)}catch(e){}if(WssInTransport)try{e.contactParams.transport="wss"}catch(e){}userAgent=new SIP.UserAgent(e),userAgent.isRegistered=function(){return userAgent&&userAgent.registerer&&userAgent.registerer.state==SIP.RegistererState.Registered},userAgent.sessions=userAgent._sessions,userAgent.registrationCompleted=!1,userAgent.registering=!1,userAgent.transport.ReconnectionAttempts=TransportReconnectionAttempts,userAgent.transport.attemptingReconnection=!1,userAgent.BlfSubs=[],userAgent.lastVoicemailCount=0,console.log("Creating User Agent... Done"),userAgent.transport.onConnect=function(){onTransportConnected()},userAgent.transport.onDisconnect=function(e){e?onTransportConnectError(e):onTransportDisconnected()};var t={expires:RegisterExpires,extraHeaders:[],extraContactHeaderParams:[]};if(RegisterExtraHeaders&&""!=RegisterExtraHeaders&&"{}"!=RegisterExtraHeaders)try{var n=JSON.parse(RegisterExtraHeaders);for(const[e,i]of Object.entries(n))""!=i&&t.extraHeaders.push(e+": "+i)}catch(e){}if(RegisterExtraContactParams&&""!=RegisterExtraContactParams&&"{}"!=RegisterExtraContactParams)try{var i=JSON.parse(RegisterExtraContactParams);for(const[e,n]of Object.entries(i))""==n?t.extraContactHeaderParams.push(e):t.extraContactHeaderParams.push(e+":"+n)}catch(e){}userAgent.registerer=new SIP.Registerer(userAgent,t),console.log("Creating Registerer... Done"),userAgent.registerer.stateChange.addListener(function(e){switch(console.log("User Agent Registration State:",e),e){case SIP.RegistererState.Initial:break;case SIP.RegistererState.Registered:onRegistered();break;case SIP.RegistererState.Unregistered:onUnregistered();break;case SIP.RegistererState.Terminated:}}),console.log("User Agent Connecting to WebSocket..."),$("#regStatus").html(lang.connecting_to_web_socket),userAgent.start().catch(function(e){onTransportConnectError(e)})}function onTransportConnected(){console.log("Connected to Web Socket!"),$("#regStatus").html(lang.connected_to_web_socket),$("#WebRtcFailed").hide(),userAgent.isReRegister=!1,userAgent.transport.attemptingReconnection=!1,userAgent.transport.ReconnectionAttempts=TransportReconnectionAttempts,0==userAgent.transport.attemptingReconnection&&0==userAgent.registering?window.setTimeout(function(){Register()},500):console.warn("onTransportConnected: Register() called, but attemptingReconnection is true or registering is true")}function onTransportConnectError(e){console.warn("WebSocket Connection Failed:",e),userAgent.isReRegister=!1,console.log("Unregister...");try{userAgent.registerer.unregister()}catch(e){}$("#regStatus").html(lang.web_socket_error),$("#WebRtcFailed").show(),ReconnectTransport(),"undefined"!=typeof web_hook_on_transportError&&web_hook_on_transportError(userAgent.transport,userAgent)}function onTransportDisconnected(){console.log("Disconnected from Web Socket!"),$("#regStatus").html(lang.disconnected_from_web_socket),userAgent.isReRegister=!1}function ReconnectTransport(){null!=userAgent&&(userAgent.registering=!1,userAgent.transport&&userAgent.transport.isConnected()?onTransportConnected():(console.log("Reconnect Transport..."),window.setTimeout(function(){$("#regStatus").html(lang.connecting_to_web_socket),console.log("ReConnecting to WebSocket..."),userAgent.transport&&userAgent.transport.isConnected()?onTransportConnected():(userAgent.transport.attemptingReconnection=!0,userAgent.reconnect().catch(function(e){userAgent.transport.attemptingReconnection=!1,console.warn("Failed to reconnect",e),ReconnectTransport()}))},1e3*TransportReconnectionTimeout),$("#regStatus").html(lang.connecting_to_web_socket),console.log("Waiting to Re-connect...",TransportReconnectionTimeout,"Attempt remaining",userAgent.transport.ReconnectionAttempts),userAgent.transport.ReconnectionAttempts=userAgent.transport.ReconnectionAttempts-1))}function Register(){if(null!=userAgent&&1!=userAgent.registering&&!userAgent.isRegistered()){var e={requestDelegate:{onReject:function(e){onRegisterFailed(e.message.reasonPhrase,e.message.statusCode)}}};console.log("Sending Registration..."),$("#regStatus").html(lang.sending_registration),userAgent.registering=!0,userAgent.registerer.register(e)}}function Unregister(e){if(null!=userAgent&&userAgent.isRegistered()){if(1==e)console.log("Skipping Unsubscribe");else{console.log("Unsubscribing..."),$("#regStatus").html(lang.unsubscribing);try{UnsubscribeAll()}catch(e){}}console.log("Unregister..."),$("#regStatus").html(lang.disconnecting),userAgent.registerer.unregister(),userAgent.transport.attemptingReconnection=!1,userAgent.registering=!1,userAgent.isReRegister=!1}}function onRegistered(){userAgent.registrationCompleted=!0,userAgent.isReRegister?(userAgent.registering=!1,console.log("ReRegistered!")):(console.log("Registered!"),$("#reglink").hide(),$("#dereglink").show(),(DoNotDisturbEnabled||"enabled"==DoNotDisturbPolicy)&&($("#dereglink").attr("class","dotDoNotDisturb"),$("#dndStatus").html("(DND)")),window.setTimeout(function(){SubscribeAll()},500),$("#regStatus").html(lang.registered),"XMPP"==ChatEngine&&reconnectXmpp(),userAgent.registering=!1,null!=alertObj&&(alertObj.dialog("close"),alertObj=null),"undefined"!=typeof web_hook_on_register&&web_hook_on_register(userAgent)),userAgent.isReRegister=!0}function onRegisterFailed(e,t){console.log("Registration Failed: "+e),$("#regStatus").html(lang.registration_failed),$("#reglink").show(),$("#dereglink").hide(),Alert(lang.registration_failed+":"+e,lang.registration_failed),userAgent.registering=!1,"undefined"!=typeof web_hook_on_registrationFailed&&web_hook_on_registrationFailed(e)}function onUnregistered(){userAgent.registrationCompleted&&(console.log("Unregistered, bye!"),$("#regStatus").html(lang.unregistered),$("#reglink").show(),$("#dereglink").hide(),"undefined"!=typeof web_hook_on_unregistered&&web_hook_on_unregistered()),userAgent.isReRegister=!1}function ReceiveCall(e){var t=e.remoteIdentity.displayName,n=e.remoteIdentity.uri.user;void 0===t&&(t=n),console.log("New Incoming Call!",t+" <"+n+">");var i=countSessions(e.id);console.log("Current Call Count:",i);var a=FindBuddyByDid(n);if(null==a){var o=n.length>DidLength?"contact":"extension",s=0==i;a=MakeBuddy(o,!0,s,!1,t,n,null,!1,null,AutoDeleteDefault)}else"extension"==a.type&&a.CallerIDName!=t?UpdateBuddyCallerID(a,t):"contact"==a.type&&t!=n&&a.CallerIDName!=t&&UpdateBuddyCallerID(a,t);var l=moment.utc();newLineNumber+=1;var r=new Line(newLineNumber,t,n,a);if(r.SipSession=e,r.SipSession.data={},r.SipSession.data.line=r.LineNumber,r.SipSession.data.calldirection="inbound",r.SipSession.data.terminateby="",r.SipSession.data.src=n,r.SipSession.data.buddyId=r.BuddyObj.identity,r.SipSession.data.callstart=l.format("YYYY-MM-DD HH:mm:ss UTC"),r.SipSession.data.callTimer=window.setInterval(function(){var e=moment.utc(),t=moment.duration(e.diff(l)),n=formatShortDuration(t.asSeconds());$("#line-"+r.LineNumber+"-timer").html(n),$("#line-"+r.LineNumber+"-datetime").html(n)},1e3),r.SipSession.data.earlyReject=!1,Lines.push(r),r.SipSession.data.withvideo=!1,1==EnableVideoCalling&&r.SipSession.request.body&&r.SipSession.request.body.indexOf("m=video")>-1&&(r.SipSession.data.withvideo=!0,a.type),r.SipSession.delegate={onBye:function(e){onSessionReceivedBye(r,e)},onMessage:function(e){onSessionReceivedMessage(r,e)},onInvite:function(e){onSessionReinvited(r,e)},onSessionDescriptionHandler:function(e,t){onSessionDescriptionHandlerCreated(r,e,t,r.SipSession.data.withvideo)}},r.SipSession.incomingInviteRequest.delegate={onCancel:function(e){onInviteCancel(r,e)}},1==DoNotDisturbEnabled||"enabled"==DoNotDisturbPolicy){if(1!=DoNotDisturbEnabled||1!=a.EnableDuringDnd)return console.log("Do Not Disturb Enabled, rejecting call."),r.SipSession.data.earlyReject=!0,void RejectCall(r.LineNumber,!0);console.log("Buddy is allowed to call while you are on DND")}if(i>=1&&(0==CallWaitingEnabled||"disabled"==CallWaitingEnabled))return console.log("Call Waiting Disabled, rejecting call."),r.SipSession.data.earlyReject=!0,void RejectCall(r.LineNumber,!0);AddLineHtml(r,"inbound"),$("#line-"+r.LineNumber+"-msg").html(lang.incoming_call),$("#line-"+r.LineNumber+"-msg").show(),$("#line-"+r.LineNumber+"-timer").show(),r.SipSession.data.withvideo?$("#line-"+r.LineNumber+"-answer-video").show():$("#line-"+r.LineNumber+"-answer-video").hide(),$("#line-"+r.LineNumber+"-AnswerCall").show(),UpdateBuddyList();var d=!1,c=1e3;if(!AutoAnswerEnabled&&"enabled"==IntercomPolicy){var u=e.request.headers["Call-Info"];if(void 0!==u&&u.length>0)for(var p=0;p<u.length;p++){var g=u[p].raw.toLowerCase();if(g.indexOf("answer-after=")>0){var m=parseInt(g.substring(g.indexOf("answer-after=")+"answer-after=".length).split(";")[0]);if(Number.isInteger(m)&&m>=0){d=!0,m>1&&(c=1e3*m);break}}}var f=e.request.headers["Alert-Info"];if(!1===d&&void 0!==f&&f.length>0)for(p=0;p<f.length;p++){var v=f[p].raw.toLowerCase();if(v.indexOf("auto answer")>0||v.indexOf("alert-autoanswer")>0){d=!0;break}if(v.indexOf("answer-after=")>0){m=parseInt(v.substring(v.indexOf("answer-after=")+"answer-after=".length).split(";")[0]);if(Number.isInteger(m)&&m>=0){d=!0,m>1&&(c=1e3*m);break}}}}if(AutoAnswerEnabled||"enabled"==AutoAnswerPolicy||d){if(0==i)return console.log("Going to Auto Answer this call..."),window.setTimeout(function(){r.SipSession.data.withvideo?AnswerVideoCall(r.LineNumber):AnswerAudioCall(r.LineNumber)},c),void SelectLine(r.LineNumber);console.warn("Could not auto answer call, already on a call.")}var b=$("#stream-"+a.identity).is(":visible");if((b||0==i)&&0==i&&SelectLine(r.LineNumber),"Notification"in window&&"granted"===Notification.permission){var h={body:lang.incoming_call_from+" "+t+" <"+n+">",icon:getPicture(a.identity)},S=new Notification(lang.incoming_call,h);S.onclick=function(e){var t=r.LineNumber,n=r.SipSession.data.withvideo;window.setTimeout(function(){n?AnswerVideoCall(t):AnswerAudioCall(t)},1e3),SelectLine(t)}}if(1==EnableRingtone)if(i>=1){console.log("Audio:",audioBlobs.CallWaiting.url);var y=new Audio(audioBlobs.CallWaiting.blob);y.preload="auto",y.loop=!1,y.oncanplaythrough=function(e){void 0!==y.sinkId&&"default"!=getRingerOutputID()&&y.setSinkId(getRingerOutputID()).then(function(){console.log("Set sinkId to:",getRingerOutputID())}).catch(function(e){console.warn("Failed not apply setSinkId.",e)}),y.play().then(function(){}).catch(function(e){console.warn("Unable to play audio file.",e)})},r.SipSession.data.ringerObj=y}else{console.log("Audio:",audioBlobs.Ringtone.url);y=new Audio(audioBlobs.Ringtone.blob);y.preload="auto",y.loop=!0,y.oncanplaythrough=function(e){void 0!==y.sinkId&&"default"!=getRingerOutputID()&&y.setSinkId(getRingerOutputID()).then(function(){console.log("Set sinkId to:",getRingerOutputID())}).catch(function(e){console.warn("Failed not apply setSinkId.",e)}),y.play().then(function(){}).catch(function(e){console.warn("Unable to play audio file.",e)})},r.SipSession.data.ringerObj=y}"undefined"!=typeof web_hook_on_invite&&web_hook_on_invite(e)}function AnswerAudioCall(e){var t=FindLineByNumber(e);if(null!=t){var n=t.SipSession;if(n.data.ringerObj&&(n.data.ringerObj.pause(),n.data.ringerObj.removeAttribute("src"),n.data.ringerObj.load(),n.data.ringerObj=null),0==HasAudioDevice)return Alert(lang.alert_no_microphone),$("#line-"+t.LineNumber+"-msg").html(lang.call_failed),void $("#line-"+t.LineNumber+"-AnswerCall").hide();$("#line-"+t.LineNumber+"-AnswerCall").hide();var i=navigator.mediaDevices.getSupportedConstraints(),a={sessionDescriptionHandlerOptions:{constraints:{audio:{deviceId:"default"},video:!1}}},o=getAudioSrcID();if("default"!=o){for(var s=!1,l=0;l<AudioinputDevices.length;++l)if(o==AudioinputDevices[l].deviceId){s=!0;break}s?a.sessionDescriptionHandlerOptions.constraints.audio.deviceId={exact:o}:(console.warn("The audio device you used before is no longer available, default settings applied."),localDB.setItem("AudioSrcId","default"))}i.autoGainControl&&(a.sessionDescriptionHandlerOptions.constraints.audio.autoGainControl=AutoGainControl),i.echoCancellation&&(a.sessionDescriptionHandlerOptions.constraints.audio.echoCancellation=EchoCancellation),i.noiseSuppression&&(a.sessionDescriptionHandlerOptions.constraints.audio.noiseSuppression=NoiseSuppression),t.SipSession.data.withvideo=!1,t.SipSession.data.VideoSourceDevice=null,t.SipSession.data.AudioSourceDevice=getAudioSrcID(),t.SipSession.data.AudioOutputDevice=getAudioOutputID(),t.SipSession.accept(a).then(function(){onInviteAccepted(t,!1)}).catch(function(e){console.warn("Failed to answer call",e,t.SipSession),t.SipSession.data.reasonCode=500,t.SipSession.data.reasonText="Client Error",teardownSession(t)})}else console.warn("Failed to get line ("+e+")")}function AnswerVideoCall(e){var t=FindLineByNumber(e);if(null!=t){var n=t.SipSession;if(n.data.ringerObj&&(n.data.ringerObj.pause(),n.data.ringerObj.removeAttribute("src"),n.data.ringerObj.load(),n.data.ringerObj=null),0==HasAudioDevice)return Alert(lang.alert_no_microphone),$("#line-"+t.LineNumber+"-msg").html(lang.call_failed),void $("#line-"+t.LineNumber+"-AnswerCall").hide();$("#line-"+t.LineNumber+"-AnswerCall").hide();var i=navigator.mediaDevices.getSupportedConstraints(),a={sessionDescriptionHandlerOptions:{constraints:{audio:{deviceId:"default"},video:{deviceId:"default"}}}},o=getAudioSrcID();if("default"!=o){for(var s=!1,l=0;l<AudioinputDevices.length;++l)if(o==AudioinputDevices[l].deviceId){s=!0;break}s?a.sessionDescriptionHandlerOptions.constraints.audio.deviceId={exact:o}:(console.warn("The audio device you used before is no longer available, default settings applied."),localDB.setItem("AudioSrcId","default"))}i.autoGainControl&&(a.sessionDescriptionHandlerOptions.constraints.audio.autoGainControl=AutoGainControl),i.echoCancellation&&(a.sessionDescriptionHandlerOptions.constraints.audio.echoCancellation=EchoCancellation),i.noiseSuppression&&(a.sessionDescriptionHandlerOptions.constraints.audio.noiseSuppression=NoiseSuppression);var r=getVideoSrcID();if("default"!=r){var d=!1;for(l=0;l<VideoinputDevices.length;++l)if(r==VideoinputDevices[l].deviceId){d=!0;break}d?a.sessionDescriptionHandlerOptions.constraints.video.deviceId={exact:r}:(console.warn("The video device you used before is no longer available, default settings applied."),localDB.setItem("VideoSrcId","default"))}i.frameRate&&""!=maxFrameRate&&(a.sessionDescriptionHandlerOptions.constraints.video.frameRate=maxFrameRate),i.height&&""!=videoHeight&&(a.sessionDescriptionHandlerOptions.constraints.video.height=videoHeight),i.aspectRatio&&""!=videoAspectRatio&&(a.sessionDescriptionHandlerOptions.constraints.video.aspectRatio=videoAspectRatio),t.SipSession.data.withvideo=!0,t.SipSession.data.VideoSourceDevice=getVideoSrcID(),t.SipSession.data.AudioSourceDevice=getAudioSrcID(),t.SipSession.data.AudioOutputDevice=getAudioOutputID(),StartVideoFullScreen&&ExpandVideoArea(t.LineNumber),t.SipSession.accept(a).then(function(){onInviteAccepted(t,!0)}).catch(function(e){console.warn("Failed to answer call",e,t.SipSession),t.SipSession.data.reasonCode=500,t.SipSession.data.reasonText="Client Error",teardownSession(t)})}else console.warn("Failed to get line ("+e+")")}function RejectCall(e){var t=FindLineByNumber(e);if(null!=t){var n=t.SipSession;null==n&&(console.warn("Reject failed, null session"),$("#line-"+t.LineNumber+"-msg").html(lang.call_failed),$("#line-"+t.LineNumber+"-AnswerCall").hide()),n.state==SIP.SessionState.Established?n.bye().catch(function(e){console.warn("Problem in RejectCall(), could not bye() call",e,n)}):n.reject({statusCode:486,reasonPhrase:"Busy Here"}).catch(function(e){console.warn("Problem in RejectCall(), could not reject() call",e,n)}),$("#line-"+t.LineNumber+"-msg").html(lang.call_rejected),n.data.terminateby="us",n.data.reasonCode=486,n.data.reasonText="Busy Here",teardownSession(t)}else console.warn("Unable to find line ("+e+")")}function onInviteCancel(e,t){console.log("Call canceled by remote party before answer"),e.SipSession.data.terminateby="them",e.SipSession.data.reasonCode=0,e.SipSession.data.reasonText="Call Cancelled",e.SipSession.dispose().catch(function(e){console.log("Failed to dispose the cancel dialog",e)}),teardownSession(e)}function onInviteAccepted(e,t,n){var i=e.SipSession;i.data.earlyMedia&&(i.data.earlyMedia.pause(),i.data.earlyMedia.removeAttribute("src"),i.data.earlyMedia.load(),i.data.earlyMedia=null),window.clearInterval(i.data.callTimer),$("#line-"+e.LineNumber+"-timer").show();var a=moment.utc();if(i.data.startTime=a,i.data.callTimer=window.setInterval(function(){var t=moment.utc(),n=moment.duration(t.diff(a)),i=formatShortDuration(n.asSeconds());$("#line-"+e.LineNumber+"-timer").html(i),$("#line-"+e.LineNumber+"-datetime").html(i)},1e3),i.isOnHold=!1,i.data.started=!0,t){var o=new MediaStream,s=i.sessionDescriptionHandler.peerConnection;s.getSenders().forEach(function(e){e.track&&"video"==e.track.kind&&o.addTrack(e.track)});var l=$("#line-"+e.LineNumber+"-localVideo").get(0);l.srcObject=o,l.onloadedmetadata=function(e){l.play()},MaxVideoBandwidth>-1&&s.getSenders().forEach(function(e){if(e.track&&"video"==e.track.kind){var t=e.getParameters();t.encodings||(t.encodings=[{}]),t.encodings[0].maxBitrate=1e3*MaxVideoBandwidth,console.log("Applying limit for Bandwidth to: ",MaxVideoBandwidth+"kb per second"),e.setParameters(t).catch(function(e){console.warn("Cannot apply Bandwidth Limits",e)})}})}(RecordAllCalls||"enabled"==CallRecordingPolicy)&&StartRecording(e.LineNumber),t?($("#line-"+e.LineNumber+"-progress").hide(),$("#line-"+e.LineNumber+"-VideoCall").show(),$("#line-"+e.LineNumber+"-ActiveCall").show(),$("#line-"+e.LineNumber+"-btn-Conference").hide(),$("#line-"+e.LineNumber+"-btn-CancelConference").hide(),$("#line-"+e.LineNumber+"-Conference").hide(),$("#line-"+e.LineNumber+"-btn-Transfer").hide(),$("#line-"+e.LineNumber+"-btn-CancelTransfer").hide(),$("#line-"+e.LineNumber+"-Transfer").hide(),$("#line-"+e.LineNumber+"-src-camera").prop("disabled",!0),$("#line-"+e.LineNumber+"-src-canvas").prop("disabled",!1),$("#line-"+e.LineNumber+"-src-desktop").prop("disabled",!1),$("#line-"+e.LineNumber+"-src-video").prop("disabled",!1)):($("#line-"+e.LineNumber+"-progress").hide(),$("#line-"+e.LineNumber+"-VideoCall").hide(),$("#line-"+e.LineNumber+"-AudioCall").show(),$("#line-"+e.LineNumber+"-btn-Mute").show(),$("#line-"+e.LineNumber+"-btn-Unmute").hide(),$("#line-"+e.LineNumber+"-btn-start-recording").show(),$("#line-"+e.LineNumber+"-btn-stop-recording").hide(),$("#line-"+e.LineNumber+"-btn-Hold").show(),$("#line-"+e.LineNumber+"-btn-Unhold").hide(),$("#line-"+e.LineNumber+"-btn-Transfer").show(),$("#line-"+e.LineNumber+"-btn-CancelTransfer").hide(),$("#line-"+e.LineNumber+"-btn-Conference").show(),$("#line-"+e.LineNumber+"-btn-CancelConference").hide(),$("#line-"+e.LineNumber+"-btn-ShowDtmf").show(),$("#line-"+e.LineNumber+"-btn-settings").show(),$("#line-"+e.LineNumber+"-btn-ShowCallStats").show(),$("#line-"+e.LineNumber+"-btn-HideCallStats").hide(),$("#line-"+e.LineNumber+"-btn-ShowTimeline").show(),$("#line-"+e.LineNumber+"-btn-HideTimeline").hide(),$("#line-"+e.LineNumber+"-btn-present-src").hide(),$("#line-"+e.LineNumber+"-btn-expand").hide(),$("#line-"+e.LineNumber+"-btn-restore").hide(),$("#line-"+e.LineNumber+"-btn-End").show(),$("#line-"+e.LineNumber+"-ActiveCall").show()),UpdateBuddyList(),updateLineScroll(e.LineNumber),e.LocalSoundMeter=StartLocalAudioMediaMonitoring(e.LineNumber,i),e.RemoteSoundMeter=StartRemoteAudioMediaMonitoring(e.LineNumber,i),$("#line-"+e.LineNumber+"-msg").html(lang.call_in_progress),t&&StartVideoFullScreen&&ExpandVideoArea(e.LineNumber),"undefined"!=typeof web_hook_on_modify&&web_hook_on_modify("accepted",i)}function onInviteTrying(e,t){$("#line-"+e.LineNumber+"-msg").html(lang.trying),"undefined"!=typeof web_hook_on_modify&&web_hook_on_modify("trying",e.SipSession)}function onInviteProgress(e,t){if(console.log("Call Progress:",t.message.statusCode),180==t.message.statusCode){$("#line-"+e.LineNumber+"-msg").html(lang.ringing);var n=audioBlobs.EarlyMedia_European;if(UserLocale().indexOf("us")>-1&&(n=audioBlobs.EarlyMedia_US),UserLocale().indexOf("gb")>-1&&(n=audioBlobs.EarlyMedia_UK),UserLocale().indexOf("au")>-1&&(n=audioBlobs.EarlyMedia_Australia),UserLocale().indexOf("jp")>-1&&(n=audioBlobs.EarlyMedia_Japan),console.log("Audio:",n.url),e.SipSession.data.earlyMedia)console.log("Early Media already playing");else{var i=new Audio(n.blob);i.preload="auto",i.loop=!0,i.oncanplaythrough=function(e){void 0!==i.sinkId&&"default"!=getAudioOutputID()&&i.setSinkId(getAudioOutputID()).then(function(){console.log("Set sinkId to:",getAudioOutputID())}).catch(function(e){console.warn("Failed not apply setSinkId.",e)}),i.play().then(function(){}).catch(function(e){console.warn("Unable to play audio file.",e)})},e.SipSession.data.earlyMedia=i}}else 183===t.message.statusCode?($("#line-"+e.LineNumber+"-msg").html(t.message.reasonPhrase+"..."),$("#line-"+e.LineNumber+"-early-dtmf").show()):$("#line-"+e.LineNumber+"-msg").html(t.message.reasonPhrase+"...");"undefined"!=typeof web_hook_on_modify&&web_hook_on_modify("progress",e.SipSession)}function onInviteRejected(e,t){console.log("INVITE Rejected:",t.message.reasonPhrase),e.SipSession.data.terminateby="them",e.SipSession.data.reasonCode=t.message.statusCode,e.SipSession.data.reasonText=t.message.reasonPhrase,teardownSession(e)}function onInviteRedirected(e){console.log("onInviteRedirected",e)}function onSessionReceivedBye(e,t){$("#line-"+e.LineNumber+"-msg").html(lang.call_ended),console.log("Call ended, bye!"),e.SipSession.data.terminateby="them",e.SipSession.data.reasonCode=16,e.SipSession.data.reasonText="Normal Call clearing",t.accept(),teardownSession(e)}function onSessionReinvited(e,t){var n=t.body;e.SipSession.data.videoChannelNames=[];var i=n.split("m=video");if(i.length>=1){for(var a=0;a<i.length;a++)if(i[a].indexOf("a=mid:")>-1&&i[a].indexOf("a=label:")>-1){for(var o=i[a].split("\r\n"),s="",l="",r=0;r<o.length;r++)0==o[r].indexOf("a=label:")&&(s=o[r].replace("a=label:","")),0==o[r].indexOf("a=mid:")&&(l=o[r].replace("a=mid:",""));e.SipSession.data.videoChannelNames.push({mid:l,channel:s})}console.log("videoChannelNames:",e.SipSession.data.videoChannelNames),RedrawStage(e.LineNumber,!1)}}function onSessionReceivedMessage(e,t){var n=t.request.headers["Content-Type"].length>=1?t.request.headers["Content-Type"][0].parsed:"Unknown";if(n.indexOf("application/x-asterisk-confbridge-event")>-1){var i=JSON.parse(t.request.body),a=e.SipSession;if(a.data.ConfbridgeChannels||(a.data.ConfbridgeChannels=[]),a.data.ConfbridgeEvents||(a.data.ConfbridgeEvents=[]),"ConfbridgeStart"==i.type)console.log("ConfbridgeStart!");else if("ConfbridgeWelcome"==i.type)console.log("Welcome to the Asterisk Conference"),console.log("Bridge ID:",i.bridge.id),console.log("Bridge Name:",i.bridge.name),console.log("Created at:",i.bridge.creationtime),console.log("Video Mode:",i.bridge.video_mode),a.data.ConfbridgeChannels=i.channels,a.data.ConfbridgeChannels.forEach(function(e){console.log(e.caller.name,"Is in the conference. Muted:",e.muted,"Admin:",e.admin)});else if("ConfbridgeJoin"==i.type)i.channels.forEach(function(e){var t=!1;a.data.ConfbridgeChannels.forEach(function(n){n.id==e.id&&(t=!0)}),t||(a.data.ConfbridgeChannels.push(e),a.data.ConfbridgeEvents.push({event:e.caller.name+" ("+e.caller.number+") joined the conference",eventTime:utcDateNow()}),console.log(e.caller.name,"Joined the conference. Muted: ",e.muted))});else if("ConfbridgeLeave"==i.type)i.channels.forEach(function(e){a.data.ConfbridgeChannels.forEach(function(t,n){t.id==e.id&&(a.data.ConfbridgeChannels.splice(n,1),console.log(e.caller.name,"Left the conference"),a.data.ConfbridgeEvents.push({event:e.caller.name+" ("+e.caller.number+") left the conference",eventTime:utcDateNow()}))})});else if("ConfbridgeTalking"==i.type){var o=$("#line-"+e.LineNumber+"-remote-videos");o&&i.channels.forEach(function(e){o.find("video").each(function(){this.srcObject.channel&&this.srcObject.channel==e.id&&("on"==e.talking_status?(console.log(e.caller.name,"is talking."),this.srcObject.isTalking=!0,$(this).css("border","1px solid red")):(console.log(e.caller.name,"stopped talking."),this.srcObject.isTalking=!1,$(this).css("border","1px solid transparent")))})})}else"ConfbridgeMute"==i.type?(i.channels.forEach(function(e){a.data.ConfbridgeChannels.forEach(function(t){t.id==e.id&&(console.log(t.caller.name,"is now muted"),t.muted=!0)})}),RedrawStage(e.LineNumber,!1)):"ConfbridgeUnmute"==i.type?(i.channels.forEach(function(e){a.data.ConfbridgeChannels.forEach(function(t){t.id==e.id&&(console.log(t.caller.name,"is now unmuted"),t.muted=!1)})}),RedrawStage(e.LineNumber,!1)):"ConfbridgeEnd"==i.type?console.log("The Asterisk Conference has ended, bye!"):console.warn("Unknown Asterisk Conference Event:",i.type,i);RefreshLineActivity(e.LineNumber),t.accept()}else n.indexOf("application/x-myphone-confbridge-chat")>-1?(console.log("x-myphone-confbridge-chat",t),t.accept()):(console.warn("Unknown message type"),t.reject())}function onSessionDescriptionHandlerCreated(e,t,n,i){t?t.peerConnection?t.peerConnection.ontrack=function(t){onTrackAddedEvent(e,i)}:console.warn("onSessionDescriptionHandler fired without a peerConnection"):console.warn("onSessionDescriptionHandler fired without a sessionDescriptionHandler")}function onTrackAddedEvent(e,t){var n=e.SipSession,i=n.sessionDescriptionHandler.peerConnection,a=new MediaStream,o=new MediaStream;if(i.getTransceivers().forEach(function(e){var n=e.receiver;n.track&&("audio"==n.track.kind&&(console.log("Adding Remote Audio Track"),a.addTrack(n.track)),t&&"video"==n.track.kind&&e.mid&&(n.track.mid=e.mid,console.log("Adding Remote Video Track - ",n.track.readyState,"MID:",n.track.mid),o.addTrack(n.track)))}),a.getAudioTracks().length>=1){var s=$("#line-"+e.LineNumber+"-remoteAudio").get(0);s.srcObject=a,s.onloadedmetadata=function(e){void 0!==s.sinkId&&s.setSinkId(getAudioOutputID()).then(function(){console.log("sinkId applied: "+getAudioOutputID())}).catch(function(e){console.warn("Error using setSinkId: ",e)}),s.play()}}if(t)if($("#line-"+e.LineNumber+"-remote-videos").empty(),o.getVideoTracks().length>=1){var l=o.getVideoTracks();l.forEach(function(t){var n=new MediaStream;n.trackID=t.id,n.mid=t.mid,t.onended=function(){console.log("Video Track Ended: ",this.mid),RedrawStage(e.LineNumber,!0)},n.addTrack(t);var i=$("<span />",{class:"VideoWrapper"});i.css("width","1px"),i.css("heigh","1px"),i.hide();var a=$("<div />",{class:"callerID"});i.append(a);var o=$("<div />",{class:"Actions"});i.append(o);var s=$("<video />",{id:t.id,mid:t.mid,muted:!0,autoplay:!0,playsinline:!0,controls:!1});s.hide();var l=s.get(0);l.srcObject=n,l.onloadedmetadata=function(t){s.show(),s.parent().show(),console.log("Playing Video Stream MID:",n.mid),RedrawStage(e.LineNumber,!0)},i.append(s),$("#line-"+e.LineNumber+"-remote-videos").append(i),console.log("Added Video Element MID:",n.mid)})}else console.log("No Video Streams"),RedrawStage(e.LineNumber,!0);"undefined"!=typeof web_hook_on_modify&&web_hook_on_modify("trackAdded",n)}function teardownSession(e){if(null!=e&&null!=e.SipSession){var t=e.SipSession;if(1!=t.data.teardownComplete){if(t.data.teardownComplete=!0,1!=t.data.earlyReject&&HidePopup(),t.data.childsession&&t.data.childsession.dispose().then(function(){t.data.childsession=null}).catch(function(e){t.data.childsession=null}),t.data.AudioSourceTrack&&"audio"==t.data.AudioSourceTrack.kind&&(t.data.AudioSourceTrack.stop(),t.data.AudioSourceTrack=null),t.data.earlyMedia&&(t.data.earlyMedia.pause(),t.data.earlyMedia.removeAttribute("src"),t.data.earlyMedia.load(),t.data.earlyMedia=null),t.data.ringerObj&&(t.data.ringerObj.pause(),t.data.ringerObj.removeAttribute("src"),t.data.ringerObj.load(),t.data.ringerObj=null),StopRecording(e.LineNumber,!0),null!=e.LocalSoundMeter&&(e.LocalSoundMeter.stop(),e.LocalSoundMeter=null),null!=e.RemoteSoundMeter&&(e.RemoteSoundMeter.stop(),e.RemoteSoundMeter=null),t&&t.sessionDescriptionHandler&&t.sessionDescriptionHandler.peerConnection){var n=t.sessionDescriptionHandler.peerConnection;n.getSenders().forEach(function(e){e.track&&"audio"==e.track.kind&&e.track.stop()})}window.clearInterval(t.data.videoResampleInterval),window.clearInterval(t.data.callTimer),AddCallMessage(e.BuddyObj.identity,t),e.SipSession.data.earlyReject?IncreaseMissedBadge(t.data.buddyId):"inbound"==t.data.calldirection&&"them"==t.data.terminateby&&null==e.SipSession.data.startTime&&IncreaseMissedBadge(t.data.buddyId),window.setTimeout(function(){RemoveLine(e)},1e3),UpdateBuddyList(),1!=t.data.earlyReject&&UpdateUI(),"undefined"!=typeof web_hook_on_terminate&&web_hook_on_terminate(t)}}}function StartRemoteAudioMediaMonitoring(e,t){console.log("Creating RemoteAudio AudioContext on Line:"+e);var n=new SoundMeter(t.id,e);if(null==n)return console.warn("AudioContext() RemoteAudio not available... it fine."),null;var i=new MediaStream,a=null,o=t.sessionDescriptionHandler.peerConnection;o.getReceivers().forEach(function(e){e.track&&"audio"==e.track.kind&&(null==a?(i.addTrack(e.track),a=e):(console.log("Found another Track, but audioReceiver not null"),console.log(e),console.log(e.track)))});var s=100;n.startTime=Date.now(),Chart.defaults.global.defaultFontSize=12;var l={responsive:!0,maintainAspectRatio:!1,animation:!1,scales:{yAxes:[{ticks:{beginAtZero:!0}}],xAxes:[{display:!1}]}};return n.ReceiveBitRateChart=new Chart($("#line-"+e+"-AudioReceiveBitRate"),{type:"line",data:{labels:MakeDataArray("",s),datasets:[{label:lang.receive_kilobits_per_second,data:MakeDataArray(0,s),backgroundColor:"rgba(168, 0, 0, 0.5)",borderColor:"rgba(168, 0, 0, 1)",borderWidth:1,pointRadius:1}]},options:l}),n.ReceiveBitRateChart.lastValueBytesReceived=0,n.ReceiveBitRateChart.lastValueTimestamp=0,n.ReceivePacketRateChart=new Chart($("#line-"+e+"-AudioReceivePacketRate"),{type:"line",data:{labels:MakeDataArray("",s),datasets:[{label:lang.receive_packets_per_second,data:MakeDataArray(0,s),backgroundColor:"rgba(168, 0, 0, 0.5)",borderColor:"rgba(168, 0, 0, 1)",borderWidth:1,pointRadius:1}]},options:l}),n.ReceivePacketRateChart.lastValuePacketReceived=0,n.ReceivePacketRateChart.lastValueTimestamp=0,n.ReceivePacketLossChart=new Chart($("#line-"+e+"-AudioReceivePacketLoss"),{type:"line",data:{labels:MakeDataArray("",s),datasets:[{label:lang.receive_packet_loss,data:MakeDataArray(0,s),backgroundColor:"rgba(168, 99, 0, 0.5)",borderColor:"rgba(168, 99, 0, 1)",borderWidth:1,pointRadius:1}]},options:l}),n.ReceivePacketLossChart.lastValuePacketLoss=0,n.ReceivePacketLossChart.lastValueTimestamp=0,n.ReceiveJitterChart=new Chart($("#line-"+e+"-AudioReceiveJitter"),{type:"line",data:{labels:MakeDataArray("",s),datasets:[{label:lang.receive_jitter,data:MakeDataArray(0,s),backgroundColor:"rgba(0, 38, 168, 0.5)",borderColor:"rgba(0, 38, 168, 1)",borderWidth:1,pointRadius:1}]},options:l}),n.ReceiveLevelsChart=new Chart($("#line-"+e+"-AudioReceiveLevels"),{type:"line",data:{labels:MakeDataArray("",s),datasets:[{label:lang.receive_audio_levels,data:MakeDataArray(0,s),backgroundColor:"rgba(140, 0, 168, 0.5)",borderColor:"rgba(140, 0, 168, 1)",borderWidth:1,pointRadius:1}]},options:l}),n.connectToSource(i,function(t){null==t&&(console.log("SoundMeter for RemoteAudio Connected, displaying levels for Line: "+e),n.levelsInterval=window.setInterval(function(){var t=n.instant/255*100;$("#line-"+e+"-Speaker").css("height",t.toFixed(2)+"%")},50),n.networkInterval=window.setInterval(function(){null!=a&&a.getStats().then(function(e){e.forEach(function(e){var t=utcDateNow(),i=n.ReceiveBitRateChart,a=n.ReceivePacketRateChart,o=n.ReceivePacketLossChart,l=n.ReceiveJitterChart,r=n.ReceiveLevelsChart
;Math.floor((Date.now()-n.startTime)/1e3);if("inbound-rtp"==e.type){if(0==i.lastValueTimestamp)return i.lastValueTimestamp=e.timestamp,i.lastValueBytesReceived=e.bytesReceived,a.lastValueTimestamp=e.timestamp,a.lastValuePacketReceived=e.packetsReceived,o.lastValueTimestamp=e.timestamp,void(o.lastValuePacketLoss=e.packetsLost);var d=8*(e.bytesReceived-i.lastValueBytesReceived)/1e3;i.lastValueTimestamp=e.timestamp,i.lastValueBytesReceived=e.bytesReceived,n.ReceiveBitRate.push({value:d,timestamp:t}),i.data.datasets[0].data.push(d),i.data.labels.push(""),i.data.datasets[0].data.length>s&&(i.data.datasets[0].data.splice(0,1),i.data.labels.splice(0,1)),i.update();var c=e.packetsReceived-a.lastValuePacketReceived;a.lastValueTimestamp=e.timestamp,a.lastValuePacketReceived=e.packetsReceived,n.ReceivePacketRate.push({value:c,timestamp:t}),a.data.datasets[0].data.push(c),a.data.labels.push(""),a.data.datasets[0].data.length>s&&(a.data.datasets[0].data.splice(0,1),a.data.labels.splice(0,1)),a.update();var u=e.packetsLost-o.lastValuePacketLoss;o.lastValueTimestamp=e.timestamp,o.lastValuePacketLoss=e.packetsLost,n.ReceivePacketLoss.push({value:u,timestamp:t}),o.data.datasets[0].data.push(u),o.data.labels.push(""),o.data.datasets[0].data.length>s&&(o.data.datasets[0].data.splice(0,1),o.data.labels.splice(0,1)),o.update(),n.ReceiveJitter.push({value:e.jitter,timestamp:t}),l.data.datasets[0].data.push(e.jitter),l.data.labels.push(""),l.data.datasets[0].data.length>s&&(l.data.datasets[0].data.splice(0,1),l.data.labels.splice(0,1)),l.update()}if("track"==e.type){var p=100*e.audioLevel;n.ReceiveLevels.push({value:p,timestamp:t}),r.data.datasets[0].data.push(p),r.data.labels.push(""),r.data.datasets[0].data.length>s&&(r.data.datasets[0].data.splice(0,1),r.data.labels.splice(0,1)),r.update()}})})},1e3))}),n}function StartLocalAudioMediaMonitoring(e,t){console.log("Creating LocalAudio AudioContext on line "+e);var n=new SoundMeter(t.id,e);if(null==n)return console.warn("AudioContext() LocalAudio not available... its fine."),null;var i=new MediaStream,a=null,o=t.sessionDescriptionHandler.peerConnection;o.getSenders().forEach(function(e){e.track&&"audio"==e.track.kind&&(null==a?(console.log("Adding Track to Monitor: ",e.track.label),i.addTrack(e.track),a=e):(console.log("Found another Track, but audioSender not null"),console.log(e),console.log(e.track)))});var s=100;n.startTime=Date.now(),Chart.defaults.global.defaultFontSize=12;var l={responsive:!0,maintainAspectRatio:!1,animation:!1,scales:{yAxes:[{ticks:{beginAtZero:!0}}],xAxes:[{display:!1}]}};return n.SendBitRateChart=new Chart($("#line-"+e+"-AudioSendBitRate"),{type:"line",data:{labels:MakeDataArray("",s),datasets:[{label:lang.send_kilobits_per_second,data:MakeDataArray(0,s),backgroundColor:"rgba(0, 121, 19, 0.5)",borderColor:"rgba(0, 121, 19, 1)",borderWidth:1,pointRadius:1}]},options:l}),n.SendBitRateChart.lastValueBytesSent=0,n.SendBitRateChart.lastValueTimestamp=0,n.SendPacketRateChart=new Chart($("#line-"+e+"-AudioSendPacketRate"),{type:"line",data:{labels:MakeDataArray("",s),datasets:[{label:lang.send_packets_per_second,data:MakeDataArray(0,s),backgroundColor:"rgba(0, 121, 19, 0.5)",borderColor:"rgba(0, 121, 19, 1)",borderWidth:1,pointRadius:1}]},options:l}),n.SendPacketRateChart.lastValuePacketSent=0,n.SendPacketRateChart.lastValueTimestamp=0,n.connectToSource(i,function(t){null==t&&(console.log("SoundMeter for LocalAudio Connected, displaying levels for Line: "+e),n.levelsInterval=window.setInterval(function(){var t=n.instant/255*100;$("#line-"+e+"-Mic").css("height",t.toFixed(2)+"%")},50),n.networkInterval=window.setInterval(function(){null!=a&&a.getStats().then(function(e){e.forEach(function(e){var t=utcDateNow(),i=n.SendBitRateChart,a=n.SendPacketRateChart;Math.floor((Date.now()-n.startTime)/1e3);if("outbound-rtp"==e.type){if(0==i.lastValueTimestamp)return i.lastValueTimestamp=e.timestamp,i.lastValueBytesSent=e.bytesSent,a.lastValueTimestamp=e.timestamp,void(a.lastValuePacketSent=e.packetsSent);var o=8*(e.bytesSent-i.lastValueBytesSent)/1e3;i.lastValueTimestamp=e.timestamp,i.lastValueBytesSent=e.bytesSent,n.SendBitRate.push({value:o,timestamp:t}),i.data.datasets[0].data.push(o),i.data.labels.push(""),i.data.datasets[0].data.length>s&&(i.data.datasets[0].data.splice(0,1),i.data.labels.splice(0,1)),i.update();var l=e.packetsSent-a.lastValuePacketSent;a.lastValueTimestamp=e.timestamp,a.lastValuePacketSent=e.packetsSent,n.SendPacketRate.push({value:l,timestamp:t}),a.data.datasets[0].data.push(l),a.data.labels.push(""),a.data.datasets[0].data.length>s&&(a.data.datasets[0].data.splice(0,1),a.data.labels.splice(0,1)),a.update()}e.type})})},1e3))}),n}function MeterSettingsOutput(e,t,n,i){var a=new SoundMeter(null,null);return a.startTime=Date.now(),a.connectToSource(e,function(e){null==e&&(console.log("SoundMeter Connected, displaying levels to:"+t),a.levelsInterval=window.setInterval(function(){var e=a.instant/255*100;$("#"+t).css(n,e.toFixed(2)+"%")},i))}),a}function SaveQosData(e,t,n){var i=window.indexedDB,a=i.open("CallQosData",1);a.onerror=function(e){console.error("IndexDB Request Error:",e)},a.onupgradeneeded=function(e){console.warn("Upgrade Required for IndexDB... probably because of first time use.");var t=e.target.result;if(0==t.objectStoreNames.contains("CallQos")){var n=t.createObjectStore("CallQos",{keyPath:"uID"});n.createIndex("sessionid","sessionid",{unique:!1}),n.createIndex("buddy","buddy",{unique:!1}),n.createIndex("QosData","QosData",{unique:!1})}else console.warn("IndexDB requested upgrade, but object store was in place")},a.onsuccess=function(i){console.log("IndexDB connected to CallQosData");var a=i.target.result;if(0==a.objectStoreNames.contains("CallQos"))return console.warn("IndexDB CallQosData.CallQos does not exists"),a.close(),void window.indexedDB.deleteDatabase("CallQosData");a.onerror=function(e){console.error("IndexDB Error:",e)};var o={uID:uID(),sessionid:t,buddy:n,QosData:e},s=a.transaction(["CallQos"],"readwrite"),l=s.objectStore("CallQos").add(o);l.onsuccess=function(e){console.log("Call CallQos Success: ",t)}}}function DisplayQosData(e){var t=window.indexedDB,n=t.open("CallQosData",1);n.onerror=function(e){console.error("IndexDB Request Error:",e)},n.onupgradeneeded=function(e){console.warn("Upgrade Required for IndexDB... probably because of first time use.")},n.onsuccess=function(t){console.log("IndexDB connected to CallQosData");var n=t.target.result;if(0!=n.objectStoreNames.contains("CallQos")){var i=n.transaction(["CallQos"]),a=i.objectStore("CallQos").index("sessionid").getAll(e);a.onerror=function(e){console.error("IndexDB Get Error:",e)},a.onsuccess=function(e){if(e.target.result&&2==e.target.result.length){var t=e.target.result[0].QosData,n=e.target.result[1].QosData;Chart.defaults.global.defaultFontSize=12;var i={responsive:!0,maintainAspectRatio:!1,animation:!1,scales:{yAxes:[{ticks:{beginAtZero:!0}}],xAxes:[{display:!1}]}},a=[],o=[],s=t.ReceiveBitRate.length>0?t.ReceiveBitRate:n.ReceiveBitRate;$.each(s,function(e,t){a.push(moment.utc(t.timestamp.replace(" UTC","")).local().format(DisplayDateFormat+" "+DisplayTimeFormat)),o.push(t.value)});new Chart($("#cdr-AudioReceiveBitRate"),{type:"line",data:{labels:a,datasets:[{label:lang.receive_kilobits_per_second,data:o,backgroundColor:"rgba(168, 0, 0, 0.5)",borderColor:"rgba(168, 0, 0, 1)",borderWidth:1,pointRadius:1}]},options:i}),a=[],o=[],s=t.ReceivePacketRate.length>0?t.ReceivePacketRate:n.ReceivePacketRate;$.each(s,function(e,t){a.push(moment.utc(t.timestamp.replace(" UTC","")).local().format(DisplayDateFormat+" "+DisplayTimeFormat)),o.push(t.value)});new Chart($("#cdr-AudioReceivePacketRate"),{type:"line",data:{labels:a,datasets:[{label:lang.receive_packets_per_second,data:o,backgroundColor:"rgba(168, 0, 0, 0.5)",borderColor:"rgba(168, 0, 0, 1)",borderWidth:1,pointRadius:1}]},options:i}),a=[],o=[],s=t.ReceivePacketLoss.length>0?t.ReceivePacketLoss:n.ReceivePacketLoss;$.each(s,function(e,t){a.push(moment.utc(t.timestamp.replace(" UTC","")).local().format(DisplayDateFormat+" "+DisplayTimeFormat)),o.push(t.value)});new Chart($("#cdr-AudioReceivePacketLoss"),{type:"line",data:{labels:a,datasets:[{label:lang.receive_packet_loss,data:o,backgroundColor:"rgba(168, 99, 0, 0.5)",borderColor:"rgba(168, 99, 0, 1)",borderWidth:1,pointRadius:1}]},options:i}),a=[],o=[],s=t.ReceiveJitter.length>0?t.ReceiveJitter:n.ReceiveJitter;$.each(s,function(e,t){a.push(moment.utc(t.timestamp.replace(" UTC","")).local().format(DisplayDateFormat+" "+DisplayTimeFormat)),o.push(t.value)});new Chart($("#cdr-AudioReceiveJitter"),{type:"line",data:{labels:a,datasets:[{label:lang.receive_jitter,data:o,backgroundColor:"rgba(0, 38, 168, 0.5)",borderColor:"rgba(0, 38, 168, 1)",borderWidth:1,pointRadius:1}]},options:i}),a=[],o=[],s=t.ReceiveLevels.length>0?t.ReceiveLevels:n.ReceiveLevels;$.each(s,function(e,t){a.push(moment.utc(t.timestamp.replace(" UTC","")).local().format(DisplayDateFormat+" "+DisplayTimeFormat)),o.push(t.value)});new Chart($("#cdr-AudioReceiveLevels"),{type:"line",data:{labels:a,datasets:[{label:lang.receive_audio_levels,data:o,backgroundColor:"rgba(140, 0, 168, 0.5)",borderColor:"rgba(140, 0, 168, 1)",borderWidth:1,pointRadius:1}]},options:i}),a=[],o=[],s=t.SendPacketRate.length>0?t.SendPacketRate:n.SendPacketRate;$.each(s,function(e,t){a.push(moment.utc(t.timestamp.replace(" UTC","")).local().format(DisplayDateFormat+" "+DisplayTimeFormat)),o.push(t.value)});new Chart($("#cdr-AudioSendPacketRate"),{type:"line",data:{labels:a,datasets:[{label:lang.send_packets_per_second,data:o,backgroundColor:"rgba(0, 121, 19, 0.5)",borderColor:"rgba(0, 121, 19, 1)",borderWidth:1,pointRadius:1}]},options:i}),a=[],o=[],s=t.SendBitRate.length>0?t.SendBitRate:n.SendBitRate;$.each(s,function(e,t){a.push(moment.utc(t.timestamp.replace(" UTC","")).local().format(DisplayDateFormat+" "+DisplayTimeFormat)),o.push(t.value)});new Chart($("#cdr-AudioSendBitRate"),{type:"line",data:{labels:a,datasets:[{label:lang.send_kilobits_per_second,data:o,backgroundColor:"rgba(0, 121, 19, 0.5)",borderColor:"rgba(0, 121, 19, 1)",borderWidth:1,pointRadius:1}]},options:i})}else console.warn("Result not expected",e.target.result)}}else console.warn("IndexDB CallQosData.CallQos does not exists")}}function DeleteQosData(e,t){var n=window.indexedDB,i=n.open("CallQosData",1);i.onerror=function(e){console.error("IndexDB Request Error:",e)},i.onupgradeneeded=function(e){console.warn("Upgrade Required for IndexDB... probably because of first time use.")},i.onsuccess=function(e){console.log("IndexDB connected to CallQosData");var n=e.target.result;0!=n.objectStoreNames.contains("CallQos")?(n.onerror=function(e){console.error("IndexDB Error:",e)},$.each(t.DataCollection,function(e,t){if("CDR"==t.ItemType&&t.SessionId&&""!=t.SessionId){console.log("Deleting CallQosData: ",t.SessionId);var i=n.transaction(["CallQos"],"readwrite").objectStore("CallQos"),a=i.index("sessionid").getAll(t.SessionId);a.onerror=function(e){console.error("IndexDB Get Error:",e)},a.onsuccess=function(e){e.target.result&&e.target.result.length>0&&$.each(e.target.result,function(e,t){try{i.delete(t.uID)}catch(e){console.log("Call CallQosData Delete failed: ",e)}})}}})):console.warn("IndexDB CallQosData.CallQos does not exists")}}function SubscribeAll(){if(userAgent.isRegistered()&&(VoiceMailSubscribe&&SubscribeVoicemail(),SubscribeToYourself&&SelfSubscribe(),userAgent.BlfSubs&&userAgent.BlfSubs.length>0&&UnsubscribeAll(),userAgent.BlfSubs=[],Buddies.length>=1)){console.log("Starting Subscribe of all ("+Buddies.length+") Extension Buddies...");for(var e=0;e<Buddies.length;e++)SubscribeBuddy(Buddies[e])}}function SelfSubscribe(){if(userAgent.isRegistered()){userAgent.selfSub&&(console.log("Unsubscribe from old self subscribe..."),SelfUnsubscribe());var e=SIP.UserAgent.makeURI("sip:"+SipUsername+"@"+SipDomain),t={expires:SubscribeBuddyExpires,extraHeaders:["Accept: "+SubscribeBuddyAccept]};userAgent.selfSub=new SIP.Subscriber(userAgent,e,SubscribeBuddyEvent,t),userAgent.selfSub.delegate={onNotify:function(e){ReceiveNotify(e,!0)}},console.log("SUBSCRIBE Self: "+SipUsername+"@"+SipDomain),userAgent.selfSub.subscribe().catch(function(e){console.warn("Error subscribing to yourself:",e)})}}function SubscribeVoicemail(){if(userAgent.isRegistered()){userAgent.voicemailSub&&(console.log("Unsubscribe from old voicemail Messages..."),UnsubscribeVoicemail());var e={expires:SubscribeVoicemailExpires},t=SIP.UserAgent.makeURI("sip:"+SipUsername+"@"+SipDomain);userAgent.voicemailSub=new SIP.Subscriber(userAgent,t,"message-summary",e),userAgent.voicemailSub.delegate={onNotify:function(e){VoicemailNotify(e)}},console.log("SUBSCRIBE VOICEMAIL: "+SipUsername+"@"+SipDomain),userAgent.voicemailSub.subscribe().catch(function(e){console.warn("Error subscribing to voicemail notifications:",e)})}}function SubscribeBuddy(e){if(userAgent.isRegistered()&&("extension"==e.type||"xmpp"==e.type)&&1==e.EnableSubscribe&&""!=e.SubscribeUser){var t=SIP.UserAgent.makeURI("sip:"+e.SubscribeUser+"@"+SipDomain),n={expires:SubscribeBuddyExpires,extraHeaders:["Accept: "+SubscribeBuddyAccept]},i=new SIP.Subscriber(userAgent,t,SubscribeBuddyEvent,n);i.data={},i.data.buddyId=e.identity,i.delegate={onNotify:function(e){ReceiveNotify(e,!1)}},console.log("SUBSCRIBE: "+e.SubscribeUser+"@"+SipDomain),i.subscribe().catch(function(e){console.warn("Error subscribing to Buddy notifications:",e)}),userAgent.BlfSubs||(userAgent.BlfSubs=[]),userAgent.BlfSubs.push(i)}}function UnsubscribeAll(){if(userAgent.isRegistered()&&(console.log("Unsubscribe from voicemail Messages..."),UnsubscribeVoicemail(),userAgent.BlfSubs&&userAgent.BlfSubs.length>0)){console.log("Unsubscribing "+userAgent.BlfSubs.length+" subscriptions...");for(var e=0;e<userAgent.BlfSubs.length;e++)UnsubscribeBlf(userAgent.BlfSubs[e]);userAgent.BlfSubs=[];for(var t=0;t<Buddies.length;t++){var n=Buddies[t];"extension"!=n.type&&"xmpp"!=n.type||($("#contact-"+n.identity+"-devstate").prop("class","dotOffline"),$("#contact-"+n.identity+"-devstate-main").prop("class","dotOffline"),$("#contact-"+n.identity+"-presence").html(lang.state_unknown),$("#contact-"+n.identity+"-presence-main").html(lang.state_unknown))}}}function UnsubscribeBlf(e){userAgent.isRegistered()&&(e.state==SIP.SubscriptionState.Subscribed?(console.log("Unsubscribe to BLF Messages...",e.data.buddyId),e.unsubscribe().catch(function(e){console.warn("Error removing BLF notifications:",e)})):console.log("Incorrect buddy subscribe state",e.data.buddyId,e.state),e.dispose().catch(function(e){console.warn("Error disposing BLF notifications:",e)}),e=null)}function UnsubscribeVoicemail(){userAgent.isRegistered()&&(userAgent.voicemailSub?(console.log("Unsubscribe to voicemail Messages...",userAgent.voicemailSub.state),userAgent.voicemailSub.state==SIP.SubscriptionState.Subscribed&&userAgent.voicemailSub.unsubscribe().catch(function(e){console.warn("Error removing voicemail notifications:",e)}),userAgent.voicemailSub.dispose().catch(function(e){console.warn("Error disposing voicemail notifications:",e)})):console.log("Not subscribed to MWI"),userAgent.voicemailSub=null)}function SelfUnsubscribe(){userAgent.isRegistered()&&(userAgent.selfSub?(console.log("Unsubscribe from yourself...",userAgent.selfSub.state),userAgent.selfSub.state==SIP.SubscriptionState.Subscribed&&userAgent.selfSub.unsubscribe().catch(function(e){console.warn("Error self subscription:",e)}),userAgent.selfSub.dispose().catch(function(e){console.warn("Error disposing self subscription:",e)})):console.log("Not subscribed to Yourself"),userAgent.selfSub=null)}function UnsubscribeBuddy(e){if(console.log("Unsubscribe: ",e.identity),("extension"==e.type||"xmpp"==e.type)&&userAgent&&userAgent.BlfSubs&&userAgent.BlfSubs.length>0)for(var t=0;t<userAgent.BlfSubs.length;t++){var n=userAgent.BlfSubs[t];if(n.data.buddyId==e.identity){console.log("Subscription found, removing: ",e.identity),UnsubscribeBlf(userAgent.BlfSubs[t]),userAgent.BlfSubs.splice(t,1);break}}}function VoicemailNotify(e){if(e.request.body.indexOf("Messages-Waiting:")>-1){e.accept();var t=e.request.body.indexOf("Messages-Waiting: yes")>-1,n=0,i=0,a=0,o=0;if(t){console.log("Messages Waiting!");for(var s=e.request.body.split("\r\n"),l=0;l<s.length;l++)if(s[l].indexOf("Voice-Message: ")>-1){var r=s[l].replace("Voice-Message: ","");r.indexOf(" (")>-1?(n=parseInt(r.split(" (")[0].split("/")[0]),i=parseInt(r.split(" (")[0].split("/")[1]),a=parseInt(r.split(" (")[1].replace(")","").split("/")[0]),o=parseInt(r.split(" (")[1].replace(")","").split("/")[1])):(n=parseInt(r.split("/")[0]),i=parseInt(r.split("/")[1]))}if(console.log("Voicemail: ",n,i,a,o),$("#TxtVoiceMessages").html(""+n),$("#TxtVoiceMessages").show(),n>userAgent.lastVoicemailCount&&(userAgent.lastVoicemailCount=n,"Notification"in window&&"granted"===Notification.permission)){var d={body:n+" New voicemail message"},c=new Notification("New VoiceMail",d);c.onclick=function(e){""!=VoicemailDid&&DialByLine("audio",null,VoicemailDid,"VoiceMail")}}}else $("#TxtVoiceMessages").html("0"),$("#TxtVoiceMessages").hide();"undefined"!=typeof web_hook_on_messages_waiting&&web_hook_on_messages_waiting(n,i,a,o)}else e.reject()}function ReceiveNotify(e,t){if(null!=userAgent&&userAgent.isRegistered()){e.accept();var n="",i="dotOffline",a="Unknown",o=e.request.headers["Content-Type"][0].parsed;if("application/pidf+xml"==o){var s=$($.parseXML(e.request.body)),l=s.find("presence").attr("entity");n=l.split("@")[0].split(":")[1];var r="closed",d=s.find("presence").find("tuple");d&&$.each(d,function(e,t){"open"==$(t).find("status").find("basic").text()&&(r="open")}),a=s.find("presence").find("note").text(),""==a&&("open"==r&&(a="Ready"),"closed"==r&&(a="Not online"))}else if("application/dialog-info+xml"==o){s=$($.parseXML(e.request.body)),l=s.find("dialog-info").attr("entity");n=l.split("@")[0].split(":")[1];s.find("dialog-info").attr("version"),s.find("dialog-info").attr("state"),s.find("dialog-info").find("dialog").attr("id");var c=s.find("dialog-info").find("dialog").find("state").text();"terminated"==c&&(a="Ready"),"trying"==c&&(a="On the phone"),"proceeding"==c&&(a="On the phone"),"early"==c&&(a="Ringing"),"confirmed"==c&&(a="On the phone")}if(t)n==SipUsername?(console.log("Self Notify:",a),"undefined"!=typeof web_hook_on_self_notify&&web_hook_on_self_notify(o,e.request.body)):console.warn("Self Subscribe Notify, but wrong user returned.",n,SipUsername);else{var u=FindBuddyByObservedUser(n);null!=u?("Not online"==a&&(i="dotOffline"),"Unavailable"==a&&(i="dotOffline"),"Ready"==a&&(i="dotOnline"),"On the phone"==a&&(i="dotInUse"),"Proceeding"==a&&(i="dotInUse"),"Ringing"==a&&(i="dotRinging"),"On hold"==a&&(i="dotOnHold"),console.log("Setting DevSate State for "+u.CallerIDName+" to "+i),u.devState=i,$("#contact-"+u.identity+"-devstate").prop("class",i),$("#contact-"+u.identity+"-devstate-main").prop("class",i),"xmpp"!=u.type&&(console.log("Setting Presence for "+u.CallerIDName+" to "+a),u.presence=a,"Not online"==a&&(a=lang.state_not_online),"Ready"==a&&(a=lang.state_ready),"On the phone"==a&&(a=lang.state_on_the_phone),"Proceeding"==a&&(a=lang.state_on_the_phone),"Ringing"==a&&(a=lang.state_ringing),"On hold"==a&&(a=lang.state_on_hold),"Unavailable"==a&&(a=lang.state_unavailable),$("#contact-"+u.identity+"-presence").html(a),$("#contact-"+u.identity+"-presence-main").html(a)),"undefined"!=typeof web_hook_on_notify&&web_hook_on_notify(o,u,e.request.body)):console.warn("Buddy not found:",n)}}}function InitialiseStream(e){var t={TotalRows:0,DataCollection:[]};return localDB.setItem(e+"-stream",JSON.stringify(t)),JSON.parse(localDB.getItem(e+"-stream"))}function SendChatMessage(e){if(null!=userAgent&&userAgent.isRegistered()){$("#contact-"+e+"-ChatMessage").focus();var t=$("#contact-"+e+"-ChatMessage").val();if(t=$.trim(t),""!=t){var n=uID(),i=FindBuddyByIdentity(e),a=moment.utc().format("YYYY-MM-DD HH:mm:ss UTC"),o=JSON.parse(localDB.getItem(e+"-stream"));null==o&&(o=InitialiseStream(e));var s={ItemId:n,ItemType:"MSG",ItemDate:a,SrcUserId:profileUserID,Src:'"'+profileName+'"',DstUserId:i.identity,Dst:"",MessageData:t};if(o.DataCollection.push(s),o.TotalRows=o.DataCollection.length,localDB.setItem(e+"-stream",JSON.stringify(o)),"extension"==i.type){var l=SIP.UserAgent.makeURI("sip:"+i.ExtNo.replace(/#/g,"%23")+"@"+SipDomain);console.log("MESSAGE: "+l+" (extension)");var r={requestDelegate:{onAccept:function(e){console.log("Message Accepted:",n),MarkMessageSent(i,n,!0)},onReject:function(e){console.warn("Message Error",e.message.reasonPhrase),MarkMessageNotSent(i,n,!0)}},requestOptions:{extraHeaders:[]}},d=new SIP.Messager(userAgent,l,t,"text/plain");d.message(r).then(function(){"undefined"!=typeof web_hook_on_message&&web_hook_on_message(d)})}"xmpp"==i.type&&(console.log("MESSAGE: "+i.jid+" (xmpp)"),XmppSendMessage(i,t,n),"undefined"!=typeof web_hook_on_message&&web_hook_on_message(t)),i.type,$("#contact-"+e+"-ChatMessage").val(""),$("#contact-"+e+"-dictate-message").hide(),$("#contact-"+e+"-emoji-menu").hide(),$("#contact-"+e+"-ChatMessage").focus(),null!=i.recognition&&(i.recognition.abort(),i.recognition=null),UpdateBuddyActivity(e),RefreshStream(i)}else Alert(lang.alert_empty_text_message,lang.no_message)}}function MarkMessageSent(e,t,n){var i=JSON.parse(localDB.getItem(e.identity+"-stream"));null==i&&null==i.DataCollection||($.each(i.DataCollection,function(e,n){if("MSG"==n.ItemType&&n.ItemId==t)return n.Sent=!0,!1}),localDB.setItem(e.identity+"-stream",JSON.stringify(i)),n&&RefreshStream(e))}function MarkMessageNotSent(e,t,n){var i=JSON.parse(localDB.getItem(e.identity+"-stream"));null==i&&null==i.DataCollection||($.each(i.DataCollection,function(e,n){if("MSG"==n.ItemType&&n.ItemId==t)return n.Sent=!1,!1}),localDB.setItem(e.identity+"-stream",JSON.stringify(i)),n&&RefreshStream(e))}function MarkDeliveryReceipt(e,t,n){var i=JSON.parse(localDB.getItem(e.identity+"-stream"));null==i&&null==i.DataCollection||($.each(i.DataCollection,function(e,n){if("MSG"==n.ItemType&&n.ItemId==t)return n.Delivered={state:!0,eventTime:utcDateNow()},!1}),localDB.setItem(e.identity+"-stream",JSON.stringify(i)),n&&RefreshStream(e))}function MarkDisplayReceipt(e,t,n){var i=JSON.parse(localDB.getItem(e.identity+"-stream"));null==i&&null==i.DataCollection||($.each(i.DataCollection,function(e,n){if("MSG"==n.ItemType&&n.ItemId==t)return n.Displayed={state:!0,eventTime:utcDateNow()},!1}),localDB.setItem(e.identity+"-stream",JSON.stringify(i)),n&&RefreshStream(e))}function MarkMessageRead(e,t){var n=JSON.parse(localDB.getItem(e.identity+"-stream"));null==n&&null==n.DataCollection||($.each(n.DataCollection,function(e,n){"MSG"==n.ItemType&&n.ItemId==t&&(n.Read={state:!0,eventTime:utcDateNow()})}),localDB.setItem(e.identity+"-stream",JSON.stringify(n)),console.log("Set message ("+t+") as Read"))}function ReceiveOutOfDialogMessage(e){var t=e.request.from.displayName,n=e.request.from.uri.normal.user,i=e.request.headers["Content-Type"].length>=1?e.request.headers["Content-Type"][0].parsed:"Unknown";if(i.indexOf("text/plain")>-1){if(console.log("New Incoming Message!",'"'+t+'" <'+n+">"),n.length>DidLength)return void console.warn("DID length greater then extensions length");var a=countSessions("0"),o=FindBuddyByDid(n);if(null==o){var s=JSON.parse(localDB.getItem(profileUserID+"-Buddies"));null==s&&(s=InitUserBuddies());var l=uID(),r=utcDateNow();s.DataCollection.push({Type:"extension",LastActivity:r,ExtensionNumber:n,MobileNumber:"",ContactNumber1:"",ContactNumber2:"",uID:l,cID:null,gID:null,jid:null,DisplayName:t,Description:"",Email:"",MemberCount:0,EnableDuringDnd:!1,Subscribe:!1}),o=new Buddy("extension",l,t,n,"","","",r,"","",jid,!1,!1),AddBuddy(o,!0,0==a,!1,tue),s.TotalRows=s.DataCollection.length,localDB.setItem(profileUserID+"-Buddies",JSON.stringify(s))}var d=e.request.body,c=uID(),u=utcDateNow();e.accept(),AddMessageToStream(o,c,"MSG",d,u),UpdateBuddyActivity(o.identity),RefreshStream(o),ActivateStream(o,d)}else i.indexOf("application/simple-message-summary")>-1?(console.warn("This message-summary is unsolicited (out-of-dialog). Consider using the SUBSCRIBE method."),VoicemailNotify(e)):(console.warn("Unknown Out Of Dialog Message Type: ",i),e.reject());"undefined"!=typeof web_hook_on_message&&web_hook_on_message(e)}function AddMessageToStream(e,t,n,i,a){var o=JSON.parse(localDB.getItem(e.identity+"-stream"));null==o&&(o=InitialiseStream(e.identity));var s={ItemId:t,ItemType:n,ItemDate:a,SrcUserId:e.identity,Src:'"'+e.CallerIDName+'"',DstUserId:profileUserID,Dst:"",MessageData:i};o.DataCollection.push(s),o.TotalRows=o.DataCollection.length,localDB.setItem(e.identity+"-stream",JSON.stringify(o)),MaxDataStoreDays&&MaxDataStoreDays>0&&(console.log("Cleaning up data: ",MaxDataStoreDays),RemoveBuddyMessageStream(FindBuddyByIdentity(buddy),MaxDataStoreDays))}function ActivateStream(e,t){var n=$("#stream-"+e.identity).is(":visible");if(!n){if(IncreaseMissedBadge(e.identity),"Notification"in window&&"granted"===Notification.permission){var i=getPicture(e.identity),a={body:t.substring(0,250),icon:i},o=new Notification(lang.message_from+" : "+e.CallerIDName,a);o.onclick=function(t){SelectBuddy(e.identity)}}console.log("Audio:",audioBlobs.Alert.url);var s=new Audio(audioBlobs.Alert.blob);s.preload="auto",s.loop=!1,s.oncanplaythrough=function(e){void 0!==s.sinkId&&"default"!=getRingerOutputID()&&s.setSinkId(getRingerOutputID()).then(function(){console.log("Set sinkId to:",getRingerOutputID())}).catch(function(e){console.warn("Failed not apply setSinkId.",e)}),s.play().then(function(){}).catch(function(e){console.warn("Unable to play audio file.",e)})}}}function AddCallMessage(e,t){var n=JSON.parse(localDB.getItem(e+"-stream"));null==n&&(n=InitialiseStream(e));var i=moment.utc(),a=0,o=0,s=0,l=moment.utc(t.data.callstart.replace(" UTC","")),r=null;t.data.startTime?(r=moment.utc(t.data.startTime),a=moment.duration(i.diff(r)),s=moment.duration(r.diff(l))):s=moment.duration(i.diff(l)),o=moment.duration(i.diff(l));var d="",c="",u="",p="";"inbound"==t.data.calldirection?(d=e,u=profileUserID,c=t.remoteIdentity.displayName,p=profileName):"outbound"==t.data.calldirection&&(d=profileUserID,u=e,c=profileName,p=t.data.dst);var g=t.data.calldirection,m=t.data.withvideo,f=t.id,v=t.data.terminateby,b={CdrId:uID(),ItemType:"CDR",ItemDate:l.format("YYYY-MM-DD HH:mm:ss UTC"),CallAnswer:r?r.format("YYYY-MM-DD HH:mm:ss UTC"):null,CallEnd:i.format("YYYY-MM-DD HH:mm:ss UTC"),SrcUserId:d,Src:c,DstUserId:u,Dst:p,RingTime:0!=s?s.asSeconds():0,Billsec:0!=a?a.asSeconds():0,TotalDuration:0!=o?o.asSeconds():0,ReasonCode:t.data.reasonCode,ReasonText:t.data.reasonText,WithVideo:m,SessionId:f,CallDirection:g,Terminate:v,MessageData:null,Tags:[],Transfers:t.data.transfer?t.data.transfer:[],Mutes:t.data.mute?t.data.mute:[],Holds:t.data.hold?t.data.hold:[],Recordings:t.data.recordings?t.data.recordings:[],ConfCalls:t.data.confcalls?t.data.confcalls:[],ConfbridgeEvents:t.data.ConfbridgeEvents?t.data.ConfbridgeEvents:[],QOS:[]};console.log("New CDR",b),n.DataCollection.push(b),n.TotalRows=n.DataCollection.length,localDB.setItem(e+"-stream",JSON.stringify(n)),UpdateBuddyActivity(e),MaxDataStoreDays&&MaxDataStoreDays>0&&(console.log("Cleaning up data: ",MaxDataStoreDays),RemoveBuddyMessageStream(FindBuddyByIdentity(e),MaxDataStoreDays))}function SendImageDataMessage(e,t){if(null!=userAgent&&userAgent.isRegistered()){var n=moment.utc().format("YYYY-MM-DD HH:mm:ss UTC"),i='<IMG class=previewImage onClick="PreviewImage(this)" src="'+t+'">',a='<table class=ourChatMessage cellspacing=0 cellpadding=0><tr><td style="width: 80px"><div class=messageDate>'+n+"</div></td><td><div class=ourChatMessageText>"+i+"</div></td></tr></table>";$("#contact-"+e+"-ChatHistory").append(a),updateScroll(e),ImageEditor_Cancel(e),UpdateBuddyActivity(e)}}function SendFileDataMessage(e,t,n,i){if(null!=userAgent&&userAgent.isRegistered()){var a=uID();$.ajax({type:"POST",url:"/api/",data:"<XML>"+t+"</XML>",xhr:function(t){var n=$.ajaxSettings.xhr();return n.upload&&n.upload.addEventListener("progress",function(t){var n=t.loaded/t.total*100;console.log("Progress for upload to "+e+" ("+a+"):"+n),$("#FileProgress-Bar-"+a).css("width",n+"%")},!1),n},success:function(e,t,n){$("#FileUpload-"+a).html("Sent"),$("#FileProgress-"+a).hide(),$("#FileProgress-Bar-"+a).css("width","0%")},error:function(e,t,n){$("#FileUpload-"+a).html("Failed ("+e.status+")"),$("#FileProgress-"+a).hide(),$("#FileProgress-Bar-"+a).css("width","100%")}});var o=utcDateNow(),s=!1,l='<i class="fa fa-file"></i>';n.toLowerCase().endsWith(".png")&&(l='<i class="fa fa-file-image-o"></i>',s=!0),n.toLowerCase().endsWith(".jpg")&&(l='<i class="fa fa-file-image-o"></i>',s=!0),n.toLowerCase().endsWith(".jpeg")&&(l='<i class="fa fa-file-image-o"></i>',s=!0),n.toLowerCase().endsWith(".bmp")&&(l='<i class="fa fa-file-image-o"></i>',s=!0),n.toLowerCase().endsWith(".gif")&&(l='<i class="fa fa-file-image-o"></i>',s=!0),n.toLowerCase().endsWith(".mov")&&(l='<i class="fa fa-file-video-o"></i>'),n.toLowerCase().endsWith(".avi")&&(l='<i class="fa fa-file-video-o"></i>'),n.toLowerCase().endsWith(".mpeg")&&(l='<i class="fa fa-file-video-o"></i>'),n.toLowerCase().endsWith(".mp4")&&(l='<i class="fa fa-file-video-o"></i>'),n.toLowerCase().endsWith(".mvk")&&(l='<i class="fa fa-file-video-o"></i>'),n.toLowerCase().endsWith(".webm")&&(l='<i class="fa fa-file-video-o"></i>'),n.toLowerCase().endsWith(".wav")&&(l='<i class="fa fa-file-audio-o"></i>'),n.toLowerCase().endsWith(".mp3")&&(l='<i class="fa fa-file-audio-o"></i>'),n.toLowerCase().endsWith(".ogg")&&(l='<i class="fa fa-file-audio-o"></i>'),n.toLowerCase().endsWith(".zip")&&(l='<i class="fa fa-file-archive-o"></i>'),n.toLowerCase().endsWith(".rar")&&(l='<i class="fa fa-file-archive-o"></i>'),n.toLowerCase().endsWith(".tar.gz")&&(l='<i class="fa fa-file-archive-o"></i>'),n.toLowerCase().endsWith(".pdf")&&(l='<i class="fa fa-file-pdf-o"></i>');var r='<DIV><SPAN id="FileUpload-'+a+'">Sending</SPAN>: '+l+" "+n+"</DIV>";r+='<DIV id="FileProgress-'+a+'" class="progressBarContainer"><DIV id="FileProgress-Bar-'+a+'" class="progressBarTrack"></DIV></DIV>',s&&(r+='<DIV><IMG class=previewImage onClick="PreviewImage(this)" src="'+t+'"></DIV>');var d='<table class=ourChatMessage cellspacing=0 cellpadding=0><tr><td style="width: 80px"><div class=messageDate>'+o+"</div></td><td><div class=ourChatMessageText>"+r+"</div></td></tr></table>";$("#contact-"+e+"-ChatHistory").append(d),updateScroll(e),ImageEditor_Cancel(e),UpdateBuddyActivity(e)}}function updateLineScroll(e){RefreshLineActivity(e);var t=$("#line-"+e+"-CallDetails").get(0);t&&(t.scrollTop=t.scrollHeight)}function updateScroll(e){var t=$("#contact-"+e+"-ChatHistory");t.children().length>0&&t.children().last().get(0).scrollIntoView(!1),t.get(0).scrollTop=t.get(0).scrollHeight}function PreviewImage(e){OpenWindow(e.src,"Preview Image",600,800,!1,!0)}function IncreaseMissedBadge(e){var t=FindBuddyByIdentity(e);if(null!=t){t.missed+=1;var n=JSON.parse(localDB.getItem(profileUserID+"-Buddies"));null!=n&&($.each(n.DataCollection,function(t,n){if(n.uID==e||n.cID==e||n.gID==e)return n.missed=n.missed+1,!1}),localDB.setItem(profileUserID+"-Buddies",JSON.stringify(n))),$("#contact-"+e+"-missed").text(t.missed),$("#contact-"+e+"-missed").show(),"undefined"!=typeof web_hook_on_missed_notify&&web_hook_on_missed_notify(t.missed),console.log("Set Missed badge for "+t.CallerIDName+" to: "+t.missed)}}function UpdateBuddyActivity(e,t){var n=FindBuddyByIdentity(e);if(null!=n){if(t)n.lastActivity=t;else{var i=utcDateNow();n.lastActivity=i}console.log("Last Activity for "+n.CallerIDName+" is now: "+n.lastActivity);var a=JSON.parse(localDB.getItem(profileUserID+"-Buddies"));null!=a&&($.each(a.DataCollection,function(t,n){if(n.uID==e||n.cID==e||n.gID==e)return n.LastActivity=i,!1}),localDB.setItem(profileUserID+"-Buddies",JSON.stringify(a))),UpdateBuddyList()}}function ClearMissedBadge(e){var t=FindBuddyByIdentity(e);if(null!=t){
t.missed=0;var n=JSON.parse(localDB.getItem(profileUserID+"-Buddies"));null!=n&&($.each(n.DataCollection,function(t,n){if(n.uID==e||n.cID==e||n.gID==e)return n.missed=0,!1}),localDB.setItem(profileUserID+"-Buddies",JSON.stringify(n))),$("#contact-"+e+"-missed").text(t.missed),$("#contact-"+e+"-missed").hide(400),"undefined"!=typeof web_hook_on_missed_notify&&web_hook_on_missed_notify(t.missed)}}function VideoCall(e,t,n){if(null!=userAgent&&userAgent.isRegistered()&&null!=e)if(0!=HasAudioDevice){if(0==HasVideoDevice)return console.warn("No video devices (webcam) found, switching to audio call."),void AudioCall(e,t);var i=navigator.mediaDevices.getSupportedConstraints(),a={earlyMedia:!0,sessionDescriptionHandlerOptions:{constraints:{audio:{deviceId:"default"},video:{deviceId:"default"}}}},o=getAudioSrcID();if("default"!=o){for(var s=!1,l=0;l<AudioinputDevices.length;++l)if(o==AudioinputDevices[l].deviceId){s=!0;break}s?a.sessionDescriptionHandlerOptions.constraints.audio.deviceId={exact:o}:(console.warn("The audio device you used before is no longer available, default settings applied."),localDB.setItem("AudioSrcId","default"))}i.autoGainControl&&(a.sessionDescriptionHandlerOptions.constraints.audio.autoGainControl=AutoGainControl),i.echoCancellation&&(a.sessionDescriptionHandlerOptions.constraints.audio.echoCancellation=EchoCancellation),i.noiseSuppression&&(a.sessionDescriptionHandlerOptions.constraints.audio.noiseSuppression=NoiseSuppression);var r=getVideoSrcID();if("default"!=r){var d=!1;for(l=0;l<VideoinputDevices.length;++l)if(r==VideoinputDevices[l].deviceId){d=!0;break}d?a.sessionDescriptionHandlerOptions.constraints.video.deviceId={exact:r}:(console.warn("The video device you used before is no longer available, default settings applied."),localDB.setItem("VideoSrcId","default"))}i.frameRate&&""!=maxFrameRate&&(a.sessionDescriptionHandlerOptions.constraints.video.frameRate=maxFrameRate),i.height&&""!=videoHeight&&(a.sessionDescriptionHandlerOptions.constraints.video.height=videoHeight),i.aspectRatio&&""!=videoAspectRatio&&(a.sessionDescriptionHandlerOptions.constraints.video.aspectRatio=videoAspectRatio),n&&(a.extraHeaders=n),$("#line-"+e.LineNumber+"-msg").html(lang.starting_video_call),$("#line-"+e.LineNumber+"-timer").show();var c=moment.utc();console.log("INVITE (video): "+t+"@"+SipDomain);var u=SIP.UserAgent.makeURI("sip:"+t.replace(/#/g,"%23")+"@"+SipDomain);e.SipSession=new SIP.Inviter(userAgent,u,a),e.SipSession.data={},e.SipSession.data.line=e.LineNumber,e.SipSession.data.buddyId=e.BuddyObj.identity,e.SipSession.data.calldirection="outbound",e.SipSession.data.dst=t,e.SipSession.data.callstart=c.format("YYYY-MM-DD HH:mm:ss UTC"),e.SipSession.data.callTimer=window.setInterval(function(){var t=moment.utc(),n=moment.duration(t.diff(c)),i=formatShortDuration(n.asSeconds());$("#line-"+e.LineNumber+"-timer").html(i),$("#line-"+e.LineNumber+"-datetime").html(i)},1e3),e.SipSession.data.VideoSourceDevice=getVideoSrcID(),e.SipSession.data.AudioSourceDevice=getAudioSrcID(),e.SipSession.data.AudioOutputDevice=getAudioOutputID(),e.SipSession.data.terminateby="them",e.SipSession.data.withvideo=!0,e.SipSession.data.earlyReject=!1,e.SipSession.isOnHold=!1,e.SipSession.delegate={onBye:function(t){onSessionReceivedBye(e,t)},onMessage:function(t){onSessionReceivedMessage(e,t)},onInvite:function(t){onSessionReinvited(e,t)},onSessionDescriptionHandler:function(t,n){onSessionDescriptionHandlerCreated(e,t,n,!0)}};var p={requestDelegate:{onTrying:function(t){onInviteTrying(e,t)},onProgress:function(t){onInviteProgress(e,t)},onRedirect:function(t){onInviteRedirected(e,t)},onAccept:function(t){onInviteAccepted(e,!0,t)},onReject:function(t){onInviteRejected(e,t)}}};e.SipSession.invite(p).catch(function(e){console.warn("Failed to send INVITE:",e)}),$("#line-"+e.LineNumber+"-btn-settings").removeAttr("disabled"),$("#line-"+e.LineNumber+"-btn-audioCall").prop("disabled","disabled"),$("#line-"+e.LineNumber+"-btn-videoCall").prop("disabled","disabled"),$("#line-"+e.LineNumber+"-btn-search").removeAttr("disabled"),$("#line-"+e.LineNumber+"-progress").show(),$("#line-"+e.LineNumber+"-msg").show(),UpdateUI(),UpdateBuddyList(),updateLineScroll(e.LineNumber),"undefined"!=typeof web_hook_on_invite&&web_hook_on_invite(e.SipSession)}else Alert(lang.alert_no_microphone)}function AudioCallMenu(e,t){var n=FindBuddyByIdentity(e);if(null!=n){var i=[];if("extension"==n.type||"xmpp"==n.type?(i.push({icon:"fa fa-phone-square",text:lang.call_extension+" ("+n.ExtNo+")",value:n.ExtNo}),null!=n.MobileNumber&&""!=n.MobileNumber&&i.push({icon:"fa fa-mobile",text:lang.call_mobile+" ("+n.MobileNumber+")",value:n.MobileNumber}),null!=n.ContactNumber1&&""!=n.ContactNumber1&&i.push({icon:"fa fa-phone",text:lang.call_number+" ("+n.ContactNumber1+")",value:n.ContactNumber1}),null!=n.ContactNumber2&&""!=n.ContactNumber2&&i.push({icon:"fa fa-phone",text:lang.call_number+" ("+n.ContactNumber2+")",value:n.ContactNumber2})):"contact"==n.type?(null!=n.MobileNumber&&""!=n.MobileNumber&&i.push({icon:"fa fa-mobile",text:lang.call_mobile+" ("+n.MobileNumber+")",value:n.MobileNumber}),null!=n.ContactNumber1&&""!=n.ContactNumber1&&i.push({icon:"fa fa-phone",text:lang.call_number+" ("+n.ContactNumber1+")",value:n.ContactNumber1}),null!=n.ContactNumber2&&""!=n.ContactNumber2&&i.push({icon:"fa fa-phone",text:lang.call_number+" ("+n.ContactNumber2+")",value:n.ContactNumber2})):"group"==n.type&&null!=n.MobileNumber&&""!=n.MobileNumber&&i.push({icon:"fa fa-users",text:lang.call_group,value:n.ExtNo}),0==i.length)return console.error("No numbers to dial"),void EditBuddyWindow(e);if(1==i.length)console.log("Automatically calling only number - AudioCall("+e+", "+i[0].value+")"),DialByLine("audio",e,i[0].value);else{var a={selectEvent:function(t,n){var i=n.item.attr("value");HidePopup(),null!=i&&(console.log("Menu click AudioCall("+e+", "+i+")"),DialByLine("audio",e,i))},createEvent:null,autoFocus:!0,items:i};PopupMenu(t,a)}}}function AudioCall(e,t,n){if(null!=userAgent&&0!=userAgent.isRegistered()&&null!=e)if(0!=HasAudioDevice){var i=navigator.mediaDevices.getSupportedConstraints(),a={earlyMedia:!0,sessionDescriptionHandlerOptions:{constraints:{audio:{deviceId:"default"},video:!1}}},o=getAudioSrcID();if("default"!=o){for(var s=!1,l=0;l<AudioinputDevices.length;++l)if(o==AudioinputDevices[l].deviceId){s=!0;break}s?a.sessionDescriptionHandlerOptions.constraints.audio.deviceId={exact:o}:(console.warn("The audio device you used before is no longer available, default settings applied."),localDB.setItem("AudioSrcId","default"))}i.autoGainControl&&(a.sessionDescriptionHandlerOptions.constraints.audio.autoGainControl=AutoGainControl),i.echoCancellation&&(a.sessionDescriptionHandlerOptions.constraints.audio.echoCancellation=EchoCancellation),i.noiseSuppression&&(a.sessionDescriptionHandlerOptions.constraints.audio.noiseSuppression=NoiseSuppression),n&&(a.extraHeaders=n),$("#line-"+e.LineNumber+"-msg").html(lang.starting_audio_call),$("#line-"+e.LineNumber+"-timer").show();var r=moment.utc();console.log("INVITE (audio): "+t+"@"+SipDomain);var d=SIP.UserAgent.makeURI("sip:"+t.replace(/#/g,"%23")+"@"+SipDomain);e.SipSession=new SIP.Inviter(userAgent,d,a),e.SipSession.data={},e.SipSession.data.line=e.LineNumber,e.SipSession.data.buddyId=e.BuddyObj.identity,e.SipSession.data.calldirection="outbound",e.SipSession.data.dst=t,e.SipSession.data.callstart=r.format("YYYY-MM-DD HH:mm:ss UTC"),e.SipSession.data.callTimer=window.setInterval(function(){var t=moment.utc(),n=moment.duration(t.diff(r)),i=formatShortDuration(n.asSeconds());$("#line-"+e.LineNumber+"-timer").html(i),$("#line-"+e.LineNumber+"-datetime").html(i)},1e3),e.SipSession.data.VideoSourceDevice=null,e.SipSession.data.AudioSourceDevice=getAudioSrcID(),e.SipSession.data.AudioOutputDevice=getAudioOutputID(),e.SipSession.data.terminateby="them",e.SipSession.data.withvideo=!1,e.SipSession.data.earlyReject=!1,e.SipSession.isOnHold=!1,e.SipSession.delegate={onBye:function(t){onSessionReceivedBye(e,t)},onMessage:function(t){onSessionReceivedMessage(e,t)},onInvite:function(t){onSessionReinvited(e,t)},onSessionDescriptionHandler:function(t,n){onSessionDescriptionHandlerCreated(e,t,n,!1)}};var c={requestDelegate:{onTrying:function(t){onInviteTrying(e,t)},onProgress:function(t){onInviteProgress(e,t)},onRedirect:function(t){onInviteRedirected(e,t)},onAccept:function(t){onInviteAccepted(e,!1,t)},onReject:function(t){onInviteRejected(e,t)}}};e.SipSession.invite(c).catch(function(e){console.warn("Failed to send INVITE:",e)}),$("#line-"+e.LineNumber+"-btn-settings").removeAttr("disabled"),$("#line-"+e.LineNumber+"-btn-audioCall").prop("disabled","disabled"),$("#line-"+e.LineNumber+"-btn-videoCall").prop("disabled","disabled"),$("#line-"+e.LineNumber+"-btn-search").removeAttr("disabled"),$("#line-"+e.LineNumber+"-progress").show(),$("#line-"+e.LineNumber+"-msg").show(),UpdateUI(),UpdateBuddyList(),updateLineScroll(e.LineNumber),"undefined"!=typeof web_hook_on_invite&&web_hook_on_invite(e.SipSession)}else Alert(lang.alert_no_microphone)}function getSession(e){if(null==userAgent)return console.warn("userAgent is null"),null;if(0==userAgent.isRegistered())return console.warn("userAgent is not registered"),null;var t=null;return $.each(userAgent.sessions,function(n,i){if(i.data.buddyId==e)return t=i,!1}),t}function countSessions(e){var t=0;return null==userAgent?(console.warn("userAgent is null"),0):($.each(userAgent.sessions,function(n,i){e!=i.id&&t++}),t)}function StartRecording(e){if("disabled"!=CallRecordingPolicy){var t=FindLineByNumber(e);if(null!=t){$("#line-"+t.LineNumber+"-btn-start-recording").hide(),$("#line-"+t.LineNumber+"-btn-stop-recording").show();var n=t.SipSession;if(null!=n){var i=uID();n.data.recordings||(n.data.recordings=[]),n.data.recordings.push({uID:i,startTime:utcDateNow(),stopTime:utcDateNow()}),n.data.mediaRecorder&&"recording"==n.data.mediaRecorder.state&&(console.warn("Call Recording was somehow on... stopping call recording"),StopRecording(e,!0)),console.log("Creating call recorder..."),n.data.recordingAudioStreams=new MediaStream;var a=n.sessionDescriptionHandler.peerConnection;if(a.getSenders().forEach(function(e){e.track&&"audio"==e.track.kind&&(console.log("Adding sender audio track to record:",e.track.label),n.data.recordingAudioStreams.addTrack(e.track))}),a.getReceivers().forEach(function(e){e.track&&"audio"==e.track.kind&&(console.log("Adding receiver audio track to record:",e.track.label),n.data.recordingAudioStreams.addTrack(e.track))}),n.data.withvideo){var o=640,s=360,l=100;"HD"==RecordingVideoSize&&(o=1280,s=720,l=144),"FHD"==RecordingVideoSize&&(o=1920,s=1080,l=240),n.data.recordingCanvas=$("<canvas/>").get(0),n.data.recordingCanvas.width="side-by-side"==RecordingLayout?2*o+5:o,n.data.recordingCanvas.height=s,n.data.recordingContext=n.data.recordingCanvas.getContext("2d"),window.clearInterval(n.data.recordingRedrawInterval),n.data.recordingRedrawInterval=window.setInterval(function(){var e=$("#line-"+t.LineNumber+"-localVideo").get(0),i=null,a=[],r=[],d=$("#line-"+t.LineNumber+"-remote-videos"),c=d.find("video").length;0==c||(1==c?i=d.find("video")[0]:c>1&&(d.find("video").each(function(e,t){var n=t.srcObject.getVideoTracks()[0];"live"==n.readyState&&t.videoWidth>10&&t.videoHeight>=10&&(1==t.srcObject.isPinned&&(i=t),1==t.srcObject.isTalking&&r.push(t),a.push(t))}),null==i&&r.length>=1&&(i=r[0]),null==i&&a.length>=1&&(i=a[0])));var u=i&&i.videoWidth>0?i.videoWidth:o,p=i&&i.videoHeight>0?i.videoHeight:s;if(u>=p){var g=o/u;if(u=o,p*=g,p>s){g=s/p;p=s,u*=g}}else{g=s/p;p=s,u*=g}var m=u<o?(o-u)/2:0,f=p<s?(s-p)/2:0;"side-by-side"==RecordingLayout&&(m=o+5+m);var v=e.videoHeight,b=e.videoWidth;if(v>0)if(b>=v){g=l/v;v=l,b*=g}else{g=l/b;b=l,v*=g}var h=10,S=10;if("side-by-side"==RecordingLayout){if(b=e.videoWidth,v=e.videoHeight,b>=v){g=o/b;if(b=o,v*=g,v>s){g=s/v;v=s,b*=g}}else{g=s/v;v=s,b*=g}h=b<o?(o-b)/2:0,S=v<s?(s-v)/2:0}n.data.recordingContext.fillRect(0,0,n.data.recordingCanvas.width,n.data.recordingCanvas.height),i&&i.videoHeight>0&&n.data.recordingContext.drawImage(i,m,f,u,p),e.videoHeight>0&&("side-by-side"==RecordingLayout||"them-pnp"==RecordingLayout)&&n.data.recordingContext.drawImage(e,h,S,b,v)},Math.floor(1e3/RecordingVideoFps)),n.data.recordingVideoMediaStream=n.data.recordingCanvas.captureStream(RecordingVideoFps)}n.data.recordingMixedAudioVideoRecordStream=new MediaStream,n.data.recordingMixedAudioVideoRecordStream.addTrack(MixAudioStreams(n.data.recordingAudioStreams).getAudioTracks()[0]),n.data.withvideo&&n.data.recordingMixedAudioVideoRecordStream.addTrack(n.data.recordingVideoMediaStream.getVideoTracks()[0]);n.data.withvideo&&"video/webm";n.data.mediaRecorder=new MediaRecorder(n.data.recordingMixedAudioVideoRecordStream),n.data.mediaRecorder.data={},n.data.mediaRecorder.data.id=""+i,n.data.mediaRecorder.data.sessionId=""+n.id,n.data.mediaRecorder.data.buddyId=""+t.BuddyObj.identity,n.data.mediaRecorder.ondataavailable=function(e){console.log("Got Call Recording Data: ",e.data.size+"Bytes",this.data.id,this.data.buddyId,this.data.sessionId),SaveCallRecording(e.data,this.data.id,this.data.buddyId,this.data.sessionId)},console.log("Starting Call Recording",i),n.data.mediaRecorder.start(),n.data.recordings[n.data.recordings.length-1].startTime=utcDateNow(),$("#line-"+t.LineNumber+"-msg").html(lang.call_recording_started),updateLineScroll(e)}else console.warn("Could not find session")}}else console.warn("Policy Disabled: Call Recording")}function SaveCallRecording(e,t,n,i){var a=window.indexedDB,o=a.open("CallRecordings",1);o.onerror=function(e){console.error("IndexDB Request Error:",e)},o.onupgradeneeded=function(e){console.warn("Upgrade Required for IndexDB... probably because of first time use.");var t=e.target.result;if(0==t.objectStoreNames.contains("Recordings")){var n=t.createObjectStore("Recordings",{keyPath:"uID"});n.createIndex("sessionid","sessionid",{unique:!1}),n.createIndex("bytes","bytes",{unique:!1}),n.createIndex("type","type",{unique:!1}),n.createIndex("mediaBlob","mediaBlob",{unique:!1})}else console.warn("IndexDB requested upgrade, but object store was in place.")},o.onsuccess=function(a){console.log("IndexDB connected to CallRecordings");var o=a.target.result;if(0==o.objectStoreNames.contains("Recordings"))return console.warn("IndexDB CallRecordings.Recordings does not exists, this call recoding will not be saved."),o.close(),void window.indexedDB.deleteDatabase("CallRecordings");o.onerror=function(e){console.error("IndexDB Error:",e)};var s={uID:t,sessionid:i,bytes:e.size,type:e.type,mediaBlob:e},l=o.transaction(["Recordings"],"readwrite"),r=l.objectStore("Recordings").add(s);r.onsuccess=function(a){console.log("Call Recording Success: ",t,e.size,e.type,n,i)}}}function StopRecording(e,t){var n=FindLineByNumber(e);if(null!=n&&null!=n.SipSession){var i=n.SipSession;if(1==t)return $("#line-"+n.LineNumber+"-btn-start-recording").show(),$("#line-"+n.LineNumber+"-btn-stop-recording").hide(),void(i.data.mediaRecorder&&("recording"==i.data.mediaRecorder.state?(console.log("Stopping Call Recording"),i.data.mediaRecorder.stop(),i.data.recordings[i.data.recordings.length-1].stopTime=utcDateNow(),window.clearInterval(i.data.recordingRedrawInterval),$("#line-"+n.LineNumber+"-msg").html(lang.call_recording_stopped),updateLineScroll(e)):console.warn("Recorder is in an unknown state")));"enabled"!=CallRecordingPolicy?Confirm(lang.confirm_stop_recording,lang.stop_recording,function(){StopRecording(e,!0)}):console.warn("Policy Enabled: Call Recording")}}function PlayAudioCallRecording(e,t,n){var i=$(e).parent();i.empty();var a=new Audio;a.autoplay=!1,a.controls=!0;var o=getAudioOutputID();void 0!==a.sinkId?a.setSinkId(o).then(function(){console.log("sinkId applied: "+o)}).catch(function(e){console.warn("Error using setSinkId: ",e)}):console.warn("setSinkId() is not possible using this browser."),i.append(a);var s=window.indexedDB,l=s.open("CallRecordings",1);l.onerror=function(e){console.error("IndexDB Request Error:",e)},l.onupgradeneeded=function(e){console.warn("Upgrade Required for IndexDB... probably because of first time use.")},l.onsuccess=function(e){console.log("IndexDB connected to CallRecordings");var i=e.target.result;if(0!=i.objectStoreNames.contains("Recordings")){var o=i.transaction(["Recordings"]),s=o.objectStore("Recordings").get(n);s.onerror=function(e){console.error("IndexDB Get Error:",e)},s.onsuccess=function(e){$("#cdr-media-meta-size-"+t+"-"+n).html(" Size: "+formatBytes(e.target.result.bytes)),$("#cdr-media-meta-codec-"+t+"-"+n).html(" Codec: "+e.target.result.type),a.src=window.URL.createObjectURL(e.target.result.mediaBlob),a.oncanplaythrough=function(){a.play().then(function(){console.log("Playback started")}).catch(function(e){console.error("Error playing back file: ",e)})}}}else console.warn("IndexDB CallRecordings.Recordings does not exists")}}function PlayVideoCallRecording(e,t,n,i){var a=$(e).parent();a.empty();var o=$("<video>").get(0);o.id="callrecording-video-"+t,o.autoplay=!1,o.controls=!0,o.playsinline=!0,o.ontimeupdate=function(e){$("#cdr-video-meta-width-"+t+"-"+n).html(lang.width+" : "+e.target.videoWidth+"px"),$("#cdr-video-meta-height-"+t+"-"+n).html(lang.height+" : "+e.target.videoHeight+"px")};var s=getAudioOutputID();void 0!==o.sinkId?o.setSinkId(s).then(function(){console.log("sinkId applied: "+s)}).catch(function(e){console.warn("Error using setSinkId: ",e)}):console.warn("setSinkId() is not possible using this browser."),a.append(o);var l=window.indexedDB,r=l.open("CallRecordings",1);r.onerror=function(e){console.error("IndexDB Request Error:",e)},r.onupgradeneeded=function(e){console.warn("Upgrade Required for IndexDB... probably because of first time use.")},r.onsuccess=function(e){console.log("IndexDB connected to CallRecordings");var a=e.target.result;if(0!=a.objectStoreNames.contains("Recordings")){var s=a.transaction(["Recordings"]),l=s.objectStore("Recordings").get(n);l.onerror=function(e){console.error("IndexDB Get Error:",e)},l.onsuccess=function(e){$("#cdr-media-meta-size-"+t+"-"+n).html(" Size: "+formatBytes(e.target.result.bytes)),$("#cdr-media-meta-codec-"+t+"-"+n).html(" Codec: "+e.target.result.type),o.src=window.URL.createObjectURL(e.target.result.mediaBlob),o.oncanplaythrough=function(){try{o.scrollIntoViewIfNeeded(!1)}catch(e){}o.play().then(function(){console.log("Playback started")}).catch(function(e){console.error("Error playing back file: ",e)}),i&&window.setTimeout(function(){var e=$("<canvas>").get(0),a=o.videoWidth,s=o.videoHeight;if(a>s){if(s>225){var l=225/s;s=225,a*=l}}else if(s>225){l=225/a;a=225,s*=l}e.width=a,e.height=s,e.getContext("2d").drawImage(o,0,0,a,s),e.toBlob(function(e){var o=new FileReader;o.readAsDataURL(e),o.onloadend=function(){var e={width:a,height:s,posterBase64:o.result};console.log("Capturing Video Poster...");var l=JSON.parse(localDB.getItem(i+"-stream"));null==l&&null==l.DataCollection||($.each(l.DataCollection,function(i,a){if("CDR"==a.ItemType&&a.CdrId==t)return a.Recordings&&a.Recordings.length>=1&&$.each(a.Recordings,function(t,i){i.uID==n&&(i.Poster=e)}),!1}),localDB.setItem(i+"-stream",JSON.stringify(l)),console.log("Capturing Video Poster, Done"))}},"image/jpeg",PosterJpegQuality)},1e3)}}}else console.warn("IndexDB CallRecordings.Recordings does not exists")}}function MixAudioStreams(e){var t=null;try{window.AudioContext=window.AudioContext||window.webkitAudioContext,t=new AudioContext}catch(t){return console.warn("AudioContext() not available, cannot record"),e}var n=t.createMediaStreamDestination();return e.getAudioTracks().forEach(function(e){var i=new MediaStream;i.addTrack(e);var a=t.createMediaStreamSource(i);a.connect(n)}),n.stream}function QuickFindBuddy(e){var t=e.value;if(""!=t){console.log("Find Buddy: ",t),Buddies.sort(function(e,t){return e.CallerIDName<t.CallerIDName?-1:e.CallerIDName>t.CallerIDName?1:0});for(var n=[],i=0,a=0;a<Buddies.length;a++){var o=Buddies[a],s=!1;if(o.CallerIDName&&o.CallerIDName.toLowerCase().indexOf(t.toLowerCase())>-1&&(s=!0),o.ExtNo&&o.ExtNo.toLowerCase().indexOf(t.toLowerCase())>-1&&(s=!0),o.Desc&&o.Desc.toLowerCase().indexOf(t.toLowerCase())>-1&&(s=!0),o.MobileNumber&&o.MobileNumber.toLowerCase().indexOf(t.toLowerCase())>-1&&(s=!0),o.ContactNumber1&&o.ContactNumber1.toLowerCase().indexOf(t.toLowerCase())>-1&&(s=!0),o.ContactNumber2&&o.ContactNumber2.toLowerCase().indexOf(t.toLowerCase())>-1&&(s=!0),s){var l="dotOffline";"Unknown"!=o.presence&&"Not online"!=o.presence&&"Unavailable"!=o.presence||(l="dotOffline"),"Ready"==o.presence&&(l="dotOnline"),"On the phone"!=o.presence&&"Proceeding"!=o.presence||(l="dotInUse"),"Ringing"==o.presence&&(l="dotRinging"),"On hold"==o.presence&&(l="dotOnHold"),i>0&&n.push({value:null,text:"-"}),n.push({value:null,text:o.CallerIDName,isHeader:!0}),""!=o.ExtNo&&n.push({icon:"fa fa-phone-square "+l,text:lang.extension+" ("+o.presence+"): "+o.ExtNo,value:o.ExtNo}),""!=o.MobileNumber&&n.push({icon:"fa fa-mobile",text:lang.mobile+": "+o.MobileNumber,value:o.MobileNumber}),""!=o.ContactNumber1&&n.push({icon:"fa fa-phone",text:lang.call+": "+o.ContactNumber1,value:o.ContactNumber1}),""!=o.ContactNumber2&&n.push({icon:"fa fa-phone",text:lang.call+": "+o.ContactNumber2,value:o.ContactNumber2}),i++}if(i>=5)break}if(n.length>1){var r={selectEvent:function(t,n){var i=n.item.attr("value");null==i&&HidePopup(),"null"!=i&&""!=i&&null!=i&&(HidePopup(),e.value=i)},createEvent:null,autoFocus:!1,items:n};PopupMenu(e,r)}else HidePopup()}}function StartTransferSession(e){$("#line-"+e+"-btn-CancelConference").is(":visible")?CancelConference(e):($("#line-"+e+"-btn-Transfer").hide(),$("#line-"+e+"-btn-CancelTransfer").show(),holdSession(e),$("#line-"+e+"-txt-FindTransferBuddy").val(""),$("#line-"+e+"-txt-FindTransferBuddy").parent().show(),$("#line-"+e+"-session-avatar").css("width","50px"),$("#line-"+e+"-session-avatar").css("height","50px"),RestoreCallControls(e),$("#line-"+e+"-btn-blind-transfer").show(),$("#line-"+e+"-btn-attended-transfer").show(),$("#line-"+e+"-btn-complete-transfer").hide(),$("#line-"+e+"-btn-cancel-transfer").hide(),$("#line-"+e+"-btn-complete-attended-transfer").hide(),$("#line-"+e+"-btn-cancel-attended-transfer").hide(),$("#line-"+e+"-btn-terminate-attended-transfer").hide(),$("#line-"+e+"-transfer-status").hide(),$("#line-"+e+"-Transfer").show(),updateLineScroll(e))}function CancelTransferSession(e){var t=FindLineByNumber(e);if(null!=t&&null!=t.SipSession){var n=t.SipSession;n.data.childsession&&(console.log("Child Transfer call detected:",n.data.childsession.state),n.data.childsession.dispose().then(function(){n.data.childsession=null}).catch(function(e){n.data.childsession=null})),$("#line-"+e+"-session-avatar").css("width",""),$("#line-"+e+"-session-avatar").css("height",""),$("#line-"+e+"-btn-Transfer").show(),$("#line-"+e+"-btn-CancelTransfer").hide(),unholdSession(e),$("#line-"+e+"-Transfer").hide(),updateLineScroll(e)}else console.warn("Null line or session")}function BlindTransfer(e){var t=$("#line-"+e+"-txt-FindTransferBuddy").val();if(t=EnableAlphanumericDial?t.replace(telAlphanumericRegEx,"").substring(0,MaxDidLength):t.replace(telNumericRegEx,"").substring(0,MaxDidLength),""!=t){var n=FindLineByNumber(e);if(null!=n&&null!=n.SipSession){var i=n.SipSession;i.data.transfer||(i.data.transfer=[]),i.data.transfer.push({type:"Blind",to:t,transferTime:utcDateNow(),disposition:"refer",dispositionTime:utcDateNow(),accept:{complete:null,eventTime:null,disposition:""}});var a=i.data.transfer.length-1,o={requestDelegate:{onAccept:function(t){console.log("Blind transfer Accepted"),i.data.terminateby="us",i.data.reasonCode=202,i.data.reasonText="Transfer",i.data.transfer[a].accept.complete=!0,i.data.transfer[a].accept.disposition=t.message.reasonPhrase,i.data.transfer[a].accept.eventTime=utcDateNow(),$("#line-"+e+"-msg").html("Call Blind Transferred (Accepted)"),updateLineScroll(e),i.bye().catch(function(e){console.warn("Could not BYE after blind transfer:",e)}),teardownSession(n)},onReject:function(t){console.warn("REFER rejected:",t),i.data.transfer[a].accept.complete=!1,i.data.transfer[a].accept.disposition=t.message.reasonPhrase,i.data.transfer[a].accept.eventTime=utcDateNow(),$("#line-"+e+"-msg").html("Call Blind Failed!"),updateLineScroll(e)}}};console.log("REFER: ",t+"@"+SipDomain);var s=SIP.UserAgent.makeURI("sip:"+t.replace(/#/g,"%23")+"@"+SipDomain);i.refer(s,o).catch(function(e){console.warn("Failed to REFER",e)}),$("#line-"+e+"-msg").html(lang.call_blind_transfered),updateLineScroll(e)}else console.warn("Null line or session")}else console.warn("Cannot transfer, no number")}function AttendedTransfer(e){var t=$("#line-"+e+"-txt-FindTransferBuddy").val();if(t=EnableAlphanumericDial?t.replace(telAlphanumericRegEx,"").substring(0,MaxDidLength):t.replace(telNumericRegEx,"").substring(0,MaxDidLength),""!=t){var n=FindLineByNumber(e);if(null!=n&&null!=n.SipSession){var i=n.SipSession;HidePopup(),$("#line-"+e+"-txt-FindTransferBuddy").parent().hide(),$("#line-"+e+"-btn-blind-transfer").hide(),$("#line-"+e+"-btn-attended-transfer").hide(),$("#line-"+e+"-btn-complete-attended-transfer").hide(),$("#line-"+e+"-btn-cancel-attended-transfer").hide(),$("#line-"+e+"-btn-terminate-attended-transfer").hide();var a=$("#line-"+e+"-transfer-status");a.html(lang.connecting),a.show(),i.data.transfer||(i.data.transfer=[]),i.data.transfer.push({type:"Attended",to:t,transferTime:utcDateNow(),disposition:"invite",dispositionTime:utcDateNow(),accept:{complete:null,eventTime:null,disposition:""}});var o=i.data.transfer.length-1;updateLineScroll(e);var s=navigator.mediaDevices.getSupportedConstraints(),l={earlyMedia:!0,sessionDescriptionHandlerOptions:{constraints:{audio:{deviceId:"default"},video:!1}}};"default"!=i.data.AudioSourceDevice&&(l.sessionDescriptionHandlerOptions.constraints.audio.deviceId={exact:i.data.AudioSourceDevice}),s.autoGainControl&&(l.sessionDescriptionHandlerOptions.constraints.audio.autoGainControl=AutoGainControl),s.echoCancellation&&(l.sessionDescriptionHandlerOptions.constraints.audio.echoCancellation=EchoCancellation),s.noiseSuppression&&(l.sessionDescriptionHandlerOptions.constraints.audio.noiseSuppression=NoiseSuppression),i.data.withvideo&&(l.sessionDescriptionHandlerOptions.constraints.video=!0,"default"!=i.data.VideoSourceDevice&&(l.sessionDescriptionHandlerOptions.constraints.video.deviceId={exact:i.data.VideoSourceDevice}),s.frameRate&&""!=maxFrameRate&&(l.sessionDescriptionHandlerOptions.constraints.video.frameRate=maxFrameRate),s.height&&""!=videoHeight&&(l.sessionDescriptionHandlerOptions.constraints.video.height=videoHeight),s.aspectRatio&&""!=videoAspectRatio&&(l.sessionDescriptionHandlerOptions.constraints.video.aspectRatio=videoAspectRatio)),console.log("TRANSFER INVITE: ","sip:"+t+"@"+SipDomain);var r=SIP.UserAgent.makeURI("sip:"+t.replace(/#/g,"%23")+"@"+SipDomain),d=new SIP.Inviter(userAgent,r,l);d.data={},d.delegate={onBye:function(t){console.log("New call session ended with BYE"),a.html(lang.call_ended),i.data.transfer[o].disposition="bye",i.data.transfer[o].dispositionTime=utcDateNow(),$("#line-"+e+"-txt-FindTransferBuddy").parent().show(),$("#line-"+e+"-btn-blind-transfer").show(),$("#line-"+e+"-btn-attended-transfer").show(),$("#line-"+e+"-btn-complete-attended-transfer").hide(),$("#line-"+e+"-btn-cancel-attended-transfer").hide(),$("#line-"+e+"-btn-terminate-attended-transfer").hide(),$("#line-"+e+"-msg").html(lang.attended_transfer_call_terminated),updateLineScroll(e),window.setTimeout(function(){a.hide(),updateLineScroll(e)},1e3)},onSessionDescriptionHandler:function(t,n){t?t.peerConnection?t.peerConnection.ontrack=function(n){var a=t.peerConnection,o=new MediaStream;a.getReceivers().forEach(function(e){e.track&&"audio"==e.track.kind&&o.addTrack(e.track)});var s=$("#line-"+e+"-transfer-remoteAudio").get(0);s.srcObject=o,s.onloadedmetadata=function(e){void 0!==s.sinkId&&s.setSinkId(i.data.AudioOutputDevice).then(function(){console.log("sinkId applied: "+i.data.AudioOutputDevice)}).catch(function(e){console.warn("Error using setSinkId: ",e)}),s.play()}}:console.warn("onSessionDescriptionHandler fired without a peerConnection"):console.warn("onSessionDescriptionHandler fired without a sessionDescriptionHandler")}},i.data.childsession=d;var c={requestDelegate:{onTrying:function(t){a.html(lang.trying),i.data.transfer[o].disposition="trying",i.data.transfer[o].dispositionTime=utcDateNow(),$("#line-"+e+"-msg").html(lang.attended_transfer_call_started)},onProgress:function(t){a.html(lang.ringing),i.data.transfer[o].disposition="progress",i.data.transfer[o].dispositionTime=utcDateNow(),$("#line-"+e+"-msg").html(lang.attended_transfer_call_started);var n=$("#line-"+e+"-btn-cancel-attended-transfer");n.off("click"),n.on("click",function(){d.cancel().catch(function(e){console.warn("Failed to CANCEL",e)}),a.html(lang.call_cancelled),console.log("New call session canceled"),i.data.transfer[o].accept.complete=!1,i.data.transfer[o].accept.disposition="cancel",i.data.transfer[o].accept.eventTime=utcDateNow(),$("#line-"+e+"-msg").html(lang.attended_transfer_call_cancelled),updateLineScroll(e)}),n.show(),updateLineScroll(e)},onRedirect:function(e){console.log("Redirect received:",e)},onAccept:function(t){a.html(lang.call_in_progress),$("#line-"+e+"-btn-cancel-attended-transfer").hide(),i.data.transfer[o].disposition="accepted",i.data.transfer[o].dispositionTime=utcDateNow();var s=$("#line-"+e+"-btn-complete-attended-transfer");s.off("click"),s.on("click",function(){var t={requestDelegate:{onAccept:function(t){console.log("Attended transfer Accepted"),i.data.terminateby="us",i.data.reasonCode=202,i.data.reasonText="Attended Transfer",i.data.transfer[o].accept.complete=!0,i.data.transfer[o].accept.disposition=t.message.reasonPhrase,i.data.transfer[o].accept.eventTime=utcDateNow(),$("#line-"+e+"-msg").html(lang.attended_transfer_complete_accepted),updateLineScroll(e),i.bye().catch(function(e){console.warn("Could not BYE after blind transfer:",e)}),teardownSession(n)},onReject:function(t){console.warn("Attended transfer rejected:",t),i.data.transfer[o].accept.complete=!1,i.data.transfer[o].accept.disposition=t.message.reasonPhrase,i.data.transfer[o].accept.eventTime=utcDateNow(),$("#line-"+e+"-msg").html("Attended Transfer Failed!"),updateLineScroll(e)}}};i.refer(d,t).catch(function(e){console.warn("Failed to REFER",e)}),a.html(lang.attended_transfer_complete),updateLineScroll(e)}),s.show(),updateLineScroll(e);var l=$("#line-"+e+"-btn-terminate-attended-transfer");l.off("click"),l.on("click",function(){d.bye().catch(function(e){console.warn("Failed to BYE",e)}),a.html(lang.call_ended),console.log("New call session end"),i.data.transfer[o].accept.complete=!1,i.data.transfer[o].accept.disposition="bye",i.data.transfer[o].accept.eventTime=utcDateNow(),$("#line-"+e+"-btn-complete-attended-transfer").hide(),$("#line-"+e+"-btn-cancel-attended-transfer").hide(),$("#line-"+e+"-btn-terminate-attended-transfer").hide(),$("#line-"+e+"-msg").html(lang.attended_transfer_call_ended),updateLineScroll(e),window.setTimeout(function(){a.hide(),CancelTransferSession(e),updateLineScroll(e)},1e3)}),l.show(),updateLineScroll(e)},onReject:function(t){console.log("New call session rejected: ",t.message.reasonPhrase),a.html(lang.call_rejected),i.data.transfer[o].disposition=t.message.reasonPhrase,i.data.transfer[o].dispositionTime=utcDateNow(),$("#line-"+e+"-txt-FindTransferBuddy").parent().show(),$("#line-"+e+"-btn-blind-transfer").show(),$("#line-"+e+"-btn-attended-transfer").show(),$("#line-"+e+"-btn-complete-attended-transfer").hide(),$("#line-"+e+"-btn-cancel-attended-transfer").hide(),$("#line-"+e+"-btn-terminate-attended-transfer").hide(),$("#line-"+e+"-msg").html(lang.attended_transfer_call_rejected),updateLineScroll(e),window.setTimeout(function(){a.hide(),updateLineScroll(e)},1e3)}}};d.invite(c).catch(function(e){console.warn("Failed to send INVITE:",e)})}else console.warn("Null line or session")
}else console.warn("Cannot transfer, no number")}function StartConferenceCall(e){$("#line-"+e+"-btn-CancelTransfer").is(":visible")?CancelTransferSession(e):($("#line-"+e+"-btn-Conference").hide(),$("#line-"+e+"-btn-CancelConference").show(),holdSession(e),$("#line-"+e+"-txt-FindConferenceBuddy").val(""),$("#line-"+e+"-txt-FindConferenceBuddy").parent().show(),$("#line-"+e+"-session-avatar").css("width","50px"),$("#line-"+e+"-session-avatar").css("height","50px"),RestoreCallControls(e),$("#line-"+e+"-btn-conference-dial").show(),$("#line-"+e+"-btn-cancel-conference-dial").hide(),$("#line-"+e+"-btn-join-conference-call").hide(),$("#line-"+e+"-btn-terminate-conference-call").hide(),$("#line-"+e+"-conference-status").hide(),$("#line-"+e+"-Conference").show(),updateLineScroll(e))}function CancelConference(e){var t=FindLineByNumber(e);if(null!=t&&null!=t.SipSession){var n=t.SipSession;n.data.childsession&&(console.log("Child Conference call detected:",n.data.childsession.state),n.data.childsession.dispose().then(function(){n.data.childsession=null}).catch(function(e){n.data.childsession=null})),$("#line-"+e+"-session-avatar").css("width",""),$("#line-"+e+"-session-avatar").css("height",""),$("#line-"+e+"-btn-Conference").show(),$("#line-"+e+"-btn-CancelConference").hide(),unholdSession(e),$("#line-"+e+"-Conference").hide(),updateLineScroll(e)}else console.warn("Null line or session")}function ConferenceDial(t){var n=$("#line-"+t+"-txt-FindConferenceBuddy").val();if(n=EnableAlphanumericDial?n.replace(telAlphanumericRegEx,"").substring(0,MaxDidLength):n.replace(telNumericRegEx,"").substring(0,MaxDidLength),""!=n){var i=FindLineByNumber(t);if(null!=i&&null!=i.SipSession){var a=i.SipSession;HidePopup(),$("#line-"+t+"-txt-FindConferenceBuddy").parent().hide(),$("#line-"+t+"-btn-conference-dial").hide(),$("#line-"+t+"-btn-cancel-conference-dial"),$("#line-"+t+"-btn-join-conference-call").hide(),$("#line-"+t+"-btn-terminate-conference-call").hide();var o=$("#line-"+t+"-conference-status");o.html(lang.connecting),o.show(),a.data.confcalls||(a.data.confcalls=[]),a.data.confcalls.push({to:n,startTime:utcDateNow(),disposition:"invite",dispositionTime:utcDateNow(),accept:{complete:null,eventTime:null,disposition:""}});var s=a.data.confcalls.length-1;updateLineScroll(t);var l=navigator.mediaDevices.getSupportedConstraints(),r={sessionDescriptionHandlerOptions:{earlyMedia:!0,constraints:{audio:{deviceId:"default"},video:!1}}};"default"!=a.data.AudioSourceDevice&&(r.sessionDescriptionHandlerOptions.constraints.audio.deviceId={exact:a.data.AudioSourceDevice}),l.autoGainControl&&(r.sessionDescriptionHandlerOptions.constraints.audio.autoGainControl=AutoGainControl),l.echoCancellation&&(r.sessionDescriptionHandlerOptions.constraints.audio.echoCancellation=EchoCancellation),l.noiseSuppression&&(r.sessionDescriptionHandlerOptions.constraints.audio.noiseSuppression=NoiseSuppression),a.data.withvideo&&(r.sessionDescriptionHandlerOptions.constraints.video=!0,"default"!=a.data.VideoSourceDevice&&(r.sessionDescriptionHandlerOptions.constraints.video.deviceId={exact:a.data.VideoSourceDevice}),l.frameRate&&""!=maxFrameRate&&(r.sessionDescriptionHandlerOptions.constraints.video.frameRate=maxFrameRate),l.height&&""!=videoHeight&&(r.sessionDescriptionHandlerOptions.constraints.video.height=videoHeight),l.aspectRatio&&""!=videoAspectRatio&&(r.sessionDescriptionHandlerOptions.constraints.video.aspectRatio=videoAspectRatio)),console.log("CONFERENCE INVITE: ","sip:"+n+"@"+SipDomain);var d=SIP.UserAgent.makeURI("sip:"+n.replace(/#/g,"%23")+"@"+SipDomain),c=new SIP.Inviter(userAgent,d,r);c.data={},c.delegate={onBye:function(e){console.log("New call session ended with BYE"),o.html(lang.call_ended),a.data.confcalls[s].disposition="bye",a.data.confcalls[s].dispositionTime=utcDateNow(),$("#line-"+t+"-txt-FindConferenceBuddy").parent().show(),$("#line-"+t+"-btn-conference-dial").show(),$("#line-"+t+"-btn-cancel-conference-dial").hide(),$("#line-"+t+"-btn-join-conference-call").hide(),$("#line-"+t+"-btn-terminate-conference-call").hide(),$("#line-"+t+"-msg").html(lang.conference_call_terminated),updateLineScroll(t),window.setTimeout(function(){o.hide(),updateLineScroll(t)},1e3)},onSessionDescriptionHandler:function(e,n){e?e.peerConnection?e.peerConnection.ontrack=function(n){var i=e.peerConnection,o=new MediaStream;i.getReceivers().forEach(function(e){e.track&&"audio"==e.track.kind&&o.addTrack(e.track)});var s=$("#line-"+t+"-conference-remoteAudio").get(0);s.srcObject=o,s.onloadedmetadata=function(e){void 0!==s.sinkId&&s.setSinkId(a.data.AudioOutputDevice).then(function(){console.log("sinkId applied: "+a.data.AudioOutputDevice)}).catch(function(e){console.warn("Error using setSinkId: ",e)}),s.play()}}:console.warn("onSessionDescriptionHandler fired without a peerConnection"):console.warn("onSessionDescriptionHandler fired without a sessionDescriptionHandler")}},c.stateChange.addListener(function(t){if(t==SIP.SessionState.Terminated&&(a.data.childsession.data.AudioSourceTrack&&"audio"==a.data.childsession.data.AudioSourceTrack.kind&&a.data.childsession.data.AudioSourceTrack.stop(),a.data.AudioSourceTrack&&"audio"==a.data.AudioSourceTrack.kind)){var n=a.sessionDescriptionHandler.peerConnection;n.getSenders().forEach(function(t){t.track&&"audio"==t.track.kind&&(t.replaceTrack(a.data.AudioSourceTrack).then(function(){a.data.ismute?t.track.enabled=!1:t.track.enabled=!0}).catch(function(){console.error(e)}),a.data.AudioSourceTrack=null)})}}),a.data.childsession=c;var u={requestDelegate:{onTrying:function(e){o.html(lang.ringing),a.data.confcalls[s].disposition="trying",a.data.confcalls[s].dispositionTime=utcDateNow(),$("#line-"+t+"-msg").html(lang.conference_call_started)},onProgress:function(e){o.html(lang.ringing),a.data.confcalls[s].disposition="progress",a.data.confcalls[s].dispositionTime=utcDateNow(),$("#line-"+t+"-msg").html(lang.conference_call_started);var n=$("#line-"+t+"-btn-cancel-conference-dial");n.off("click"),n.on("click",function(){c.cancel().catch(function(e){console.warn("Failed to CANCEL",e)}),o.html(lang.call_cancelled),console.log("New call session canceled"),a.data.confcalls[s].accept.complete=!1,a.data.confcalls[s].accept.disposition="cancel",a.data.confcalls[s].accept.eventTime=utcDateNow(),$("#line-"+t+"-msg").html(lang.conference_call_cancelled),updateLineScroll(t)}),n.show(),updateLineScroll(t)},onRedirect:function(e){console.log("Redirect received:",e)},onAccept:function(e){o.html(lang.call_in_progress),$("#line-"+t+"-btn-cancel-conference-dial").hide(),a.data.confcalls[s].complete=!0,a.data.confcalls[s].disposition="accepted",a.data.confcalls[s].dispositionTime=utcDateNow();var n=$("#line-"+t+"-btn-join-conference-call");n.off("click"),n.on("click",function(){if(a.data.childsession){var e=new MediaStream,i=new MediaStream,l=a.sessionDescriptionHandler.peerConnection,r=a.data.childsession.sessionDescriptionHandler.peerConnection;r.getReceivers().forEach(function(t){t.track&&"audio"==t.track.kind&&(console.log("Adding conference session:",t.track.label),e.addTrack(t.track))}),l.getReceivers().forEach(function(e){e.track&&"audio"==e.track.kind&&(console.log("Adding conference session:",e.track.label),i.addTrack(e.track))}),l.getSenders().forEach(function(t){if(t.track&&"audio"==t.track.kind){console.log("Switching to mixed Audio track on session"),a.data.AudioSourceTrack=t.track,e.addTrack(t.track);var n=MixAudioStreams(e).getAudioTracks()[0];n.IsMixedTrack=!0,t.replaceTrack(n)}}),r.getSenders().forEach(function(e){if(e.track&&"audio"==e.track.kind){console.log("Switching to mixed Audio track on conf call"),a.data.childsession.data.AudioSourceTrack=e.track,i.addTrack(e.track);var t=MixAudioStreams(i).getAudioTracks()[0];t.IsMixedTrack=!0,e.replaceTrack(t)}}),o.html(lang.call_in_progress),console.log("Conference Call In Progress"),a.data.confcalls[s].accept.complete=!0,a.data.confcalls[s].accept.disposition="join",a.data.confcalls[s].accept.eventTime=utcDateNow(),$("#line-"+t+"-btn-terminate-conference-call").show(),$("#line-"+t+"-msg").html(lang.conference_call_in_progress),n.hide(),updateLineScroll(t),window.setTimeout(function(){unholdSession(t),updateLineScroll(t)},1e3)}else console.warn("Conference session lost")}),n.show(),updateLineScroll(t);var i=$("#line-"+t+"-btn-terminate-conference-call");i.off("click"),i.on("click",function(){c.bye().catch(function(e){console.warn("Failed to BYE",e)}),o.html(lang.call_ended),console.log("New call session end"),a.data.confcalls[s].accept.disposition="bye",a.data.confcalls[s].accept.eventTime=utcDateNow(),$("#line-"+t+"-msg").html(lang.conference_call_ended),updateLineScroll(t),window.setTimeout(function(){o.hide(),CancelConference(t),updateLineScroll(t)},1e3)}),i.show(),updateLineScroll(t)},onReject:function(e){console.log("New call session rejected: ",e.message.reasonPhrase),o.html(lang.call_rejected),a.data.confcalls[s].disposition=e.message.reasonPhrase,a.data.confcalls[s].dispositionTime=utcDateNow(),$("#line-"+t+"-txt-FindConferenceBuddy").parent().show(),$("#line-"+t+"-btn-conference-dial").show(),$("#line-"+t+"-btn-cancel-conference-dial").hide(),$("#line-"+t+"-btn-join-conference-call").hide(),$("#line-"+t+"-btn-terminate-conference-call").hide(),$("#line-"+t+"-msg").html(lang.conference_call_rejected),updateLineScroll(t),window.setTimeout(function(){o.hide(),updateLineScroll(t)},1e3)}}};c.invite(u).catch(function(e){console.warn("Failed to send INVITE:",e)})}else console.warn("Null line or session")}else console.warn("Cannot transfer, must be [0-9*+#]")}function cancelSession(e){var t=FindLineByNumber(e);null!=t&&null!=t.SipSession&&(t.SipSession.data.terminateby="us",t.SipSession.data.reasonCode=0,t.SipSession.data.reasonText="Call Cancelled",console.log("Cancelling session : "+e),t.SipSession.state==SIP.SessionState.Initial||t.SipSession.state==SIP.SessionState.Establishing?t.SipSession.cancel():(console.warn("Session not in correct state for cancel.",t.SipSession.state),console.log("Attempting teardown : "+e),teardownSession(t)),$("#line-"+e+"-msg").html(lang.call_cancelled))}function holdSession(e){var t=FindLineByNumber(e);if(null!=t&&null!=t.SipSession){var n=t.SipSession;if(1!=n.isOnHold){console.log("Putting Call on hold:",e),n.isOnHold=!0;var i=n.sessionDescriptionHandlerOptionsReInvite;i.hold=!0,n.sessionDescriptionHandlerOptionsReInvite=i;var a={requestDelegate:{onAccept:function(){if(n&&n.sessionDescriptionHandler&&n.sessionDescriptionHandler.peerConnection){var t=n.sessionDescriptionHandler.peerConnection;t.getReceivers().forEach(function(e){e.track&&(e.track.enabled=!1)}),t.getSenders().forEach(function(e){e.track&&"audio"==e.track.kind?(1==e.track.IsMixedTrack&&n.data.AudioSourceTrack&&"audio"==n.data.AudioSourceTrack.kind&&(console.log("Muting Mixed Audio Track : "+n.data.AudioSourceTrack.label),n.data.AudioSourceTrack.enabled=!1),console.log("Muting Audio Track : "+e.track.label),e.track.enabled=!1):e.track&&"video"==e.track.kind&&(e.track.enabled=!1)})}n.isOnHold=!0,console.log("Call is is on hold:",e),$("#line-"+e+"-btn-Hold").hide(),$("#line-"+e+"-btn-Unhold").show(),$("#line-"+e+"-msg").html(lang.call_on_hold),n.data.hold||(n.data.hold=[]),n.data.hold.push({event:"hold",eventTime:utcDateNow()}),updateLineScroll(e),"undefined"!=typeof web_hook_on_modify&&web_hook_on_modify("hold",n)},onReject:function(){n.isOnHold=!1,console.warn("Failed to put the call on hold:",e)}}};n.invite(a).catch(function(e){n.isOnHold=!1,console.warn("Error attempting to put the call on hold:",e)})}else console.log("Call is is already on hold:",e)}}function unholdSession(e){var t=FindLineByNumber(e);if(null!=t&&null!=t.SipSession){var n=t.SipSession;if(0!=n.isOnHold){console.log("Taking call off hold:",e),n.isOnHold=!1;var i=n.sessionDescriptionHandlerOptionsReInvite;i.hold=!1,n.sessionDescriptionHandlerOptionsReInvite=i;var a={requestDelegate:{onAccept:function(){if(n&&n.sessionDescriptionHandler&&n.sessionDescriptionHandler.peerConnection){var t=n.sessionDescriptionHandler.peerConnection;t.getReceivers().forEach(function(e){e.track&&(e.track.enabled=!0)}),t.getSenders().forEach(function(e){e.track&&"audio"==e.track.kind?(1==e.track.IsMixedTrack&&n.data.AudioSourceTrack&&"audio"==n.data.AudioSourceTrack.kind&&(console.log("Unmuting Mixed Audio Track : "+n.data.AudioSourceTrack.label),n.data.AudioSourceTrack.enabled=!0),console.log("Unmuting Audio Track : "+e.track.label),e.track.enabled=!0):e.track&&"video"==e.track.kind&&(e.track.enabled=!0)})}n.isOnHold=!1,console.log("Call is off hold:",e),$("#line-"+e+"-btn-Hold").show(),$("#line-"+e+"-btn-Unhold").hide(),$("#line-"+e+"-msg").html(lang.call_in_progress),n.data.hold||(n.data.hold=[]),n.data.hold.push({event:"unhold",eventTime:utcDateNow()}),updateLineScroll(e),"undefined"!=typeof web_hook_on_modify&&web_hook_on_modify("unhold",n)},onReject:function(){n.isOnHold=!0,console.warn("Failed to put the call on hold",e)}}};n.invite(a).catch(function(e){n.isOnHold=!0,console.warn("Error attempting to take to call off hold",e)})}else console.log("Call is already off hold:",e)}}function MuteSession(e){var t=FindLineByNumber(e);if(null!=t&&null!=t.SipSession){$("#line-"+e+"-btn-Unmute").show(),$("#line-"+e+"-btn-Mute").hide();var n=t.SipSession,i=n.sessionDescriptionHandler.peerConnection;i.getSenders().forEach(function(e){e.track&&"audio"==e.track.kind&&(1==e.track.IsMixedTrack&&n.data.AudioSourceTrack&&"audio"==n.data.AudioSourceTrack.kind&&(console.log("Muting Mixed Audio Track : "+n.data.AudioSourceTrack.label),n.data.AudioSourceTrack.enabled=!1),console.log("Muting Audio Track : "+e.track.label),e.track.enabled=!1)}),n.data.mute||(n.data.mute=[]),n.data.mute.push({event:"mute",eventTime:utcDateNow()}),n.data.ismute=!0,$("#line-"+e+"-msg").html(lang.call_on_mute),updateLineScroll(e),"undefined"!=typeof web_hook_on_modify&&web_hook_on_modify("mute",n)}}function UnmuteSession(e){var t=FindLineByNumber(e);if(null!=t&&null!=t.SipSession){$("#line-"+e+"-btn-Unmute").hide(),$("#line-"+e+"-btn-Mute").show();var n=t.SipSession,i=n.sessionDescriptionHandler.peerConnection;i.getSenders().forEach(function(e){e.track&&"audio"==e.track.kind&&(1==e.track.IsMixedTrack&&n.data.AudioSourceTrack&&"audio"==n.data.AudioSourceTrack.kind&&(console.log("Unmuting Mixed Audio Track : "+n.data.AudioSourceTrack.label),n.data.AudioSourceTrack.enabled=!0),console.log("Unmuting Audio Track : "+e.track.label),e.track.enabled=!0)}),n.data.mute||(n.data.mute=[]),n.data.mute.push({event:"unmute",eventTime:utcDateNow()}),n.data.ismute=!1,$("#line-"+e+"-msg").html(lang.call_off_mute),updateLineScroll(e),"undefined"!=typeof web_hook_on_modify&&web_hook_on_modify("unmute",n)}}function endSession(e){var t=FindLineByNumber(e);null!=t&&null!=t.SipSession&&(console.log("Ending call with: "+e),t.SipSession.data.terminateby="us",t.SipSession.data.reasonCode=16,t.SipSession.data.reasonText="Normal Call clearing",t.SipSession.bye().catch(function(e){console.warn("Failed to bye the session!",e)}),$("#line-"+e+"-msg").html(lang.call_ended),$("#line-"+e+"-ActiveCall").hide(),teardownSession(t),updateLineScroll(e))}function sendDTMF(e,t){var n=FindLineByNumber(e);if(null!=n&&null!=n.SipSession){var i={duration:100,interToneGap:70};if(1==n.SipSession.isOnHold)if(n.SipSession.data.childsession)if(n.SipSession.data.childsession.state==SIP.SessionState.Established){console.log("Sending DTMF ("+t+"): "+n.LineNumber+" child session");var a=n.SipSession.data.childsession.sessionDescriptionHandler.sendDtmf(t,i);a?console.log("Sent DTMF ("+t+") child session"):console.log("Failed to send DTMF ("+t+") child session")}else console.warn("Cannot Send DTMF ("+t+"): "+n.LineNumber+" is on hold, and the child session is not established");else console.warn("Cannot Send DTMF ("+t+"): "+n.LineNumber+" is on hold, and there is no child session");else if(n.SipSession.state==SIP.SessionState.Established||n.SipSession.state==SIP.SessionState.Establishing){console.log("Sending DTMF ("+t+"): "+n.LineNumber);a=n.SipSession.sessionDescriptionHandler.sendDtmf(t,i);a?console.log("Sent DTMF ("+t+")"):console.log("Failed to send DTMF ("+t+")"),$("#line-"+e+"-msg").html(lang.send_dtmf+": "+t),updateLineScroll(e),"undefined"!=typeof web_hook_on_dtmf&&web_hook_on_dtmf(t,n.SipSession)}else console.warn("Cannot Send DTMF ("+t+"): "+n.LineNumber+" session is not establishing or established")}}function switchVideoSource(t,n){var i=FindLineByNumber(t);if(null!=i&&null!=i.SipSession){var a=i.SipSession;$("#line-"+t+"-msg").html(lang.switching_video_source);var o=navigator.mediaDevices.getSupportedConstraints(),s={audio:!1,video:{deviceId:"default"}};"default"!=n&&(s.video.deviceId={exact:n}),o.frameRate&&""!=maxFrameRate&&(s.video.frameRate=maxFrameRate),o.height&&""!=videoHeight&&(s.video.height=videoHeight),o.aspectRatio&&""!=videoAspectRatio&&(s.video.aspectRatio=videoAspectRatio),a.data.VideoSourceDevice=n;var l=a.sessionDescriptionHandler.peerConnection,r=new MediaStream;navigator.mediaDevices.getUserMedia(s).then(function(e){var t=e.getVideoTracks()[0];l.getSenders().forEach(function(e){e.track&&"video"==e.track.kind&&(console.log("Switching Video Track : "+e.track.label+" to "+t.label),e.track.stop(),e.replaceTrack(t),r.addTrack(t))})}).catch(function(e){console.error("Error on getUserMedia",e,s)}),a.data.AudioSourceTrack&&"audio"==a.data.AudioSourceTrack.kind&&l.getSenders().forEach(function(t){t.track&&"audio"==t.track.kind&&(t.replaceTrack(a.data.AudioSourceTrack).then(function(){a.data.ismute?t.track.enabled=!1:t.track.enabled=!0}).catch(function(){console.error(e)}),a.data.AudioSourceTrack=null)}),console.log("Showing as preview...");var d=$("#line-"+t+"-localVideo").get(0);d.srcObject=r,d.onloadedmetadata=function(e){d.play()}}else console.warn("Line or Session is Null")}function SendCanvas(t){var n=FindLineByNumber(t);if(null!=n&&null!=n.SipSession){var i=n.SipSession;$("#line-"+t+"-msg").html(lang.switching_to_canvas),RemoveScratchpad(t);var a=$("<canvas/>");a.prop("id","line-"+t+"-scratchpad"),$("#line-"+t+"-scratchpad-container").append(a),$("#line-"+t+"-scratchpad").css("display","inline-block"),$("#line-"+t+"-scratchpad").css("width","100%"),$("#line-"+t+"-scratchpad").css("height","100%"),$("#line-"+t+"-scratchpad").prop("width",640),$("#line-"+t+"-scratchpad").prop("height",360),$("#line-"+t+"-scratchpad-container").show(),console.log("Canvas for Scratchpad created..."),scratchpad=new fabric.Canvas("line-"+t+"-scratchpad"),scratchpad.id="line-"+t+"-scratchpad",scratchpad.backgroundColor="#FFFFFF",scratchpad.isDrawingMode=!0,scratchpad.renderAll(),scratchpad.redrawIntrtval=window.setInterval(function(){scratchpad.renderAll()},1e3),CanvasCollection.push(scratchpad);var o=$("#line-"+t+"-scratchpad").get(0).captureStream(25),s=o.getVideoTracks()[0],l=i.sessionDescriptionHandler.peerConnection;l.getSenders().forEach(function(e){e.track&&"video"==e.track.kind&&(console.log("Switching Track : "+e.track.label+" to Scratchpad Canvas"),e.track.stop(),e.replaceTrack(s))}),i.data.AudioSourceTrack&&"audio"==i.data.AudioSourceTrack.kind&&l.getSenders().forEach(function(t){t.track&&"audio"==t.track.kind&&(t.replaceTrack(i.data.AudioSourceTrack).then(function(){i.data.ismute?t.track.enabled=!1:t.track.enabled=!0}).catch(function(){console.error(e)}),i.data.AudioSourceTrack=null)}),console.log("Showing as preview...");var r=$("#line-"+t+"-localVideo").get(0);r.srcObject=o,r.onloadedmetadata=function(e){r.play()}}else console.warn("Line or Session is Null")}function SendVideo(e,t){var n=FindLineByNumber(e);if(null!=n&&null!=n.SipSession){var i=n.SipSession;$("#line-"+e+"-src-camera").prop("disabled",!1),$("#line-"+e+"-src-canvas").prop("disabled",!1),$("#line-"+e+"-src-desktop").prop("disabled",!1),$("#line-"+e+"-src-video").prop("disabled",!0),$("#line-"+e+"-src-blank").prop("disabled",!1),$("#line-"+e+"-msg").html(lang.switching_to_shared_video),$("#line-"+e+"-scratchpad-container").hide(),RemoveScratchpad(e),$("#line-"+e+"-sharevideo").hide(),$("#line-"+e+"-sharevideo").get(0).pause(),$("#line-"+e+"-sharevideo").get(0).removeAttribute("src"),$("#line-"+e+"-sharevideo").get(0).load(),$("#line-"+e+"-localVideo").hide(),$("#line-"+e+"-remote-videos").hide();var a=$("#line-"+e+"-sharevideo");a.prop("src",t),a.off("loadedmetadata"),a.on("loadedmetadata",function(){console.log("Video can play now... ");var t=360;"HD"==VideoResampleSize&&(t=720),"FHD"==VideoResampleSize&&(t=1080);var n=a.get(0),o=$("<canvas/>").get(0),s=n.videoWidth,l=n.videoHeight;if(s>=l){if(l>t){var r=t/l;l=t,s*=r}}else if(s>t){r=t/s;s=t,l*=r}o.width=s,o.height=l;var d=o.getContext("2d");window.clearInterval(i.data.videoResampleInterval),i.data.videoResampleInterval=window.setInterval(function(){d.drawImage(n,0,0,s,l)},40);var c=null;"captureStream"in n?c=n.captureStream():"mozCaptureStream"in n?c=n.mozCaptureStream():console.warn("Cannot capture stream from video, this will result in no audio being transmitted.");var u=o.captureStream(25),p=u.getVideoTracks()[0],g=null!=c?c.getAudioTracks()[0]:null,m=i.sessionDescriptionHandler.peerConnection;m.getSenders().forEach(function(e){if(e.track&&"video"==e.track.kind&&(console.log("Switching Track : "+e.track.label),e.track.stop(),e.replaceTrack(p)),e.track&&"audio"==e.track.kind){console.log("Switching to mixed Audio track on session"),i.data.AudioSourceTrack=e.track;var t=new MediaStream;g&&t.addTrack(g),t.addTrack(e.track);var n=MixAudioStreams(t).getAudioTracks()[0];n.IsMixedTrack=!0,e.replaceTrack(n)}}),console.log("Showing as preview...");var f=$("#line-"+e+"-localVideo").get(0);f.srcObject=c,f.onloadedmetadata=function(e){f.play().then(function(){console.log("Playing Preview Video File")}).catch(function(e){console.error("Cannot play back video",e)})},console.log("Starting Video..."),$("#line-"+e+"-sharevideo").get(0).play()}),$("#line-"+e+"-sharevideo").show(),console.log("Video for Sharing created...")}else console.warn("Line or Session is Null")}function ShareScreen(t){var n=FindLineByNumber(t);if(null!=n&&null!=n.SipSession){var i=n.SipSession;$("#line-"+t+"-msg").html(lang.switching_to_shared_screen);var a=new MediaStream,o=i.sessionDescriptionHandler.peerConnection;if(navigator.getDisplayMedia){var s={video:!0,audio:!1};navigator.getDisplayMedia(s).then(function(e){console.log("navigator.getDisplayMedia");var n=e.getVideoTracks()[0];o.getSenders().forEach(function(e){e.track&&"video"==e.track.kind&&(console.log("Switching Video Track : "+e.track.label+" to Screen"),e.track.stop(),e.replaceTrack(n),a.addTrack(n))}),console.log("Showing as preview...");var i=$("#line-"+t+"-localVideo").get(0);i.srcObject=a,i.onloadedmetadata=function(e){i.play()}}).catch(function(e){console.error("Error on getUserMedia")})}else if(navigator.mediaDevices.getDisplayMedia){s={video:!0,audio:!1};navigator.mediaDevices.getDisplayMedia(s).then(function(e){console.log("navigator.mediaDevices.getDisplayMedia");var n=e.getVideoTracks()[0];o.getSenders().forEach(function(e){e.track&&"video"==e.track.kind&&(console.log("Switching Video Track : "+e.track.label+" to Screen"),e.track.stop(),e.replaceTrack(n),a.addTrack(n))}),console.log("Showing as preview...");var i=$("#line-"+t+"-localVideo").get(0);i.srcObject=a,i.onloadedmetadata=function(e){i.play()}}).catch(function(e){console.error("Error on getUserMedia")})}else{s={video:{mediaSource:"screen"},audio:!1};navigator.mediaDevices.getUserMedia(s).then(function(e){console.log("navigator.mediaDevices.getUserMedia");var n=e.getVideoTracks()[0];o.getSenders().forEach(function(e){e.track&&"video"==e.track.kind&&(console.log("Switching Video Track : "+e.track.label+" to Screen"),e.track.stop(),e.replaceTrack(n),a.addTrack(n))}),console.log("Showing as preview...");var i=$("#line-"+t+"-localVideo").get(0);i.srcObject=a,i.onloadedmetadata=function(e){i.play()}}).catch(function(e){console.error("Error on getUserMedia")})}i.data.AudioSourceTrack&&"audio"==i.data.AudioSourceTrack.kind&&o.getSenders().forEach(function(t){t.track&&"audio"==t.track.kind&&(t.replaceTrack(i.data.AudioSourceTrack).then(function(){i.data.ismute?t.track.enabled=!1:t.track.enabled=!0}).catch(function(){console.error(e)}),i.data.AudioSourceTrack=null)})}else console.warn("Line or Session is Null")}function DisableVideoStream(t){var n=FindLineByNumber(t);if(null!=n&&null!=n.SipSession){var i=n.SipSession,a=i.sessionDescriptionHandler.peerConnection;a.getSenders().forEach(function(t){t.track&&"video"==t.track.kind&&(console.log("Disable Video Track : "+t.track.label),t.track.enabled=!1),t.track&&"audio"==t.track.kind&&i.data.AudioSourceTrack&&"audio"==i.data.AudioSourceTrack.kind&&(t.replaceTrack(i.data.AudioSourceTrack).then(function(){i.data.ismute?t.track.enabled=!1:t.track.enabled=!0}).catch(function(){console.error(e)}),i.data.AudioSourceTrack=null)}),console.log("Showing as preview...");var o=$("#line-"+t+"-localVideo").get(0);o.pause(),o.removeAttribute("src"),o.load(),$("#line-"+t+"-msg").html(lang.video_disabled)}else console.warn("Line or Session is Null")}function ShowDtmfMenu(e){console.log("Show DTMF"),HidePopup(),RestoreCallControls(e);var t="";t+="<div>",t+='<table cellspacing=10 cellpadding=0 style="margin-left:auto; margin-right: auto">',t+="<tr><td><button class=dialButtons onclick=\"sendDTMF('"+e+"', '1')\"><div>1</div><span>&nbsp;</span></button></td>",t+="<td><button class=dialButtons onclick=\"sendDTMF('"+e+"', '2')\"><div>2</div><span>ABC</span></button></td>",t+="<td><button class=dialButtons onclick=\"sendDTMF('"+e+"', '3')\"><div>3</div><span>DEF</span></button></td></tr>",t+="<tr><td><button class=dialButtons onclick=\"sendDTMF('"+e+"', '4')\"><div>4</div><span>GHI</span></button></td>",t+="<td><button class=dialButtons onclick=\"sendDTMF('"+e+"', '5')\"><div>5</div><span>JKL</span></button></td>",t+="<td><button class=dialButtons onclick=\"sendDTMF('"+e+"', '6')\"><div>6</div><span>MNO</span></button></td></tr>",t+="<tr><td><button class=dialButtons onclick=\"sendDTMF('"+e+"', '7')\"><div>7</div><span>PQRS</span></button></td>",t+="<td><button class=dialButtons onclick=\"sendDTMF('"+e+"', '8')\"><div>8</div><span>TUV</span></button></td>",t+="<td><button class=dialButtons onclick=\"sendDTMF('"+e+"', '9')\"><div>9</div><span>WXYZ</span></button></td></tr>",t+="<tr><td><button class=dialButtons onclick=\"sendDTMF('"+e+"', '*')\">*</button></td>",t+="<td><button class=dialButtons onclick=\"sendDTMF('"+e+"', '0')\">0</button></td>",t+="<td><button class=dialButtons onclick=\"sendDTMF('"+e+"', '#')\">#</button></td></tr>",t+="</table>",t+="</div>";var n=400,i=240;OpenWindow(t,lang.send_dtmf,n,i,!1,!1,lang.cancel,function(){CloseWindow()})}function ShowPresentMenu(e,t){var n=[];n.push({value:"src-camera",icon:"fa fa-video-camera",text:lang.camera,isHeader:!1}),n.push({value:"src-canvas",icon:"fa fa-pencil-square",text:lang.scratchpad,isHeader:!1}),n.push({value:"src-desktop",icon:"fa fa-desktop",text:lang.screen,isHeader:!1}),n.push({value:"src-video",icon:"fa fa-file-video-o",text:lang.video,isHeader:!1}),n.push({value:"src-blank",icon:"fa fa-ban",text:lang.blank,isHeader:!1});var i={selectEvent:function(e,n){var i=n.item.attr("value");null!=i?("src-camera"==i&&PresentCamera(t),"src-canvas"==i&&PresentScratchpad(t),"src-desktop"==i&&PresentScreen(t),"src-video"==i&&PresentVideo(t),"src-blank"==i&&PresentBlank(t),HidePopup()):HidePopup()},createEvent:null,autoFocus:!0,items:n};PopupMenu(e,i)}function ShowCallTimeline(e){console.log("Show Timeline"),HidePopup(),RestoreCallControls(e),$("#line-"+e+"-AudioStats").is(":visible")&&HideCallStats(e),$("#line-"+e+"-AudioOrVideoCall").hide(),$("#line-"+e+"-CallDetails").show(),$("#line-"+e+"-btn-ShowTimeline").hide(),$("#line-"+e+"-btn-HideTimeline").show()}function HideCallTimeline(e){console.log("Hide Timeline"),HidePopup(),$("#line-"+e+"-CallDetails").hide(),$("#line-"+e+"-AudioOrVideoCall").show(),$("#line-"+e+"-btn-ShowTimeline").show(),$("#line-"+e+"-btn-HideTimeline").hide()}function ShowCallStats(e){console.log("Show Call Stats"),HidePopup(),RestoreCallControls(e),$("#line-"+e+"-CallDetails").is(":visible")&&HideCallTimeline(e),$("#line-"+e+"-AudioOrVideoCall").hide(),$("#line-"+e+"-AudioStats").show(),$("#line-"+e+"-btn-ShowCallStats").hide(),$("#line-"+e+"-btn-HideCallStats").show()}function HideCallStats(e){console.log("Hide Call Stats"),HidePopup(),$("#line-"+e+"-AudioOrVideoCall").show(),$("#line-"+e+"-AudioStats").hide(),$("#line-"+e+"-btn-ShowCallStats").show(),$("#line-"+e+"-btn-HideCallStats").hide()}function ToggleMoreButtons(e){$("#line-"+e+"-btn-more").is(":visible")?RestoreCallControls(e):ExpandCallControls(e)}function ExpandCallControls(e){$("#line-"+e+"-btn-more").show(200),$("#line-"+e+"-btn-ControlToggle").html('<i class="fa fa-chevron-down"></i>')}function RestoreCallControls(e){$("#line-"+e+"-btn-more").hide(200),$("#line-"+e+"-btn-ControlToggle").html('<i class="fa fa-chevron-up"></i>')}function ExpandVideoArea(e){$("#line-"+e+"-call-fullscreen").prop("class","streamSection highlightSection FullScreenVideo"),$("#line-"+e+"-btn-restore").show(),$("#line-"+e+"-btn-expand").hide(),$("#line-"+e+"-VideoCall").css("background-color","#000000"),RedrawStage(e,!1),"undefined"!=typeof web_hook_on_expand_video_area&&web_hook_on_expand_video_area(e)}function RestoreVideoArea(e){$("#line-"+e+"-call-fullscreen").prop("class","streamSection highlightSection"),$("#line-"+e+"-btn-restore").hide(),$("#line-"+e+"-btn-expand").show(),$("#line-"+e+"-VideoCall").css("background-color",""),RedrawStage(e,!1),"undefined"!=typeof web_hook_on_restore_video_area&&web_hook_on_restore_video_area(e)}function ShowDial(){ShowContacts(),$("#myContacts").hide(),$("#searchArea").hide(),$("#actionArea").empty();var e='<div style="text-align:right"><button class=roundButtons onclick="ShowContacts()"><i class="fa fa-close"></i></button></div>';e+='<div style="text-align:center; margin-top:15px"><input id=dialText class=dialTextInput oninput="handleDialInput(this, event)" onkeydown="dialOnkeydown(event, this)" style="width:170px; height:32px"><button id=dialDeleteKey class=roundButtons onclick="KeyPress(\'del\')"></button></div>',e+='<table cellspacing=10 cellpadding=0 style="margin-left:auto; margin-right: auto">',e+="<tr><td><button class=dialButtons onclick=\"KeyPress('1')\"><div>1</div><span>&nbsp;</span></button></td>",e+="<td><button class=dialButtons onclick=\"KeyPress('2')\"><div>2</div><span>ABC</span></button></td>",e+="<td><button class=dialButtons onclick=\"KeyPress('3')\"><div>3</div><span>DEF</span></button></td></tr>",e+="<tr><td><button class=dialButtons onclick=\"KeyPress('4')\"><div>4</div><span>GHI</span></button></td>",e+="<td><button class=dialButtons onclick=\"KeyPress('5')\"><div>5</div><span>JKL</span></button></td>",e+="<td><button class=dialButtons onclick=\"KeyPress('6')\"><div>6</div><span>MNO</span></button></td></tr>",e+="<tr><td><button class=dialButtons onclick=\"KeyPress('7')\"><div>7</div><span>PQRS</span></button></td>",e+="<td><button class=dialButtons onclick=\"KeyPress('8')\"><div>8</div><span>TUV</span></button></td>",e+="<td><button class=dialButtons onclick=\"KeyPress('9')\"><div>9</div><span>WXYZ</span></button></td></tr>",e+="<tr><td><button class=dialButtons onclick=\"KeyPress('*')\">*</button></td>",e+="<td><button class=dialButtons onclick=\"KeyPress('0')\">0</button></td>",e+="<td><button class=dialButtons onclick=\"KeyPress('#')\">#</button></td></tr>",e+="</table>",e+='<div style="text-align: center; margin-bottom:15px">',e+='<button class="dialButtons dialButtonsDial" id=dialAudio title="'+lang.audio_call+'" onclick="DialByLine(\'audio\')"><i class="fa fa-phone"></i></button>',EnableVideoCalling&&(e+='<button class="dialButtons dialButtonsDial" id=dialVideo style="margin-left:20px" title="'+lang.video_call+'" onclick="DialByLine(\'video\')"><i class="fa fa-video-camera"></i></button>'),e+="</div>",$("#actionArea").html(e),$("#dialDeleteKey").hide(),$("#actionArea").show(),
$("#dialText").focus()}function handleDialInput(e,t){EnableAlphanumericDial?$("#dialText").val($("#dialText").val().replace(/[^\da-zA-Z\*\#\+]/g,"").substring(0,MaxDidLength)):$("#dialText").val($("#dialText").val().replace(/[^\d\*\#\+]/g,"").substring(0,MaxDidLength)),$("#dialVideo").prop("disabled",$("#dialText").val().length>=DidLength),$("#dialText").val().length>0?($("#dialText").css("width","138px"),$("#dialDeleteKey").show()):($("#dialText").css("width","170px"),$("#dialDeleteKey").hide())}function dialOnkeydown(e,t,n){var i=e.keyCode?e.keyCode:e.which;if("13"==i)return e.preventDefault(),DialByLine("audio"),!1}function KeyPress(e){var t=$("#dialText").val(),n=$("#dialText").get(0),i=n.selectionStart,a=n.selectionEnd,o=t.length,s="";i==a?(s="del"==e?t.substring(0,i-1)+t.substring(a,o):t.substring(0,i)+e+t.substring(a,o),$("#dialText").val(s.substring(0,MaxDidLength)),$("#dialText").focus(),"del"==e?n.setSelectionRange(i-1,i-1):n.setSelectionRange(i+1,i+1)):(s="del"==e?t.substring(0,i)+t.substring(a,o):t.substring(0,i)+e+t.substring(a,o),$("#dialText").val(s.substring(0,MaxDidLength)),$("#dialText").focus(),"del"==e?n.setSelectionRange(i,i):n.setSelectionRange(i+1,i+1)),$("#dialVideo").prop("disabled",$("#dialText").val().length>=DidLength),$("#dialText").val().length>0?($("#dialText").css("width","138px"),$("#dialDeleteKey").show()):($("#dialText").css("width","170px"),$("#dialDeleteKey").hide())}function ShowContacts(){var e=$("#local-video-preview").get(0);try{var t=e.srcObject.getTracks();t.forEach(function(e){e.stop()}),e.srcObject=null}catch(e){}try{t=window.SettingsMicrophoneStream.getTracks();t.forEach(function(e){e.stop()})}catch(e){}window.SettingsMicrophoneStream=null;try{var n=window.SettingsMicrophoneSoundMeter;n.stop()}catch(e){}window.SettingsMicrophoneSoundMeter=null;try{window.SettingsOutputAudio.pause()}catch(e){}window.SettingsOutputAudio=null;try{t=window.SettingsOutputStream.getTracks();t.forEach(function(e){e.stop()})}catch(e){}window.SettingsOutputStream=null;try{n=window.SettingsOutputStreamMeter;n.stop()}catch(e){}window.SettingsOutputStreamMeter=null;try{window.SettingsRingerAudio.pause()}catch(e){}window.SettingsRingerAudio=null;try{t=window.SettingsRingerStream.getTracks();t.forEach(function(e){e.stop()})}catch(e){}window.SettingsRingerStream=null;try{n=window.SettingsRingerStreamMeter;n.stop()}catch(e){}window.SettingsRingerStreamMeter=null,$("#actionArea").hide(),$("#actionArea").empty(),$("#myContacts").show(),$("#searchArea").show()}function ShowSortAnfFilter(){ShowContacts(),$("#myContacts").hide(),$("#searchArea").hide(),$("#actionArea").empty();var e='<div style="text-align:right"><button class=roundButtons onclick="ShowContacts()"><i class="fa fa-close"></i></button></div>';e+='<table cellspacing=10 cellpadding=0 style="margin-left:auto; margin-right: auto">',e+="<tr><td><div><input disabled type=radio name=sort_by id=sort_by_type><label for=sort_by_type>"+lang.sort_type+"</label></div>",e+='<div style="margin-left:20px"><input type=radio name=sort_by_type id=sort_by_type_cex><label for=sort_by_type_cex>'+lang.sort_type_cex+"</label></div>",e+='<div style="margin-left:20px"><input type=radio name=sort_by_type id=sort_by_type_cxe><label for=sort_by_type_cxe>'+lang.sort_type_cxe+"</label></div>",e+='<div style="margin-left:20px"><input type=radio name=sort_by_type id=sort_by_type_xec><label for=sort_by_type_xec>'+lang.sort_type_xec+"</label></div>",e+='<div style="margin-left:20px"><input type=radio name=sort_by_type id=sort_by_type_xce><label for=sort_by_type_xce>'+lang.sort_type_xce+"</label></div>",e+='<div style="margin-left:20px"><input type=radio name=sort_by_type id=sort_by_type_exc><label for=sort_by_type_exc>'+lang.sort_type_exc+"</label></div>",e+='<div style="margin-left:20px"><input type=radio name=sort_by_type id=sort_by_type_ecx><label for=sort_by_type_ecx>'+lang.sort_type_ecx+"</label></div>",e+="</td></tr>",e+="<tr><td><div><input type=radio name=sort_by id=sort_by_exten><label for=sort_by_exten>"+lang.sort_exten+"</label></div></td></tr>",e+="<tr><td><div><input type=radio name=sort_by id=sort_by_alpha><label for=sort_by_alpha>"+lang.sort_alpha+"</label></div></td></tr>",e+="<tr><td><div><input type=radio name=sort_by id=sort_by_activity><label for=sort_by_activity>"+lang.sort_activity+"</label></div></td></tr>",e+="<tr><td><div><input type=checkbox id=sort_auto_delete_at_end><label for=sort_auto_delete_at_end>"+lang.sort_auto_delete_at_end+"</label></div></td></tr>",e+="<tr><td><div><input type=checkbox id=sort_auto_delete_hide><label for=sort_auto_delete_hide>"+lang.sort_auto_delete_hide+"</label></div></td></tr>",e+="<tr><td><div><input type=checkbox id=sort_show_exten_num><label for=sort_show_exten_num>"+lang.sort_show_exten_num+"</label></div></td></tr>",e+="</table>",e+="</div>",$("#actionArea").html(e),$("#sort_by_type").prop("checked","type"==BuddySortBy),$("#sort_by_type_cex").prop("checked","type"==BuddySortBy&&"c|e|x"==SortByTypeOrder),$("#sort_by_type_cxe").prop("checked","type"==BuddySortBy&&"c|x|e"==SortByTypeOrder),$("#sort_by_type_xec").prop("checked","type"==BuddySortBy&&"x|e|c"==SortByTypeOrder),$("#sort_by_type_xce").prop("checked","type"==BuddySortBy&&"x|c|e"==SortByTypeOrder),$("#sort_by_type_exc").prop("checked","type"==BuddySortBy&&"e|x|c"==SortByTypeOrder),$("#sort_by_type_ecx").prop("checked","type"==BuddySortBy&&"e|c|x"==SortByTypeOrder),$("#sort_by_exten").prop("checked","extension"==BuddySortBy),$("#sort_by_alpha").prop("checked","alphabetical"==BuddySortBy),$("#sort_by_activity").prop("checked","activity"==BuddySortBy),$("#sort_auto_delete_at_end").prop("checked",1==BuddyAutoDeleteAtEnd),$("#sort_auto_delete_hide").prop("checked",1==HideAutoDeleteBuddies),$("#sort_show_exten_num").prop("checked",1==BuddyShowExtenNum),$("#sort_by_type_cex").change(function(){BuddySortBy="type",localDB.setItem("BuddySortBy","type"),SortByTypeOrder="c|e|x",localDB.setItem("SortByTypeOrder","c|e|x"),$("#sort_by_type").prop("checked",!0),UpdateBuddyList()}),$("#sort_by_type_cxe").change(function(){BuddySortBy="type",localDB.setItem("BuddySortBy","type"),SortByTypeOrder="c|x|e",localDB.setItem("SortByTypeOrder","c|x|e"),$("#sort_by_type").prop("checked",!0),UpdateBuddyList()}),$("#sort_by_type_xec").change(function(){BuddySortBy="type",localDB.setItem("BuddySortBy","type"),SortByTypeOrder="x|e|c",localDB.setItem("SortByTypeOrder","x|e|c"),$("#sort_by_type").prop("checked",!0),UpdateBuddyList()}),$("#sort_by_type_xce").change(function(){BuddySortBy="type",localDB.setItem("BuddySortBy","type"),SortByTypeOrder="x|e|c",localDB.setItem("SortByTypeOrder","x|c|e"),$("#sort_by_type").prop("checked",!0),UpdateBuddyList()}),$("#sort_by_type_exc").change(function(){BuddySortBy="type",localDB.setItem("BuddySortBy","type"),SortByTypeOrder="e|x|c",localDB.setItem("SortByTypeOrder","e|x|c"),$("#sort_by_type").prop("checked",!0),UpdateBuddyList()}),$("#sort_by_type_ecx").change(function(){BuddySortBy="type",localDB.setItem("BuddySortBy","type"),SortByTypeOrder="e|c|x",localDB.setItem("SortByTypeOrder","e|c|x"),$("#sort_by_type").prop("checked",!0),UpdateBuddyList()}),$("#sort_by_exten").change(function(){BuddySortBy="extension",localDB.setItem("BuddySortBy","extension"),$("#sort_by_type_cex").prop("checked",!1),$("#sort_by_type_cxe").prop("checked",!1),$("#sort_by_type_xec").prop("checked",!1),$("#sort_by_type_xce").prop("checked",!1),$("#sort_by_type_exc").prop("checked",!1),$("#sort_by_type_ecx").prop("checked",!1),UpdateBuddyList()}),$("#sort_by_alpha").change(function(){BuddySortBy="alphabetical",localDB.setItem("BuddySortBy","alphabetical"),$("#sort_by_type_cex").prop("checked",!1),$("#sort_by_type_cxe").prop("checked",!1),$("#sort_by_type_xec").prop("checked",!1),$("#sort_by_type_xce").prop("checked",!1),$("#sort_by_type_exc").prop("checked",!1),$("#sort_by_type_ecx").prop("checked",!1),UpdateBuddyList()}),$("#sort_by_activity").change(function(){BuddySortBy="activity",localDB.setItem("BuddySortBy","activity"),$("#sort_by_type_cex").prop("checked",!1),$("#sort_by_type_cxe").prop("checked",!1),$("#sort_by_type_xec").prop("checked",!1),$("#sort_by_type_xce").prop("checked",!1),$("#sort_by_type_exc").prop("checked",!1),$("#sort_by_type_ecx").prop("checked",!1),UpdateBuddyList()}),$("#sort_auto_delete_at_end").change(function(){BuddyAutoDeleteAtEnd=this.checked,localDB.setItem("BuddyAutoDeleteAtEnd",this.checked?"1":"0"),this.checked&&($("#sort_auto_delete_hide").prop("checked",!1),HideAutoDeleteBuddies=!1,localDB.setItem("HideAutoDeleteBuddies","0")),UpdateBuddyList()}),$("#sort_auto_delete_hide").change(function(){HideAutoDeleteBuddies=this.checked,localDB.setItem("HideAutoDeleteBuddies",this.checked?"1":"0"),this.checked&&($("#sort_auto_delete_at_end").prop("checked",!1),BuddyAutoDeleteAtEnd=!1,localDB.setItem("BuddyAutoDeleteAtEnd","0")),UpdateBuddyList()}),$("#sort_show_exten_num").change(function(){BuddyShowExtenNum=this.checked,localDB.setItem("BuddyShowExtenNum",this.checked?"1":"0"),UpdateBuddyList()}),$("#actionArea").show()}function DialByLine(e,t,n,i,a){if(null!=userAgent&&0!=userAgent.isRegistered()){var o=n||$("#dialText").val();if(o=EnableAlphanumericDial?o.replace(telAlphanumericRegEx,"").substring(0,MaxDidLength):o.replace(telNumericRegEx,"").substring(0,MaxDidLength),0!=o.length){ShowContacts();var s=t?FindBuddyByIdentity(t):FindBuddyByDid(o);if(null==s){var l=o.length>DidLength?"contact":"extension";"*"!=o.substring(0,1)&&"#"!=o.substring(0,1)||(l="contact"),s=MakeBuddy(l,!0,!1,!1,i||o,o,null,!1,null,AutoDeleteDefault)}newLineNumber+=1;var r=new Line(newLineNumber,s.CallerIDName,o,s);Lines.push(r),AddLineHtml(r,"outbound"),SelectLine(newLineNumber),UpdateBuddyList(),"audio"==e?AudioCall(r,o,a):VideoCall(r,o,a);try{$("#line-"+newLineNumber).get(0).scrollIntoViewIfNeeded()}catch(e){}}else console.warn("Enter number to dial")}else ShowMyProfile()}function SelectLine(e){var t=FindLineByNumber(e);if(null!=t){for(var n=0,i=0;i<Lines.length;i++)if(Lines[i].LineNumber==t.LineNumber&&(n=i+1),1==Lines[i].IsSelected&&Lines[i].LineNumber==t.LineNumber)return;console.log("Selecting Line : "+t.LineNumber),$(".streamSelected").each(function(){$(this).prop("class","stream")}),$("#line-ui-"+t.LineNumber).prop("class","streamSelected"),$("#line-ui-"+t.LineNumber+"-DisplayLineNo").html('<i class="fa fa-phone"></i> '+lang.line+" "+n),$("#line-ui-"+t.LineNumber+"-LineIcon").html(n),SwitchLines(t.LineNumber);for(i=0;i<Lines.length;i++){var a=Lines[i].LineNumber==t.LineNumber?"buddySelected":"buddy";null!=Lines[i].SipSession&&(a=Lines[i].SipSession.isOnHold?"buddyActiveCallHollding":"buddyActiveCall"),$("#line-"+Lines[i].LineNumber).prop("class",a),Lines[i].IsSelected=Lines[i].LineNumber==t.LineNumber}for(var o=0;o<Buddies.length;o++)$("#contact-"+Buddies[o].identity).prop("class","buddy"),Buddies[o].IsSelected=!1;UpdateUI()}}function FindLineByNumber(e){for(var t=0;t<Lines.length;t++)if(Lines[t].LineNumber==e)return Lines[t];return null}function AddLineHtml(e,t){var n=getPicture(e.BuddyObj.identity),i='<table id="line-ui-'+e.LineNumber+'" class=stream cellspacing=0 cellpadding=0>';i+='<tr><td class="streamSection highlightSection" style="height: 85px;">',i+='<div style="float:left; margin:0px; padding:5px; height:38px; line-height:38px">',i+='<button id="line-'+e.LineNumber+'-btn-back" onclick="CloseLine(\''+e.LineNumber+'\')" class=roundButtons title="'+lang.back+'"><i class="fa fa-chevron-left"></i></button> ',i+="</div>",i+='<div class=contact style="cursor: unset; float: left;">',i+='<div id="line-ui-'+e.LineNumber+'-LineIcon" class=lineIcon>'+e.LineNumber+"</div>",i+='<div id="line-ui-'+e.LineNumber+'-DisplayLineNo" class=contactNameText><i class="fa fa-phone"></i> '+lang.line+" "+e.LineNumber+"</div>",i+='<div class=presenceText style="max-width:150px">'+e.DisplayNumber+"</div>",i+="</div>",i+='<div style="float:right; line-height: 46px;">',i+='<div  id="line-'+e.LineNumber+'-monitoring" style="margin-right:10px">',i+='<span style="vertical-align: middle"><i class="fa fa-microphone"></i></span> ',i+='<span class=meterContainer title="'+lang.microphone_levels+'">',i+='<span id="line-'+e.LineNumber+'-Mic" class=meterLevel style="height:0%"></span>',i+="</span> ",i+='<span style="vertical-align: middle"><i class="fa fa-volume-up"></i></span> ',i+='<span class=meterContainer title="'+lang.speaker_levels+'">',i+='<span id="line-'+e.LineNumber+'-Speaker" class=meterLevel style="height:0%"></span>',i+="</span> ",i+="</div>",i+="</div>",i+='<div style="clear:both; height:0px"></div>',i+='<div id="line-'+e.LineNumber+'-timer" class=CallTimer></div>',i+='<div id="line-'+e.LineNumber+'-msg" class=callStatus style="display:none">...</div>',i+='<div style="display:none;">',i+='<audio id="line-'+e.LineNumber+'-remoteAudio"></audio>',i+="</div>",i+="</td></tr>",i+='<tr><td id="line-'+e.LineNumber+'-call-fullscreen" class="streamSection highlightSection">',i+='<div id="line-'+e.LineNumber+'-AnswerCall" style="display:none">',i+='<div class="CallPictureUnderlay" style="background-image: url(\''+n+"')\"></div>",i+='<div class="CallColorUnderlay"></div>',i+='<div class="CallUi">',i+="<div class=callingDisplayName>"+e.DisplayName+"</div>",i+="<div class=callingDisplayNumber>"+e.DisplayNumber+"</div>",i+='<div id="line-'+e.LineNumber+'-in-avatar" class="inCallAvatar" style="background-image: url(\''+n+"')\"></div>",i+="<div class=answerCall>",i+="<button onclick=\"AnswerAudioCall('"+e.LineNumber+'\')" class=answerButton><i class="fa fa-phone"></i> '+lang.answer_call+"</button> ",EnableVideoCalling&&(i+=' <button id="line-'+e.LineNumber+'-answer-video" onclick="AnswerVideoCall(\''+e.LineNumber+'\')" class=answerButton><i class="fa fa-video-camera"></i> '+lang.answer_call_with_video+"</button> "),i+=" <button onclick=\"RejectCall('"+e.LineNumber+'\')" class=rejectButton><i class="fa fa-phone" style="transform: rotate(135deg);"></i> '+lang.reject_call+"</button> ",i+='<div id="line-'+e.LineNumber+'-answer-crm-space">',i+="</div>",i+="</div>",i+="</div>",i+="</div>",i+='<div id="line-'+e.LineNumber+'-progress" style="display:none">',i+='<div class="CallPictureUnderlay" style="background-image: url(\''+n+"')\"></div>",i+='<div class="CallColorUnderlay"></div>',i+='<div class="CallUi">',i+="<div class=callingDisplayName>"+e.DisplayName+"</div>",i+="<div class=callingDisplayNumber>"+e.DisplayNumber+"</div>",i+='<div id="line-'+e.LineNumber+'-out-avatar" class="inCallAvatar" style="background-image: url(\''+n+"')\"></div>",i+="<div class=progressCall>",i+="<button onclick=\"cancelSession('"+e.LineNumber+'\')" class=rejectButton><i class="fa fa-phone" style="transform: rotate(135deg);"></i> '+lang.cancel+"</button>",i+=' <button id="line-'+e.LineNumber+'-early-dtmf" onclick="ShowDtmfMenu(\''+e.LineNumber+'\')" style="display:none"><i class="fa fa-keyboard-o"></i> '+lang.send_dtmf+"</button>",i+="</div>",i+="</div>",i+="</div>",i+='<div id="line-'+e.LineNumber+'-ActiveCall" class=cleanScroller style="display:none; position: absolute; top: 0px; left: 0px; height: 100%; width: 100%;">',i+='<div id="line-'+e.LineNumber+'-AudioOrVideoCall" style="height:100%">',i+='<div id="line-'+e.LineNumber+'-AudioCall" style="height:100%; display:none">',i+='<div class="CallPictureUnderlay" style="background-image: url(\''+n+"')\"></div>",i+='<div class="CallColorUnderlay"></div>',i+='<div class="CallUi">',i+="<div class=callingDisplayName>"+e.DisplayName+"</div>",i+="<div class=callingDisplayNumber>"+e.DisplayNumber+"</div>",i+='<div id="line-'+e.LineNumber+'-session-avatar" class="inCallAvatar" style="background-image: url(\''+n+"')\"></div>",i+='<div id="line-'+e.LineNumber+'-Transfer" style="text-align: center; line-height:40px; display:none">',i+='<div style="margin-top:10px">',i+='<span class=searchClean><input id="line-'+e.LineNumber+'-txt-FindTransferBuddy" oninput="QuickFindBuddy(this,\''+e.LineNumber+'\')" type=text autocomplete=none style="width:150px;" autocomplete=none placeholder="'+lang.search_or_enter_number+'"></span>',i+="<br>",i+=' <button id="line-'+e.LineNumber+'-btn-blind-transfer" onclick="BlindTransfer(\''+e.LineNumber+'\')"><i class="fa fa-reply" style="transform: rotateY(180deg)"></i> '+lang.blind_transfer+"</button>",i+=' <button id="line-'+e.LineNumber+'-btn-attended-transfer" onclick="AttendedTransfer(\''+e.LineNumber+'\')"><i class="fa fa-reply-all" style="transform: rotateY(180deg)"></i> '+lang.attended_transfer+"</button>",i+=' <button id="line-'+e.LineNumber+'-btn-complete-attended-transfer" style="display:none"><i class="fa fa-reply-all" style="transform: rotateY(180deg)"></i> '+lang.complete_transfer+"</button>",i+=' <button id="line-'+e.LineNumber+'-btn-cancel-attended-transfer" style="display:none"><i class="fa fa-phone" style="transform: rotate(135deg);"></i> '+lang.cancel_transfer+"</button>",i+=' <button id="line-'+e.LineNumber+'-btn-terminate-attended-transfer" style="display:none"><i class="fa fa-phone" style="transform: rotate(135deg);"></i> '+lang.end_transfer_call+"</button>",i+="</div>",i+='<div id="line-'+e.LineNumber+'-transfer-status" class=callStatus style="margin-top:10px; display:none">...</div>',i+='<audio id="line-'+e.LineNumber+'-transfer-remoteAudio" style="display:none"></audio>',i+="</div>",i+='<div id="line-'+e.LineNumber+'-Conference" style="text-align: center; line-height:40px; display:none">',i+='<div style="margin-top:10px">',i+='<span class=searchClean><input id="line-'+e.LineNumber+'-txt-FindConferenceBuddy" oninput="QuickFindBuddy(this,\''+e.LineNumber+'\')" type=text autocomplete=none style="width:150px;" autocomplete=none placeholder="'+lang.search_or_enter_number+'"></span>',i+="<br>",i+=' <button id="line-'+e.LineNumber+'-btn-conference-dial" onclick="ConferenceDial(\''+e.LineNumber+'\')"><i class="fa fa-phone"></i> '+lang.call+"</button>",i+=' <button id="line-'+e.LineNumber+'-btn-cancel-conference-dial" style="display:none"><i class="fa fa-phone" style="transform: rotate(135deg);"></i> '+lang.cancel_call+"</button>",i+=' <button id="line-'+e.LineNumber+'-btn-join-conference-call" style="display:none"><i class="fa fa-users"></i> '+lang.join_conference_call+"</button>",i+=' <button id="line-'+e.LineNumber+'-btn-terminate-conference-call" style="display:none"><i class="fa fa-phone" style="transform: rotate(135deg);"></i> '+lang.end_conference_call+"</button>",i+="</div>",i+='<div id="line-'+e.LineNumber+'-conference-status" class=callStatus style="margin-top:10px; display:none">...</div>',i+='<audio id="line-'+e.LineNumber+'-conference-remoteAudio" style="display:none"></audio>',i+="</div>",i+='<div id="line-'+e.LineNumber+'-active-audio-call-crm-space">',i+="</div>",i+="</div>",i+="</div>",i+='<div id="line-'+e.LineNumber+'-VideoCall" style="height:100%; display:none">',i+='<div id="line-'+e.LineNumber+'-preview-container" class="PreviewContainer cleanScroller">',i+='<video id="line-'+e.LineNumber+'-localVideo" muted playsinline></video>',i+="</div>",i+='<div id="line-'+e.LineNumber+'-stage-container" class=StageContainer>',i+='<div id="line-'+e.LineNumber+'-remote-videos" class=VideosContainer></div>',i+='<div id="line-'+e.LineNumber+'-scratchpad-container" class=ScratchpadContainer style="display:none"></div>',i+='<video id="line-'+e.LineNumber+'-sharevideo" controls muted playsinline style="display:none; object-fit: contain; width: 100%;"></video>',i+="</div>",i+="</div>",i+="</div>",i+="<div class=CallControlContainer>",i+="<div class=CallControl>",i+='<div><button id="line-'+e.LineNumber+'-btn-ControlToggle" onclick="ToggleMoreButtons(\''+e.LineNumber+'\')" style="font-size:24px; width:80px"><i class="fa fa-chevron-up"></i></button></div>',i+="<div>",i+='<button id="line-'+e.LineNumber+'-btn-Mute" onclick="MuteSession(\''+e.LineNumber+'\')" class="roundButtons dialButtons inCallButtons" title="'+lang.mute+'"><i class="fa fa-microphone-slash"></i></button>',i+='<button id="line-'+e.LineNumber+'-btn-Unmute" onclick="UnmuteSession(\''+e.LineNumber+'\')" class="roundButtons dialButtons inCallButtons" title="'+lang.unmute+'" style="color: red; display:none"><i class="fa fa-microphone"></i></button>',i+='<button id="line-'+e.LineNumber+'-btn-Hold" onclick="holdSession(\''+e.LineNumber+'\')" class="roundButtons dialButtons inCallButtons"  title="'+lang.hold_call+'"><i class="fa fa-pause-circle"></i></button>',i+='<button id="line-'+e.LineNumber+'-btn-Unhold" onclick="unholdSession(\''+e.LineNumber+'\')" class="roundButtons dialButtons inCallButtons" title="'+lang.resume_call+'" style="color: red; display:none"><i class="fa fa-play-circle"></i></button>',"outbound"==t?i+='<button id="line-'+e.LineNumber+'-btn-ShowDtmf" onclick="ShowDtmfMenu(\''+e.LineNumber+'\')" class="roundButtons dialButtons inCallButtons" title="'+lang.send_dtmf+'"><i class="fa fa-keyboard-o"></i></button>':EnableTransfer&&(i+='<button id="line-'+e.LineNumber+'-btn-Transfer" onclick="StartTransferSession(\''+e.LineNumber+'\')" class="roundButtons dialButtons inCallButtons" title="'+lang.transfer_call+'"><i class="fa fa-reply" style="transform: rotateY(180deg)"></i></button>',i+='<button id="line-'+e.LineNumber+'-btn-CancelTransfer" onclick="CancelTransferSession(\''+e.LineNumber+'\')" class="roundButtons dialButtons inCallButtons" title="'+lang.cancel_transfer+'" style="color: red; display:none"><i class="fa fa-reply" style="transform: rotateY(180deg)"></i></button>'),i+='<button id="line-'+e.LineNumber+'-btn-expand" onclick="ExpandVideoArea(\''+e.LineNumber+'\')" class="roundButtons dialButtons inCallButtons"><i class="fa fa-expand"></i></button>',i+='<button id="line-'+e.LineNumber+'-btn-restore" onclick="RestoreVideoArea(\''+e.LineNumber+'\')" class="roundButtons dialButtons inCallButtons" style="display:none"><i class="fa fa-compress"></i></button>',i+='<button id="line-'+e.LineNumber+'-btn-End" onclick="endSession(\''+e.LineNumber+'\')" class="roundButtons dialButtons inCallButtons hangupButton" title="'+lang.end_call+'"><i class="fa fa-phone" style="transform: rotate(135deg);"></i></button>',i+="</div>",i+='<div id="line-'+e.LineNumber+'-btn-more" style="display:none">',"undefined"==typeof MediaRecorder||"allow"!=CallRecordingPolicy&&"enabled"!=CallRecordingPolicy||(i+='<button id="line-'+e.LineNumber+'-btn-start-recording" onclick="StartRecording(\''+e.LineNumber+'\')" class="roundButtons dialButtons inCallButtons" title="'+lang.start_call_recording+'"><i class="fa fa-dot-circle-o"></i></button>',i+='<button id="line-'+e.LineNumber+'-btn-stop-recording" onclick="StopRecording(\''+e.LineNumber+'\')" class="roundButtons dialButtons inCallButtons" title="'+lang.stop_call_recording+'" style="color: red; display:none"><i class="fa fa-circle"></i></button>'),EnableConference&&(i+='<button id="line-'+e.LineNumber+'-btn-Conference" onclick="StartConferenceCall(\''+e.LineNumber+'\')" class="roundButtons dialButtons inCallButtons" title="'+lang.conference_call+'"><i class="fa fa-users"></i></button>',i+='<button id="line-'+e.LineNumber+'-btn-CancelConference" onclick="CancelConference(\''+e.LineNumber+'\')" class="roundButtons dialButtons inCallButtons" title="'+lang.cancel_conference+'" style="color: red; display:none"><i class="fa fa-users"></i></button>'),"outbound"==t?EnableTransfer&&(i+='<button id="line-'+e.LineNumber+'-btn-Transfer" onclick="StartTransferSession(\''+e.LineNumber+'\')" class="roundButtons dialButtons inCallButtons" title="'+lang.transfer_call+'"><i class="fa fa-reply" style="transform: rotateY(180deg)"></i></button>',i+='<button id="line-'+e.LineNumber+'-btn-CancelTransfer" onclick="CancelTransferSession(\''+e.LineNumber+'\')" class="roundButtons dialButtons inCallButtons" title="'+lang.cancel_transfer+'" style="color: red; display:none"><i class="fa fa-reply" style="transform: rotateY(180deg)"></i></button>'):i+='<button id="line-'+e.LineNumber+'-btn-ShowDtmf" onclick="ShowDtmfMenu(\''+e.LineNumber+'\')" class="roundButtons dialButtons inCallButtons" title="'+lang.send_dtmf+'"><i class="fa fa-keyboard-o"></i></button>',i+='<button id="line-'+e.LineNumber+'-btn-settings" onclick="ChangeSettings(\''+e.LineNumber+'\', this)" class="roundButtons dialButtons inCallButtons" title="'+lang.device_settings+'"><i class="fa fa-volume-up"></i></button>',i+='<button id="line-'+e.LineNumber+'-btn-present-src" onclick="ShowPresentMenu(this, \''+e.LineNumber+'\')" class="roundButtons dialButtons inCallButtons" title="'+lang.camera+'"><i class="fa fa-video-camera"></i></button>',i+='<button id="line-'+e.LineNumber+'-btn-ShowCallStats" onclick="ShowCallStats(\''+e.LineNumber+'\')" class="roundButtons dialButtons inCallButtons" title="'+lang.call_stats+'"><i class="fa fa-area-chart"></i></button>',i+='<button id="line-'+e.LineNumber+'-btn-HideCallStats" onclick="HideCallStats(\''+e.LineNumber+'\')" class="roundButtons dialButtons inCallButtons" title="'+lang.call_stats+'" style="color: red; display:none"><i class="fa fa-area-chart"></i></button>',i+='<button id="line-'+e.LineNumber+'-btn-ShowTimeline" onclick="ShowCallTimeline(\''+e.LineNumber+'\')" class="roundButtons dialButtons inCallButtons" title="'+lang.activity_timeline+'"><i class="fa fa-list-ul"></i></button>',i+='<button id="line-'+e.LineNumber+'-btn-HideTimeline" onclick="HideCallTimeline(\''+e.LineNumber+'\')" class="roundButtons dialButtons inCallButtons" title="'+lang.activity_timeline+'" style="color: red; display:none"><i class="fa fa-list-ul"></i></button>',i+="</div>",i+="</div>",i+="</div>",i+='<div id="line-'+e.LineNumber+'-AudioStats" class="audioStats cleanScroller" style="display:none">',i+="<div>",i+="<div>"+lang.send_statistics+"</div>",i+='<div style="position: relative; margin: auto; height: 160px; width: 100%;"><canvas id="line-'+e.LineNumber+'-AudioSendBitRate" class=audioGraph></canvas></div>',i+='<div style="position: relative; margin: auto; height: 160px; width: 100%;"><canvas id="line-'+e.LineNumber+'-AudioSendPacketRate" class=audioGraph></canvas></div>',i+="</div>",i+="<div>",i+="<div>"+lang.receive_statistics+"</div>",i+='<div style="position: relative; margin: auto; height: 160px; width: 100%;"><canvas id="line-'+e.LineNumber+'-AudioReceiveBitRate" class=audioGraph></canvas></div>',i+='<div style="position: relative; margin: auto; height: 160px; width: 100%;"><canvas id="line-'+e.LineNumber+'-AudioReceivePacketRate" class=audioGraph></canvas></div>',i+='<div style="position: relative; margin: auto; height: 160px; width: 100%;"><canvas id="line-'+e.LineNumber+'-AudioReceivePacketLoss" class=audioGraph></canvas></div>',i+='<div style="position: relative; margin: auto; height: 160px; width: 100%;"><canvas id="line-'+e.LineNumber+'-AudioReceiveJitter" class=audioGraph></canvas></div>',i+='<div style="position: relative; margin: auto; height: 160px; width: 100%;"><canvas id="line-'+e.LineNumber+'-AudioReceiveLevels" class=audioGraph></canvas></div>',i+="</div>",i+="</div>",i+='<div id="line-'+e.LineNumber+'-CallDetails" class="callTimeline cleanScroller" style="display:none">',i+="</div>",i+="</div>",i+="</td></tr>",i+="</table>",$("#rightContent").append(i),$("#line-"+e.LineNumber+"-AudioOrVideoCall").on("click",function(){RestoreCallControls(e.LineNumber)})}function RemoveLine(e){if(null!=e){for(var t=e.SipSession.data.earlyReject,n=0;n<Lines.length;n++)if(Lines[n].LineNumber==e.LineNumber){Lines.splice(n,1);break}1!=t&&(CloseLine(e.LineNumber),$("#line-ui-"+e.LineNumber).remove()),UpdateBuddyList(),1!=t&&null!=localDB.getItem("SelectedBuddy")&&(console.log("Selecting previously selected buddy...",localDB.getItem("SelectedBuddy")),SelectBuddy(localDB.getItem("SelectedBuddy")),UpdateUI())}}function CloseLine(e){$(".buddySelected").each(function(){$(this).prop("class","buddy")}),$(".streamSelected").each(function(){$(this).prop("class","stream")}),console.log("Closing Line: "+e);for(var t=0;t<Lines.length;t++)Lines[t].IsSelected=!1;selectedLine=null;for(var n=0;n<Buddies.length;n++)Buddies[n].IsSelected=!1;selectedBuddy=null,UpdateUI()}function SwitchLines(e){$.each(userAgent.sessions,function(t,n){n.state==SIP.SessionState.Established&&0==n.isOnHold&&n.data.line!=e&&holdSession(n.data.line),n.data.IsCurrentCall=!1});var t=FindLineByNumber(e);if(null!=t&&null!=t.SipSession){var n=t.SipSession;n.state==SIP.SessionState.Established&&1==n.isOnHold&&unholdSession(e),n.data.IsCurrentCall=!0}selectedLine=e,RefreshLineActivity(e)}function RefreshLineActivity(e){var t=FindLineByNumber(e);if(null!=t&&null!=t.SipSession){var n=t.SipSession;$("#line-"+e+"-CallDetails").empty();var i=[],a=0,o=moment.utc(n.data.callstart.replace(" UTC","")),s=null;n.data.startTime&&(s=moment.utc(n.data.startTime),a=moment.duration(s.diff(o))),o=o.format("YYYY-MM-DD HH:mm:ss UTC"),s=s?s.format("YYYY-MM-DD HH:mm:ss UTC"):null,a=0!=a?a.asSeconds():0;var l="",r="";"inbound"==n.data.calldirection?l="<"+n.remoteIdentity.uri.user+"> "+n.remoteIdentity.displayName:"outbound"==n.data.calldirection&&(r=n.data.dst);var d=n.data.withvideo?"("+lang.with_video+")":"",c="inbound"==n.data.calldirection?lang.you_received_a_call_from+" "+l+" "+d:lang.you_made_a_call_to+" "+r+" "+d;if(i.push({Message:c,TimeStr:o}),s){var u="inbound"==n.data.calldirection?lang.you_answered_after+" "+a+" "+lang.seconds_plural:lang.they_answered_after+" "+a+" "+lang.seconds_plural;i.push({Message:u,TimeStr:s})}var p=n.data.transfer?n.data.transfer:[];$.each(p,function(e,t){var n="Blind"==t.type?lang.you_started_a_blind_transfer_to+" "+t.to+". ":lang.you_started_an_attended_transfer_to+" "+t.to+". ";t.accept&&1==t.accept.complete?n+=lang.the_call_was_completed:""!=t.accept.disposition&&(n+=lang.the_call_was_not_completed+" ("+t.accept.disposition+")"),i.push({Message:n,TimeStr:t.transferTime})});var g=n.data.mute?n.data.mute:[];$.each(g,function(e,t){i.push({Message:"mute"==t.event?lang.you_put_the_call_on_mute:lang.you_took_the_call_off_mute,TimeStr:t.eventTime})});var m=n.data.hold?n.data.hold:[];$.each(m,function(e,t){i.push({Message:"hold"==t.event?lang.you_put_the_call_on_hold:lang.you_took_the_call_off_hold,TimeStr:t.eventTime})});var f=n.data.ConfbridgeEvents?n.data.ConfbridgeEvents:[];$.each(f,function(e,t){i.push({Message:t.event,TimeStr:t.eventTime})});var v=n.data.recordings?n.data.recordings:[];$.each(v,function(e,t){var n=lang.call_is_being_recorded;t.startTime!=t.stopTime&&(n+="("+lang.now_stopped+")"),i.push({Message:n,TimeStr:t.startTime})});var b=n.data.confcalls?n.data.confcalls:[];$.each(b,function(e,t){var n=lang.you_started_a_conference_call_to+" "+t.to+". ";t.accept&&1==t.accept.complete?n+=lang.the_call_was_completed:""!=t.accept.disposition&&(n+=lang.the_call_was_not_completed+" ("+t.accept.disposition+")"),i.push({Message:n,TimeStr:t.startTime})}),i.sort(function(e,t){var n=moment.utc(e.TimeStr.replace(" UTC","")),i=moment.utc(t.TimeStr.replace(" UTC",""));return n.isSameOrAfter(i,"second")?-1:1}),$.each(i,function(t,n){var i=moment.utc(n.TimeStr.replace(" UTC","")).local().format(DisplayTimeFormat),a="<table class=timelineMessage cellspacing=0 cellpadding=0><tr>";a+="<td class=timelineMessageArea>",a+='<div class=timelineMessageDate><i class="fa fa-circle timelineMessageDot"></i>'+i+"</div>",a+="<div class=timelineMessageText>"+n.Message+"</div>",a+="</td>",a+="</tr></table>",$("#line-"+e+"-CallDetails").prepend(a)})}}function InitUserBuddies(){var e={TotalRows:0,DataCollection:[]};return localDB.setItem(profileUserID+"-Buddies",JSON.stringify(e)),JSON.parse(localDB.getItem(profileUserID+"-Buddies"))}function MakeBuddy(e,t,n,i,a,o,s,l,r,d){var c=JSON.parse(localDB.getItem(profileUserID+"-Buddies"));null==c&&(c=InitUserBuddies());var u=utcDateNow(),p=null,g=uID();return"extension"==e&&(c.DataCollection.push({Type:"extension",LastActivity:u,ExtensionNumber:o,MobileNumber:"",ContactNumber1:"",ContactNumber2:"",uID:g,cID:null,gID:null,jid:null,DisplayName:a,Description:"",Email:"",MemberCount:0,EnableDuringDnd:l,Subscribe:i,SubscribeUser:r,AutoDelete:d}),
p=new Buddy("extension",g,a,o,"","","",u,"","",null,l,i,r,d),AddBuddy(p,t,n,i,!0)),"xmpp"==e&&(c.DataCollection.push({Type:"xmpp",LastActivity:u,ExtensionNumber:o,MobileNumber:"",ContactNumber1:"",ContactNumber2:"",uID:g,cID:null,gID:null,jid:s,DisplayName:a,Description:"",Email:"",MemberCount:0,EnableDuringDnd:l,Subscribe:i,SubscribeUser:r,AutoDelete:d}),p=new Buddy("xmpp",g,a,o,"","","",u,"","",s,l,i,r,d),AddBuddy(p,t,n,i,!0)),"contact"==e&&(c.DataCollection.push({Type:"contact",LastActivity:u,ExtensionNumber:"",MobileNumber:"",ContactNumber1:o,ContactNumber2:"",uID:null,cID:g,gID:null,jid:null,DisplayName:a,Description:"",Email:"",MemberCount:0,EnableDuringDnd:l,Subscribe:!1,SubscribeUser:null,AutoDelete:d}),p=new Buddy("contact",g,a,"","",o,"",u,"","",null,l,!1,null,d),AddBuddy(p,t,n,!1,!0)),"group"==e&&(c.DataCollection.push({Type:"group",LastActivity:u,ExtensionNumber:o,MobileNumber:"",ContactNumber1:"",ContactNumber2:"",uID:null,cID:null,gID:g,jid:null,DisplayName:a,Description:"",Email:"",MemberCount:0,EnableDuringDnd:!1,Subscribe:!1,SubscribeUser:null,AutoDelete:d}),p=new Buddy("group",g,a,o,"","","",u,"","",null,!1,!1,null,d),AddBuddy(p,t,n,!1,!0)),c.TotalRows=c.DataCollection.length,localDB.setItem(profileUserID+"-Buddies",JSON.stringify(c)),p}function UpdateBuddyCallerID(e,t){e.CallerIDName=t;var n=e.identity,i=JSON.parse(localDB.getItem(profileUserID+"-Buddies"));null!=i&&($.each(i.DataCollection,function(e,i){if(i.uID==n||i.cID==n||i.gID==n)return i.DisplayName=t,!1}),localDB.setItem(profileUserID+"-Buddies",JSON.stringify(i))),UpdateBuddyList()}function AddBuddy(e,t,n,i,a){Buddies.push(e),1==t&&UpdateBuddyList(),AddBuddyMessageStream(e),1==i&&SubscribeBuddy(e),1==n&&SelectBuddy(e.identity),1==a&&CleanupBuddies()}function CleanupBuddies(){if(MaxBuddyAge>1||MaxBuddies>1){if(Buddies.sort(function(e,t){var n=moment.utc(e.lastActivity.replace(" UTC","")),i=moment.utc(t.lastActivity.replace(" UTC",""));return n.isSameOrAfter(i,"second")?-1:1}),MaxBuddyAge>1){var e=moment.utc().subtract(MaxBuddyAge,"days");console.log("Running Buddy Cleanup for activity older than: ",e.format(DisplayDateFormat+" "+DisplayTimeFormat));for(var t=Buddies.length-1;t>=0;t--){var n=moment.utc(Buddies[t].lastActivity.replace(" UTC",""));n.isSameOrAfter(e,"second")||1==Buddies[t].AllowAutoDelete&&(console.warn("This buddy is too old, and will be deleted: ",n.format(DisplayDateFormat+" "+DisplayTimeFormat)),DoRemoveBuddy(Buddies[t].identity))}}if(MaxBuddies>1&&MaxBuddies<Buddies.length){console.log("Running Buddy Cleanup for buddies more than: ",MaxBuddies);for(t=Buddies.length-1;t>=MaxBuddies;t--)1==Buddies[t].AllowAutoDelete&&(console.warn("This buddy is too Many, and will be deleted: ",Buddies[t].identity),DoRemoveBuddy(Buddies[t].identity))}}}function PopulateBuddyList(){console.log("Clearing Buddies..."),Buddies=new Array,console.log("Adding Buddies...");var e=JSON.parse(localDB.getItem(profileUserID+"-Buddies"));null==e&&(e=InitUserBuddies()),console.log("Total Buddies: "+e.TotalRows),$.each(e.DataCollection,function(e,t){if(t.AutoDelete=1==t.AutoDelete,t.Pinned=1==t.Pinned,"extension"==t.Type){var n=new Buddy("extension",t.uID,t.DisplayName,t.ExtensionNumber,t.MobileNumber,t.ContactNumber1,t.ContactNumber2,t.LastActivity,t.Description,t.Email,null,t.EnableDuringDnd,t.Subscribe,t.SubscribeUser,t.AutoDelete,t.Pinned);AddBuddy(n,!1,!1,!1)}else if("xmpp"==t.Type){n=new Buddy("xmpp",t.uID,t.DisplayName,t.ExtensionNumber,"","","",t.LastActivity,"","",t.jid,t.EnableDuringDnd,t.Subscribe,t.SubscribeUser,t.AutoDelete,t.Pinned);AddBuddy(n,!1,!1,!1)}else if("contact"==t.Type){n=new Buddy("contact",t.cID,t.DisplayName,"",t.MobileNumber,t.ContactNumber1,t.ContactNumber2,t.LastActivity,t.Description,t.Email,null,t.EnableDuringDnd,t.Subscribe,t.SubscribeUser,t.AutoDelete,t.Pinned);AddBuddy(n,!1,!1,!1)}else if("group"==t.Type){n=new Buddy("group",t.gID,t.DisplayName,t.ExtensionNumber,"","","",t.LastActivity,t.MemberCount+" member(s)",t.Email,null,t.EnableDuringDnd,t.Subscribe,t.SubscribeUser,t.AutoDelete,t.Pinned);AddBuddy(n,!1,!1,!1)}}),CleanupBuddies(),console.log("Updating Buddy List..."),UpdateBuddyList()}function UpdateBuddyList(){var e=$("#txtFindBuddy").val();$("#myContacts").empty();for(var t=0,n=0;n<Lines.length;n++){var i=Lines[n].IsSelected?"buddySelected":"buddy";null!=Lines[n].SipSession&&(i=Lines[n].SipSession.isOnHold?"buddyActiveCallHollding":"buddyActiveCall");var a='<div id="line-'+Lines[n].LineNumber+'" class='+i+" onclick=\"SelectLine('"+Lines[n].LineNumber+"')\">";0==Lines[n].IsSelected&&Lines[n].SipSession&&1!=Lines[n].SipSession.data.started&&"inbound"==Lines[n].SipSession.data.calldirection&&(a+='<span id="line-'+Lines[n].LineNumber+'-ringing" class=missedNotifyer style="padding-left: 5px; padding-right: 5px; width:unset"><i class="fa fa-phone"></i> '+lang.state_ringing+"</span>"),a+="<div class=lineIcon>"+(n+1)+"</div>",a+='<div class=contactNameText><i class="fa fa-phone"></i> '+lang.line+" "+(n+1)+"</div>",a+='<div id="line-'+Lines[n].LineNumber+'-datetime" class=contactDate>&nbsp;</div>',a+="<div class=presenceText>"+Lines[n].DisplayName+" <"+Lines[n].DisplayNumber+"></div>",a+="</div>",Lines[n].SipSession&&1!=Lines[n].SipSession.data.earlyReject&&($("#myContacts").append(a),t++)}if(1!=DisableBuddies){if(t>0&&$("#myContacts").append("<hr class=hrline>"),0==Buddies.length&&0==t)return console.warn("You have no buddies, will show the Dial Screen rather"),void(1==UiCustomDialButton?"undefined"!=typeof web_hook_dial_out&&web_hook_dial_out(null):ShowDial());SortBuddies();for(var o=0,s=0;s<Buddies.length;s++){var l=Buddies[s];if(e&&e.length>=1){var r=!1;if(l.CallerIDName.toLowerCase().indexOf(e.toLowerCase())>-1&&(r=!0),l.ExtNo.toLowerCase().indexOf(e.toLowerCase())>-1&&(r=!0),l.Desc.toLowerCase().indexOf(e.toLowerCase())>-1&&(r=!0),!r)continue}var d=moment.utc(),c=moment.utc(l.lastActivity.replace(" UTC","")),u="";if(u=c.isSame(d,"day")?c.local().format(DisplayTimeFormat):c.local().format(DisplayDateFormat),HideAutoDeleteBuddies&&l.AllowAutoDelete)o++;else{i=l.IsSelected?"buddySelected":"buddy";if("extension"==l.type){var p=l.presence;"Unknown"==p&&(p=lang.state_unknown),"Not online"==p&&(p=lang.state_not_online),"Ready"==p&&(p=lang.state_ready),"On the phone"==p&&(p=lang.state_on_the_phone),"Ringing"==p&&(p=lang.state_ringing),"On hold"==p&&(p=lang.state_on_hold),"Unavailable"==p&&(p=lang.state_unavailable),1!=l.EnableSubscribe&&(p=l.Desc);var g="";1==l.AllowAutoDelete&&(g='<i class="fa fa-clock-o"></i> ');a='<div id="contact-'+l.identity+'" class='+i+" onclick=\"SelectBuddy('"+l.identity+"', 'extension')\">";a+='<span id="contact-'+l.identity+'-missed" class=missedNotifyer style="'+(l.missed&&l.missed>0?"":"display:none")+'">'+l.missed+"</span>",a+='<div id="contact-'+l.identity+'-picture" class=buddyIcon style="background-image: url(\''+getPicture(l.identity,l.type)+"')\"></div>",a+=l.Pinned?'<span class=pinnedBuddy><i class="fa fa-thumb-tack"></i></span>':"",a+="<div class=contactNameText>",a+='<span id="contact-'+l.identity+'-devstate" class="'+(l.EnableSubscribe?l.devState:"dotDefault")+'"></span>',a+=1==BuddyShowExtenNum?" "+l.ExtNo+" - ":" ",a+=l.CallerIDName,a+="</div>",a+='<div id="contact-'+l.identity+'-datetime" class=contactDate>'+g+u+"</div>",a+='<div id="contact-'+l.identity+'-presence" class=presenceText>'+p+"</div>",a+="</div>",$("#myContacts").append(a)}else if("xmpp"==l.type){p=l.presenceText,g="";1==l.AllowAutoDelete&&(g='<i class="fa fa-clock-o"></i> '),p=p.replace(/[<>"'\r\n&]/g,function(e){let t={"<":"lt",">":"gt",'"':"quot","'":"apos","&":"amp","\r":"#10","\n":"#13"};return"&"+t[e]+";"});a='<div id="contact-'+l.identity+'" class='+i+" onclick=\"SelectBuddy('"+l.identity+"', 'extension')\">";a+='<span id="contact-'+l.identity+'-missed" class=missedNotifyer style="'+(l.missed&&l.missed>0?"":"display:none")+'">'+l.missed+"</span>",a+='<div id="contact-'+l.identity+'-picture" class=buddyIcon style="background-image: url(\''+getPicture(l.identity,l.type)+"')\"></div>",a+=l.Pinned?'<span class=pinnedBuddy><i class="fa fa-thumb-tack"></i></span>':"",a+="<div class=contactNameText>",a+='<span id="contact-'+l.identity+'-devstate" class="'+(l.EnableSubscribe?l.devState:"dotDefault")+'"></span>',a+=1==BuddyShowExtenNum?" "+l.ExtNo+" - ":" ",a+=l.CallerIDName,a+="</div>",a+='<div id="contact-'+l.identity+'-datetime" class=contactDate>'+g+u+"</div>",a+='<div id="contact-'+l.identity+'-presence" class=presenceText><i class="fa fa-comments"></i> '+p+"</div>",a+='<div id="contact-'+l.identity+'-chatstate-menu" class=presenceText style="display:none"><i class="fa fa-commenting-o"></i> '+l.CallerIDName+" "+lang.is_typing+"...</div>",a+="</div>",$("#myContacts").append(a)}else if("contact"==l.type){g="";1==l.AllowAutoDelete&&(g='<i class="fa fa-clock-o"></i> ');a='<div id="contact-'+l.identity+'" class='+i+" onclick=\"SelectBuddy('"+l.identity+"', 'contact')\">";a+='<span id="contact-'+l.identity+'-missed" class=missedNotifyer style="'+(l.missed&&l.missed>0?"":"display:none")+'">'+l.missed+"</span>",a+='<div id="contact-'+l.identity+'-picture" class=buddyIcon style="background-image: url(\''+getPicture(l.identity,l.type)+"')\"></div>",a+=l.Pinned?'<span class=pinnedBuddy><i class="fa fa-thumb-tack"></i></span>':"",a+='<div class=contactNameText><i class="fa fa-address-card"></i> '+l.CallerIDName+"</div>",a+='<div id="contact-'+l.identity+'-datetime" class=contactDate>'+g+u+"</div>",a+="<div class=presenceText>"+l.Desc+"</div>",a+="</div>",$("#myContacts").append(a)}else if("group"==l.type){g="";1==l.AllowAutoDelete&&(g='<i class="fa fa-clock-o"></i> ');a='<div id="contact-'+l.identity+'" class='+i+" onclick=\"SelectBuddy('"+l.identity+"', 'group')\">";a+='<span id="contact-'+l.identity+'-missed" class=missedNotifyer style="'+(l.missed&&l.missed>0?"":"display:none")+'">'+l.missed+"</span>",a+='<div id="contact-'+l.identity+'-picture" class=buddyIcon style="background-image: url(\''+getPicture(l.identity,l.type)+"')\"></div>",a+=l.Pinned?'<span class=pinnedBuddy><i class="fa fa-thumb-tack"></i></span>':"",a+='<div class=contactNameText><i class="fa fa-users"></i> '+l.CallerIDName+"</div>",a+='<div id="contact-'+l.identity+'-datetime" class=contactDate>'+g+u+"</div>",a+="<div class=presenceText>"+l.Desc+"</div>",a+="</div>",$("#myContacts").append(a)}}}if(o>0){console.warn("Auto Delete Buddies not shown",o);a="<div id=hiddenBuddies class=hiddenBuddiesText>("+lang.sort_no_showing.replace("{0}",o)+")</div>";$("#myContacts").append(a),$("#hiddenBuddies").on("click",function(){HideAutoDeleteBuddies=!1,UpdateBuddyList()})}for(s=0;s<Buddies.length;s++)if(Buddies[s].IsSelected){SelectBuddy(Buddies[s].identity,Buddies[s].type);break}}else 0==t&&(1==UiCustomDialButton?"undefined"!=typeof web_hook_dial_out&&web_hook_dial_out(null):ShowDial())}function AddBuddyMessageStream(e){var t="";if(t+='<tr><td id="contact-'+e.identity+'-ProfileCell" class="streamSection highlightSection buddyProfileSection" style="height: 50px; box-sizing: border-box;">',t+='<table cellpadding=0 cellspacing=0 border=0 style="width:100%; table-layout: fixed;">',t+="<tr>",t+='<td style="width:38px; text-align: center;">',t+='<button id="contact-'+e.identity+'-btn-back" onclick="CloseBuddy(\''+e.identity+'\')" class=roundButtons style="margin-right:5px" title="'+lang.back+'"><i class="fa fa-chevron-left"></i></button> ',t+="</td>",t+='<td style="width:100%">',t+='<div class=contact style="cursor: unset; padding:0px">',"extension"==e.type||"xmpp"==e.type?t+='<div id="contact-'+e.identity+'-picture-main" class=buddyIcon style="background-image: url(\''+getPicture(e.identity)+"')\"></div>":"contact"==e.type?t+='<div id="contact-'+e.identity+'-picture-main" class=buddyIcon style="background-image: url(\''+getPicture(e.identity,"contact")+"')\"></div>":"group"==e.type&&(t+='<div id="contact-'+e.identity+'-picture-main" class=buddyIcon style="background-image: url(\''+getPicture(e.identity,"group")+"')\"></div>"),"extension"==e.type||"xmpp"==e.type?(t+='<div class=contactNameText style="margin-right: 0px;">',t+='<span id="contact-'+e.identity+'-devstate-main" class="'+e.devState+'"></span>',t+=' <span id="contact-'+e.identity+'-name">'+e.CallerIDName+"</span>",t+="</div>"):"contact"==e.type?(t+='<div class=contactNameText style="margin-right: 0px;">',t+='<i class="fa fa-address-card"></i>',t+=' <span id="contact-'+e.identity+'-name">'+e.CallerIDName+"</span>",t+="</div>"):"group"==e.type&&(t+='<div class=contactNameText style="margin-right: 0px;">',t+='<i class="fa fa-users"></i>',t+=' <span id="contact-'+e.identity+'-name">'+e.CallerIDName+"</span>",t+="</div>"),"extension"==e.type){var n=e.presence;"Unknown"==n&&(n=lang.state_unknown),"Not online"==n&&(n=lang.state_not_online),"Ready"==n&&(n=lang.state_ready),"On the phone"==n&&(n=lang.state_on_the_phone),"Ringing"==n&&(n=lang.state_ringing),"On hold"==n&&(n=lang.state_on_hold),"Unavailable"==n&&(n=lang.state_unavailable),t+='<div id="contact-'+e.identity+'-presence-main" class=presenceText>'+n+"</div>"}else"xmpp"==e.type?(t+='<div id="contact-'+e.identity+'-presence-main" class=presenceText><i class="fa fa-comments"></i> '+e.presenceText+"</div>",t+='<div id="contact-'+e.identity+'-chatstate-main" class=presenceText style="display:none"><i class="fa fa-commenting-o"></i> '+e.CallerIDName+" "+lang.is_typing+"...</div>"):t+='<div id="contact-'+e.identity+'-presence-main" class=presenceText>'+e.Desc+"</div>";t+="</div>",t+="</td>";var i=80;"extension"!=e.type&&"xmpp"!=e.type||!EnableVideoCalling||(i=120);var a=200;"extension"!=e.type&&"xmpp"!=e.type||!EnableVideoCalling||(a=240),t+='<td id="contact-'+e.identity+'-action-buttons" style="width: '+i+'px; text-align: right">',t+='<button id="contact-'+e.identity+'-btn-audioCall" onclick="AudioCallMenu(\''+e.identity+'\', this)" class=roundButtons title="'+lang.audio_call+'"><i class="fa fa-phone"></i></button>',"extension"!=e.type&&"xmpp"!=e.type||!EnableVideoCalling||(t+=' <button id="contact-'+e.identity+"-btn-videoCall\" onclick=\"DialByLine('video', '"+e.identity+"', '"+e.ExtNo+'\');" class=roundButtons title="'+lang.video_call+'"><i class="fa fa-video-camera"></i></button>'),t+='<span id="contact-'+e.identity+'-extra-buttons" style="display:none">',t+=' <button id="contact-'+e.identity+'-btn-edit" onclick="EditBuddyWindow(\''+e.identity+'\')" class=roundButtons title="'+lang.edit+'"><i class="fa fa-pencil"></i></button>',t+=' <button id="contact-'+e.identity+'-btn-search" onclick="FindSomething(\''+e.identity+'\')" class=roundButtons title="'+lang.find_something+'"><i class="fa fa-search"></i></button>',t+=' <button id="contact-'+e.identity+'-btn-pin" onclick="TogglePinned(\''+e.identity+'\')" class=roundButtons title="'+lang.pin_to_top+'"><i class="fa fa-thumb-tack"></i></button>',t+="</span>",t+=' <button id="contact-'+e.identity+'-btn-toggle-extra" onclick="ToggleExtraButtons(\''+e.identity+"', "+i+", "+a+')" class=roundButtons><i class="fa fa-ellipsis-h"></i></button>',t+="</td>",t+="</tr></table>",t+="</div>",t+='<div style="clear:both; height:0px"></div>',t+='<div id="contact-'+e.identity+'-search" style="margin-top:6px; display:none">',t+='<span class=searchClean style="width:100%"><input type=text style="width: calc(100% - 40px);" autocomplete=none oninput=SearchStream(this,\''+e.identity+"') placeholder=\""+lang.find_something_in_the_message_stream+'"></span>',t+="</div>",t+="</td></tr>";var o="";o+='<tr><td id="contact-'+e.identity+'-MessagesCell" class="streamSection streamSectionBackground wallpaperBackground buddyMessageSection">',o+='<div id="contact-'+e.identity+'-ChatHistory" class="chatHistory cleanScroller" ondragenter="setupDragDrop(event, \''+e.identity+"')\" ondragover=\"setupDragDrop(event, '"+e.identity+"')\" ondragleave=\"cancelDragDrop(event, '"+e.identity+"')\" ondrop=\"onFileDragDrop(event, '"+e.identity+"')\">",o+="</div>",o+="</td></tr>";var s="";"extension"!=e.type&&"xmpp"!=e.type&&"group"!=e.type||!EnableTextMessaging||(s+='<tr><td id="contact-'+e.identity+'-InteractionCell" class="streamSection highlightSection buddyInteractionSection" style="height:80px">',s+='<div id="contact-'+e.identity+'-imagePastePreview" class=sendImagePreview style="display:none" tabindex=0></div>',s+='<div id="contact-'+e.identity+'-msgPreview" class=sendMessagePreview style="display:none">',s+="<table class=sendMessagePreviewContainer cellpadding=0 cellspacing=0><tr>",s+='<td style="text-align:right"><div id="contact-'+e.identity+'-msgPreviewhtml" class="sendMessagePreviewHtml cleanScroller"></div></td>',s+='<td style="width:40px"><button onclick="SendChatMessage(\''+e.identity+'\')" class="roundButtons" title="'+lang.send+'"><i class="fa fa-paper-plane"></i></button></td>',s+="</tr></table>",s+="</div>",s+='<div id="contact-'+e.identity+'-fileShare" style="display:none">',s+='<input type=file multiple onchange="console.log(this)" />',s+="</div>",s+='<div id="contact-'+e.identity+'-audio-recording" style="display:none"></div>',s+='<div id="contact-'+e.identity+'-video-recording" style="display:none"></div>',s+='<div id="contact-'+e.identity+'-dictate-message" style="display:none"></div>',s+='<div id="contact-'+e.identity+'-emoji-menu" style="display:none"></div>',s+='<div id="contact-'+e.identity+'-chatstate" style="display:none"><i class="fa fa-commenting-o"></i> '+e.CallerIDName+" "+lang.is_typing+"...</div>",s+="<table class=sendMessageContainer cellpadding=0 cellspacing=0><tr>",s+='<td id="contact-'+e.identity+'-add-menu" class=MessageActions style="width:40px"><button onclick="AddMenu(this, \''+e.identity+'\')" class=roundButtons title="'+lang.menu+'"><i class="fa fa-ellipsis-h"></i></button></td>',s+='<td><textarea id="contact-'+e.identity+'-ChatMessage" class="chatMessage cleanScroller" placeholder="'+lang.type_your_message_here+'" onkeydown="chatOnkeydown(event, this,\''+e.identity+"')\" oninput=\"chatOnInput(event, this,'"+e.identity+"')\" onpaste=\"chatOnbeforepaste(event, this,'"+e.identity+"')\"></textarea></td>",s+='<td id="contact-'+e.identity+'-sendMessageButtons" style="width:40px; display:none"><button onclick="SendChatMessage(\''+e.identity+'\')" class="roundButtons" title="'+lang.send+'"><i class="fa fa-paper-plane"></i></button></td>',s+="</tr></table>",s+="</td></tr>");var l='<table id="stream-'+e.identity+'" class=stream cellspacing=0 cellpadding=0>';"top"==UiMessageLayout?(l+=o,l+=t):(l+=t,l+=o),l+=s,l+="</table>",$("#rightContent").append(l),"top"==UiMessageLayout?($("#contact-"+e.identity+"-MessagesCell").addClass(""),$("#contact-"+e.identity+"-ProfileCell").addClass("sectionBorderTop"),$("#contact-"+e.identity+"-InteractionCell").addClass("")):($("#contact-"+e.identity+"-ProfileCell").addClass("sectionBorderBottom"),$("#contact-"+e.identity+"-MessagesCell").addClass(""),$("#contact-"+e.identity+"-InteractionCell").addClass("sectionBorderTop"))}function RemoveBuddyMessageStream(e,t){if(null!=e){var n=JSON.parse(localDB.getItem(e.identity+"-stream"));if(t&&t>0){if(n&&n.DataCollection&&n.DataCollection.length>=1){var i={TotalRows:0,DataCollection:[]};i.DataCollection=n.DataCollection.filter(function(e){var n=moment.utc(e.ItemDate.replace(" UTC","")),i=moment().utc().subtract(t,"days");return!!n.isSameOrAfter(i,"second")}),i.TotalRows=i.DataCollection.length,localDB.setItem(e.identity+"-stream",JSON.stringify(i));var a={TotalRows:0,DataCollection:[]};a.DataCollection=n.DataCollection.filter(function(e){var n=moment.utc(e.ItemDate.replace(" UTC","")),i=moment().utc().subtract(t,"days");return!n.isSameOrAfter(i,"second")}),a.TotalRows=a.DataCollection.length,n=a,RefreshStream(e)}}else{CloseBuddy(e.identity),$("#stream-"+e.identity).remove(),localDB.removeItem(e.identity+"-stream");var o=JSON.parse(localDB.getItem(profileUserID+"-Buddies")),s=0;$.each(o.DataCollection,function(t,n){if(n.uID==e.identity||n.cID==e.identity||n.gID==e.identity)return s=t,!1}),o.DataCollection.splice(s,1),o.TotalRows=o.DataCollection.length,localDB.setItem(profileUserID+"-Buddies",JSON.stringify(o)),localDB.removeItem("img-"+e.identity+"-extension"),localDB.removeItem("img-"+e.identity+"-contact"),localDB.removeItem("img-"+e.identity+"-group")}UpdateBuddyList(),n&&n.DataCollection&&n.DataCollection.length>=1&&DeleteCallRecordings(e.identity,n),n&&n.DataCollection&&n.DataCollection.length>=1&&DeleteQosData(e.identity,n)}}function DeleteCallRecordings(e,t){var n=window.indexedDB,i=n.open("CallRecordings",1);i.onerror=function(e){console.error("IndexDB Request Error:",e)},i.onupgradeneeded=function(e){console.warn("Upgrade Required for IndexDB... probably because of first time use.")},i.onsuccess=function(e){console.log("IndexDB connected to CallRecordings");var n=e.target.result;0!=n.objectStoreNames.contains("Recordings")?(n.onerror=function(e){console.error("IndexDB Error:",e)},$.each(t.DataCollection,function(e,t){"CDR"==t.ItemType&&t.Recordings&&t.Recordings.length&&$.each(t.Recordings,function(e,t){console.log("Deleting Call Recording: ",t.uID);var i=n.transaction(["Recordings"],"readwrite").objectStore("Recordings");try{var a=i.delete(t.uID);a.onsuccess=function(e){console.log("Call Recording Deleted: ",t.uID)}}catch(e){console.log("Call Recording Delete failed: ",e)}})})):console.warn("IndexDB CallRecordings.Recordings does not exists")}}function ToggleExtraButtons(e,t,n){var i=$("#contact-"+e+"-extra-buttons");i.is(":visible")?(i.hide(),$("#contact-"+e+"-action-buttons").css("width",t+"px")):(i.show(),$("#contact-"+e+"-action-buttons").css("width",n+"px"))}function SortBuddies(){"type"==BuddySortBy&&Buddies.sort(function(e,t){var n=moment.utc(e.lastActivity.replace(" UTC","")),i=moment.utc(t.lastActivity.replace(" UTC","")),a=e.type,o=t.type;return"c|e|x"==SortByTypeOrder&&("contact"==e.type&&(a="A"),"contact"==t.type&&(o="A"),"extension"==e.type&&(a="B"),"extension"==t.type&&(o="B"),"xmpp"==e.type&&(a="C"),"xmpp"==t.type&&(o="C")),"c|x|e"==SortByTypeOrder&&("contact"==e.type&&(a="A"),"contact"==t.type&&(o="A"),"extension"==e.type&&(a="C"),"extension"==t.type&&(o="C"),"xmpp"==e.type&&(a="B"),"xmpp"==t.type&&(o="B")),"x|e|c"==SortByTypeOrder&&("contact"==e.type&&(a="C"),"contact"==t.type&&(o="C"),"extension"==e.type&&(a="B"),"extension"==t.type&&(o="B"),"xmpp"==e.type&&(a="A"),"xmpp"==t.type&&(o="A")),"x|c|e"==SortByTypeOrder&&("contact"==e.type&&(a="B"),"contact"==t.type&&(o="B"),"extension"==e.type&&(a="C"),"extension"==t.type&&(o="C"),"xmpp"==e.type&&(a="A"),"xmpp"==t.type&&(o="A")),"e|x|c"==SortByTypeOrder&&("contact"==e.type&&(a="C"),"contact"==t.type&&(o="C"),"extension"==e.type&&(a="A"),"extension"==t.type&&(o="A"),"xmpp"==e.type&&(a="B"),"xmpp"==t.type&&(o="B")),"e|c|x"==SortByTypeOrder&&("contact"==e.type&&(a="B"),"contact"==t.type&&(o="A"),"extension"==e.type&&(a="A"),"extension"==t.type&&(o="A"),"xmpp"==e.type&&(a="C"),"xmpp"==t.type&&(o="C")),a.localeCompare(o)||(n.isSameOrAfter(i,"second")?-1:1)}),"extension"==BuddySortBy&&Buddies.sort(function(e,t){var n="extension"==e.type||"xmpp"==e.type?e.ExtNo:e.ContactNumber1,i="extension"==t.type||"xmpp"==t.type?t.ExtNo:e.ContactNumber1,a=moment.utc(e.lastActivity.replace(" UTC","")),o=moment.utc(t.lastActivity.replace(" UTC",""));return n.localeCompare(i)||(a.isSameOrAfter(o,"second")?-1:1)}),"alphabetical"==BuddySortBy&&Buddies.sort(function(e,t){var n=moment.utc(e.lastActivity.replace(" UTC","")),i=moment.utc(t.lastActivity.replace(" UTC",""));return e.CallerIDName.localeCompare(t.CallerIDName)||(n.isSameOrAfter(i,"second")?-1:1)}),"activity"==BuddySortBy&&Buddies.sort(function(e,t){var n=moment.utc(e.lastActivity.replace(" UTC","")),i=moment.utc(t.lastActivity.replace(" UTC",""));return n.isSameOrAfter(i,"second")?-1:1}),1==BuddyAutoDeleteAtEnd&&Buddies.sort(function(e,t){return e.AllowAutoDelete===t.AllowAutoDelete?0:e.AllowAutoDelete?1:-1}),Buddies.sort(function(e,t){return e.Pinned===t.Pinned?0:e.Pinned?-1:1})}function SelectBuddy(e){var t=FindBuddyByIdentity(e);if(null!=t){var n=1!=BuddyShowExtenNum||"extension"!=t.type&&"xmpp"!=t.type?t.CallerIDName:" "+t.ExtNo+" - "+t.CallerIDName;$("#contact-"+t.identity+"-name").html(n);var i="";"extension"==t.type?(i+=t.presence,"Unknown"==i&&(i=lang.state_unknown),"Not online"==i&&(i=lang.state_not_online),"Ready"==i&&(i=lang.state_ready),"On the phone"==i&&(i=lang.state_on_the_phone),"Ringing"==i&&(i=lang.state_ringing),"On hold"==i&&(i=lang.state_on_hold),"Unavailable"==i&&(i=lang.state_unavailable),1!=t.EnableSubscribe&&(i=t.Desc)):"xmpp"==t.type?(i+='<i class="fa fa-comments"></i> ',i+=t.presenceText):"contact"==t.type?i+=t.Desc:"group"==t.type&&(i+=t.Desc),$("#contact-"+t.identity+"-presence-main").html(i),$("#contact-"+t.identity+"-picture-main").css("background-image",$("#contact-"+t.identity+"-picture-main").css("background-image"));for(var a=0;a<Buddies.length;a++)if(1==Buddies[a].IsSelected&&Buddies[a].identity==e)return;console.log("Selecting Buddy: "+t.CallerIDName),selectedBuddy=t,$(".streamSelected").each(function(){$(this).prop("class","stream")}),$("#stream-"+e).prop("class","streamSelected");for(var o=0;o<Lines.length;o++){var s="buddy";null!=Lines[o].SipSession&&(s=Lines[o].SipSession.isOnHold?"buddyActiveCallHollding":"buddyActiveCall"),$("#line-"+Lines[o].LineNumber).prop("class",s),Lines[o].IsSelected=!1}ClearMissedBadge(e);for(a=0;a<Buddies.length;a++){s=Buddies[a].identity==e?"buddySelected":"buddy";$("#contact-"+Buddies[a].identity).prop("class",s),$("#contact-"+Buddies[a].identity+"-ChatHistory").empty(),Buddies[a].IsSelected=Buddies[a].identity==e}UpdateUI(),RefreshStream(t);try{$("#contact-"+e).get(0).scrollIntoViewIfNeeded()}catch(e){}localDB.setItem("SelectedBuddy",e)}}function CloseBuddy(e){$(".buddySelected").each(function(){$(this).prop("class","buddy")}),$(".streamSelected").each(function(){$(this).prop("class","stream")}),console.log("Closing Buddy: "+e);for(var t=0;t<Buddies.length;t++)Buddies[t].IsSelected=!1;selectedBuddy=null;for(var n=0;n<Lines.length;n++)Lines[n].IsSelected=!1;selectedLine=null,localDB.setItem("SelectedBuddy",null),UpdateUI()}function RemoveBuddy(e){CloseWindow(),Confirm(lang.confirm_remove_buddy,lang.remove_buddy,function(){DoRemoveBuddy(e),UpdateBuddyList()})}function DoRemoveBuddy(e){for(var t=0;t<Buddies.length;t++)if(Buddies[t].identity==e){RemoveBuddyMessageStream(Buddies[t]),UnsubscribeBuddy(Buddies[t]),"xmpp"==Buddies[t].type&&XmppRemoveBuddyFromRoster(Buddies[t]),Buddies.splice(t,1);break}}function FindBuddyByDid(e){for(var t=0;t<Buddies.length;t++)if(Buddies[t].ExtNo==e||Buddies[t].MobileNumber==e||Buddies[t].ContactNumber1==e||Buddies[t].ContactNumber2==e)return Buddies[t];return null}function FindBuddyByExtNo(e){for(var t=0;t<Buddies.length;t++)if(Buddies[t].ExtNo==e)return Buddies[t];return null}function FindBuddyByNumber(e){for(var t=0;t<Buddies.length;t++)if(Buddies[t].MobileNumber==e||Buddies[t].ContactNumber1==e||Buddies[t].ContactNumber2==e)return Buddies[t];return null}function FindBuddyByIdentity(e){for(var t=0;t<Buddies.length;t++)if(Buddies[t].identity==e)return Buddies[t];return null}function FindBuddyByJid(e){for(var t=0;t<Buddies.length;t++)if(Buddies[t].jid==e)return Buddies[t];return console.warn("Buddy not found on jid: "+e),null}function FindBuddyByObservedUser(e){for(var t=0;t<Buddies.length;t++)if(Buddies[t].SubscribeUser==e)return Buddies[t];return null}function SearchStream(e,t){var n=e.value,i=FindBuddyByIdentity(t);""==n?(console.log("Restore Stream"),RefreshStream(i)):RefreshStream(i,n)}function RefreshStream(e,t){$("#contact-"+e.identity+"-ChatHistory").empty();var n=JSON.parse(localDB.getItem(e.identity+"-stream"));null!=n&&null!=n.DataCollection&&(n.DataCollection.sort(function(e,t){var n=moment.utc(e.ItemDate.replace(" UTC","")),i=moment.utc(t.ItemDate.replace(" UTC",""));return n.isSameOrAfter(i,"second")?-1:1}),t&&""!=t&&(console.log("Rows without filter ("+t+"): ",n.DataCollection.length),n.DataCollection=n.DataCollection.filter(function(e){if(-1!=t.indexOf("date: ")){var n=getFilter(t,"date");if(""!=n&&-1!=e.ItemDate.indexOf(n))return!0}if(e.MessageData&&e.MessageData.length>1){if(-1!=e.MessageData.toLowerCase().indexOf(t.toLowerCase()))return!0;if(-1!=t.toLowerCase().indexOf(e.MessageData.toLowerCase()))return!0}if("MSG"==e.ItemType);else if("CDR"==e.ItemType){if(e.Tags&&e.Tags.length>1){var i=getFilter(t,"tag");if(""!=i&&1==e.Tags.some(function(e){return-1!=i.toLowerCase().indexOf(e.value.toLowerCase())||-1!=e.value.toLowerCase().indexOf(i.toLowerCase())}))return!0}}else"FILE"==e.ItemType||e.ItemType;return!1}),console.log("Rows After Filter: ",n.DataCollection.length)),n.DataCollection.length>StreamBuffer&&(console.log("Rows:",n.DataCollection.length," (will be trimmed to "+StreamBuffer+")"),n.DataCollection.splice(StreamBuffer)),$.each(n.DataCollection,function(t,n){var i=moment.utc(n.ItemDate.replace(" UTC","")).isSame(moment.utc(),"day"),a=moment.utc(n.ItemDate.replace(" UTC","")).local().calendar(null,{sameElse:DisplayDateFormat});if(i&&(a=moment.utc(n.ItemDate.replace(" UTC","")).local().format(DisplayTimeFormat)),"MSG"==n.ItemType){var o='<i class="fa fa-question-circle-o SendingMessage"></i>';1==n.Sent&&(o='<i class="fa fa-check SentMessage"></i>'),0==n.Sent&&(o='<i class="fa fa-exclamation-circle FailedMessage"></i>'),n.Delivered&&1==n.Delivered.state&&(o+=' <i class="fa fa-check DeliveredMessage"></i>'),n.Displayed&&1==n.Displayed.state&&(o='<i class="fa fa-check CompletedMessage"></i>');var s=ReformatMessage(n.MessageData),l=s.length>1e3;if(n.SrcUserId==profileUserID){var r="<table class=ourChatMessage cellspacing=0 cellpadding=0><tr>";r+='<td class=ourChatMessageText onmouseenter="ShowChatMenu(this)" onmouseleave="HideChatMenu(this)">',r+="<span onclick=\"ShowMessageMenu(this,'MSG','"+n.ItemId+"', '"+e.identity+'\')" class=chatMessageDropdown style="display:none"><i class="fa fa-chevron-down"></i></span>',r+="<div id=msg-text-"+n.ItemId+' class=messageText style="'+(l?"max-height:190px; overflow:hidden":"")+'">'+s+"</div>",l&&(r+="<div id=msg-readmore-"+n.ItemId+" class=messageReadMore><span onclick=\"ExpandMessage(this,'"+n.ItemId+"', '"+e.identity+"')\">"+lang.read_more+"</span></div>"),r+="<div class=messageDate>"+a+" "+o+"</div>",r+="</td>",r+="</tr></table>"}else{var d="";r="<table class=theirChatMessage cellspacing=0 cellpadding=0><tr>";if(r+='<td class=theirChatMessageText onmouseenter="ShowChatMenu(this)" onmouseleave="HideChatMenu(this)">',r+="<span onclick=\"ShowMessageMenu(this,'MSG','"+n.ItemId+"', '"+e.identity+'\')" class=chatMessageDropdown style="display:none"><i class="fa fa-chevron-down"></i></span>',"group"==e.type&&(r+="<div class=messageDate>"+d+"</div>"),r+="<div id=msg-text-"+n.ItemId+' class=messageText style="'+(l?"max-height:190px; overflow:hidden":"")+'">'+s+"</div>",l&&(r+="<div id=msg-readmore-"+n.ItemId+" class=messageReadMore><span onclick=\"ExpandMessage(this,'"+n.ItemId+"', '"+e.identity+"')\">"+lang.read_more+"</span></div>"),r+="<div class=messageDate>"+a+"</div>",r+="</td>",r+="</tr></table>","xmpp"==e.type){var c=$("#stream-"+e.identity).is(":visible");c&&!n.Read&&(console.log("Buddy stream is now visible, marking XMPP message("+n.ItemId+") as read"),MarkMessageRead(e,n.ItemId),XmppSendDisplayReceipt(e,n.ItemId))}}$("#contact-"+e.identity+"-ChatHistory").prepend(r)}else if("CDR"==n.ItemType){var u=n.Billsec>0?"green":"red",p=(s="","<span id=cdr-flagged-"+n.CdrId+' style="'+(n.Flagged?"":"display:none")+'">');p+='<i class="fa fa-flag FlagCall"></i> ',p+="</span>";var g="";n.MessageData&&(g=n.MessageData),n.Tags||(n.Tags=[]);var m="<ul id=cdr-tags-"+n.CdrId+' class=tags style="'+(n.Tags&&n.Tags.length>0?"":"display:none")+'">';$.each(n.Tags,function(t,i){m+="<li onclick=\"TagClick(this, '"+n.CdrId+"', '"+e.identity+"')\">"+i.value+"</li>"}),m+="<li class=tagText><input maxlength=24 type=text onkeypress=\"TagKeyPress(event, this, '"+n.CdrId+"', '"+e.identity+'\')" onfocus="TagFocus(this)"></li>',m+="</ul>";var f=n.WithVideo?"fa-video-camera":"fa-phone"
;s+='<i class="fa '+f+'" style="color:'+u+'"></i>';var v=n.WithVideo?lang.a_video_call:lang.an_audio_call,b="";if(n.Recordings&&n.Recordings.length>=1&&$.each(n.Recordings,function(t,i){if(i.uID){var a=moment.utc(i.startTime.replace(" UTC","")).local(),o=moment.utc(i.stopTime.replace(" UTC","")).local(),s=moment.duration(o.diff(a));if(b+="<div class=callRecording>",n.WithVideo)if(i.Poster){i.Poster.width,i.Poster.height;var l=i.Poster.posterBase64;b+='<div><IMG src="'+l+'"><button onclick="PlayVideoCallRecording(this, \''+n.CdrId+"', '"+i.uID+'\')" class=videoPoster><i class="fa fa-play"></i></button></div>'}else b+="<div><button class=roundButtons onclick=\"PlayVideoCallRecording(this, '"+n.CdrId+"', '"+i.uID+"', '"+e.identity+'\')"><i class="fa fa-video-camera"></i></button></div>';else b+="<div><button class=roundButtons onclick=\"PlayAudioCallRecording(this, '"+n.CdrId+"', '"+i.uID+"', '"+e.identity+'\')"><i class="fa fa-play"></i></button></div>';b+="<div>"+lang.started+": "+a.format(DisplayTimeFormat)+' <i class="fa fa-long-arrow-right"></i> '+lang.stopped+": "+o.format(DisplayTimeFormat)+"</div>",b+="<div>"+lang.recording_duration+": "+formatShortDuration(s.asSeconds())+"</div>",b+="<div>",b+='<span id="cdr-video-meta-width-'+n.CdrId+"-"+i.uID+'"></span>',b+='<span id="cdr-video-meta-height-'+n.CdrId+"-"+i.uID+'"></span>',b+='<span id="cdr-media-meta-size-'+n.CdrId+"-"+i.uID+'"></span>',b+='<span id="cdr-media-meta-codec-'+n.CdrId+"-"+i.uID+'"></span>',b+="</div>",b+="</div>"}}),n.SrcUserId==profileUserID){"0"==n.Billsec?s+=" "+lang.you_tried_to_make+" "+v+" ("+n.ReasonText+").":s+=" "+lang.you_made+" "+v+", "+lang.and_spoke_for+" "+formatDuration(n.Billsec)+".";r="<table class=ourChatMessage cellspacing=0 cellpadding=0><tr>";r+='<td style="padding-right:4px;">'+p+"</td>",r+='<td class=ourChatMessageText onmouseenter="ShowChatMenu(this)" onmouseleave="HideChatMenu(this)">',r+="<span onClick=\"ShowMessageMenu(this,'CDR','"+n.CdrId+"', '"+e.identity+'\')" class=chatMessageDropdown style="display:none"><i class="fa fa-chevron-down"></i></span>',r+="<div>"+s+"</div>",r+="<div>"+m+"</div>",r+="<div id=cdr-comment-"+n.CdrId+" class=cdrComment>"+g+"</div>",r+="<div class=callRecordings>"+b+"</div>",r+="<div class=messageDate>"+a+"</div>",r+="</td>",r+="</tr></table>"}else{"0"==n.Billsec?s+=" "+lang.you_missed_a_call+" ("+n.ReasonText+").":s+=" "+lang.you_received+" "+v+", "+lang.and_spoke_for+" "+formatDuration(n.Billsec)+".";r="<table class=theirChatMessage cellspacing=0 cellpadding=0><tr>";r+='<td class=theirChatMessageText onmouseenter="ShowChatMenu(this)" onmouseleave="HideChatMenu(this)">',r+="<span onClick=\"ShowMessageMenu(this,'CDR','"+n.CdrId+"', '"+e.identity+'\')" class=chatMessageDropdown style="display:none"><i class="fa fa-chevron-down"></i></span>',r+='<div style="text-align:left">'+s+"</div>",r+="<div>"+m+"</div>",r+="<div id=cdr-comment-"+n.CdrId+" class=cdrComment>"+g+"</div>",r+="<div class=callRecordings>"+b+"</div>",r+="<div class=messageDate> "+a+"</div>",r+="</td>",r+='<td style="padding-left:4px">'+p+"</td>",r+="</tr></table>"}$("#contact-"+e.identity+"-ChatHistory").prepend(r)}else"FILE"==n.ItemType||n.ItemType}),updateScroll(e.identity),window.setTimeout(function(){updateScroll(e.identity)},300))}function ShowChatMenu(e){$(e).children("span").show()}function HideChatMenu(e){$(e).children("span").hide()}function ExpandMessage(e,t,n){$("#msg-text-"+t).css("max-height",""),$("#msg-text-"+t).css("overflow",""),$("#msg-readmore-"+t).remove(),HidePopup(500)}function RedrawStage(e,t){$("#line-"+e+"-VideoCall"),$("#line-"+e+"-stage-container");var n=$("#line-"+e+"-preview-container"),i=$("#line-"+e+"-remote-videos"),a=FindLineByNumber(e);if(null==a)return;var o=a.SipSession;if(null==o)return;var s=!1,l="";n.find("video").each(function(e,t){$(t).hide()}),n.css("width","");var r=0;if(i.find("video").each(function(n,i){var d=i.srcObject,c=d.getVideoTracks()[0],u=c.getSettings(),p=u.width?u.width:i.videoWidth,g=u.height?u.height:i.videoHeight;d.mid&&(d.channel="unknown",d.CallerIdName="",d.CallerIdNumber="",d.isAdminMuted=!1,d.isAdministrator=!1,o&&o.data&&o.data.videoChannelNames&&o.data.videoChannelNames.forEach(function(e){d.mid==e.mid&&(d.channel=e.channel)}),o&&o.data&&o.data.ConfbridgeChannels&&o.data.ConfbridgeChannels.forEach(function(e){e.id==d.channel&&(d.CallerIdName=e.caller.name,d.CallerIdNumber=e.caller.number,d.isAdminMuted=e.muted,d.isAdministrator=e.admin)})),t&&$("#line-"+e+"-preview-container").find("video").each(function(e,t){0==t.id.indexOf("copy-")&&t.remove()}),$(i).parent().off("click"),$(i).parent().css("width","1px"),$(i).parent().css("height","1px"),$(i).hide(),$(i).parent().hide(),a.pinnedVideo&&a.pinnedVideo==d.trackID&&"live"==c.readyState&&p>10&&g>=10&&(s=!0,l=a.pinnedVideo),"live"==c.readyState&&p>10&&g>=10?(r++,console.log("Display Video - ",c.readyState,"MID:",d.mid,"channel:",d.channel,"src width:",p,"src height",g)):console.log("Hide Video - ",c.readyState,"MID:",d.mid)}),0==r)return n.css("width",g+"px"),void n.find("video").each(function(e,t){$(t).show()});if(s&&(r=1),!i.outerWidth()>0)return;if(!i.outerHeight()>0)return;var d=3,c=.75;""!=videoAspectRatio&&"1.33"!=videoAspectRatio||(c=.75),"1.77"==videoAspectRatio&&(c=.5625),"1"==videoAspectRatio&&(c=1);var u=i.outerWidth()-2*d,p=i.outerHeight()-2*d,g=n.outerWidth(),m=0;let f=1;for(;f<5e3;){let e=StageArea(f,r,u,p,d,c);if(!1===e){m=f-1;break}f++}m-=2*d,i.find("video").each(function(n,i){var a=i.srcObject,d=a.getVideoTracks()[0],u=d.getSettings(),p=u.width?u.width:i.videoWidth,g=u.height?u.height:i.videoHeight,f=m,v=m*c;if(s){if(l==i.srcObject.trackID){$(i).parent().css("width",f+"px"),$(i).parent().css("height",v+"px"),$(i).show(),$(i).parent().show();var b=$("<button />",{class:"videoOverlayButtons"});b.html('<i class="fa fa-th-large"></i>'),b.on("click",function(){UnPinVideo(e,i)}),$(i).parent().find(".Actions").empty(),$(i).parent().find(".Actions").append(b)}else if("live"==d.readyState&&p>10&&g>=10&&t){var h=$("<video />",{id:"copy-"+a.id,muted:!0,autoplay:!0,playsinline:!0,controls:!1}),S=h.get(0);S.srcObject=a,$("#line-"+e+"-preview-container").append(h)}}else if("live"==d.readyState&&p>10&&g>=10){$(i).parent().css("width",f+"px"),$(i).parent().css("height",v+"px"),$(i).show(),$(i).parent().show();var y=$("<button />",{class:"videoOverlayButtons"});y.html('<i class="fa fa-thumb-tack"></i>'),y.on("click",function(){PinVideo(e,i,i.srcObject.trackID)}),$(i).parent().find(".Actions").empty(),r>1&&$(i).parent().find(".Actions").append(y)}var D="",w="";1==a.isAdminMuted&&(D='<i class="fa fa-microphone-slash" style="color:red"></i>&nbsp;'),1==a.isAdministrator&&(w='<i class="fa fa-user" style="color:orange"></i>&nbsp;'),""==a.CallerIdName&&(a.CallerIdName=FindBuddyByIdentity(o.data.buddyId).CallerIDName),$(i).parent().find(".callerID").html(w+D+a.CallerIdName)}),n.css("width",g+"px"),n.find("video").each(function(e,t){$(t).show()})}function StageArea(e,t,n,i,a,o){let s=w=0,l=e*o+2*a;for(;s<t;)w+e>n&&(w=0,l=l+e*o+2*a),w=w+e+2*a,s++;return!(l>i)&&e}function PinVideo(e,t,n){var i=FindLineByNumber(e);null!=i&&(console.log("Setting Pinned Video:",n),i.pinnedVideo=n,t.srcObject.isPinned=!0,RedrawStage(e,!0))}function UnPinVideo(e,t){var n=FindLineByNumber(e);null!=n&&(console.log("Removing Pinned Video"),n.pinnedVideo="",t.srcObject.isPinned=!1,RedrawStage(e,!0))}function ShowMessageMenu(t,n,i,a){var o=[];if("CDR"==n){var s=$("#cdr-flagged-"+i).is(":visible"),l=s?lang.clear_flag:lang.flag_call;o.push({value:1,icon:"fa fa-external-link",text:lang.show_call_detail_record}),o.push({value:2,icon:"fa fa-tags",text:lang.tag_call}),o.push({value:3,icon:"fa fa-flag",text:l}),o.push({value:4,icon:"fa fa-quote-left",text:lang.edit_comment})}else"MSG"==n&&(o.push({value:10,icon:"fa fa-clipboard",text:lang.copy_message}),o.push({value:12,icon:"fa fa-quote-left",text:lang.quote_message}));var r={selectEvent:function(t,n){var o=n.item.attr("value");if(HidePopup(),null!=o){if(console.log("Menu click ("+o+")"),1==o){var s=null,l=JSON.parse(localDB.getItem(a+"-stream"));if(null==l&&null==l.DataCollection||$.each(l.DataCollection,function(e,t){if("CDR"==t.ItemType&&t.CdrId==i)return s=t,!1}),null==s)return;var r=[],d='<div class="UiWindowField">',c=moment.utc(s.ItemDate.replace(" UTC","")).local().format(DisplayDateFormat+" "+DisplayTimeFormat),u=s.CallAnswer?moment.utc(s.CallAnswer.replace(" UTC","")).local().format(DisplayDateFormat+" "+DisplayTimeFormat):null,p=s.RingTime?s.RingTime:0,g=(moment.utc(s.CallEnd.replace(" UTC","")).local().format(DisplayDateFormat+" "+DisplayTimeFormat),""),m="";"inbound"==s.CallDirection?g=s.Src:"outbound"==s.CallDirection&&(m=s.Dst),d+="<div class=UiText><b>SIP CallID</b> : "+s.SessionId+"</div>",d+="<div class=UiText><b>"+lang.call_direction+"</b> : "+s.CallDirection+"</div>",d+="<div class=UiText><b>"+lang.call_date_and_time+"</b> : "+c+"</div>",d+="<div class=UiText><b>"+lang.ring_time+"</b> : "+formatDuration(p)+" ("+p+")</div>",d+="<div class=UiText><b>"+lang.talk_time+"</b> : "+formatDuration(s.Billsec)+" ("+s.Billsec+")</div>",d+="<div class=UiText><b>"+lang.call_duration+"</b> : "+formatDuration(s.TotalDuration)+" ("+s.TotalDuration+")</div>",d+="<div class=UiText><b>"+lang.video_call+"</b> : "+(s.WithVideo?lang.yes:lang.no)+"</div>",d+="<div class=UiText><b>"+lang.flagged+"</b> : "+(s.Flagged?'<i class="fa fa-flag FlagCall"></i> '+lang.yes:lang.no)+"</div>",d+="<hr>",d+='<h2 style="font-size: 16px">'+lang.call_tags+"</h2>",d+="<hr>",$.each(s.Tags,function(e,t){d+="<span class=cdrTag>"+t.value+"</span>"}),d+='<h2 style="font-size: 16px">'+lang.call_notes+"</h2>",d+="<hr>",s.MessageData&&(d+='"'+s.MessageData+'"'),d+='<h2 style="font-size: 16px">'+lang.activity_timeline+"</h2>",d+="<hr>";var f=s.WithVideo?"("+lang.with_video+")":"",v="inbound"==s.CallDirection?lang.you_received_a_call_from+" "+g+" "+f:lang.you_made_a_call_to+" "+m+" "+f;if(r.push({Message:v,TimeStr:s.ItemDate}),u){var b="inbound"==s.CallDirection?lang.you_answered_after+" "+p+" "+lang.seconds_plural:lang.they_answered_after+" "+p+" "+lang.seconds_plural;r.push({Message:b,TimeStr:s.CallAnswer})}$.each(s.Transfers,function(e,t){var n="Blind"==t.type?lang.you_started_a_blind_transfer_to+" "+t.to+". ":lang.you_started_an_attended_transfer_to+" "+t.to+". ";t.accept&&1==t.accept.complete?n+=lang.the_call_was_completed:""!=t.accept.disposition&&(n+=lang.the_call_was_not_completed+" ("+t.accept.disposition+")"),r.push({Message:n,TimeStr:t.transferTime})}),$.each(s.Mutes,function(e,t){r.push({Message:"mute"==t.event?lang.you_put_the_call_on_mute:lang.you_took_the_call_off_mute,TimeStr:t.eventTime})}),$.each(s.Holds,function(e,t){r.push({Message:"hold"==t.event?lang.you_put_the_call_on_hold:lang.you_took_the_call_off_hold,TimeStr:t.eventTime})}),$.each(s.ConfbridgeEvents,function(e,t){r.push({Message:t.event,TimeStr:t.eventTime})}),$.each(s.ConfCalls,function(e,t){var n=lang.you_started_a_conference_call_to+" "+t.to+". ";t.accept&&1==t.accept.complete?n+=lang.the_call_was_completed:""!=t.accept.disposition&&(n+=lang.the_call_was_not_completed+" ("+t.accept.disposition+")"),r.push({Message:n,TimeStr:t.startTime})}),$.each(s.Recordings,function(e,t){var n=moment.utc(t.startTime.replace(" UTC","")).local(),i=moment.utc(t.stopTime.replace(" UTC","")).local(),a=moment.duration(i.diff(n)),o=lang.call_is_being_recorded;t.startTime!=t.stopTime&&(o+="("+formatShortDuration(a.asSeconds())+")"),r.push({Message:o,TimeStr:t.startTime})}),r.push({Message:"us"==s.Terminate?lang.you_ended_the_call:lang.they_ended_the_call,TimeStr:s.CallEnd}),r.sort(function(e,t){var n=moment.utc(e.TimeStr.replace(" UTC","")),i=moment.utc(t.TimeStr.replace(" UTC",""));return n.isSameOrAfter(i,"second")?1:-1}),$.each(r,function(e,t){var n=moment.utc(t.TimeStr.replace(" UTC","")).local().format(DisplayTimeFormat),i="<table class=timelineMessage cellspacing=0 cellpadding=0><tr>";i+="<td class=timelineMessageArea>",i+='<div class=timelineMessageDate style="color: #333333"><i class="fa fa-circle timelineMessageDot"></i>'+n+"</div>",i+='<div class=timelineMessageText style="color: #000000">'+t.Message+"</div>",i+="</td>",i+="</tr></table>",d+=i}),d+='<h2 style="font-size: 16px">'+lang.call_recordings+"</h2>",d+="<hr>";var h="";$.each(s.Recordings,function(e,t){if(t.uID){var n=moment.utc(t.startTime.replace(" UTC","")).local(),i=moment.utc(t.stopTime.replace(" UTC","")).local(),a=moment.duration(i.diff(n));h+="<div>",s.WithVideo?h+='<div><video id="callrecording-video-'+t.uID+'" controls playsinline style="width: 100%"></div>':h+='<div><audio id="callrecording-audio-'+t.uID+'" controls style="width: 100%"></div>',h+="<div>"+lang.started+": "+n.format(DisplayTimeFormat)+' <i class="fa fa-long-arrow-right"></i> '+lang.stopped+": "+i.format(DisplayTimeFormat)+"</div>",h+="<div>"+lang.recording_duration+": "+formatShortDuration(a.asSeconds())+"</div>",h+='<div><a id="download-'+t.uID+'">'+lang.save_as+"</a> ("+lang.right_click_and_select_save_link_as+")</div>",h+="</div>"}}),d+=h,s.CallAnswer&&(d+='<h2 style="font-size: 16px">'+lang.send_statistics+"</h2>",d+="<hr>",d+='<div style="position: relative; margin: auto; height: 160px; width: 100%;"><canvas id="cdr-AudioSendBitRate"></canvas></div>',d+='<div style="position: relative; margin: auto; height: 160px; width: 100%;"><canvas id="cdr-AudioSendPacketRate"></canvas></div>',d+='<h2 style="font-size: 16px">'+lang.receive_statistics+"</h2>",d+="<hr>",d+='<div style="position: relative; margin: auto; height: 160px; width: 100%;"><canvas id="cdr-AudioReceiveBitRate"></canvas></div>',d+='<div style="position: relative; margin: auto; height: 160px; width: 100%;"><canvas id="cdr-AudioReceivePacketRate"></canvas></div>',d+='<div style="position: relative; margin: auto; height: 160px; width: 100%;"><canvas id="cdr-AudioReceivePacketLoss"></canvas></div>',d+='<div style="position: relative; margin: auto; height: 160px; width: 100%;"><canvas id="cdr-AudioReceiveJitter"></canvas></div>',d+='<div style="position: relative; margin: auto; height: 160px; width: 100%;"><canvas id="cdr-AudioReceiveLevels"></canvas></div>'),d+="<br><br></div>",OpenWindow(d,lang.call_detail_record,480,640,!1,!0,null,null,lang.cancel,function(){CloseWindow()},function(){$.each(s.Recordings,function(e,t){var n=null;n=s.WithVideo?$("#callrecording-video-"+t.uID).get(0):$("#callrecording-audio-"+t.uID).get(0);var i=$("#download-"+t.uID),a=getAudioOutputID();void 0!==n.sinkId?n.setSinkId(a).then(function(){console.log("sinkId applied: "+a)}).catch(function(e){console.warn("Error using setSinkId: ",e)}):console.warn("setSinkId() is not possible using this browser.");var o=window.indexedDB,l=o.open("CallRecordings",1);l.onerror=function(e){console.error("IndexDB Request Error:",e)},l.onupgradeneeded=function(e){console.warn("Upgrade Required for IndexDB... probably because of first time use.")},l.onsuccess=function(e){console.log("IndexDB connected to CallRecordings");var a=e.target.result;if(0!=a.objectStoreNames.contains("Recordings")){var o=a.transaction(["Recordings"]),l=o.objectStore("Recordings").get(t.uID);l.onerror=function(e){console.error("IndexDB Get Error:",e)},l.onsuccess=function(e){var a=window.URL.createObjectURL(e.target.result.mediaBlob);n.src=a,s.WithVideo?i.prop("download","Video-Call-Recording-"+t.uID+".webm"):i.prop("download","Audio-Call-Recording-"+t.uID+".webm"),i.prop("href",a)}}else console.warn("IndexDB CallRecordings.Recordings does not exists")}}),s.CallAnswer&&DisplayQosData(s.SessionId)})}if(2==o&&$("#cdr-tags-"+i).show(),3==o){var S=$("#cdr-flagged-"+i).is(":visible");if(S){console.log("Clearing Flag from: ",i),$("#cdr-flagged-"+i).hide();l=JSON.parse(localDB.getItem(a+"-stream"));null==l&&null==l.DataCollection||($.each(l.DataCollection,function(e,t){if("CDR"==t.ItemType&&t.CdrId==i)return t.Flagged=!1,!1}),localDB.setItem(a+"-stream",JSON.stringify(l)))}else{console.log("Flag Call: ",i),$("#cdr-flagged-"+i).show();l=JSON.parse(localDB.getItem(a+"-stream"));null==l&&null==l.DataCollection||($.each(l.DataCollection,function(e,t){if("CDR"==t.ItemType&&t.CdrId==i)return t.Flagged=!0,!1}),localDB.setItem(a+"-stream",JSON.stringify(l)))}}if(4==o){var y=$("#cdr-comment-"+i).text();$("#cdr-comment-"+i).empty();var D=$("<input maxlength=500 type=text>").appendTo("#cdr-comment-"+i);D.on("focus",function(){HidePopup(500)}),D.on("blur",function(){var e=$(this).val();SaveComment(i,a,e)}),D.keypress(function(e){var t=e.keyCode?e.keyCode:e.which;if("13"==t){e.preventDefault();var n=$(this).val();SaveComment(i,a,n)}}),D.val(y),D.focus()}if(10==o){var w=$("#msg-text-"+i).text();navigator.clipboard.writeText(w).then(function(){console.log("Text copied to the clipboard:",w)}).catch(function(){console.error("Error writing to the clipboard:",e)})}if(12==o){w=$("#msg-text-"+i).text();w='"'+w+'"';var C=$("#contact-"+a+"-ChatMessage");console.log("Quote Message:",w),C.val(w+"\n"+C.val())}if(20==o){l=JSON.parse(localDB.getItem(a+"-stream"));null==l&&null==l.DataCollection||($.each(l.DataCollection,function(e,t){if("CDR"==t.ItemType&&t.CdrId==i)return l.DataCollection.splice(e,1),!1}),localDB.setItem(a+"-stream",JSON.stringify(l)),RefreshStream(FindBuddyByIdentity(a)))}if(21==o){l=JSON.parse(localDB.getItem(a+"-stream"));null==l&&null==l.DataCollection||($.each(l.DataCollection,function(e,t){if("CDR"==t.ItemType&&t.CdrId==i)return t.Recordings&&t.Recordings.length>=1&&$.each(t.Recordings,function(e,t){t.Poster=null}),console.log("Poster Image Deleted"),!1}),localDB.setItem(a+"-stream",JSON.stringify(l)),RefreshStream(FindBuddyByIdentity(a)))}}},createEvent:null,autoFocus:!0,items:o};PopupMenu(t,r)}function SaveComment(e,t,n){console.log("Setting Comment:",n),$("#cdr-comment-"+e).empty(),$("#cdr-comment-"+e).append(n);var i=JSON.parse(localDB.getItem(t+"-stream"));null==i&&null==i.DataCollection||($.each(i.DataCollection,function(t,i){if("CDR"==i.ItemType&&i.CdrId==e)return i.MessageData=n,!1}),localDB.setItem(t+"-stream",JSON.stringify(i)))}function TagKeyPress(e,t,n,i){HidePopup(500);var a=e.keyCode?e.keyCode:e.which;if("13"==a||"44"==a){if(e.preventDefault(),""==$(t).val())return;console.log("Adding Tag:",$(t).val()),$("#cdr-tags-"+n+" li:last").before("<li onclick=\"TagClick(this, '"+n+"', '"+i+"')\">"+$(t).val()+"</li>"),$(t).val(""),UpdateTags(n,i)}}function TagClick(e,t,n){console.log("Removing Tag:",$(e).text()),$(e).remove(),UpdateTags(t,n)}function UpdateTags(e,t){var n=JSON.parse(localDB.getItem(t+"-stream"));null==n&&null==n.DataCollection||($.each(n.DataCollection,function(t,n){if("CDR"==n.ItemType&&n.CdrId==e)return n.Tags=[],$("#cdr-tags-"+e).children("li").each(function(){"tagText"!=$(this).prop("class")&&n.Tags.push({value:$(this).text()})}),!1}),localDB.setItem(t+"-stream",JSON.stringify(n)))}function TagFocus(e){HidePopup(500)}function AddMenu(e,t){if(UiCustomMessageAction)"undefined"!=typeof web_hook_on_message_action&&web_hook_on_message_action(t,e);else{var n=[];EnableTextExpressions&&n.push({value:1,icon:"fa fa-smile-o",text:lang.select_expression}),EnableTextDictate&&n.push({value:2,icon:"fa fa-microphone",text:lang.dictate_message}),EnableSendFiles&&i.push({value:3,name:'<i class="fa fa-share-alt"></i> Share File'}),EnableSendImages&&i.push({value:4,name:'<i class="fa fa-camera"></i> Take/Share Picture'}),EnableAudioRecording&&i.push({value:5,name:'<i class="fa fa-file-audio-o"></i> Record Audio Message'}),EnableVideoRecording&&i.push({value:6,name:'<i class="fa fa-file-video-o"></i> Record Video Message'});var i={selectEvent:function(e,n){var i=n.item.attr("value");HidePopup(),null!=i&&("1"==i&&ShowEmojiBar(t),"2"==i&&ShowDictate(t))},createEvent:null,autoFocus:!0,items:n};PopupMenu(e,i)}}function ShowEmojiBar(e){var t=$("#contact-"+e+"-emoji-menu"),n=$("#contact-"+e+"-ChatMessage"),i=$("<div/>");i.prop("class","emojiButton");var a=["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""];$.each(a,function(a,o){var s=$("<button>");s.html(o),s.on("click",function(){var i=n.prop("selectionStart"),a=n.val();n.val(a.substring(0,i)+$(this).html()+a.substring(i,a.length)),t.hide(),updateScroll(e)}),i.append(s)}),t.empty(),t.append(i),t.show(),updateScroll(e)}function ShowDictate(e){var t=FindBuddyByIdentity(e);if(null!=t){null!=t.recognition&&(t.recognition.abort(),t.recognition=null);try{var n=window.SpeechRecognition||window.webkitSpeechRecognition;t.recognition=new n}catch(e){return console.error(e),void Alert(lang.alert_speech_recognition,lang.speech_recognition)}var i=$("<div/>"),a=$("#contact-"+e+"-dictate-message"),o=$("#contact-"+e+"-ChatMessage");t.recognition.continuous=!0,t.recognition.onstart=function(){i.html('<i class="fa fa-microphone" style="font-size: 21px"></i><i class="fa fa-cog fa-spin" style="font-size:10px; vertical-align:text-bottom; margin-left:2px"></i> '+lang.im_listening),updateScroll(e)},t.recognition.onspeechend=function(){i.html(lang.msg_silence_detection),window.setTimeout(function(){a.hide(),updateScroll(e)},1e3)},t.recognition.onerror=function(n){"no-speech"==n.error?i.html(lang.msg_no_speech):(t.recognition&&(console.warn("SpeechRecognition Error: ",n),t.recognition.abort()),t.recognition=null),window.setTimeout(function(){a.hide(),updateScroll(e)},1e3)},t.recognition.onresult=function(e){var t=e.results[e.resultIndex][0].transcript;0==(1==e.resultIndex&&t==e.results[0][0].transcript)&&(($.trim(o.val()).endsWith(".")||""==$.trim(o.val()))&&("\r"==t||"\n"==t||"\r\n"==t||"\t"==t||(t=$.trim(t),t=t.replace(/^./," "+t[0].toUpperCase()))),console.log("Dictate:",t),o.val(o.val()+t))},a.empty(),a.append(i),a.show(),updateScroll(e),t.recognition.start()}}function ShowMyProfile(){ShowContacts(),$("#myContacts").hide(),$("#searchArea").hide(),$("#actionArea").empty();var e='<div style="text-align:right"><button class=roundButtons onclick="ShowContacts()"><i class="fa fa-close"></i></button></div>';e+="<div border=0 class=UiSideField>",1==EnableAccountSettings&&(e+='<div class=UiTextHeading onclick="ToggleHeading(this,\'Configure_Extension_Html\')"><i class="fa fa-user-circle-o UiTextHeadingIcon" style="background-color:#a93a3a"></i> '+lang.account+"</div>");var t='<div id=Configure_Extension_Html style="display:none">';t+="<div class=UiText>"+lang.asterisk_server_address+":</div>",t+="<div><input id=Configure_Account_wssServer class=UiInputText type=text placeholder='"+lang.eg_asterisk_server_address+"' value='"+getDbItem("wssServer","")+"'></div>",t+="<div class=UiText>"+lang.websocket_port+":</div>",t+="<div><input id=Configure_Account_WebSocketPort class=UiInputText type=text placeholder='"+lang.eg_websocket_port+"' value='"+getDbItem("WebSocketPort","")+"'></div>",t+="<div class=UiText>"+lang.websocket_path+":</div>",t+="<div><input id=Configure_Account_ServerPath class=UiInputText type=text placeholder='"+lang.eg_websocket_path+"' value='"+getDbItem("ServerPath","")+"'></div>",t+="<div class=UiText>"+lang.full_name+":</div>",t+="<div><input id=Configure_Account_profileName class=UiInputText type=text placeholder='"+lang.eg_full_name+"' value='"+getDbItem("profileName","")+"'></div>",t+="<div class=UiText>"+lang.sip_domain+":</div>",t+="<div><input id=Configure_Account_SipDomain class=UiInputText type=text placeholder='"+lang.eg_sip_domain+"' value='"+getDbItem("SipDomain","")+"'></div>",t+="<div class=UiText>"+lang.sip_username+":</div>",t+="<div><input id=Configure_Account_SipUsername class=UiInputText type=text placeholder='"+lang.eg_sip_username+"' value='"+getDbItem("SipUsername","")+"'></div>",t+="<div class=UiText>"+lang.sip_password+":</div>",t+="<div><input id=Configure_Account_SipPassword class=UiInputText type=password placeholder='"+lang.eg_sip_password+"' value='"+getDbItem("SipPassword","")+"'></div>",t+="<div class=UiText>"+lang.subscribe_voicemail+":</div>",t+="<div><input type=checkbox id=Configure_Account_Voicemail_Subscribe "+(1==VoiceMailSubscribe?"checked":"")+"><label for=Configure_Account_Voicemail_Subscribe>"+lang.yes+"</label></div>",t+='<div id=Voicemail_Did_row style="display:'+(1==VoiceMailSubscribe?"unset":"none")+'">',t+='<div class=UiText style="margin-left:20px">'+lang.voicemail_did+":</div>",t+='<div style="margin-left:20px"><input id=Configure_Account_Voicemail_Did class=UiInputText type=text placeholder=\''+lang.eg_internal_subscribe_extension+"' value='"+getDbItem("VoicemailDid","")+"'></div>",t+="</div>",t+="<div class=UiText>"+lang.chat_engine+":</div>",t+='<ul style="list-style-type:none">',t+="<li><input type=radio name=chatEngine id=chat_type_sip "+("XMPP"==ChatEngine?"":"checked")+"><label for=chat_type_sip>SIP</label>",t+="<li><input type=radio name=chatEngine id=chat_type_xmpp "+("XMPP"==ChatEngine?"checked":"")+"><label for=chat_type_xmpp>XMPP</label>",t+="</ul>",t+='<div id=RowChatEngine_xmpp style="display:'+("XMPP"==ChatEngine?"unset":"none")+'">',t+="<div class=UiText>"+lang.xmpp_server_address+":</div>",t+="<div><input id=Configure_Account_xmpp_address class=UiInputText type=text placeholder='"+lang.eg_xmpp_server_address+"' value='"+getDbItem("XmppServer","")+"'></div>",t+="<div class=UiText>XMPP "+lang.websocket_port+":</div>",t+="<div><input id=Configure_Account_xmpp_port class=UiInputText type=text placeholder='"+lang.eg_websocket_port+"' value='"+getDbItem("XmppWebsocketPort","")+"'></div>",t+="<div class=UiText>XMPP "+lang.websocket_path+":</div>",t+="<div><input id=Configure_Account_xmpp_path class=UiInputText type=text placeholder='"+lang.eg_websocket_path+"' value='"+getDbItem("XmppWebsocketPath","")+"'></div>",t+="<div class=UiText>"+lang.extension_number+":</div>",t+="<div><input id=Configure_Account_profileUser class=UiInputText type=text placeholder='"+lang.eg_internal_subscribe_extension+"' value='"+getDbItem("profileUser","")+"'></div>",t+="</div>",t+="</div>",1==EnableAccountSettings&&(e+=t),e+='<div class=UiTextHeading onclick="ToggleHeading(this,\'Audio_Video_Html\')"><i class="fa fa fa-video-camera UiTextHeadingIcon" style="background-color:#208e3c"></i> '+lang.audio_video+"</div>";var n='<div id=Audio_Video_Html style="display:none">';n+="<div class=UiText>"+lang.speaker+":</div>",n+='<div style="text-align:center"><select id=playbackSrc style="width:100%"></select></div>',n+="<div class=Settings_VolumeOutput_Container><div id=Settings_SpeakerOutput class=Settings_VolumeOutput></div></div>",n+='<div><button class=roundButtons id=preview_output_play><i class="fa fa-play"></i></button></div>',n+="<div id=RingDeviceSection>",n+="<div class=UiText>"+lang.ring_device+":</div>",n+='<div style="text-align:center"><select id=ringDevice style="width:100%"></select></div>',n+="<div class=Settings_VolumeOutput_Container><div id=Settings_RingerOutput class=Settings_VolumeOutput></div></div>",n+='<div><button class=roundButtons id=preview_ringer_play><i class="fa fa-play"></i></button></div>',n+="</div>",n+="<div class=UiText>"+lang.microphone+":</div>",n+='<div style="text-align:center"><select id=microphoneSrc style="width:100%"></select></div>',n+="<div class=Settings_VolumeOutput_Container><div id=Settings_MicrophoneOutput class=Settings_VolumeOutput></div></div>",n+="<div><input type=checkbox id=Settings_AutoGainControl><label for=Settings_AutoGainControl> "+lang.auto_gain_control+"<label></div>",n+="<div><input type=checkbox id=Settings_EchoCancellation><label for=Settings_EchoCancellation> "+lang.echo_cancellation+"<label></div>",n+="<div><input type=checkbox id=Settings_NoiseSuppression><label for=Settings_NoiseSuppression> "+lang.noise_suppression+"<label></div>",n+="<div class=UiText>"+lang.camera+":</div>",n+='<div style="text-align:center"><select id=previewVideoSrc style="width:100%"></select></div>',n+="<div class=UiText>"+lang.frame_rate+":</div>",n+="<div class=pill-nav>",n+='<input name=Settings_FrameRate id=r40 type=radio value="2"><label class=radio_pill for=r40>2</label>',n+='<input name=Settings_FrameRate id=r41 type=radio value="5"><label class=radio_pill for=r41>5</label>',n+='<input name=Settings_FrameRate id=r42 type=radio value="10"><label class=radio_pill for=r42>10</label>',n+='<input name=Settings_FrameRate id=r43 type=radio value="15"><label class=radio_pill for=r43>15</label>',n+='<input name=Settings_FrameRate id=r44 type=radio value="20"><label class=radio_pill for=r44>20</label>',n+='<input name=Settings_FrameRate id=r45 type=radio value="25"><label class=radio_pill for=r45>25</label>',n+='<input name=Settings_FrameRate id=r46 type=radio value="30"><label class=radio_pill for=r46>30</label>',n+='<input name=Settings_FrameRate id=r47 type=radio value=""><label class=radio_pill for=r47><i class="fa fa-trash"></i></label>',n+="</div>",n+="<div class=UiText>"+lang.quality+":</div>",n+="<div class=pill-nav>",n+='<input name=Settings_Quality id=r30 type=radio value="160"><label class=radio_pill for=r30><i class="fa fa-video-camera" style="transform: scale(0.4)"></i> HQVGA</label>',n+='<input name=Settings_Quality id=r31 type=radio value="240"><label class=radio_pill for=r31><i class="fa fa-video-camera" style="transform: scale(0.6)"></i> QVGA</label>',n+='<input name=Settings_Quality id=r32 type=radio value="480"><label class=radio_pill for=r32><i class="fa fa-video-camera" style="transform: scale(0.8)"></i> VGA</label>',n+='<input name=Settings_Quality id=r33 type=radio value="720"><label class=radio_pill for=r33><i class="fa fa-video-camera" style="transform: scale(1)"></i> HD</label>',n+='<input name=Settings_Quality id=r34 type=radio value=""><label class=radio_pill for=r34><i class="fa fa-trash"></i></label>',n+="</div>",n+="<div class=UiText>"+lang.image_orientation+":</div>",n+="<div class=pill-nav>",n+='<input name=Settings_Orientation id=r20 type=radio value="rotateY(0deg)"><label class=radio_pill for=r20><i class="fa fa-address-card" style="transform: rotateY(0deg)"></i> '+lang.image_orientation_normal+"</label>",n+='<input name=Settings_Orientation id=r21 type=radio value="rotateY(180deg)"><label class=radio_pill for=r21><i class="fa fa-address-card" style="transform: rotateY(180deg)"></i> '+lang.image_orientation_mirror+"</label>",n+="</div>",n+="<div class=UiText>"+lang.aspect_ratio+":</div>",n+="<div class=pill-nav>",n+='<input name=Settings_AspectRatio id=r10 type=radio value="1"><label class=radio_pill for=r10><i class="fa fa-square-o" style="transform: scaleX(1); margin-left: 7px; margin-right: 7px"></i> 1:1</label>',n+='<input name=Settings_AspectRatio id=r11 type=radio value="1.33"><label class=radio_pill for=r11><i class="fa fa-square-o" style="transform: scaleX(1.33); margin-left: 5px; margin-right: 5px;"></i> 4:3</label>',n+='<input name=Settings_AspectRatio id=r12 type=radio value="1.77"><label class=radio_pill for=r12><i class="fa fa-square-o" style="transform: scaleX(1.77); margin-right: 3px;"></i> 16:9</label>',n+='<input name=Settings_AspectRatio id=r13 type=radio value=""><label class=radio_pill for=r13><i class="fa fa-trash"></i></label>',n+="</div>",n+="<div class=UiText>"+lang.preview+":</div>",n+='<div style="text-align:center; margin-top:10px"><video id=local-video-preview class=previewVideo muted playsinline></video></div>',n+="</div>",e+=n,1==EnableAppearanceSettings&&(e+='<div class=UiTextHeading onclick="ToggleHeading(this,\'Appearance_Html\')"><i class="fa fa-pencil UiTextHeadingIcon" style="background-color:#416493"></i> '+lang.appearance+"</div>");var i='<div id=Appearance_Html style="display:none">';i+='<div id=ImageCanvas style="width:150px; height:150px"></div>',i+='<div style="margin-top:50px;"><input id=fileUploader type=file></div>',i+='<div style="margin-top:10px"></div>';var a=getDbItem("profileVcard",null)
;null!=a&&(a=JSON.parse(a)),i+="<div class=UiText>"+lang.title_description+":</div>",i+="<div><input id=Configure_Profile_TitleDesc class=UiInputText type=text placeholder='"+lang.eg_general_manager+"' value='"+(null!=a?a.TitleDesc:"")+"'></div>",i+="<div class=UiText>"+lang.mobile_number+":</div>",i+="<div><input id=Configure_Profile_Mobile class=UiInputText type=text placeholder='"+lang.eg_mobile_number+"' value='"+(null!=a?a.Mobile:"")+"'></div>",i+="<div class=UiText>"+lang.email+":</div>",i+="<div><input id=Configure_Profile_Email class=UiInputText type=text placeholder='"+lang.email+"' value='"+(null!=a?a.Email:"")+"'></div>",i+="<div class=UiText>"+lang.contact_number_1+":</div>",i+="<div><input id=Configure_Profile_Number1 class=UiInputText type=text placeholder='"+lang.eg_contact_number_1+"' value='"+(null!=a?a.Number1:"")+"'></div>",i+="<div class=UiText>"+lang.contact_number_2+":</div>",i+="<div><input id=Configure_Profile_Number2 class=UiInputText type=text placeholder='"+lang.eg_contact_number_2+"' value='"+(null!=a?a.Number2:"")+"'></div>",i+="</div>",1==EnableAppearanceSettings&&(e+=i),1==EnableNotificationSettings&&(e+='<div class=UiTextHeading onclick="ToggleHeading(this,\'Notifications_Html\')"><i class="fa fa-bell UiTextHeadingIcon" style="background-color:#ab8e04"></i> '+lang.notifications+"</div>");var o='<div id=Notifications_Html style="display:none">';o+="<div class=UiText>"+lang.notifications+":</div>",o+="<div><input type=checkbox id=Settings_Notifications><label for=Settings_Notifications> "+lang.enable_onscreen_notifications+"<label></div>",o+="</div>",1==EnableNotificationSettings&&(e+=o),e+="</div>",e+="<div class=UiWindowButtonBar id=ButtonBar></div>",$("#actionArea").html(e);var s=[];s.push({text:lang.save,action:function(){var e=$("#chat_type_sip").is(":checked")?"SIMPLE":"XMPP";if(EnableAccountSettings){if(""==$("#Configure_Account_wssServer").val())return void console.warn("Validation Failed");if(""==$("#Configure_Account_WebSocketPort").val())return void console.warn("Validation Failed");if(""==$("#Configure_Account_profileName").val())return void console.warn("Validation Failed");if(""==$("#Configure_Account_SipDomain").val())return void console.warn("Validation Failed");if(""==$("#Configure_Account_SipUsername").val())return void console.warn("Validation Failed");if(""==$("#Configure_Account_SipPassword").val())return void console.warn("Validation Failed");if("XMPP"==e){if(""==$("#Configure_Account_xmpp_address").val())return void console.warn("Validation Failed");if(""==$("#Configure_Account_xmpp_port").val())return void console.warn("Validation Failed");if(""==$("#Configure_Account_profileUser").val())return void console.warn("Validation Failed")}}if(null==localDB.getItem("profileUserID")&&localDB.setItem("profileUserID",uID()),EnableAccountSettings&&(localDB.setItem("wssServer",$("#Configure_Account_wssServer").val()),localDB.setItem("WebSocketPort",$("#Configure_Account_WebSocketPort").val()),localDB.setItem("ServerPath",$("#Configure_Account_ServerPath").val()),localDB.setItem("profileName",$("#Configure_Account_profileName").val()),localDB.setItem("SipDomain",$("#Configure_Account_SipDomain").val()),localDB.setItem("SipUsername",$("#Configure_Account_SipUsername").val()),localDB.setItem("SipPassword",$("#Configure_Account_SipPassword").val()),localDB.setItem("VoiceMailSubscribe",$("#Configure_Account_Voicemail_Subscribe").is(":checked")?"1":"0"),localDB.setItem("VoicemailDid",$("#Configure_Account_Voicemail_Did").val()),localDB.setItem("ChatEngine",e),localDB.setItem("profileUser",$("#Configure_Account_profileUser").val()),localDB.setItem("XmppServer",$("#Configure_Account_xmpp_address").val()),localDB.setItem("XmppWebsocketPort",$("#Configure_Account_xmpp_port").val()),localDB.setItem("XmppWebsocketPath",$("#Configure_Account_xmpp_path").val())),localDB.setItem("AudioOutputId",$("#playbackSrc").val()),localDB.setItem("VideoSrcId",$("#previewVideoSrc").val()),localDB.setItem("VideoHeight",$("input[name=Settings_Quality]:checked").val()),localDB.setItem("FrameRate",$("input[name=Settings_FrameRate]:checked").val()),localDB.setItem("AspectRatio",$("input[name=Settings_AspectRatio]:checked").val()),localDB.setItem("VideoOrientation",$("input[name=Settings_Orientation]:checked").val()),localDB.setItem("AudioSrcId",$("#microphoneSrc").val()),localDB.setItem("AutoGainControl",$("#Settings_AutoGainControl").is(":checked")?"1":"0"),localDB.setItem("EchoCancellation",$("#Settings_EchoCancellation").is(":checked")?"1":"0"),localDB.setItem("NoiseSuppression",$("#Settings_NoiseSuppression").is(":checked")?"1":"0"),localDB.setItem("RingOutputId",$("#ringDevice").val()),EnableAppearanceSettings){var t={TitleDesc:$("#Configure_Profile_TitleDesc").val(),Mobile:$("#Configure_Profile_Mobile").val(),Email:$("#Configure_Profile_Email").val(),Number1:$("#Configure_Profile_Number1").val(),Number2:$("#Configure_Profile_Number2").val()};localDB.setItem("profileVcard",JSON.stringify(t));var n={type:"base64",size:"viewport",format:"png",quality:1,circle:!1};$("#Appearance_Html").show(),$("#ImageCanvas").croppie("result",n).then(function(e){localDB.setItem("profilePicture",e),$("#Appearance_Html").hide(),Alert(lang.alert_settings,lang.reload_required,function(){window.location.reload()})})}else Alert(lang.alert_settings,lang.reload_required,function(){window.location.reload()});EnableNotificationSettings&&localDB.setItem("Notifications",$("#Settings_Notifications").is(":checked")?"1":"0")}}),s.push({text:lang.cancel,action:function(){ShowContacts()}}),$.each(s,function(e,t){var n=$("<button>"+t.text+"</button>").click(t.action);$("#ButtonBar").append(n)}),$("#actionArea").show(),window.setTimeout(function(){EnableAccountSettings&&($("#chat_type_sip").change(function(){$("#chat_type_sip").is(":checked")&&$("#RowChatEngine_xmpp").hide()}),$("#chat_type_xmpp").change(function(){$("#chat_type_xmpp").is(":checked")&&$("#RowChatEngine_xmpp").show()}),$("#Configure_Account_Voicemail_Subscribe").change(function(){$("#Configure_Account_Voicemail_Subscribe").is(":checked")?$("#Voicemail_Did_row").show():$("#Voicemail_Did_row").hide()}));var e=$("#playbackSrc"),t=$("#preview_output_play"),n=$("#preview_ringer_play"),i=$("#microphoneSrc");$("#Settings_AutoGainControl").prop("checked",AutoGainControl),$("#Settings_EchoCancellation").prop("checked",EchoCancellation),$("#Settings_NoiseSuppression").prop("checked",NoiseSuppression);var a=$("#previewVideoSrc"),o=$("input[name=Settings_Orientation]");o.each(function(){this.value==MirrorVideo&&$(this).prop("checked",!0)}),$("#local-video-preview").css("transform",MirrorVideo);var s=$("input[name=Settings_FrameRate]");s.each(function(){this.value==maxFrameRate&&$(this).prop("checked",!0)});var l=$("input[name=Settings_Quality]");l.each(function(){this.value==videoHeight&&$(this).prop("checked",!0)});var r=$("input[name=Settings_AspectRatio]");r.each(function(){this.value==videoAspectRatio&&$(this).prop("checked",!0)});$("#ringTone");var d=$("#ringDevice");r.change(function(){console.log("Call to change Aspect Ratio ("+this.value+")");var e=$("#local-video-preview").get(0);e.muted=!0,e.playsinline=!0,e.autoplay=!0;var t=e.srcObject.getTracks();t.forEach(function(e){e.stop()});var n={audio:!1,video:{deviceId:"default"!=a.val()?{exact:a.val()}:"default"}};""!=$("input[name=Settings_FrameRate]:checked").val()&&(n.video.frameRate=$("input[name=Settings_FrameRate]:checked").val()),""!=$("input[name=Settings_Quality]:checked").val()&&(n.video.height=$("input[name=Settings_Quality]:checked").val()),""!=this.value&&(n.video.aspectRatio=this.value),console.log("Constraints:",n);var i=new MediaStream;navigator.mediaDevices&&navigator.mediaDevices.getUserMedia(n).then(function(t){var n=t.getVideoTracks()[0];i.addTrack(n),e.srcObject=i,e.onloadedmetadata=function(t){e.play()}}).catch(function(e){console.error(e),Alert(lang.alert_error_user_media,lang.error)})}),l.change(function(){console.log("Call to change Video Height ("+this.value+")");var e=$("#local-video-preview").get(0);e.muted=!0,e.playsinline=!0,e.autoplay=!0;var t=e.srcObject.getTracks();t.forEach(function(e){e.stop()});var n={audio:!1,video:{deviceId:"default"!=a.val()?{exact:a.val()}:"default"}};""!=$("input[name=Settings_FrameRate]:checked").val()&&(n.video.frameRate=$("input[name=Settings_FrameRate]:checked").val()),this.value&&(n.video.height=this.value),""!=$("input[name=Settings_AspectRatio]:checked").val()&&(n.video.aspectRatio=$("input[name=Settings_AspectRatio]:checked").val()),console.log("Constraints:",n);var i=new MediaStream;navigator.mediaDevices&&navigator.mediaDevices.getUserMedia(n).then(function(t){var n=t.getVideoTracks()[0];i.addTrack(n),e.srcObject=i,e.onloadedmetadata=function(t){e.play()}}).catch(function(e){console.error(e),Alert(lang.alert_error_user_media,lang.error)})}),s.change(function(){console.log("Call to change Frame Rate ("+this.value+")");var e=$("#local-video-preview").get(0);e.muted=!0,e.playsinline=!0,e.autoplay=!0;var t=e.srcObject.getTracks();t.forEach(function(e){e.stop()});var n={audio:!1,video:{deviceId:"default"!=a.val()?{exact:a.val()}:"default"}};""!=this.value&&(n.video.frameRate=this.value),""!=$("input[name=Settings_Quality]:checked").val()&&(n.video.height=$("input[name=Settings_Quality]:checked").val()),""!=$("input[name=Settings_AspectRatio]:checked").val()&&(n.video.aspectRatio=$("input[name=Settings_AspectRatio]:checked").val()),console.log("Constraints:",n);var i=new MediaStream;navigator.mediaDevices&&navigator.mediaDevices.getUserMedia(n).then(function(t){var n=t.getVideoTracks()[0];i.addTrack(n),e.srcObject=i,e.onloadedmetadata=function(t){e.play()}}).catch(function(e){console.error(e),Alert(lang.alert_error_user_media,lang.error)})}),i.change(function(){console.log("Call to change Microphone ("+this.value+")");try{var e=window.SettingsMicrophoneStream.getTracks();e.forEach(function(e){e.stop()}),window.SettingsMicrophoneStream=null}catch(e){}try{soundMeter=window.SettingsMicrophoneSoundMeter,soundMeter.stop(),window.SettingsMicrophoneSoundMeter=null}catch(e){}var t={audio:{deviceId:{exact:this.value}},video:!1},n=new MediaStream;navigator.mediaDevices.getUserMedia(t).then(function(e){var t=e.getAudioTracks()[0];null!=t&&(n.addTrack(t),window.SettingsMicrophoneStream=n,window.SettingsMicrophoneSoundMeter=MeterSettingsOutput(n,"Settings_MicrophoneOutput","width",50))}).catch(function(e){console.log("Failed to getUserMedia",e)})}),e.change(function(){console.log("Call to change Speaker ("+this.value+")");var e=window.SettingsOutputAudio;null!=e&&void 0!==e.sinkId&&e.setSinkId(this.value).then(function(){console.log("sinkId applied to audioObj:",this.value)}).catch(function(e){console.warn("Failed not apply setSinkId.",e)})}),t.click(function(){try{window.SettingsOutputAudio.pause()}catch(e){}window.SettingsOutputAudio=null;try{var t=window.SettingsOutputStream.getTracks();t.forEach(function(e){e.stop()})}catch(e){}window.SettingsOutputStream=null;try{var n=window.SettingsOutputStreamMeter;n.stop()}catch(e){}window.SettingsOutputStreamMeter=null,console.log("Audio:",audioBlobs.speech_orig.url);var i=new Audio(audioBlobs.speech_orig.blob);i.preload="auto",i.onplay=function(){var e=new MediaStream;if(void 0!==i.captureStream)e=i.captureStream();else{if(void 0!==i.mozCaptureStream)return;if(void 0===i.webkitCaptureStream)return void console.warn("Cannot display Audio Levels");e=i.webkitCaptureStream()}window.SettingsOutputStream=e,window.SettingsOutputStreamMeter=MeterSettingsOutput(e,"Settings_SpeakerOutput","width",50)},i.oncanplaythrough=function(t){void 0!==i.sinkId&&i.setSinkId(e.val()).then(function(){console.log("Set sinkId to:",e.val())}).catch(function(e){console.warn("Failed not apply setSinkId.",e)}),i.play().then(function(){}).catch(function(e){console.warn("Unable to play audio file",e)}),console.log("Playing sample audio file... ")},window.SettingsOutputAudio=i}),n.click(function(){try{window.SettingsRingerAudio.pause()}catch(e){}window.SettingsRingerAudio=null;try{var e=window.SettingsRingerStream.getTracks();e.forEach(function(e){e.stop()})}catch(e){}window.SettingsRingerStream=null;try{var t=window.SettingsRingerStreamMeter;t.stop()}catch(e){}window.SettingsRingerStreamMeter=null,console.log("Audio:",audioBlobs.Ringtone.url);var n=new Audio(audioBlobs.Ringtone.blob);n.preload="auto",n.onplay=function(){var e=new MediaStream;if(void 0!==n.captureStream)e=n.captureStream();else{if(void 0!==n.mozCaptureStream)return;if(void 0===n.webkitCaptureStream)return void console.warn("Cannot display Audio Levels");e=n.webkitCaptureStream()}window.SettingsRingerStream=e,window.SettingsRingerStreamMeter=MeterSettingsOutput(e,"Settings_RingerOutput","width",50)},n.oncanplaythrough=function(e){void 0!==n.sinkId&&n.setSinkId(d.val()).then(function(){console.log("Set sinkId to:",d.val())}).catch(function(e){console.warn("Failed not apply setSinkId.",e)}),n.play().then(function(){}).catch(function(e){console.warn("Unable to play audio file",e)}),console.log("Playing sample audio file... ")},window.SettingsRingerAudio=n}),o.change(function(){console.log("Call to change Orientation ("+this.value+")"),$("#local-video-preview").css("transform",this.value)}),a.change(function(){console.log("Call to change WebCam ("+this.value+")");var e=$("#local-video-preview").get(0);e.muted=!0,e.playsinline=!0,e.autoplay=!0;var t=e.srcObject.getTracks();t.forEach(function(e){e.stop()});var n={audio:!1,video:{deviceId:"default"!=this.value?{exact:this.value}:"default"}};""!=$("input[name=Settings_FrameRate]:checked").val()&&(n.video.frameRate=$("input[name=Settings_FrameRate]:checked").val()),""!=$("input[name=Settings_Quality]:checked").val()&&(n.video.height=$("input[name=Settings_Quality]:checked").val()),""!=$("input[name=Settings_AspectRatio]:checked").val()&&(n.video.aspectRatio=$("input[name=Settings_AspectRatio]:checked").val()),console.log("Constraints:",n);var i=new MediaStream;navigator.mediaDevices&&navigator.mediaDevices.getUserMedia(n).then(function(t){var n=t.getVideoTracks()[0];i.addTrack(n),e.srcObject=i,e.onloadedmetadata=function(t){e.play()}}).catch(function(e){console.error(e),Alert(lang.alert_error_user_media,lang.error)})});var c=$("#local-video-preview").get(0);c.muted=!0,c.playsinline=!0,c.autoplay=!0;var u=new MediaStream,p=new MediaStream;if(navigator.mediaDevices?navigator.mediaDevices.enumerateDevices().then(function(t){for(var n=getVideoSrcID(),o=!1,s=getAudioSrcID(),l=!1,r=!1,g=!1,m=!1,f=0;f<t.length;++f)console.log("Found Device ("+t[f].kind+"): ",t[f].label),"audioinput"===t[f].kind?(r=!0,"default"!=s&&t[f].deviceId==s&&(l=!0)):"audiooutput"===t[f].kind?g=!0:"videoinput"===t[f].kind&&(m=!0,"default"!=n&&t[f].deviceId==n&&(o=!0));var v={audio:r,video:m};r&&(v.audio={deviceId:"default"},l&&(v.audio.deviceId={exact:s})),m&&(v.video={deviceId:"default"},o&&(v.video.deviceId={exact:n})),""!=$("input[name=Settings_FrameRate]:checked").val()&&(v.video.frameRate=$("input[name=Settings_FrameRate]:checked").val()),""!=$("input[name=Settings_Quality]:checked").val()&&(v.video.height=$("input[name=Settings_Quality]:checked").val()),""!=$("input[name=Settings_AspectRatio]:checked").val()&&(v.video.aspectRatio=$("input[name=Settings_AspectRatio]:checked").val()),console.log("Get User Media",v),navigator.mediaDevices.getUserMedia(v).then(function(e){var t=e.getVideoTracks().length>=1?e.getVideoTracks()[0]:null;m&&null!=t?(u.addTrack(t),c.srcObject=u,c.onloadedmetadata=function(e){c.play()}):console.warn("No video / webcam devices found. Video Calling will not be possible.");var n=e.getAudioTracks().length>=1?e.getAudioTracks()[0]:null;return r&&null!=n?(p.addTrack(n),window.SettingsMicrophoneStream=p,window.SettingsMicrophoneSoundMeter=MeterSettingsOutput(p,"Settings_MicrophoneOutput","width",50)):console.warn("No microphone devices found. Calling will not be possible."),$("#Settings_SpeakerOutput").css("width","0%"),$("#Settings_RingerOutput").css("width","0%"),g||(console.log("No speaker devices found, make sure one is plugged in."),$("#playbackSrc").hide(),$("#RingDeviceSection").hide()),navigator.mediaDevices.enumerateDevices()}).then(function(t){for(var n=0;n<t.length;++n){console.log("Found Device ("+t[n].kind+") Again: ",t[n].label,t[n].deviceId);var o=t[n],s=o.deviceId,l=o.label;l.indexOf("(")>0&&(l=l.substring(0,l.indexOf("(")));var r=$("<option/>");if(r.prop("value",s),"audioinput"===o.kind)r.text(""!=l?l:"Microphone"),getAudioSrcID()==s&&r.prop("selected",!0),i.append(r);else if("audiooutput"===o.kind){r.text(""!=l?l:"Speaker"),getAudioOutputID()==s&&r.prop("selected",!0),e.append(r);var c=r.clone();getRingerOutputID()==s&&c.prop("selected",!0),d.append(c)}else"videoinput"===o.kind&&(getVideoSrcID()==s&&r.prop("selected",!0),r.text(""!=l?l:"Webcam"),a.append(r))}if(a.children("option").length>0){r=$("<option/>");r.prop("value","default"),"default"!=getVideoSrcID()&&""!=getVideoSrcID()&&"null"!=getVideoSrcID()||r.prop("selected",!0),r.text("("+lang.default_video_src+")"),a.append(r)}}).catch(function(e){console.error(e),Alert(lang.alert_error_user_media,lang.error)})}).catch(function(e){console.error("Error getting Media Devices",e)}):Alert(lang.alert_media_devices,lang.error),EnableAppearanceSettings&&($("#Appearance_Html").show(),$("#ImageCanvas").croppie({viewport:{width:150,height:150,type:"circle"}}),$("#ImageCanvas").croppie("bind",{url:getPicture("profilePicture")}).then(function(){$("#Appearance_Html").hide()}),$("#fileUploader").change(function(){var e=$(this).prop("files");if(1==e.length){var t=Math.floor(1e9*Math.random()),n=e[0],i=n.name,a=n.size;if(a<=52428800){console.log("Adding ("+t+"): "+i+" of size: "+a+"bytes");var o=new FileReader;o.Name=i,o.UploadId=t,o.Size=a,o.onload=function(e){$("#ImageCanvas").croppie("bind",{url:e.target.result})},o.readAsDataURL(n)}else Alert(lang.alert_file_size,lang.error)}else Alert(lang.alert_single_file,lang.error)})),EnableNotificationSettings){var g=$("#Settings_Notifications");g.prop("checked",NotificationsActive),g.change(function(){this.checked&&"granted"!=Notification.permission&&(checkNotificationPromise()?Notification.requestPermission().then(function(e){console.log(e),HandleNotifyPermission(e)}):Notification.requestPermission(function(e){console.log(e),HandleNotifyPermission(e)}))})}},0)}function RefreshRegistration(){Unregister(),console.log("Unregister complete..."),window.setTimeout(function(){console.log("Starting registration..."),Register()},1e3)}function ToggleHeading(e,t){$("#"+t).toggle()}function ToggleAutoAnswer(){if("disabled"==AutoAnswerPolicy)return AutoAnswerEnabled=!1,void console.warn("Policy AutoAnswer: Disabled");AutoAnswerEnabled=1!=AutoAnswerEnabled,"enabled"==AutoAnswerPolicy&&(AutoAnswerEnabled=!0),localDB.setItem("AutoAnswerEnabled",1==AutoAnswerEnabled?"1":"0"),console.log("AutoAnswer:",AutoAnswerEnabled)}function ToggleDoNoDisturb(){return"disabled"==DoNotDisturbPolicy?(DoNotDisturbEnabled=!1,void console.warn("Policy DoNotDisturb: Disabled")):"enabled"==DoNotDisturbPolicy?(DoNotDisturbEnabled=!0,void console.warn("Policy DoNotDisturb: Enabled")):(1==DoNotDisturbEnabled?(DoNotDisturbEnabled=!1,localDB.setItem("DoNotDisturbEnabled","0"),$("#dereglink").attr("class","dotOnline"),$("#dndStatus").html(""),"undefined"!=typeof web_hook_disable_dnd&&web_hook_disable_dnd()):(DoNotDisturbEnabled=!0,localDB.setItem("DoNotDisturbEnabled","1"),$("#dereglink").attr("class","dotDoNotDisturb"),$("#dndStatus").html("(DND)"),"undefined"!=typeof web_hook_enable_dnd&&web_hook_enable_dnd()),void console.log("DoNotDisturb",DoNotDisturbEnabled))}function ToggleCallWaiting(){if("disabled"==CallWaitingPolicy)return CallWaitingEnabled=!1,void console.warn("Policy CallWaiting: Disabled");CallWaitingEnabled=1!=CallWaitingEnabled,"enabled"==CallWaitingPolicy&&(CallWaitingPolicy=!0),localDB.setItem("CallWaitingEnabled",1==CallWaitingEnabled?"1":"0"),console.log("CallWaiting",CallWaitingEnabled)}function ToggleRecordAllCalls(){if("disabled"==CallRecordingPolicy)return RecordAllCalls=!1,void console.warn("Policy CallRecording: Disabled");RecordAllCalls=1!=RecordAllCalls,"enabled"==CallRecordingPolicy&&(RecordAllCalls=!0),localDB.setItem("RecordAllCalls",1==RecordAllCalls?"1":"0"),console.log("RecordAllCalls",RecordAllCalls)}function ChangeSettings(e,t){if(UiCustomMediaSettings)"undefined"!=typeof web_hook_on_edit_media&&web_hook_on_edit_media(e,t);else{var n=FindLineByNumber(e);if(null!=n&&null!=n.SipSession){var i=n.SipSession;if(navigator.mediaDevices){var a=[];a.push({value:"",icon:null,text:lang.microphone,isHeader:!0});for(var o=0;o<AudioinputDevices.length;++o){var s=AudioinputDevices[o],l=s.deviceId,r=s.label?s.label:"Microphone";r.indexOf("(")>0&&(r=r.substring(0,r.indexOf("(")));var d=i.data.AudioSourceDevice==l;a.push({value:"input-"+l,icon:"fa fa-microphone",text:r,isDisabled:d})}if(HasSpeakerDevice){a.push({value:"",icon:null,text:"-"}),a.push({value:"",icon:null,text:lang.speaker,isHeader:!0});for(o=0;o<SpeakerDevices.length;++o){s=SpeakerDevices[o],l=s.deviceId,r=s.label?s.label:"Speaker";r.indexOf("(")>0&&(r=r.substring(0,r.indexOf("(")));d=i.data.AudioOutputDevice==l;a.push({value:"output-"+l,icon:"fa fa-volume-up",text:r,isDisabled:d})}}if(1==i.data.withvideo){a.push({value:"",icon:null,text:"-"}),a.push({value:"",icon:null,text:lang.camera,isHeader:!0});for(o=0;o<VideoinputDevices.length;++o){s=VideoinputDevices[o],l=s.deviceId,r=s.label?s.label:"Webcam";r.indexOf("(")>0&&(r=r.substring(0,r.indexOf("(")));d=i.data.VideoSourceDevice==l;a.push({value:"video-"+l,icon:"fa fa-video-camera",text:r,isDisabled:d})}}var c={selectEvent:function(t,a){var o=a.item.attr("value");if(null!=o){if(o.indexOf("input-")>-1){var s=o.replace("input-","");console.log("Call to change Microphone: ",s),HidePopup();var l=!1;i.data.mediaRecorder&&"recording"==i.data.mediaRecorder.state&&(StopRecording(e,!0),l=!0),n.LocalSoundMeter&&n.LocalSoundMeter.stop(),i.data.AudioSourceDevice=s;var r={audio:{deviceId:"default"!=s?{exact:s}:"default"},video:!1};navigator.mediaDevices.getUserMedia(r).then(function(t){var a=t.getAudioTracks()[0],o=i.sessionDescriptionHandler.peerConnection;o.getSenders().forEach(function(t){t.track&&"audio"==t.track.kind&&(console.log("Switching Audio Track : "+t.track.label+" to "+a.label),t.track.stop(),t.replaceTrack(a).then(function(){l&&StartRecording(e),n.LocalSoundMeter=StartLocalAudioMediaMonitoring(e,i)}).catch(function(e){console.error("Error replacing track: ",e)}))})}).catch(function(e){console.error("Error on getUserMedia")})}if(o.indexOf("output-")>-1){s=o.replace("output-","");console.log("Call to change Speaker: ",s),HidePopup(),i.data.AudioOutputDevice=s;var d=s;console.log("Attempting to set Audio Output SinkID for line "+e+" ["+d+"]");var c=$("#line-"+e+"-remoteAudio").get(0);c&&(void 0!==c.sinkId?c.setSinkId(d).then(function(){console.log("sinkId applied: "+d)}).catch(function(e){console.warn("Error using setSinkId: ",e)}):console.warn("setSinkId() is not possible using this browser."))}if(o.indexOf("video-")>-1){s=o.replace("video-","");console.log("Call to change WebCam"),HidePopup(),switchVideoSource(e,s)}}else HidePopup()},createEvent:null,autoFocus:!0,items:a};PopupMenu(t,c)}else console.warn("navigator.mediaDevices not possible.")}else console.warn("SIP Session is NULL.")}}function PresentCamera(e){var t=FindLineByNumber(e);if(null!=t&&null!=t.SipSession){var n=t.SipSession;$("#line-"+e+"-src-camera").prop("disabled",!0),$("#line-"+e+"-src-canvas").prop("disabled",!1),$("#line-"+e+"-src-desktop").prop("disabled",!1),$("#line-"+e+"-src-video").prop("disabled",!1),$("#line-"+e+"-src-blank").prop("disabled",!1),$("#line-"+e+"-scratchpad-container").hide(),RemoveScratchpad(e),$("#line-"+e+"-sharevideo").hide(),$("#line-"+e+"-sharevideo").get(0).pause(),$("#line-"+e+"-sharevideo").get(0).removeAttribute("src"),$("#line-"+e+"-sharevideo").get(0).load(),window.clearInterval(n.data.videoResampleInterval),$("#line-"+e+"-localVideo").show(),$("#line-"+e+"-remote-videos").show(),RedrawStage(e,!0),switchVideoSource(e,n.data.VideoSourceDevice)}else console.warn("Line or Session is Null.")}function PresentScreen(e){var t=FindLineByNumber(e);if(null!=t&&null!=t.SipSession){var n=t.SipSession;$("#line-"+e+"-src-camera").prop("disabled",!1),$("#line-"+e+"-src-canvas").prop("disabled",!1),$("#line-"+e+"-src-desktop").prop("disabled",!0),$("#line-"+e+"-src-video").prop("disabled",!1),$("#line-"+e+"-src-blank").prop("disabled",!1),$("#line-"+e+"-scratchpad-container").hide(),RemoveScratchpad(e),$("#line-"+e+"-sharevideo").hide(),$("#line-"+e+"-sharevideo").get(0).pause(),$("#line-"+e+"-sharevideo").get(0).removeAttribute("src"),$("#line-"+e+"-sharevideo").get(0).load(),window.clearInterval(n.data.videoResampleInterval),$("#line-"+e+"-localVideo").show(),$("#line-"+e+"-remote-videos").show(),ShareScreen(e)}else console.warn("Line or Session is Null.")}function PresentScratchpad(e){var t=FindLineByNumber(e);if(null!=t&&null!=t.SipSession){var n=t.SipSession;$("#line-"+e+"-src-camera").prop("disabled",!1),$("#line-"+e+"-src-canvas").prop("disabled",!0),$("#line-"+e+"-src-desktop").prop("disabled",!1),$("#line-"+e+"-src-video").prop("disabled",!1),$("#line-"+e+"-src-blank").prop("disabled",!1),$("#line-"+e+"-scratchpad-container").hide(),RemoveScratchpad(e),$("#line-"+e+"-sharevideo").hide(),$("#line-"+e+"-sharevideo").get(0).pause(),$("#line-"+e+"-sharevideo").get(0).removeAttribute("src"),$("#line-"+e+"-sharevideo").get(0).load(),window.clearInterval(n.data.videoResampleInterval),$("#line-"+e+"-localVideo").show(),$("#line-"+e+"-remote-videos").hide(),SendCanvas(e)}else console.warn("Line or Session is Null.")}function PresentVideo(e){var t=FindLineByNumber(e);if(null!=t&&null!=t.SipSession){t.SipSession;var n='<div class="UiWindowField"><input type=file  accept="video/*" id=SelectVideoToSend></div>';OpenWindow(n,lang.select_video,150,360,!1,!1,null,null,lang.cancel,function(){CloseWindow()},function(){$("#SelectVideoToSend").on("change",function(t){var n=t.target;n.files.length>=1?(CloseWindow(),SendVideo(e,URL.createObjectURL(n.files[0]))):console.warn("Please Select a file to present.")})},null)}else console.warn("Line or Session is Null.")}function PresentBlank(e){var t=FindLineByNumber(e);if(null!=t&&null!=t.SipSession){var n=t.SipSession;$("#line-"+e+"-src-camera").prop("disabled",!1),$("#line-"+e+"-src-canvas").prop("disabled",!1),$("#line-"+e+"-src-desktop").prop("disabled",!1),$("#line-"+e+"-src-video").prop("disabled",!1),$("#line-"+e+"-src-blank").prop("disabled",!0),$("#line-"+e+"-scratchpad-container").hide(),RemoveScratchpad(e),$("#line-"+e+"-sharevideo").hide(),$("#line-"+e+"-sharevideo").get(0).pause(),$("#line-"+e+"-sharevideo").get(0).removeAttribute("src"),$("#line-"+e+"-sharevideo").get(0).load(),window.clearInterval(n.data.videoResampleInterval),$("#line-"+e+"-localVideo").hide(),$("#line-"+e+"-remote-videos").show(),DisableVideoStream(e)}else console.warn("Line or Session is Null.")}function RemoveScratchpad(e){var t=GetCanvas("line-"+e+"-scratchpad");null!=t&&(window.clearInterval(t.redrawIntrtval),RemoveCanvas("line-"+e+"-scratchpad"),$("#line-"+e+"-scratchpad-container").empty(),t=null)}function chatOnbeforepaste(e,t,n){console.log("Handle paste, checking for Images...");for(var i=(e.clipboardData||e.originalEvent.clipboardData).items,a=!1,o=0;o<i.length;o++)if(0!==i[o].type.indexOf("image"));else{console.log("Image found! Opening image editor...");var s=i[o].getAsFile(),l=new FileReader;l.onload=function(e){console.log("Image loaded... setting placeholder...");var t=new Image;t.onload=function(){console.log("Placeholder loaded... CreateImageEditor..."),CreateImageEditor(n,t)},t.src=e.target.result},l.readAsDataURL(s),a=!0}a&&e.preventDefault()}function chatOnkeydown(e,t,n){var i=e.keyCode?e.keyCode:e.which;if("13"==i){if(!e.shiftKey&&!e.ctrlKey)return e.preventDefault(),SendChatMessage(n),!1}else{var a=FindBuddyByIdentity(n);null!=a&&"xmpp"==a.type&&XmppStartComposing(a)}}function chatOnInput(e,t,n){var i=$.trim($(t).val());""!=i?$("#contact-"+n+"-sendMessageButtons").show():$("#contact-"+n+"-sendMessageButtons").hide()}function ReformatMessage(e){var t=e;return t=t.replace(/</gi,"&lt;"),t=t.replace(/>/gi,"&gt;"),t=t.replace(/\n/gi,"<br>"),t=t.replace(/(:\)|:\-\)|:o\))/g,String.fromCodePoint(128578)),t=t.replace(/(:\(|:\-\(|:o\()/g,String.fromCodePoint(128577)),t=t.replace(/(;\)|;\-\)|;o\))/g,String.fromCodePoint(128521)),t=t.replace(/(:'\(|:'\-\()/g,String.fromCodePoint(128554)),t=t.replace(/(:'\(|:'\-\()/g,String.fromCodePoint(128514)),t=t.replace(/(:\$)/g,String.fromCodePoint(128563)),t=t.replace(/(>:\()/g,String.fromCodePoint(128547)),t=t.replace(/(:\)/g,String.fromCodePoint(128536)),t=t.replace(/(:\O|:\O)/g,String.fromCodePoint(128562)),t=t.replace(/(:P|:\-P|:p|:\-p)/g,String.fromCodePoint(128539)),t=t.replace(/(;P|;\-P|;p|;\-p)/g,String.fromCodePoint(128540)),t=t.replace(/(:D|:\-D)/g,String.fromCodePoint(128525)),t=t.replace(/(\(like\))/g,String.fromCodePoint(128077)),t=t.replace(/((([A-Za-z]{3,9}:(?:\/\/)?)(?:[-;:&=\+\$,\w]+@)?[A-Za-z0-9.-]+|(?:www.|[-;:&=\+\$,\w]+@)[A-Za-z0-9.-]+)((?:\/[\+~%\/.\w-_]*)?\??(?:[-\+=&;%@.\w_]*)#?(?:[\w]*))?)/gi,function(e){var t=e.length>50?e.substring(0,47)+"...":e,n='<A target=_blank class=previewHyperlink href="'+e+'">'+t+"</A>";return n}),t}function getPicture(e,t,n){var i=Math.floor(Math.random()*avatars.length),a=hostingPrefix+""+avatars[i];if("profilePicture"==e){var o=localDB.getItem("profilePicture");return null==o?a:o}t=t||"extension";var s=FindBuddyByIdentity(e);if(null==s)return a;if(1!=n&&""!=s.imageObjectURL)return s.imageObjectURL;o=localDB.getItem("img-"+e+"-"+t);return null==o?(s.imageObjectURL=a,s.imageObjectURL):(s.imageObjectURL=URL.createObjectURL(base64toBlob(o,"image/png")),s.imageObjectURL)}function CreateImageEditor(e,t){console.log("Setting Up ImageEditor..."),$("#contact-"+e+"-imagePastePreview").is(":visible")?(console.log("Resetting ImageEditor..."),$("#contact-"+e+"-imagePastePreview").empty(),RemoveCanvas("contact-"+e+"-imageCanvas")):$("#contact-"+e+"-imagePastePreview").show();var n=$("<div/>");n.css("margin-bottom","5px"),n.append('<button class="toolBarButtons" title="Select" onclick="ImageEditor_Select(\''+e+'\')"><i class="fa fa-mouse-pointer"></i></button>'),n.append("&nbsp;|&nbsp;"),n.append('<button class="toolBarButtons" title="Draw" onclick="ImageEditor_FreedrawPen(\''+e+'\')"><i class="fa fa-pencil"></i></button>'),n.append('<button class="toolBarButtons" title="Paint" onclick="ImageEditor_FreedrawPaint(\''+e+'\')"><i class="fa fa-paint-brush"></i></button>'),n.append("&nbsp;|&nbsp;"),n.append('<button class="toolBarButtons" title="Select Line Color" onclick="ImageEditor_SetectLineColor(\''+e+'\')"><i class="fa fa-pencil-square-o" style="color:rgb(255, 0, 0)"></i></button>'),n.append('<button class="toolBarButtons" title="Select Fill Color" onclick="ImageEditor_SetectFillColor(\''+e+'\')"><i class="fa fa-pencil-square" style="color:rgb(255, 0, 0)"></i></button>'),n.append("&nbsp;|&nbsp;"),n.append('<button class="toolBarButtons" title="Add Circle" onclick="ImageEditor_AddCircle(\''+e+'\')"><i class="fa fa-circle"></i></button>'),n.append('<button class="toolBarButtons" title="Add Rectangle" onclick="ImageEditor_AddRectangle(\''+e+'\')"><i class="fa fa-stop"></i></button>'),n.append('<button class="toolBarButtons" title="Add Triangle" onclick="ImageEditor_AddTriangle(\''+e+'\')"><i class="fa fa-play"></i></button>'),n.append('<button class="toolBarButtons" title="Add Emoji" onclick="ImageEditor_SetectEmoji(\''+e+'\')"><i class="fa fa-smile-o"></i></button>'),n.append('<button class="toolBarButtons" title="Add Text" onclick="ImageEditor_AddText(\''+e+'\')"><i class="fa fa-font"></i></button>'),n.append('<button class="toolBarButtons" title="Delete Selected Items" onclick="ImageEditor_Clear(\''+e+'\')"><i class="fa fa-times"></i></button>'),
n.append('<button class="toolBarButtons" title="Clear All" onclick="ImageEditor_ClearAll(\''+e+'\')"><i class="fa fa-trash"></i></button>'),n.append("&nbsp;|&nbsp;"),n.append('<button class="toolBarButtons" title="Pan" onclick="ImageEditor_Pan(\''+e+'\')"><i class="fa fa-hand-paper-o"></i></button>'),n.append('<button class="toolBarButtons" title="Zoom In" onclick="ImageEditor_ZoomIn(\''+e+'\')"><i class="fa fa-search-plus"></i></button>'),n.append('<button class="toolBarButtons" title="Zoom Out" onclick="ImageEditor_ZoomOut(\''+e+'\')"><i class="fa fa-search-minus"></i></button>'),n.append('<button class="toolBarButtons" title="Reset Pan & Zoom" onclick="ImageEditor_ResetZoom(\''+e+'\')"><i class="fa fa-search" aria-hidden="true"></i></button>'),n.append("&nbsp;|&nbsp;"),n.append('<button class="toolBarButtons" title="Cancel" onclick="ImageEditor_Cancel(\''+e+'\')"><i class="fa fa-times-circle"></i></button>'),n.append('<button class="toolBarButtons" title="Send" onclick="ImageEditor_Send(\''+e+'\')"><i class="fa fa-paper-plane"></i></button>'),$("#contact-"+e+"-imagePastePreview").append(n);var i=$("<canvas/>");i.prop("id","contact-"+e+"-imageCanvas"),i.css("border","1px solid #CCCCCC"),$("#contact-"+e+"-imagePastePreview").append(i),console.log("Canvas for ImageEditor created...");var a=t.width,o=t.height,s=$("#contact-"+e+"-imagePastePreview").width()-2,l=480;$("#contact-"+e+"-imageCanvas").prop("width",s),$("#contact-"+e+"-imageCanvas").prop("height",l);var r=1,d=1,c=1;a>s||o>l?(a>s&&(d=s/a),o>l&&(c=l/o,console.log("Scale to fit height: "+c)),r=Math.min(d,c),console.log("Scale down to fit: "+r),a*=r,o*=r,console.log("resizing canvas to fit new image size..."),$("#contact-"+e+"-imageCanvas").prop("width",a),$("#contact-"+e+"-imageCanvas").prop("height",o)):(console.log("Image is able to fit, resizing canvas..."),$("#contact-"+e+"-imageCanvas").prop("width",a),$("#contact-"+e+"-imageCanvas").prop("height",o)),console.log("Creating fabric API...");var u=new fabric.Canvas("contact-"+e+"-imageCanvas");u.id="contact-"+e+"-imageCanvas",u.ToolSelected="None",u.PenColour="rgb(255, 0, 0)",u.PenWidth=2,u.PaintColour="rgba(227, 230, 3, 0.6)",u.PaintWidth=10,u.FillColour="rgb(255, 0, 0)",u.isDrawingMode=!1,u.selectionColor="rgba(112,179,233,0.25)",u.selectionBorderColor="rgba(112,179,233, 0.8)",u.selectionLineWidth=1,u.setZoom(r),u.on("mouse:down",function(e){var t=e.e;"Pan"==this.ToolSelected&&(this.isDragging=!0,this.selection=!1,this.lastPosX=t.clientX,this.lastPosY=t.clientY),null!=e.target&&(!0===t.altKey&&(e.target.lockMovementX=!0),!0===t.shiftKey&&(e.target.lockMovementY=!0),e.target.set({transparentCorners:!1,borderColor:"rgba(112,179,233, 0.4)",cornerColor:"rgba(112,179,233, 0.8)",cornerSize:6}))}),u.on("mouse:move",function(e){if(this.isDragging){var t=e.e;this.viewportTransform[4]+=t.clientX-this.lastPosX,this.viewportTransform[5]+=t.clientY-this.lastPosY,this.requestRenderAll(),this.lastPosX=t.clientX,this.lastPosY=t.clientY}}),u.on("mouse:up",function(e){this.isDragging=!1,this.selection=!0,null!=e.target&&(e.target.lockMovementX=!1,e.target.lockMovementY=!1)}),u.on("mouse:wheel",function(e){var t=e.e.deltaY,n=(u.getPointer(e.e),u.getZoom());n+=t/200,n>10&&(n=10),n<.1&&(n=.1),u.zoomToPoint({x:e.e.offsetX,y:e.e.offsetY},n),e.e.preventDefault(),e.e.stopPropagation()}),u.backgroundImage=new fabric.Image(t),CanvasCollection.push(u),$("#contact-"+e+"-imagePastePreview").keydown(function(t){t=t||window.event;var n=t.keyCode;console.log("Key press on Image Editor ("+e+"): "+n),46==n&&ImageEditor_Clear(e)}),console.log("ImageEditor: "+u.id+" created"),ImageEditor_FreedrawPen(e)}function GetCanvas(e){for(var t=0;t<CanvasCollection.length;t++)try{if(CanvasCollection[t].id==e)return CanvasCollection[t]}catch(e){console.warn("CanvasCollection.id not available")}return null}function RemoveCanvas(e){for(var t=0;t<CanvasCollection.length;t++)try{if(CanvasCollection[t].id==e){console.log("Found Old Canvas, Disposing..."),CanvasCollection[t].clear(),CanvasCollection[t].dispose(),CanvasCollection[t].id="--deleted--",console.log("CanvasCollection.splice("+t+", 1)"),CanvasCollection.splice(t,1);break}}catch(e){}console.log("There are "+CanvasCollection.length+" canvas now.")}function FindSomething(e){$("#contact-"+e+"-search").toggle(),0==$("#contact-"+e+"-search").is(":visible")&&RefreshStream(FindBuddyByIdentity(e)),updateScroll(e)}function TogglePinned(e){var t=FindBuddyByIdentity(e);if(null!=t){t.Pinned?(console.log("Disable Pinned for",e),t.Pinned=!1):(console.log("Enable Pinned for",e),t.Pinned=!0);var n=JSON.parse(localDB.getItem(profileUserID+"-Buddies"));null!=n&&($.each(n.DataCollection,function(n,i){if(i.uID==e||i.cID==e||i.gID==e)return i.Pinned=t.Pinned,!1}),localDB.setItem(profileUserID+"-Buddies",JSON.stringify(n))),UpdateBuddyList()}}function onFileDragDrop(e,t){var n=e.dataTransfer.files;console.log("You are about to upload "+n.length+" file."),$("#contact-"+t+"-ChatHistory").css("outline","none");for(var i=0;i<n.length;i++){var a=n[i],o=new FileReader;o.onload=function(e){a.size<=52428800?SendFileDataMessage(t,e.target.result,a.name,a.size):alert("The file '"+a.name+"' is bigger than 50MB, you cannot upload this file")},console.log("Adding: "+a.name+" of size: "+a.size+"bytes"),o.readAsDataURL(a)}preventDefault(e)}function cancelDragDrop(e,t){$("#contact-"+t+"-ChatHistory").css("outline","none"),preventDefault(e)}function setupDragDrop(e,t){$("#contact-"+t+"-ChatHistory").css("outline","2px dashed #184369"),preventDefault(e)}function preventDefault(e){e.preventDefault(),e.stopPropagation()}function OpenWindow(e,t,n,i,a,o,s,l,r,d,c,u){console.log("Open Window: "+t),null!=windowObj&&(windowObj.dialog("close"),windowObj=null),windowObj=$("<div></div>").html(e).dialog({autoOpen:!1,title:t,modal:!0,width:i,height:n,resizable:o,classes:{"ui-dialog-content":"cleanScroller"},close:function(e,t){$(this).dialog("destroy"),windowObj=null}});var p=[];s&&l&&p.push({text:s,click:function(){console.log("Button 1 ("+s+") Clicked"),l()}}),r&&d&&p.push({text:r,click:function(){console.log("Button 2 ("+r+") Clicked"),d()}}),p.length>=1&&windowObj.dialog("option","buttons",p),u&&windowObj.on("dialogbeforeclose",function(e,t){return u(this)}),c&&windowObj.on("dialogopen",function(e,t){c()}),windowObj.dialog("open"),a&&windowObj.dialog({dialogClass:"no-close"}),$(".ui-dialog-titlebar").dblclick(function(){var e=$(window).outerWidth(),t=$(window).outerHeight();windowObj.parent().css("top","0px"),windowObj.parent().css("left","0px"),windowObj.dialog("option","height",t),windowObj.dialog("option","width",e),UpdateUI()}),UpdateUI()}function CloseWindow(e){console.log("Call to close any open window"),null!=windowObj&&(windowObj.dialog("close"),windowObj=null),1==e&&(null!=confirmObj&&(confirmObj.dialog("close"),confirmObj=null),null!=promptObj&&(promptObj.dialog("close"),promptObj=null),null!=alertObj&&(alertObj.dialog("close"),alertObj=null))}function WindowProgressOn(){}function WindowProgressOff(){}function Alert(e,t,n){if(null!=confirmObj&&(confirmObj.dialog("close"),confirmObj=null),null!=promptObj&&(promptObj.dialog("close"),promptObj=null),null==alertObj){console.log("Alert called with Title: "+t+", saying: "+e);var i="<div class=NoSelect>";i+='<div class=UiText style="padding: 10px" id=AllertMessageText>'+e+"</div>",i+="</div>",alertObj=$("<div>").html(i).dialog({autoOpen:!1,title:t,modal:!0,width:300,height:"auto",resizable:!1,closeOnEscape:!1,close:function(e,t){$(this).dialog("destroy"),alertObj=null}});var a=[];a.push({text:lang.ok,click:function(){console.log("Alert OK clicked"),n&&n(),$(this).dialog("close"),alertObj=null}}),alertObj.dialog("option","buttons",a),alertObj.dialog("open"),alertObj.dialog({dialogClass:"no-close"}),UpdateUI()}else console.error("Alert not null, while Alert called: "+t+", saying:"+e)}function Confirm(e,t,n,i){if(null!=alertObj&&(alertObj.dialog("close"),alertObj=null),null!=promptObj&&(promptObj.dialog("close"),promptObj=null),null==confirmObj){console.log("Confirm called with Title: "+t+", saying: "+e);var a="<div class=NoSelect>";a+='<div class=UiText style="padding: 10px" id=ConfrimMessageText>'+e+"</div>",a+="</div>",confirmObj=$("<div>").html(a).dialog({autoOpen:!1,title:t,modal:!0,width:300,height:"auto",resizable:!1,closeOnEscape:!1,close:function(e,t){$(this).dialog("destroy"),confirmObj=null}});var o=[];o.push({text:lang.ok,click:function(){console.log("Confrim OK clicked"),n&&n(),$(this).dialog("close"),confirmObj=null}}),o.push({text:lang.cancel,click:function(){console.log("Confirm Cancel clicked"),i&&i(),$(this).dialog("close"),confirmObj=null}}),confirmObj.dialog("option","buttons",o),confirmObj.dialog("open"),confirmObj.dialog({dialogClass:"no-close"}),UpdateUI()}else console.error("Confirm not null, while Confrim called with Title: "+t+", saying: "+e)}function Prompt(e,t,n,i,a,o,s,l){if(null!=alertObj&&(alertObj.dialog("close"),alertObj=null),null!=confirmObj&&(confirmObj.dialog("close"),confirmObj=null),null==promptObj){console.log("Prompt called with Title: "+t+", saying: "+e);var r="<div class=NoSelect>";r+='<div class=UiText style="padding: 10px" id=PromptMessageText>',r+=e,r+='<div style="margin-top:10px">'+n+" : </div>",r+='<div style="margin-top:5px"><INPUT id=PromptValueField type='+a+' value="'+i+'" placeholder="'+o+'" style="width:98%"></div>',r+="</div>",r+="</div>",promptObj=$("<div>").html(r).dialog({autoOpen:!1,title:t,modal:!0,width:300,height:"auto",resizable:!1,closeOnEscape:!1,close:function(e,t){$(this).dialog("destroy"),promptObj=null}});var d=[];d.push({text:lang.ok,click:function(){console.log("Prompt OK clicked, with value: "+$("#PromptValueField").val()),s&&s($("#PromptValueField").val()),$(this).dialog("close"),promptObj=null}}),d.push({text:lang.cancel,click:function(){console.log("Prompt Cancel clicked"),l&&l(),$(this).dialog("close"),promptObj=null}}),promptObj.dialog("option","buttons",d),promptObj.dialog("open"),promptObj.dialog({dialogClass:"no-close"}),UpdateUI()}else console.error("Prompt not null, while Prompt called with Title: "+t+", saying: "+e)}function PopupMenu(e,t){console.log("Show Popup Menu"),null!=menuObj&&(menuObj.menu("destroy"),menuObj.empty(),menuObj.remove(),menuObj=null);var n=$(e).offset().left-$(document).scrollLeft(),i=$(e).offset().top-$(document).scrollTop(),a=$(e).outerWidth(),o=$(e).outerHeight();menuObj=$("<ul></ul>"),t&&t.items&&$.each(t.items,function(e,t){var n=1==t.isHeader?' class="ui-widget-header"':"",i=1==t.isDisabled?' class="ui-state-disabled"':"";null!=t.icon?menuObj.append('<li value="'+t.value+'" '+n+" "+i+'><div><span class="'+t.icon+' ui-icon"></span>'+t.text+"</div></li>"):menuObj.append('<li value="'+t.value+'" '+n+" "+i+"><div>"+t.text+"</div></li>")}),menuObj.append("<li><div>-</div></li>"),menuObj.append('<li><div style="text-align:center; padding-right: 2em">'+lang.cancel+"</div></li>"),menuObj.appendTo(document.body),menuObj.menu({}),t&&t.selectEvent&&menuObj.on("menuselect",t.selectEvent),t&&t.createEvent&&menuObj.on("menucreate",t.createEvent),menuObj.on("blur",function(){HidePopup()}),t&&1==t.autoFocus&&menuObj.focus();var s=menuObj.outerWidth(),l=n-(s/2-a/2);l+s+10>window.innerWidth&&(l=window.innerWidth-s-10),l<0&&(l=0),menuObj.css("left",l+"px");var r=menuObj.outerHeight(),d=i+o;d+r+10>window.innerHeight&&(d=window.innerHeight-r-10),d<0&&(d=0),menuObj.css("top",d+"px")}function HidePopup(e){if(e)window.setTimeout(function(){if(null!=menuObj){menuObj.menu("destroy");try{menuObj.empty()}catch(e){}try{menuObj.remove()}catch(e){}menuObj=null}},e);else if(null!=menuObj){menuObj.menu("destroy");try{menuObj.empty()}catch(e){}try{menuObj.remove()}catch(e){}menuObj=null}}function DetectDevices(){navigator.mediaDevices.enumerateDevices().then(function(e){HasVideoDevice=!1,HasAudioDevice=!1,HasSpeakerDevice=!1,AudioinputDevices=[],VideoinputDevices=[],SpeakerDevices=[];for(var t=0;t<e.length;++t)"audioinput"===e[t].kind?(HasAudioDevice=!0,AudioinputDevices.push(e[t])):"audiooutput"===e[t].kind?(HasSpeakerDevice=!0,SpeakerDevices.push(e[t])):"videoinput"===e[t].kind&&(HasVideoDevice=!0,VideoinputDevices.push(e[t]))}).catch(function(e){console.error("Error enumerating devices",e)})}function onStatusChange(e){e==Strophe.Status.CONNECTING?console.log("XMPP is connecting..."):e==Strophe.Status.CONNFAIL?console.warn("XMPP failed to connect."):e==Strophe.Status.DISCONNECTING?console.log("XMPP is disconnecting."):e==Strophe.Status.DISCONNECTED?(console.log("XMPP is disconnected."),window.setTimeout(function(){},5e3)):e==Strophe.Status.CONNECTED?(console.log("XMPP is connected!"),XmppSetMyVcard(),XmppGetBuddies(),XMPP.ping=window.setTimeout(function(){XmppSendPing()},45e3)):console.log("XMPP is: ",Strophe.Status)}function XmppSendPing(){XMPP&&0!=XMPP.connected||reconnectXmpp();var e=$iq({type:"get",id:XMPP.getUniqueId(),to:SipDomain,from:XMPP.jid});e.c("ping",{xmlns:"urn:xmpp:ping"}),XMPP.sendIQ(e,function(e){},function(e){console.warn("Error in Ping",e)},3e4),XMPP.ping=window.setTimeout(function(){XmppSendPing()},45e3)}function XmppSetMyPresence(e,t,n){if(XMPP&&0!=XMPP.connected){console.log("Setting My Own Presence to: "+e+"("+t+")"),""==t&&(t=lang.default_status),$("#regStatus").html('<i class="fa fa-comments"></i> '+t);var i=$pres({id:XMPP.getUniqueId(),from:XMPP.jid});if(i.c("show").t(e),t&&""!=t&&(i.root(),i.c("status").t(t)),1==n){var a=getPicture("profilePicture"),o=a.split(",")[1],s=$.md5(o);i.root(),i.c("x",{xmlns:"vcard-temp:x:update"}),s&&i.c("photo",{},s)}XMPP.sendPresence(i,function(e){},function(e){console.warn("Error in XmppSetMyPresence",e)},3e4)}else console.warn("XMPP not connected")}function onPresenceChange(e){var t=e.getAttribute("from"),n=e.getAttribute("to"),i=(e.getAttribute("subscription"),e.getAttribute("type")?e.getAttribute("type"):"presence"),a="",o="",s="";Strophe.forEachChild(e,"show",function(e){a=e.textContent}),Strophe.forEachChild(e,"status",function(e){o=e.textContent}),Strophe.forEachChild(e,"x",function(e){s=e.getAttribute("xmlns")});var l=Strophe.getBareJidFromJid(t);if(t==n)return!0;var r=FindBuddyByJid(l);return null==r?(console.warn("Buddy Not Found: ",l),!0):"subscribe"==i?(console.log("Presence: "+r.CallerIDName+" requesting subscrption"),XmppConfirmSubscription(r),XmppSendSubscriptionRequest(r),UpdateBuddyList(),!0):"subscribed"==i?(console.log("Presence: "+r.CallerIDName+" confimed subscrption"),UpdateBuddyList(),!0):"unavailable"==i?(console.log("Presence: "+r.CallerIDName+" unavailable"),UpdateBuddyList(),!0):("vcard-temp:x:update"==s&&(console.log("Presence: "+r.ExtNo+" - "+r.CallerIDName+" vCard change"),XmppGetBuddyVcard(r),UpdateBuddyList()),""!=a&&(console.log("Presence: "+r.ExtNo+" - "+r.CallerIDName+" is now: "+a+"("+o+")"),r.presence=a,r.presenceText=""==o?lang.default_status:o,UpdateBuddyList()),!0)}function XmppConfirmSubscription(e){if(XMPP&&0!=XMPP.connected){var t=$pres({to:e.jid,from:XMPP.jid,type:"subscribed"});XMPP.sendPresence(t)}else console.warn("XMPP not connected")}function XmppSendSubscriptionRequest(e){if(XMPP&&0!=XMPP.connected){var t=$pres({to:e.jid,from:XMPP.jid,type:"subscribe"});XMPP.sendPresence(t)}else console.warn("XMPP not connected")}function XmppRemoveBuddyFromRoster(e){if(XMPP&&0!=XMPP.connected){var t=$iq({type:"set",id:XMPP.getUniqueId(),from:XMPP.jid});t.c("query",{xmlns:"jabber:iq:roster"}),t.c("item",{jid:e.jid,subscription:"remove"}),null!=e.jid?(console.log("Removing "+e.CallerIDName+"  from roster..."),XMPP.sendIQ(t,function(e){})):console.warn("Missing JID",e)}else console.warn("XMPP not connected")}function XmppAddBuddyToRoster(e){if(XMPP&&0!=XMPP.connected){var t=$iq({type:"set",id:XMPP.getUniqueId(),from:XMPP.jid});t.c("query",{xmlns:"jabber:iq:roster"}),t.c("item",{jid:e.jid,name:e.CallerIDName}),null!=e.jid?(console.log("Adding "+e.CallerIDName+"  to roster..."),XMPP.sendIQ(t,function(t){XmppGetBuddyVcard(e),XmppSendSubscriptionRequest(e)})):console.warn("Missing JID",e)}else console.warn("XMPP not connected")}function XmppGetBuddies(){if(XMPP&&0!=XMPP.connected){var e=$iq({type:"get",id:XMPP.getUniqueId(),from:XMPP.jid});e.c("query",{xmlns:"jabber:iq:roster"}),console.log("Getting Buddy List (roster)..."),XMPP.sendIQ(e,function(e){Strophe.forEachChild(e,"query",function(e){Strophe.forEachChild(e,"item",function(e){var t=e.getAttribute("jid"),n=e.getAttribute("name"),i=Strophe.getNodeFromJid(t),a=i;""!=XmppRealm&&""!=XmppRealmSeparator&&(a=i.split(XmppRealmSeparator,2)[1]);e.getAttribute("ask")&&e.getAttribute("ask"),e.getAttribute("subscription")&&e.getAttribute("subscription");var o=t.indexOf("@"+XmppChatGroupService+".")>-1,s=FindBuddyByJid(t);null==s?(1==o?(console.log("Adding roster (group):",a,"-",n),s=MakeBuddy("group",!1,!1,!1,n,a,t,!1,a,!1)):(console.log("Adding roster (xmpp):",a,"-",n),s=MakeBuddy("xmpp",!1,!1,!0,n,a,t,!1,a,!1)),XmppGetBuddyVcard(s)):(console.log("Existing roster item:",a,"-",n),XmppGetBuddyVcard(s))})}),XmppSetMyPresence(getDbItem("XmppLastPresence","chat"),getDbItem("XmppLastStatus",""),!0),UpdateBuddyList()},function(e){console.warn("Error Getting Roster",e)},3e4)}else console.warn("XMPP not connected")}function onBuddySetRequest(e){return console.log("onBuddySetRequest",e),!0}function onBuddyUpdate(e){return!0}function RefreshBuddyData(e){}function XmppGetMyVcard(){if(XMPP&&0!=XMPP.connected){var e=$iq({type:"get",id:XMPP.getUniqueId(),from:XMPP.jid});e.c("vCard",{xmlns:"vcard-temp"}),XMPP.sendIQ(e,function(e){console.log("XmppGetMyVcard Response: ",e)},function(e){console.warn("Error in XmppGetMyVcard",e)},3e4)}else console.warn("XMPP not connected")}function XmppSetMyVcard(){if(XMPP&&0!=XMPP.connected){var e=getDbItem("profileVcard",null);if(null!=e&&""!=e){e=JSON.parse(e);var t=getPicture("profilePicture"),n=t.split(",")[1],i=$iq({type:"set",id:XMPP.getUniqueId(),from:XMPP.jid});i.c("vCard",{xmlns:"vcard-temp"}),i.c("FN",{},profileName),i.c("TITLE",{},e.TitleDesc),i.c("TEL"),i.c("NUMBER",{},profileUser),i.up(),i.c("TEL"),i.c("CELL",{},e.Mobile),i.up(),i.c("TEL"),i.c("VOICE",{},e.Number1),i.up(),i.c("TEL"),i.c("FAX",{},e.Number2),i.up(),i.c("EMAIL"),i.c("USERID",{},e.Email),i.up(),i.c("PHOTO"),i.c("TYPE",{},"image/png"),i.c("BINVAL",{},n),i.up(),i.c("JABBERID",{},Strophe.getBareJidFromJid(XMPP.jid)),console.log("Sending vCard update"),XMPP.sendIQ(i,function(e){},function(e){console.warn("Error in XmppSetMyVcard",e)},3e4)}else console.warn("No vCard created yet")}else console.warn("XMPP not connected")}function XmppGetBuddyVcard(e){if(XMPP&&0!=XMPP.connected){if(null!=e&&null!=e.jid){var t=$iq({type:"get",id:XMPP.getUniqueId(),from:XMPP.jid,to:e.jid});t.c("vCard",{xmlns:"vcard-temp"}),XMPP.sendIQ(t,function(e){var t=e.getAttribute("from");console.log("Got vCard for: "+t);var n=FindBuddyByJid(t);if(null!=n){var i="";Strophe.forEachChild(e,"vCard",function(e){Strophe.forEachChild(e,null,function(e){"FN"==e.tagName&&(n.CallerIDName=e.textContent),"TITLE"==e.tagName&&(n.Desc=e.textContent),"JABBERID"==e.tagName&&e.textContent!=t&&console.warn("JID does not match: ",e.textContent,t),"TEL"==e.tagName&&(Strophe.forEachChild(e,"NUMBER",function(e){e.textContent!=n.ExtNo&&console.warn("Subscribe Extension does not match: ",e.textContent,n.ExtNo)}),Strophe.forEachChild(e,"CELL",function(e){n.MobileNumber=e.textContent}),Strophe.forEachChild(e,"VOICE",function(e){n.ContactNumber1=e.textContent}),Strophe.forEachChild(e,"FAX",function(e){n.ContactNumber2=e.textContent})),"EMAIL"==e.tagName&&Strophe.forEachChild(e,"USERID",function(e){n.Email=e.textContent}),"PHOTO"==e.tagName&&Strophe.forEachChild(e,"BINVAL",function(e){i="data:image/png;base64,"+e.textContent})})});var a={},o=-1,s=JSON.parse(localDB.getItem(profileUserID+"-Buddies"));$.each(s.DataCollection,function(e,t){if(t.uID==n.identity)return a=t,o=e,!1}),-1!=o&&(a.MobileNumber=n.MobileNumber,a.ContactNumber1=n.ContactNumber1,a.ContactNumber2=n.ContactNumber2,a.DisplayName=n.CallerIDName,a.Description=n.Desc,a.Email=n.Email,s.DataCollection[o]=a,localDB.setItem(profileUserID+"-Buddies",JSON.stringify(s))),""!=i&&(console.log("Buddy: "+n.CallerIDName+" picture updated"),localDB.setItem("img-"+n.identity+"-"+n.type,i),$("#contact-"+n.identity+"-picture-main").css("background-image","url("+getPicture(n.identity,n.type,!0)+")")),UpdateBuddyList()}else console.warn("Received a vCard for non-existing buddy",t)},function(e){console.warn("Error in XmppGetBuddyVcard",e)},3e4)}}else console.warn("XMPP not connected")}function onMessage(e){var t=e.getAttribute("from"),n=Strophe.getBareJidFromJid(t),i=(e.getAttribute("to"),e.getAttribute("id")),a=FindBuddyByJid(n);if(null==a)return console.warn("Spam!"),!0;var o=!1,s=utcDateNow();Strophe.forEachChild(e,"delay",function(e){"urn:xmpp:delay"==e.getAttribute("xmlns")&&(o=!0,s=moment(e.getAttribute("stamp")).utc().format("YYYY-MM-DD HH:mm:ss UTC"))});var l="";Strophe.forEachChild(e,"body",function(e){l=e.textContent});var r="";if(Strophe.forEachChild(e,"composing",function(e){"http://jabber.org/protocol/chatstates"==e.getAttribute("xmlns")&&(r="composing")}),Strophe.forEachChild(e,"paused",function(e){"http://jabber.org/protocol/chatstates"==e.getAttribute("xmlns")&&(r="paused")}),Strophe.forEachChild(e,"active",function(e){"http://jabber.org/protocol/chatstates"==e.getAttribute("xmlns")&&(r="active")}),"composing"==r)return o||XmppShowComposing(a),!0;XmppHideComposing(a);var d=!1,c="";Strophe.forEachChild(e,"replace",function(e){"urn:xmpp:message-correct:0"==e.getAttribute("xmlns")&&(d=!0,Strophe.forEachChild(e,"id",function(e){c=e.textContent}))}),d&&""!=c&&(console.log("Message "+c+" for "+a.CallerIDName+" was corrected"),CorrectMessage(a,c,l));var u="",p="";if(Strophe.forEachChild(e,"x",function(e){"jabber:x:event"==e.getAttribute("xmlns")&&(Strophe.forEachChild(e,"delivered",function(e){u="delivered"}),Strophe.forEachChild(e,"displayed",function(e){u="displayed"}),Strophe.forEachChild(e,"id",function(e){p=e.textContent}))}),"delivered"==u&&""!=p)return console.log("Message "+p+" for "+a.CallerIDName+" was delivered"),MarkDeliveryReceipt(a,p,!0),!0;if("displayed"==u&&""!=p)return console.log("Message "+p+" for "+a.CallerIDName+" was displayed"),MarkDisplayReceipt(a,p,!0),!0;if(""==l);else if(i){XmppSendDeliveryReceipt(a,i),AddMessageToStream(a,i,"MSG",l,s),UpdateBuddyActivity(a.identity);var g=$("#stream-"+a.identity).is(":visible");g&&(MarkMessageRead(a,i),XmppSendDisplayReceipt(a,i)),RefreshStream(a),ActivateStream(a,l)}else console.warn("Sorry, messages must have an id ",e);return!0}function XmppShowComposing(e){console.log("Buddy is composing a message..."),$("#contact-"+e.identity+"-chatstate").show(),$("#contact-"+e.identity+"-presence").hide(),$("#contact-"+e.identity+"-presence-main").hide(),$("#contact-"+e.identity+"-chatstate-menu").show(),$("#contact-"+e.identity+"-chatstate-main").show(),updateScroll(e.identity)}function XmppHideComposing(e){console.log("Buddy composing is done..."),$("#contact-"+e.identity+"-chatstate").hide(),$("#contact-"+e.identity+"-chatstate-menu").hide(),$("#contact-"+e.identity+"-chatstate-main").hide(),$("#contact-"+e.identity+"-presence").show(),$("#contact-"+e.identity+"-presence-main").show(),updateScroll(e.identity)}function XmppSendMessage(e,t,n,i,a,o){if(XMPP&&0!=XMPP.connected){o||(o="normal");var s=$msg({to:e.jid,type:o,id:n,from:XMPP.jid});i&&""!=i&&(s.c("thread").t(i),s.up()),s.c("body").t(t),s.up(),s.c("active",{xmlns:"http://jabber.org/protocol/chatstates"}),s.up(),s.c("x",{xmlns:"jabber:x:event"}),s.c("delivered"),s.up(),s.c("displayed"),console.log("sending message..."),e.chatstate="active",e.chatstateTimeout&&window.clearTimeout(e.chatstateTimeout),e.chatstateTimeout=null;try{XMPP.send(s),MarkMessageSent(e,n,!1)}catch(t){MarkMessageNotSent(e,n,!1)}}else console.warn("XMPP not connected")}function XmppStartComposing(e,t){if(XMPP&&0!=XMPP.connected){if(null!=e.jid&&""!=e.jid&&(e.chatstateTimeout&&window.clearTimeout(e.chatstateTimeout),e.chatstateTimeout=window.setTimeout(function(){XmppPauseComposing(e,t)},1e4),!e.chatstate||"composing"!=e.chatstate)){var n=$msg({to:e.jid,from:XMPP.jid});t&&""!=t&&(n.c("thread").t(t),n.up()),n.c("composing",{xmlns:"http://jabber.org/protocol/chatstates"}),console.log("you are composing a message..."),e.chatstate="composing",XMPP.send(n)}}else console.warn("XMPP not connected")}function XmppPauseComposing(e,t){if(XMPP&&0!=XMPP.connected){if(null!=e.jid&&""!=e.jid&&(!e.chatstate||"paused"!=e.chatstate)){var n=$msg({to:e.jid,from:XMPP.jid});t&&""!=t&&(n.c("thread").t(t),n.up()),n.c("paused",{xmlns:"http://jabber.org/protocol/chatstates"}),console.log("You have paused your message..."),e.chatstate="paused",e.chatstateTimeout&&window.clearTimeout(e.chatstateTimeout),e.chatstateTimeout=null,XMPP.send(n)}}else console.warn("XMPP not connected")}function XmppSendDeliveryReceipt(e,t){if(XMPP&&0!=XMPP.connected){var n=$msg({to:e.jid,from:XMPP.jid});n.c("x",{xmlns:"jabber:x:event"}),n.c("delivered"),n.up(),n.c("id").t(t),console.log("sending delivery notice for "+t+"..."),XMPP.send(n)}else console.warn("XMPP not connected")}function XmppSendDisplayReceipt(e,t){if(XMPP&&0!=XMPP.connected){var n=$msg({to:e.jid,from:XMPP.jid});n.c("x",{xmlns:"jabber:x:event"}),n.c("displayed"),n.up(),n.c("id").t(t),console.log("sending display notice for "+t+"..."),XMPP.send(n)}else console.warn("XMPP not connected")}function onPingRequest(e){var t=e.getAttribute("id"),n=e.getAttribute("to"),i=e.getAttribute("from"),a=$iq({type:"result",id:t,to:i,from:n});return XMPP.send(a),!0}function onVersionRequest(e){var t=e.getAttribute("id"),n=e.getAttribute("to"),i=e.getAttribute("from"),a=$iq({type:"result",id:t,to:i,from:n});return a.c("query",{xmlns:"jabber:iq:version"}),a.c("name",null,"Browser Phone"),a.c("version",null,"0.0.1"),a.c("os",null,"Browser"),XMPP.send(a),!0}function onInfoQuery(e){return console.log("onInfoQuery",e),!0}function onInfoQueryRequest(e){console.log("onInfoQueryRequest",e);var t="";return Strophe.forEachChild(e,"query",function(e){t=e.getAttribute("xmlns")}),console.log(t),!0}function onInfoQueryCommand(e){console.log("onInfoQueryCommand",e);var t="";return Strophe.forEachChild(e,"query",function(e){t=e.getAttribute("xmlns")}),console.log(t),!0}function XMPP_GetGroups(){var e=$iq({type:"get",id:XMPP.getUniqueId(),to:XmppChatGroupService+"."+SipDomain,from:XMPP.jid});e.c("query",{xmlns:"http://jabber.org/protocol/disco#items",node:"http://jabber.org/protocol/muc#rooms"}),XMPP.sendIQ(e,function(e){console.log("GetGroups Response: ",e)},function(e){console.warn("Error in GetGroups",e)},3e4)}function XMPP_GetGroupMembers(){var e=$iq({type:"get",id:XMPP.getUniqueId(),to:"directors@"+XmppChatGroupService+"."+SipDomain,from:XMPP.jid});e.c("query",{xmlns:"http://jabber.org/protocol/disco#items"}),XMPP.sendIQ(e,function(e){console.log("GetGroupMembers Response: ",e)},function(e){console.warn("Error in GetGroupMembers",e)},3e4)}function XMPP_JoinGroup(){var e=$pres({id:XMPP.getUniqueId(),from:XMPP.jid,to:"directors@"+XmppChatGroupService+"."+SipDomain+"/nickname"});e.c("x",{xmlns:"http://jabber.org/protocol/muc"}),XMPP.sendPresence(e,function(e){console.log("JoinGroup Response: ",e)},function(e){console.warn("Error in Set Presence",e)},3e4)}function XMPP_QueryMix(){var e=$iq({type:"get",id:XMPP.getUniqueId(),from:XMPP.jid});e.c("query",{xmlns:"http://jabber.org/protocol/disco#info"}),XMPP.sendIQ(e,function(e){console.log("XMPP_QueryMix Response: ",e)},function(e){console.warn("Error in XMPP_QueryMix",e)},3e4)}const appversion="0.3.17",sipjsversion="0.20.0",navUserAgent=window.navigator.userAgent;let welcomeScreen='<div class="UiWindowField"><pre style="font-size: 12px">';welcomeScreen+="===========================================================================\n",welcomeScreen+="Copyright  2020 - All Rights Reserved\n",welcomeScreen+="===========================================================================\n",welcomeScreen+="\n",welcomeScreen+="                            NO WARRANTY\n",welcomeScreen+="\n",welcomeScreen+="BECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY\n",welcomeScreen+="FOR THE PROGRAM, TO THE EXTENT PERMITTED BY APPLICABLE LAW.  EXCEPT WHEN\n",welcomeScreen+="OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES\n",welcomeScreen+='PROVIDE THE PROGRAM "AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED\n',welcomeScreen+="OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF\n",welcomeScreen+="MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  THE ENTIRE RISK AS\n",welcomeScreen+="TO THE QUALITY AND PERFORMANCE OF THE PROGRAM IS WITH YOU.  SHOULD THE\n",welcomeScreen+="PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING,\n",welcomeScreen+="REPAIR OR CORRECTION.\n",welcomeScreen+="\n",welcomeScreen+="IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING\n",welcomeScreen+="WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR\n",welcomeScreen+="REDISTRIBUTE THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES,\n",welcomeScreen+="INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING\n",welcomeScreen+="OUT OF THE USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED\n",welcomeScreen+="TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY\n",welcomeScreen+="YOU OR THIRD PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER\n",welcomeScreen+="PROGRAMS), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE\n",welcomeScreen+="POSSIBILITY OF SUCH DAMAGES.\n",welcomeScreen+="\n",welcomeScreen+="============================================================================\n</pre>",welcomeScreen+="</div>";let loadAlternateLang="1"==getDbItem("loadAlternateLang","0");const availableLang=["ja","zh-hans","zh","ru","tr","nl","es","de","pl","pt-br"],avatars=["avatars/default.0.png","avatars/default.1.png","avatars/default.2.png","avatars/default.3.png","avatars/default.4.png","avatars/default.5.png","avatars/default.6.png","avatars/default.7.png","avatars/default.8.png"],wallpaperLight="wallpaper.light.png",wallpaperDark="wallpaper.dark.png"
;let profileUserID=getDbItem("profileUserID",null),profileName=getDbItem("profileName",null),wssServer=getDbItem("wssServer",null),WebSocketPort=getDbItem("WebSocketPort",null),ServerPath=getDbItem("ServerPath",null),SipDomain=getDbItem("SipDomain",null),SipUsername=getDbItem("SipUsername",null),SipPassword=getDbItem("SipPassword",null),SingleInstance="1"==getDbItem("SingleInstance","1"),TransportConnectionTimeout=parseInt(getDbItem("TransportConnectionTimeout",15)),TransportReconnectionAttempts=parseInt(getDbItem("TransportReconnectionAttempts",999)),TransportReconnectionTimeout=parseInt(getDbItem("TransportReconnectionTimeout",3)),SubscribeToYourself="1"==getDbItem("SubscribeToYourself","0"),VoiceMailSubscribe="1"==getDbItem("VoiceMailSubscribe","1"),VoicemailDid=getDbItem("VoicemailDid",""),SubscribeVoicemailExpires=parseInt(getDbItem("SubscribeVoicemailExpires",300)),ContactUserName=getDbItem("ContactUserName",""),userAgentStr=getDbItem("UserAgentStr","Browser Phone "+appversion+" (SIPJS - "+sipjsversion+") "+navUserAgent),hostingPrefix=getDbItem("HostingPrefix",""),RegisterExpires=parseInt(getDbItem("RegisterExpires",300)),RegisterExtraHeaders=getDbItem("RegisterExtraHeaders","{}"),RegisterExtraContactParams=getDbItem("RegisterExtraContactParams","{}"),RegisterContactParams=getDbItem("RegisterContactParams","{}"),WssInTransport="1"==getDbItem("WssInTransport","1"),IpInContact="1"==getDbItem("IpInContact","1"),BundlePolicy=getDbItem("BundlePolicy","balanced"),IceStunServerJson=getDbItem("IceStunServerJson",""),IceStunCheckTimeout=parseInt(getDbItem("IceStunCheckTimeout",500)),SubscribeBuddyAccept=getDbItem("SubscribeBuddyAccept","application/pidf+xml"),SubscribeBuddyEvent=getDbItem("SubscribeBuddyEvent","presence"),SubscribeBuddyExpires=parseInt(getDbItem("SubscribeBuddyExpires",300)),NoAnswerTimeout=parseInt(getDbItem("NoAnswerTimeout",120)),AutoAnswerEnabled="1"==getDbItem("AutoAnswerEnabled","0"),DoNotDisturbEnabled="1"==getDbItem("DoNotDisturbEnabled","0"),CallWaitingEnabled="1"==getDbItem("CallWaitingEnabled","1"),RecordAllCalls="1"==getDbItem("RecordAllCalls","0"),StartVideoFullScreen="1"==getDbItem("StartVideoFullScreen","1"),SelectRingingLine="1"==getDbItem("SelectRingingLine","1"),UiMaxWidth=parseInt(getDbItem("UiMaxWidth",1240)),UiThemeStyle=getDbItem("UiThemeStyle","system"),UiMessageLayout=getDbItem("UiMessageLayout","middle"),UiCustomConfigMenu="1"==getDbItem("UiCustomConfigMenu","0"),UiCustomDialButton="1"==getDbItem("UiCustomDialButton","0"),UiCustomSortAndFilterButton="1"==getDbItem("UiCustomSortAndFilterButton","0"),UiCustomAddBuddy="1"==getDbItem("UiCustomAddBuddy","0"),UiCustomEditBuddy="1"==getDbItem("UiCustomEditBuddy","0"),UiCustomMediaSettings="1"==getDbItem("UiCustomMediaSettings","0"),UiCustomMessageAction="1"==getDbItem("UiCustomMessageAction","0"),AutoGainControl="1"==getDbItem("AutoGainControl","1"),EchoCancellation="1"==getDbItem("EchoCancellation","1"),NoiseSuppression="1"==getDbItem("NoiseSuppression","1"),MirrorVideo=getDbItem("VideoOrientation","rotateY(180deg)"),maxFrameRate=getDbItem("FrameRate",""),videoHeight=getDbItem("VideoHeight",""),MaxVideoBandwidth=parseInt(getDbItem("MaxVideoBandwidth","2048")),videoAspectRatio=getDbItem("AspectRatio","1.33"),NotificationsActive="1"==getDbItem("Notifications","0"),StreamBuffer=parseInt(getDbItem("StreamBuffer",50)),MaxDataStoreDays=parseInt(getDbItem("MaxDataStoreDays",0)),PosterJpegQuality=parseFloat(getDbItem("PosterJpegQuality",.6)),VideoResampleSize=getDbItem("VideoResampleSize","HD"),RecordingVideoSize=getDbItem("RecordingVideoSize","HD"),RecordingVideoFps=parseInt(getDbItem("RecordingVideoFps",12)),RecordingLayout=getDbItem("RecordingLayout","them-pnp"),DidLength=parseInt(getDbItem("DidLength",6)),MaxDidLength=parseInt(getDbItem("MaxDidLength",16)),DisplayDateFormat=getDbItem("DateFormat","YYYY-MM-DD"),DisplayTimeFormat=getDbItem("TimeFormat","h:mm:ss A"),Language=getDbItem("Language","auto"),BuddySortBy=getDbItem("BuddySortBy","activity"),SortByTypeOrder=getDbItem("SortByTypeOrder","e|x|c"),BuddyAutoDeleteAtEnd="1"==getDbItem("BuddyAutoDeleteAtEnd","0"),HideAutoDeleteBuddies="1"==getDbItem("HideAutoDeleteBuddies","0"),BuddyShowExtenNum="1"==getDbItem("BuddyShowExtenNum","0"),EnableTextMessaging="1"==getDbItem("EnableTextMessaging","1"),DisableFreeDial="1"==getDbItem("DisableFreeDial","0"),DisableBuddies="1"==getDbItem("DisableBuddies","0"),EnableTransfer="1"==getDbItem("EnableTransfer","1"),EnableConference="1"==getDbItem("EnableConference","1"),AutoAnswerPolicy=getDbItem("AutoAnswerPolicy","allow"),DoNotDisturbPolicy=getDbItem("DoNotDisturbPolicy","allow"),CallWaitingPolicy=getDbItem("CallWaitingPolicy","allow"),CallRecordingPolicy=getDbItem("CallRecordingPolicy","allow"),IntercomPolicy=getDbItem("IntercomPolicy","enabled"),EnableAccountSettings="1"==getDbItem("EnableAccountSettings","1"),EnableAppearanceSettings="1"==getDbItem("EnableAppearanceSettings","1"),EnableNotificationSettings="1"==getDbItem("EnableNotificationSettings","1"),EnableAlphanumericDial="1"==getDbItem("EnableAlphanumericDial","0"),EnableVideoCalling="1"==getDbItem("EnableVideoCalling","1"),EnableTextExpressions="1"==getDbItem("EnableTextExpressions","1"),EnableTextDictate="1"==getDbItem("EnableTextDictate","1"),EnableRingtone="1"==getDbItem("EnableRingtone","1"),MaxBuddies=parseInt(getDbItem("MaxBuddies",999)),MaxBuddyAge=parseInt(getDbItem("MaxBuddyAge",365)),AutoDeleteDefault="1"==getDbItem("AutoDeleteDefault","1"),ChatEngine=getDbItem("ChatEngine","SIMPLE"),XmppServer=getDbItem("XmppServer",""),XmppWebsocketPort=getDbItem("XmppWebsocketPort",""),XmppWebsocketPath=getDbItem("XmppWebsocketPath",""),profileUser=getDbItem("profileUser",null),XmppRealm=getDbItem("XmppRealm",""),XmppRealmSeparator=getDbItem("XmppRealmSeparator","-"),XmppChatGroupService=getDbItem("XmppChatGroupService","conference"),EnableSendFiles=!1,EnableSendImages=!1,EnableAudioRecording=!1,EnableVideoRecording=!1,EnableSms=!1,EnableFax=!1,EnableEmail=!1;const instanceID=String(Date.now());let localDB=window.localStorage,userAgent=null,CanvasCollection=[],Buddies=[],selectedBuddy=null,selectedLine=null,windowObj=null,alertObj=null,confirmObj=null,promptObj=null,menuObj=null,HasVideoDevice=!1,HasAudioDevice=!1,HasSpeakerDevice=!1,AudioinputDevices=[],VideoinputDevices=[],SpeakerDevices=[],Lines=[],lang={},audioBlobs={},newLineNumber=1,telNumericRegEx=/[^\d\*\#\+]/g,telAlphanumericRegEx=/[^\da-zA-Z\*\#\+\-\_\.\!\~\'\(\)]/g;$(window).on("beforeunload",function(){Unregister(!0),XMPP&&XMPP.disconnect("")}),$(window).on("resize",function(){UpdateUI()}),$(window).on("offline",function(){console.warn("Offline!"),$("#regStatus").html(lang.disconnected_from_web_socket),$("#WebRtcFailed").show(),console.log("Disconnect Transport...");try{userAgent.transport.disconnect()}catch(e){}}),$(window).on("online",function(){console.log("Online!"),ReconnectTransport()}),$(document).ready(function(){var e="undefined"!=typeof phoneOptions?phoneOptions:{};void 0!==e.welcomeScreen&&(welcomeScreen=e.welcomeScreen),void 0!==e.loadAlternateLang&&(loadAlternateLang=e.loadAlternateLang),void 0!==e.profileName&&(profileName=e.profileName),void 0!==e.wssServer&&(wssServer=e.wssServer),void 0!==e.WebSocketPort&&(WebSocketPort=e.WebSocketPort),void 0!==e.ServerPath&&(ServerPath=e.ServerPath),void 0!==e.SipDomain&&(SipDomain=e.SipDomain),void 0!==e.SipUsername&&(SipUsername=e.SipUsername),void 0!==e.SipPassword&&(SipPassword=e.SipPassword),void 0!==e.SingleInstance&&(SingleInstance=e.SingleInstance),void 0!==e.TransportConnectionTimeout&&(TransportConnectionTimeout=e.TransportConnectionTimeout),void 0!==e.TransportReconnectionAttempts&&(TransportReconnectionAttempts=e.TransportReconnectionAttempts),void 0!==e.TransportReconnectionTimeout&&(TransportReconnectionTimeout=e.TransportReconnectionTimeout),void 0!==e.SubscribeToYourself&&(SubscribeToYourself=e.SubscribeToYourself),void 0!==e.VoiceMailSubscribe&&(VoiceMailSubscribe=e.VoiceMailSubscribe),void 0!==e.VoicemailDid&&(VoicemailDid=e.VoicemailDid),void 0!==e.SubscribeVoicemailExpires&&(SubscribeVoicemailExpires=e.SubscribeVoicemailExpires),void 0!==e.ContactUserName&&(ContactUserName=e.ContactUserName),void 0!==e.userAgentStr&&(userAgentStr=e.userAgentStr),void 0!==e.hostingPrefix&&(hostingPrefix=e.hostingPrefix),void 0!==e.RegisterExpires&&(RegisterExpires=e.RegisterExpires),void 0!==e.RegisterExtraHeaders&&(RegisterExtraHeaders=e.RegisterExtraHeaders),void 0!==e.RegisterExtraContactParams&&(RegisterExtraContactParams=e.RegisterExtraContactParams),void 0!==e.RegisterContactParams&&(RegisterContactParams=e.RegisterContactParams),void 0!==e.WssInTransport&&(WssInTransport=e.WssInTransport),void 0!==e.IpInContact&&(IpInContact=e.IpInContact),void 0!==e.BundlePolicy&&(BundlePolicy=e.BundlePolicy),void 0!==e.IceStunServerJson&&(IceStunServerJson=e.IceStunServerJson),void 0!==e.IceStunCheckTimeout&&(IceStunCheckTimeout=e.IceStunCheckTimeout),void 0!==e.SubscribeBuddyAccept&&(SubscribeBuddyAccept=e.SubscribeBuddyAccept),void 0!==e.SubscribeBuddyEvent&&(SubscribeBuddyEvent=e.SubscribeBuddyEvent),void 0!==e.SubscribeBuddyExpires&&(SubscribeBuddyExpires=e.SubscribeBuddyExpires),void 0!==e.NoAnswerTimeout&&(NoAnswerTimeout=e.NoAnswerTimeout),void 0!==e.AutoAnswerEnabled&&(AutoAnswerEnabled=e.AutoAnswerEnabled),void 0!==e.DoNotDisturbEnabled&&(DoNotDisturbEnabled=e.DoNotDisturbEnabled),void 0!==e.CallWaitingEnabled&&(CallWaitingEnabled=e.CallWaitingEnabled),void 0!==e.RecordAllCalls&&(RecordAllCalls=e.RecordAllCalls),void 0!==e.StartVideoFullScreen&&(StartVideoFullScreen=e.StartVideoFullScreen),void 0!==e.SelectRingingLine&&(SelectRingingLine=e.SelectRingingLine),void 0!==e.UiMaxWidth&&(UiMaxWidth=e.UiMaxWidth),void 0!==e.UiThemeStyle&&(UiThemeStyle=e.UiThemeStyle),void 0!==e.UiMessageLayout&&(UiMessageLayout=e.UiMessageLayout),void 0!==e.UiCustomConfigMenu&&(UiCustomConfigMenu=e.UiCustomConfigMenu),void 0!==e.UiCustomDialButton&&(UiCustomDialButton=e.UiCustomDialButton),void 0!==e.UiCustomSortAndFilterButton&&(UiCustomSortAndFilterButton=e.UiCustomSortAndFilterButton),void 0!==e.UiCustomAddBuddy&&(UiCustomAddBuddy=e.UiCustomAddBuddy),void 0!==e.UiCustomEditBuddy&&(UiCustomEditBuddy=e.UiCustomEditBuddy),void 0!==e.UiCustomMediaSettings&&(UiCustomMediaSettings=e.UiCustomMediaSettings),void 0!==e.UiCustomMessageAction&&(UiCustomMessageAction=e.UiCustomMessageAction),void 0!==e.AutoGainControl&&(AutoGainControl=e.AutoGainControl),void 0!==e.EchoCancellation&&(EchoCancellation=e.EchoCancellation),void 0!==e.NoiseSuppression&&(NoiseSuppression=e.NoiseSuppression),void 0!==e.MirrorVideo&&(MirrorVideo=e.MirrorVideo),void 0!==e.maxFrameRate&&(maxFrameRate=e.maxFrameRate),void 0!==e.videoHeight&&(videoHeight=e.videoHeight),void 0!==e.MaxVideoBandwidth&&(MaxVideoBandwidth=e.MaxVideoBandwidth),void 0!==e.videoAspectRatio&&(videoAspectRatio=e.videoAspectRatio),void 0!==e.NotificationsActive&&(NotificationsActive=e.NotificationsActive),void 0!==e.StreamBuffer&&(StreamBuffer=e.StreamBuffer),void 0!==e.PosterJpegQuality&&(PosterJpegQuality=e.PosterJpegQuality),void 0!==e.VideoResampleSize&&(VideoResampleSize=e.VideoResampleSize),void 0!==e.RecordingVideoSize&&(RecordingVideoSize=e.RecordingVideoSize),void 0!==e.RecordingVideoFps&&(RecordingVideoFps=e.RecordingVideoFps),void 0!==e.RecordingLayout&&(RecordingLayout=e.RecordingLayout),void 0!==e.DidLength&&(DidLength=e.DidLength),void 0!==e.MaxDidLength&&(MaxDidLength=e.MaxDidLength),void 0!==e.DisplayDateFormat&&(DisplayDateFormat=e.DisplayDateFormat),void 0!==e.DisplayTimeFormat&&(DisplayTimeFormat=e.DisplayTimeFormat),void 0!==e.Language&&(Language=e.Language),void 0!==e.BuddySortBy&&(BuddySortBy=e.BuddySortBy),void 0!==e.SortByTypeOrder&&(SortByTypeOrder=e.SortByTypeOrder),void 0!==e.BuddyAutoDeleteAtEnd&&(BuddyAutoDeleteAtEnd=e.BuddyAutoDeleteAtEnd),void 0!==e.HideAutoDeleteBuddies&&(HideAutoDeleteBuddies=e.HideAutoDeleteBuddies),void 0!==e.BuddyShowExtenNum&&(BuddyShowExtenNum=e.BuddyShowExtenNum),void 0!==e.EnableTextMessaging&&(EnableTextMessaging=e.EnableTextMessaging),void 0!==e.DisableFreeDial&&(DisableFreeDial=e.DisableFreeDial),void 0!==e.DisableBuddies&&(DisableBuddies=e.DisableBuddies),void 0!==e.EnableTransfer&&(EnableTransfer=e.EnableTransfer),void 0!==e.EnableConference&&(EnableConference=e.EnableConference),void 0!==e.AutoAnswerPolicy&&(AutoAnswerPolicy=e.AutoAnswerPolicy),void 0!==e.DoNotDisturbPolicy&&(DoNotDisturbPolicy=e.DoNotDisturbPolicy),void 0!==e.CallWaitingPolicy&&(CallWaitingPolicy=e.CallWaitingPolicy),void 0!==e.CallRecordingPolicy&&(CallRecordingPolicy=e.CallRecordingPolicy),void 0!==e.IntercomPolicy&&(IntercomPolicy=e.IntercomPolicy),void 0!==e.EnableAccountSettings&&(EnableAccountSettings=e.EnableAccountSettings),void 0!==e.EnableAppearanceSettings&&(EnableAppearanceSettings=e.EnableAppearanceSettings),void 0!==e.EnableNotificationSettings&&(EnableNotificationSettings=e.EnableNotificationSettings),void 0!==e.EnableAlphanumericDial&&(EnableAlphanumericDial=e.EnableAlphanumericDial),void 0!==e.EnableVideoCalling&&(EnableVideoCalling=e.EnableVideoCalling),void 0!==e.EnableTextExpressions&&(EnableTextExpressions=e.EnableTextExpressions),void 0!==e.EnableTextDictate&&(EnableTextDictate=e.EnableTextDictate),void 0!==e.EnableRingtone&&(EnableRingtone=e.EnableRingtone),void 0!==e.MaxBuddies&&(MaxBuddies=e.MaxBuddies),void 0!==e.MaxBuddyAge&&(MaxBuddyAge=e.MaxBuddyAge),void 0!==e.ChatEngine&&(ChatEngine=e.ChatEngine),void 0!==e.XmppServer&&(XmppServer=e.XmppServer),void 0!==e.XmppWebsocketPort&&(XmppWebsocketPort=e.XmppWebsocketPort),void 0!==e.XmppWebsocketPath&&(XmppWebsocketPath=e.XmppWebsocketPath),void 0!==e.profileUser&&(profileUser=e.profileUser),void 0!==e.XmppRealm&&(XmppRealm=e.XmppRealm),void 0!==e.XmppRealmSeparator&&(XmppRealmSeparator=e.XmppRealmSeparator),void 0!==e.XmppChatGroupService&&(XmppChatGroupService=e.XmppChatGroupService),console.log("Runtime options",e),1==SingleInstance&&(console.log("Instance ID :",instanceID),localDB.setItem("InstanceId",instanceID),window.addEventListener("storage",onLocalStorageEvent,!1)),$.getJSON(hostingPrefix+"lang/en.json",function(e){if(lang=e,console.log("English Language Pack loaded: ",lang),1==loadAlternateLang){var t=GetAlternateLanguage();""!=t?(console.log("Loading Alternate Language Pack: ",t),$.getJSON(hostingPrefix+"lang/"+t+".json",function(e){lang=e}).always(function(){console.log("Alternate Language Pack loaded: ",lang),InitUi()})):(console.log("No Alternate Language Found."),InitUi())}else InitUi()})}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(e){console.log(`Changed system Theme to: ${e.matches?"dark":"light"} mode`),ApplyThemeColor()});class SoundMeter{constructor(e,t){var n=null;try{window.AudioContext=window.AudioContext||window.webkitAudioContext,n=new AudioContext}catch(e){console.warn("AudioContext() LocalAudio not available... its fine.")}if(null==n)return null;this.context=n,this.source=null,this.lineNum=t,this.sessionId=e,this.captureInterval=null,this.levelsInterval=null,this.networkInterval=null,this.startTime=0,this.ReceiveBitRateChart=null,this.ReceiveBitRate=[],this.ReceivePacketRateChart=null,this.ReceivePacketRate=[],this.ReceivePacketLossChart=null,this.ReceivePacketLoss=[],this.ReceiveJitterChart=null,this.ReceiveJitter=[],this.ReceiveLevelsChart=null,this.ReceiveLevels=[],this.SendBitRateChart=null,this.SendBitRate=[],this.SendPacketRateChart=null,this.SendPacketRate=[],this.instant=0,this.AnalyserNode=this.context.createAnalyser(),this.AnalyserNode.minDecibels=-90,this.AnalyserNode.maxDecibels=-10,this.AnalyserNode.smoothingTimeConstant=.85}connectToSource(e,t){console.log("SoundMeter connecting...");try{this.source=this.context.createMediaStreamSource(e),this.source.connect(this.AnalyserNode),this._start(),t(null)}catch(e){console.error(e),t(e)}}_start(){var e=this;e.instant=0,e.AnalyserNode.fftSize=32,e.dataArray=new Uint8Array(e.AnalyserNode.frequencyBinCount),this.captureInterval=window.setInterval(function(){e.AnalyserNode.getByteFrequencyData(e.dataArray),e.instant=0;for(var t=0;t<e.dataArray.length;t++)e.dataArray[t]>e.instant&&(e.instant=e.dataArray[t])},1)}stop(){console.log("Disconnecting SoundMeter..."),window.clearInterval(this.captureInterval),this.captureInterval=null,window.clearInterval(this.levelsInterval),this.levelsInterval=null,window.clearInterval(this.networkInterval),this.networkInterval=null;try{this.source.disconnect()}catch(e){}this.source=null;try{this.AnalyserNode.disconnect()}catch(e){}this.AnalyserNode=null;try{this.context.close()}catch(e){}this.context=null;var e=FindLineByNumber(this.lineNum),t={ReceiveBitRate:this.ReceiveBitRate,ReceivePacketRate:this.ReceivePacketRate,ReceivePacketLoss:this.ReceivePacketLoss,ReceiveJitter:this.ReceiveJitter,ReceiveLevels:this.ReceiveLevels,SendBitRate:this.SendBitRate,SendPacketRate:this.SendPacketRate};null!=this.sessionId&&SaveQosData(t,this.sessionId,e.BuddyObj.identity)}}var Line=function(e,t,n,i){this.LineNumber=e,this.DisplayName=t,this.DisplayNumber=n,this.IsSelected=!1,this.BuddyObj=i,this.SipSession=null,this.LocalSoundMeter=null,this.RemoteSoundMeter=null},Buddy=function(e,t,n,i,a,o,s,l,r,d,c,u,p,g,m,f){this.type=e,this.identity=t,this.jid=c,this.CallerIDName=n||"",this.Email=d,this.Desc=r,this.ExtNo=i,this.MobileNumber=a,this.ContactNumber1=o,this.ContactNumber2=s,this.lastActivity=l,this.devState="dotOffline",this.presence="Unknown",this.missed=0,this.IsSelected=!1,this.imageObjectURL="",this.presenceText=lang.default_status,this.EnableDuringDnd=u,this.EnableSubscribe=p,this.SubscribeUser=g||i,this.AllowAutoDelete=void 0!==m?m:AutoDeleteDefault,this.Pinned=void 0!==f&&f},ImageEditor_Select=function(e){var t=GetCanvas("contact-"+e+"-imageCanvas");return null!=t&&(t.ToolSelected="none",t.isDrawingMode=!1,!0)},ImageEditor_FreedrawPen=function(e){var t=GetCanvas("contact-"+e+"-imageCanvas");return null!=t&&(t.freeDrawingBrush.color=t.PenColour,t.freeDrawingBrush.width=t.PenWidth,t.ToolSelected="Draw",t.isDrawingMode=!0,console.log(t),!0)},ImageEditor_FreedrawPaint=function(e){var t=GetCanvas("contact-"+e+"-imageCanvas");return null!=t&&(t.freeDrawingBrush.color=t.PaintColour,t.freeDrawingBrush.width=t.PaintWidth,t.ToolSelected="Paint",t.isDrawingMode=!0,!0)},ImageEditor_Pan=function(e){var t=GetCanvas("contact-"+e+"-imageCanvas");return null!=t&&(t.ToolSelected="Pan",t.isDrawingMode=!1,!0)},ImageEditor_ResetZoom=function(e){var t=GetCanvas("contact-"+e+"-imageCanvas");return null!=t&&(t.setZoom(1),t.setViewportTransform([1,0,0,1,0,0]),!0)},ImageEditor_ZoomIn=function(e){var t=GetCanvas("contact-"+e+"-imageCanvas");if(null!=t){var n=t.getZoom();n+=.5,n>10&&(n=10),n<.1&&(n=.1);var i=new fabric.Point(t.getWidth()/2,t.getHeight()/2);fabric.util.transformPoint(i,t.viewportTransform);return t.zoomToPoint(i,n),!0}return!1},ImageEditor_ZoomOut=function(e){var t=GetCanvas("contact-"+e+"-imageCanvas");if(null!=t){var n=t.getZoom();n-=.5,n>10&&(n=10),n<.1&&(n=.1);var i=new fabric.Point(t.getWidth()/2,t.getHeight()/2);fabric.util.transformPoint(i,t.viewportTransform);return t.zoomToPoint(i,n),!0}return!1},ImageEditor_AddCircle=function(e){var t=GetCanvas("contact-"+e+"-imageCanvas");if(null!=t){t.ToolSelected="none",t.isDrawingMode=!1;var n=new fabric.Circle({radius:20,fill:t.FillColour});return t.add(n),t.centerObject(n),t.setActiveObject(n),!0}return!1},ImageEditor_AddRectangle=function(e){var t=GetCanvas("contact-"+e+"-imageCanvas");if(null!=t){t.ToolSelected="none",t.isDrawingMode=!1;var n=new fabric.Rect({width:40,height:40,fill:t.FillColour});return t.add(n),t.centerObject(n),t.setActiveObject(n),!0}return!1},ImageEditor_AddTriangle=function(e){var t=GetCanvas("contact-"+e+"-imageCanvas");if(null!=t){t.ToolSelected="none",t.isDrawingMode=!1;var n=new fabric.Triangle({width:40,height:40,fill:t.FillColour});return t.add(n),t.centerObject(n),t.setActiveObject(n),!0}return!1},ImageEditor_AddEmoji=function(e){var t=GetCanvas("contact-"+e+"-imageCanvas");if(null!=t){t.ToolSelected="none",t.isDrawingMode=!1;var n=new fabric.Text(String.fromCodePoint(128578),{fontSize:24});return t.add(n),t.centerObject(n),t.setActiveObject(n),!0}return!1},ImageEditor_AddText=function(e,t){var n=GetCanvas("contact-"+e+"-imageCanvas");if(null!=n){n.ToolSelected="none",n.isDrawingMode=!1;var i=new fabric.IText(t,{fill:n.FillColour,fontFamily:"arial",fontSize:18});return n.add(i),n.centerObject(i),n.setActiveObject(i),!0}return!1},ImageEditor_Clear=function(e){var t=GetCanvas("contact-"+e+"-imageCanvas");if(null!=t){t.ToolSelected="none",t.isDrawingMode=!1;for(var n=t.getActiveObjects(),i=0;i<n.length;i++)t.remove(n[i]);return t.discardActiveObject(),!0}return!1},ImageEditor_ClearAll=function(e){var t=GetCanvas("contact-"+e+"-imageCanvas");if(null!=t){var n=t.backgroundImage;return t.ToolSelected="none",t.isDrawingMode=!1,t.clear(),t.backgroundImage=n,!0}return!1},ImageEditor_Cancel=function(e){console.log("Removing ImageEditor..."),$("#contact-"+e+"-imagePastePreview").empty(),RemoveCanvas("contact-"+e+"-imageCanvas"),$("#contact-"+e+"-imagePastePreview").hide()},ImageEditor_Send=function(e){var t=GetCanvas("contact-"+e+"-imageCanvas");if(null!=t){var n=t.toDataURL({format:"png"});return SendImageDataMessage(e,n),!0}return!1},allowDradAndDrop=function(){var e=document.createElement("div");return("draggable"in e||"ondragstart"in e&&"ondrop"in e)&&"FormData"in window&&"FileReader"in window};DetectDevices(),window.setInterval(function(){DetectDevices()},1e4);var XMPP=null,reconnectXmpp=function(){console.log("Connect/Reconnect XMPP connection..."),XMPP&&XMPP.disconnect(""),XMPP&&XMPP.reset();var e="wss://"+XmppServer+":"+XmppWebsocketPort+XmppWebsocketPath,t=profileUser+"@"+SipDomain;""!=XmppRealm&&XmppRealmSeparator&&(t=XmppRealm+XmppRealmSeparator+t);var n=SipPassword;XMPP=null,""!=SipDomain&&""!=XmppServer&&""!=XmppWebsocketPort&&""!=XmppWebsocketPath?(XMPP=new Strophe.Connection(e),XMPP.addHandler(onPingRequest,"urn:xmpp:ping","iq","get"),XMPP.addHandler(onVersionRequest,"jabber:iq:version","iq","get"),XMPP.addHandler(onPresenceChange,null,"presence",null),XMPP.addHandler(onMessage,null,"message",null),console.log("XMPP connect..."),XMPP.connect(t,n,onStatusChange)):console.log("Cannot connect to XMPP: ",SipDomain,XmppServer,XmppWebsocketPort,XmppWebsocketPath)};